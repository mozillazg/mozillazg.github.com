<!DOCTYPE html>
<html lang="zh"  prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml" class="han-init">
<head>
    <title>Amazon EKS Pod Identity 新特性探索 - mozillazg's Blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- share.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css">


    <link href="https://mozillazg.com/favicon.ico" rel="icon">

<link rel="canonical" href="https://mozillazg.com/2023/12/security-deep-dive-into-aws-eks-pod-identity-feature.html">

        <meta name="author" content="mozillazg" />
        <meta name="keywords" content="security,kubernetes,k8s,aws,eks,pod-identity,irsa,cloud-security" />
    <meta name="description" content="本文将简单探索一下 AWS 本周新发布的名为 Amazon EKS Pod Identity 的 EKS 安全特性。 功能介绍 Amazon EKS Pod Identity 是 AWS 对 EKS 原有的 IAM roles for service accounts (IRSA) 功能的补充，通过新增的 EKS Pod Identity 功能，用户可以用更简便的方式实现为 Pod 安全的授予 AWS API 访问权限， 并且所有的配置管理操作都可以通过 AWS API 或者控制台完成。 使用方法 用户只需执行如下操作, 即可基于 EKS Pod Identity 特性实现为 Pod 内应用安全的授予 AWS API 访问权限。 首先，需要创建一个 IAM 角色，确保该角色信任 pods.eks.amazonaws.com 。角色信任策略示例如下。 { &#34;Version&#34;: &#34;2012-10-17&#34;, &#34;Statement&#34;: [ { &#34;Effect&#34;: &#34;Allow&#34;, &#34;Principal&#34;: { &#34;Service&#34;: &#34;pods.eks.amazonaws.com&#34; }, &#34;Action&#34;: [ &#34;sts:AssumeRole&#34;, &#34;sts:TagSession&#34; ] } ] } 其次，需要在 EKS 集群内安装 eks-pod-identity-agent 组件（支持通过控制台安装）。 aws eks create-addon \ --cluster-name &lt;CLUSTER_NAME&gt; \ --addon-name eks-pod-identity-agent \ --addon-version v1.0.0-eksbuild.1 然后，需要配置应用 Pod 所使用的 Service Account 与 AWS IAM 角色之间的关联关系， 允许使用该 Service Account 的应用扮演特定的 IAM 角色（支持通过控制台配置）。 aws eks create-pod-identity-association \ --cluster-name &lt;CLUSTER_NAME&gt; \ --namespace &lt;NAMESPACE&gt; \ --service-account &lt;SERVICE_ACCOUNT_NAME&gt; \ --role-arn &lt;IAM_ROLE_ARN&gt; 最后，应用程序需要更新使用最新的支持 EKS Pod Identity 特性的 AWS SDK ， 并且代码里需要使用 SDK 提供的 默认凭证搜索逻辑 或者显式调用 EKS Pod Identity 依赖的 Container credential provider 。 工作流程 EKS Pod Identity 特性的工作流程如下。 当用户/Controller 向 apiserver 提交 Pod 时，会触发 eks-pod-identity-webhook 的 mutating webhook 流程。 eks-pod-identity-webhook 的 mutating webhook 流程会为 Pod 挂载 service account oidc token 文件以及配置环境变量 (AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE, AWS_CONTAINER_CREDENTIALS_FULL_URI ）。 - env: - name: AWS_STS_REGIONAL_ENDPOINTS value: regional - name: AWS_DEFAULT_REGION value: us-west-2 - name: AWS_REGION value: us-west-2 - name: AWS_CONTAINER_CREDENTIALS_FULL_URI value: http://169.254.170.23/v1/credentials - name: AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE value: /var/run/secrets/pods.eks.amazonaws.com/serviceaccount/eks-pod-identity-token volumeMounts: - mountPath: /var/run/secrets/pods.eks.amazonaws.com/serviceaccount name: eks-pod-identity-token readOnly: true volumes: - name: eks-pod-identity-token projected: defaultMode: 420 sources: - serviceAccountToken: audience: pods.eks.amazonaws.com expirationSeconds: 86400 path: eks-pod-identity-token Pod 容器内的应用使用的 AWS SDK 将使用通过环境变量 AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE 获取的 service account oidc token 访问环境变量 AWS_CONTAINER_CREDENTIALS_FULL_URI 指向的地址 （http://169.254.170.23/v1/credentials）获取 AWS sts token。 $ curl $AWS_CONTAINER_CREDENTIALS_FULL_URI -H &#34;Authorization: $(cat $AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE)&#34; 2&gt;/dev/null |jq { &#34;AccessKeyId&#34;: &#34;ASXXXXXXXXXXXXX&#34;, &#34;SecretAccessKey&#34;: &#34;+j5XXXXXXXX&#34;, &#34;Token&#34;: &#34;IQoJb3JpXXXXXXX&#34;, &#34;AccountId&#34;: &#34;5XXXXXXXXXXX&#34;, &#34;Expiration&#34;: &#34;2023-12-03T13:13:26Z&#34; } AWS_CONTAINER_CREDENTIALS_FULL_URI 指向的其实是 Pod 所在节点上部署的 eks-pod-identity-agent 组件 Pod 所暴露的服务。 eks-pod-identity-agent 收到请求后，将使用传递过来的 oidc token 访问 EKS 新增的 AssumeRoleForPodIdentity API 获取所需的 AWS sts token，然后将获取到的 sts token 返回给客户端。 $ aws eks-auth assume-role-for-pod-identity --cluster-name test --token $(cat $AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE) |jq { &#34;subject&#34;: { &#34;namespace&#34;: &#34;default&#34;, &#34;serviceAccount&#34;: &#34;default&#34; }, &#34;audience&#34;: &#34;pods.eks.amazonaws.com&#34;, &#34;podIdentityAssociation&#34;: { &#34;associationArn&#34;: &#34;arn:aws:eks:us-west-2:5XXXXXXXXXXX:podidentityassociation/test/a-6aaXXXXXXXXXXXXXX&#34;, &#34;associationId&#34;: &#34;a-6aaXXXXXXXXXXXXXX&#34; }, &#34;assumedRoleUser&#34;: { &#34;arn&#34;: &#34;arn:aws:sts::5XXXXXXXXXXX:assumed-role/test-eks-pod-identity/eks-test-XXXXXXXXXXXXXXXX&#34;, &#34;assumeRoleId&#34;: &#34;ARXXXXXXXXXXXXXXXXXXX:eks-test-XXXXXXXXXXXXXXXXXX&#34; }, &#34;credentials&#34;: { &#34;sessionToken&#34;: &#34;IQoXXXXX&#34;, &#34;secretAccessKey&#34;: &#34;nR4XXXXXX&#34;, &#34;accessKeyId&#34;: &#34;ASXXXXXXXXXXXXXXXXXX&#34;, &#34;expiration&#34;: &#34;2023-12-03T13:37:22+00:00&#34; } } 应用调用的 AWS SDK 使用获取到的 sts token 访问应用所需的 AWS 云产品 API。 这个流程中有几个关键的组件和信息需要重点关注，下面将逐个说明。 eks-pod-identity-webhook EKS Pod Identity 功能直接复用 IRSA 功能所依赖的 eks-pod-identity-webhook 组件， 使用这个组件实现为 Pod 自动注入所需的 oidc token 配置以及环境变量配置。并且， EKS 集群控制面中部署的 eks-pod-identity-webhook 为 EKS Pod Identity 做了特殊优化， 只有当对应的 service account 未包含 IRSA 相关配置，并且存在与之关联 的 IAM 角色信息（通过前面的使用方法中介绍的方法关联角色）时，才会为 Pod 注入 EKS Pod Identity 相关配置。 eks-pod-identity-webhook 为了支持 EKS Pod Identity 所作的修改可以参考开源实现（开源实现缺少判断存在关联角色的逻辑） 对应的 PR #189 以及 #196 。 eks-pod-identity-agent 官方推荐的 EKS Pod Identity 实现方案依赖在集群里安装名为 eks-pod-identity-agent 的组件。该组件的工作负载 YAML 如下。 apiVersion: apps/v1 kind: DaemonSet metadata: annotations: deprecated.daemonset.template.generation: &#34;1&#34; creationTimestamp: &#34;2023-12-03T04:24:15Z&#34; generation: 1 labels: app.kubernetes.io/instance: eks-pod-identity-agent app.kubernetes.io/managed-by: Helm app.kubernetes.io/name: eks-pod-identity-agent app.kubernetes.io/version: 0.0.25 helm.sh/chart: eks-pod-identity-agent-1.0.0 name: eks-pod-identity-agent namespace: kube-system resourceVersion: &#34;8978&#34; uid: 08c03e91-69d4-460b-8acb-b9f9f546dd87 spec: revisionHistoryLimit: 10 selector: matchLabels: app.kubernetes.io/instance: eks-pod-identity-agent app.kubernetes.io/name: eks-pod-identity-agent template: metadata: creationTimestamp: null labels: app.kubernetes.io/instance: eks-pod-identity-agent app.kubernetes.io/name: eks-pod-identity-agent spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/os operator: In values: - linux - key: kubernetes.io/arch operator: In values: - amd64 - arm64 - key: eks.amazonaws.com/compute-type operator: NotIn values: - fargate containers: - args: - --port - &#34;80&#34; - --cluster-name - test - --probe-port - &#34;2703&#34; command: - /go-runner - /eks-pod-identity-agent - server env: - name: AWS_REGION value: us-west-2 image: 602401143452.dkr.ecr.us-west-2.amazonaws.com/eks/eks-pod-identity-agent:0.0.25 imagePullPolicy: Always livenessProbe: failureThreshold: 3 httpGet: host: localhost path: /healthz port: probes-port scheme: HTTP initialDelaySeconds: 30 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 10 name: eks-pod-identity-agent ports: - containerPort: 80 name: proxy protocol: TCP - containerPort: 2703 name: probes-port protocol: TCP readinessProbe: failureThreshold: 30 httpGet: host: localhost path: /readyz port: probes-port scheme: HTTP initialDelaySeconds: 1 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 10 resources: {} securityContext: capabilities: add: - CAP_NET_BIND_SERVICE terminationMessagePath: /dev/termination-log terminationMessagePolicy: File dnsPolicy: ClusterFirst hostNetwork: true initContainers: - command: - /go-runner - /eks-pod-identity-agent - initialize image: 602401143452.dkr.ecr.us-west-2.amazonaws.com/eks/eks-pod-identity-agent:0.0.25 imagePullPolicy: Always name: eks-pod-identity-agent-init resources: {} securityContext: privileged: true terminationMessagePath: /dev/termination-log terminationMessagePolicy: File priorityClassName: system-node-critical restartPolicy: Always schedulerName: default-scheduler securityContext: {} terminationGracePeriodSeconds: 30 updateStrategy: rollingUpdate: maxSurge: 0 maxUnavailable: 10% type: RollingUpdate status: currentNumberScheduled: 1 desiredNumberScheduled: 1 numberAvailable: 1 numberMisscheduled: 0 numberReady: 1 observedGeneration: 1 eks-pod-identity-agent 组件具有如下特点： 依赖节点 IAM 角色被授予如下 IAM 权限策略。 { &#34;Version&#34;: &#34;2012-10-17&#34;, &#34;Statement&#34;: [ { &#34;Effect&#34;: &#34;Allow&#34;, &#34;Action&#34;: [ &#34;eks-auth:AssumeRoleForPodIdentity&#34;, ], &#34;Resource&#34;: &#34;*&#34; } ] } 组件 Pod 使用 hostNetwork 。 组件内的服务将监听 80 和 2703 端口。 其中 80 端口监听的 IPv4 地址为 169.254.170.23, IPv6 地址为 [fd00:ec2::23] 。 $ ss -anltp |grep eks-pod LISTEN 0 4096 127.0.0.1:2703 0.0.0.0:* users:((&#34;eks-pod-identit&#34;,pid=3798,fd=5)) LISTEN 0 4096 169.254.170.23:80 0.0.0.0:* users:((&#34;eks-pod-identit&#34;,pid=3798,fd=4)) LISTEN 0 4096 [fd00:ec2::23]:80 [::]:* users:((&#34;eks-pod-identit&#34;,pid=3798,fd=3)) 组件将通过 init 容器在节点上创建一个 IPv4 地址为 169.254.170.23, IPv6 地址为 [fd00:ec2::23] 的网络接口 pod-id-link0 。 pod-id-link0: flags=195&lt;UP,BROADCAST,RUNNING,NOARP&gt; mtu 1500 inet 169.254.170.23 netmask 255.255.255.255 broadcast 0.0.0.0 inet6 fe80::2078:53ff:fe2f:c723 prefixlen 64 scopeid 0x20&lt;link&gt; inet6 fd00:ec2::23 prefixlen 128 scopeid 0x0&lt;global&gt; ether 22:78:53:2f:c7:23 txqueuelen 1000 (Ethernet) RX packets 0 bytes 0 (0.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 10 bytes 700 (700.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 init 容器还会设置下面这样的的路由规则，确保在本机处理发往 169.254.170.23 的流量。 169.254.170.23 dev pod-id-link0 AssumeRoleForPodIdentity EKS 提供了一个新的 API AssumeRoleForPodIdentity ， 用于使用 service account oidc token 获取扮演 service account 关联 IAM 角色的 sts token。 service account oidc token 中的 payload 的内容示例如下。 { &#34;aud&#34;: [ &#34;pods.eks.amazonaws.com&#34; ], &#34;exp&#34;: 1701672885, &#34;iat&#34;: 1701586485, &#34;iss&#34;: &#34;https://oidc.eks.us-west-2.amazonaws.com/id/DA16E524AXXXXXX&#34;, &#34;kubernetes.io&#34;: { &#34;namespace&#34;: &#34;default&#34;, &#34;pod&#34;: { &#34;name&#34;: &#34;test-596475c6d5-xgvml&#34;, &#34;uid&#34;: &#34;924e66b2-841e-4969-9fa7-a19f3f6f1029&#34; }, &#34;serviceaccount&#34;: { &#34;name&#34;: &#34;default&#34;, &#34;uid&#34;: &#34;eca98cb1-ca2e-469b-8f9d-2be9f5a3354f&#34; } }, &#34;nbf&#34;: 1701586485, &#34;sub&#34;: &#34;system:serviceaccount:default:default&#34; } 可以看到这个 oidc token 跟 IRSA 方案中的 oidc token 相比，除了 aud 不一样外（IRSA 中是 sts.amazonaws.com ）， 其他内容都是一样的。 因此，据我猜测，AssumeRoleForPodIdentity 的后端逻辑可能类似下面这样： 首先，基于 oidc 协议解析和校验客户端传递过来的 oidc token 的有效性和合法性。 然后，基于用户配置的 service account 与 IAM 角色关联关系，获取需要扮演的角色信息。 最后，调用 sts API 扮演对应角色，获取客户端所需的 sts token。 servce account 关联 IAM 角色 为了简化用户为 service account 关联 IAM 角色的操作，EKS 新增了一组用于管理 service account 与 IAM 角色关联关系的 API。 同时还增加了对应的 EKS 控制台操作页面，并且关联关系都存储在 EKS 侧，并没有去修改角色的信任策略。 CreatePodIdentityAssociation ：为 service account 关联角色。 DescribePodIdentityAssociation : 查看单条角色关联记录的详情。 UpdatePodIdentityAssociation ：修改 service account 关联的角色信息。 DeletePodIdentityAssociation ：删除一条角色关联记录。 ListPodIdentityAssociations ：获取当前存在的角色关联记录。 权限控制 在 IRSA 方案中，我们需要在 IAM 角色的信任策略中配置允许的集群 oidc provider 以及 service account 信息。 但是，在 EKS Pod Identity 方案中，我们不再需要修改角色的信任策略，只需要使用前面介绍的方法使用 EKS 控制台或者 EKS API 即可完成控制角色能被哪些集群的哪些 service account 使用，这些关联关系存储在 EKS 侧，不再需要频繁的更新角色的信任策略。 通过这种方式， EKS Pod Identity 解决了 IRSA 中因为角色信任策略的内容大小限制导致一个角色只能被有限的几个 service account 关联使用的问题 （详见 #148 ）， 在 EKS Pod Identity 方案中，一个角色可以与不限数量的 service account 进行关联。 attribute-based access control (ABAC) EKS Pod Identity 方案还引入了新的基于属性的访问控制能力（attribute-based access control (ABAC)）： 通过 EKS Pod Identity 方案获取到的 sts token 默认都携带了集群信息、命名空间以及 service account 等 tag 属性， 用户可以基于 IAM 提供的 tag 鉴权 特性， 在为角色配置权限策略时，实现基于属性的访问控制能力。 通过 EKS Pod Identity 获取的 sts token 默认携带了如下 tag ： eks-cluster-arn ：当前集群的 ARN。 eks-cluster-name ：当前集群的名称。 kubernetes-namespace: service account 所在的命名空间名称。 kubernetes-service-account ：service account 的名称。 kubernetes-pod-name ：使用 service account 的 pod 的名称。 kubernetes-pod-uid ：使用 service account 的 pod 的 uid。 &#34;tags&#34;: [ { &#34;key&#34;: &#34;eks-cluster-arn&#34;, &#34;value&#34;: &#34;arn:aws:eks:us-west-2:5XXXXXXXXXXX:cluster/test&#34; }, { &#34;key&#34;: &#34;eks-cluster-name&#34;, &#34;value&#34;: &#34;test&#34; }, { &#34;key&#34;: &#34;kubernetes-namespace&#34;, &#34;value&#34;: &#34;default&#34; }, { &#34;key&#34;: &#34;kubernetes-service-account&#34;, &#34;value&#34;: &#34;default&#34; }, { &#34;key&#34;: &#34;kubernetes-pod-name&#34;, &#34;value&#34;: &#34;test-596475c6d5-xgvml&#34; }, { &#34;key&#34;: &#34;kubernetes-pod-uid&#34;, &#34;value&#34;: &#34;924e66b2-841e-4969-9fa7-a19f3f6f1029&#34; } ] 我们在定义角色权限策略的时候，可以通过 ${aws:PrincipalTag/&lt;tag-key&gt;} 的方式 在权限策略的 Condition 配置中表示凭证属性中包含的特定 tag 的值。 { &#34;Version&#34;: &#34;2012-10-17&#34;, &#34;Statement&#34;: [ { &#34;Effect&#34;: &#34;Allow&#34;, &#34;Action&#34;: [ &#34;s3:GetObject&#34;, &#34;s3:GetObjectTagging&#34; ], &#34;Resource&#34;: &#34;*&#34;, &#34;Condition&#34;: { &#34;StringEquals&#34;: { &#34;s3:ExistingObjectTag/eks-cluster-name&#34;: &#34;${aws:PrincipalTag/eks-cluster-name}&#34; }, &#34;StringEqualsIfExists&#34;: { &#34;aws:ResourceTag/kubernetes-namespace&#34;: &#34;s3-demo&#34;, &#34;aws:Resourcelag/kubernetes-service-account&#34;: &#34;${aws:PrincipalTag/kubernetes-service-account}&#34; } } } ] } 通过上面这个示例权限策略，我们可以对通过 EKS Pod Identity 特性扮演角色获取的 sts token 的权限做如下限制： 只允许访问存在名为 eks-cluster-name 的 tag 的 s3 object ，并且 tag 的值必须是当前 sts token 关联集群的名称。 如果 s3 object 存在名为 kubernetes-namespace 的 tag，只允许访问这个 tag 的值是 s3-demo 的 object。 如果 s3 object 存在名为 kubernetes-service-account 的 tag，只允许访问这个 tag 的值是当前 sts token 关联的 service account 名称的 object。 与 IRSA 的区别 根据上面介绍的信息，我们可以比较一下 EKS Pod Identity 与 IRSA 特性的区别，它们主要的区别如下： 比较项 EKS Pod Identity IRSA 节点 IAM 角色增加额外权限 需要增加 eks-auth:AssumeRoleForPodIdentity 权限 不需要 创建 IAM oidc provider 不需要 需要为每个集群创建一个 oidc provider service account 关联角色 通过 EKS API/控制台 配置 service account annotation + 修改角色信任策略 一个角色可以关联的 service account 数量 无限制 角色信任策略有 4096 个字符限制， 最多关联 10 个左右 service account 或 集群 一个 service account 可以关联的角色数量 一个 无限制 角色信任策略修改次数 只需修改一次 确保信任 pods.eks.amazonaws.com 以及包含所需的 action 需要为每个关联的集群修改至少一次 基于 service account 相关属性进行访问控制 通过 ABAC 进行支持 不支持 集群类型 只支持 EKS 集群，不支持 AWS Outposts、 不支持 EKS Anywhere、AWS Fargate (Fargate)、自建集群 仅不支持 AWS Outposts 数据面依赖 kubelet + eks-pod-identity-agent kublet 稳定性风险 依赖集群控制面和数据面的稳定性 + EKS API； 同时还依赖 aks-pod-identity-agent 的稳定性； 应用 pod 如果先于 eks-pod-identity-agent pod 启动/就绪会出现短暂的无法获取到 sts token 的问题 （比如，同样配置了 hostNetwork 的 pod 在 自动伸缩场景可能会遇到这种情况，以及不建议 CNI、CSI 这些常常会先于 agent pod 启动的组件使用） 依赖集群控制面和数据面的稳定性 + STS API 参考资料 Amazon EKS Pod Identity simplifies IAM permissions for applications on Amazon EKS clusters | AWS News Blog Introducing fine-grained IAM roles for service accounts | AWS Open Source Blog EKS Pod Identities - Amazon EKS aws/amazon-eks-pod-identity-webhook: Amazon EKS Pod Identity Webhook Define permissions for EKS Pod Identities to assume roles based on tags - Amazon EKS Controlling access to and for IAM users and roles using tags - AWS Identity and Access Management IAM JSON policy elements: Condition - AWS Identity and Access Management Deep dive into the new Amazon EKS Pod Identity feature | Datadog Security Labs" />

    <style>
      .js-toc {
        margin-bottom: 20px;
      }
      .donate-modal {
        text-align: center;
      }
      #donate-modal-container .donate-image {
        max-height: 300px !important;
        min-height: inherit !important;
      }
    </style>

        <meta property="og:site_name" content="mozillazg's Blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Amazon EKS Pod Identity 新特性探索"/>
        <meta property="og:url" content="https://mozillazg.com/2023/12/security-deep-dive-into-aws-eks-pod-identity-feature.html"/>
        <meta property="og:description" content="本文将简单探索一下 AWS 本周新发布的名为 Amazon EKS Pod Identity 的 EKS 安全特性。 功能介绍 Amazon EKS Pod Identity 是 AWS 对 EKS 原有的 IAM roles for service accounts (IRSA) 功能的补充，通过新增的 EKS Pod Identity 功能，用户可以用更简便的方式实现为 Pod 安全的授予 AWS API 访问权限， 并且所有的配置管理操作都可以通过 AWS API 或者控制台完成。 使用方法 用户只需执行如下操作, 即可基于 EKS Pod Identity 特性实现为 Pod 内应用安全的授予 AWS API 访问权限。 首先，需要创建一个 IAM 角色，确保该角色信任 pods.eks.amazonaws.com 。角色信任策略示例如下。 { &#34;Version&#34;: &#34;2012-10-17&#34;, &#34;Statement&#34;: [ { &#34;Effect&#34;: &#34;Allow&#34;, &#34;Principal&#34;: { &#34;Service&#34;: &#34;pods.eks.amazonaws.com&#34; }, &#34;Action&#34;: [ &#34;sts:AssumeRole&#34;, &#34;sts:TagSession&#34; ] } ] } 其次，需要在 EKS 集群内安装 eks-pod-identity-agent 组件（支持通过控制台安装）。 aws eks create-addon \ --cluster-name &lt;CLUSTER_NAME&gt; \ --addon-name eks-pod-identity-agent \ --addon-version v1.0.0-eksbuild.1 然后，需要配置应用 Pod 所使用的 Service Account 与 AWS IAM 角色之间的关联关系， 允许使用该 Service Account 的应用扮演特定的 IAM 角色（支持通过控制台配置）。 aws eks create-pod-identity-association \ --cluster-name &lt;CLUSTER_NAME&gt; \ --namespace &lt;NAMESPACE&gt; \ --service-account &lt;SERVICE_ACCOUNT_NAME&gt; \ --role-arn &lt;IAM_ROLE_ARN&gt; 最后，应用程序需要更新使用最新的支持 EKS Pod Identity 特性的 AWS SDK ， 并且代码里需要使用 SDK 提供的 默认凭证搜索逻辑 或者显式调用 EKS Pod Identity 依赖的 Container credential provider 。 工作流程 EKS Pod Identity 特性的工作流程如下。 当用户/Controller 向 apiserver 提交 Pod 时，会触发 eks-pod-identity-webhook 的 mutating webhook 流程。 eks-pod-identity-webhook 的 mutating webhook 流程会为 Pod 挂载 service account oidc token 文件以及配置环境变量 (AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE, AWS_CONTAINER_CREDENTIALS_FULL_URI ）。 - env: - name: AWS_STS_REGIONAL_ENDPOINTS value: regional - name: AWS_DEFAULT_REGION value: us-west-2 - name: AWS_REGION value: us-west-2 - name: AWS_CONTAINER_CREDENTIALS_FULL_URI value: http://169.254.170.23/v1/credentials - name: AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE value: /var/run/secrets/pods.eks.amazonaws.com/serviceaccount/eks-pod-identity-token volumeMounts: - mountPath: /var/run/secrets/pods.eks.amazonaws.com/serviceaccount name: eks-pod-identity-token readOnly: true volumes: - name: eks-pod-identity-token projected: defaultMode: 420 sources: - serviceAccountToken: audience: pods.eks.amazonaws.com expirationSeconds: 86400 path: eks-pod-identity-token Pod 容器内的应用使用的 AWS SDK 将使用通过环境变量 AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE 获取的 service account oidc token 访问环境变量 AWS_CONTAINER_CREDENTIALS_FULL_URI 指向的地址 （http://169.254.170.23/v1/credentials）获取 AWS sts token。 $ curl $AWS_CONTAINER_CREDENTIALS_FULL_URI -H &#34;Authorization: $(cat $AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE)&#34; 2&gt;/dev/null |jq { &#34;AccessKeyId&#34;: &#34;ASXXXXXXXXXXXXX&#34;, &#34;SecretAccessKey&#34;: &#34;+j5XXXXXXXX&#34;, &#34;Token&#34;: &#34;IQoJb3JpXXXXXXX&#34;, &#34;AccountId&#34;: &#34;5XXXXXXXXXXX&#34;, &#34;Expiration&#34;: &#34;2023-12-03T13:13:26Z&#34; } AWS_CONTAINER_CREDENTIALS_FULL_URI 指向的其实是 Pod 所在节点上部署的 eks-pod-identity-agent 组件 Pod 所暴露的服务。 eks-pod-identity-agent 收到请求后，将使用传递过来的 oidc token 访问 EKS 新增的 AssumeRoleForPodIdentity API 获取所需的 AWS sts token，然后将获取到的 sts token 返回给客户端。 $ aws eks-auth assume-role-for-pod-identity --cluster-name test --token $(cat $AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE) |jq { &#34;subject&#34;: { &#34;namespace&#34;: &#34;default&#34;, &#34;serviceAccount&#34;: &#34;default&#34; }, &#34;audience&#34;: &#34;pods.eks.amazonaws.com&#34;, &#34;podIdentityAssociation&#34;: { &#34;associationArn&#34;: &#34;arn:aws:eks:us-west-2:5XXXXXXXXXXX:podidentityassociation/test/a-6aaXXXXXXXXXXXXXX&#34;, &#34;associationId&#34;: &#34;a-6aaXXXXXXXXXXXXXX&#34; }, &#34;assumedRoleUser&#34;: { &#34;arn&#34;: &#34;arn:aws:sts::5XXXXXXXXXXX:assumed-role/test-eks-pod-identity/eks-test-XXXXXXXXXXXXXXXX&#34;, &#34;assumeRoleId&#34;: &#34;ARXXXXXXXXXXXXXXXXXXX:eks-test-XXXXXXXXXXXXXXXXXX&#34; }, &#34;credentials&#34;: { &#34;sessionToken&#34;: &#34;IQoXXXXX&#34;, &#34;secretAccessKey&#34;: &#34;nR4XXXXXX&#34;, &#34;accessKeyId&#34;: &#34;ASXXXXXXXXXXXXXXXXXX&#34;, &#34;expiration&#34;: &#34;2023-12-03T13:37:22+00:00&#34; } } 应用调用的 AWS SDK 使用获取到的 sts token 访问应用所需的 AWS 云产品 API。 这个流程中有几个关键的组件和信息需要重点关注，下面将逐个说明。 eks-pod-identity-webhook EKS Pod Identity 功能直接复用 IRSA 功能所依赖的 eks-pod-identity-webhook 组件， 使用这个组件实现为 Pod 自动注入所需的 oidc token 配置以及环境变量配置。并且， EKS 集群控制面中部署的 eks-pod-identity-webhook 为 EKS Pod Identity 做了特殊优化， 只有当对应的 service account 未包含 IRSA 相关配置，并且存在与之关联 的 IAM 角色信息（通过前面的使用方法中介绍的方法关联角色）时，才会为 Pod 注入 EKS Pod Identity 相关配置。 eks-pod-identity-webhook 为了支持 EKS Pod Identity 所作的修改可以参考开源实现（开源实现缺少判断存在关联角色的逻辑） 对应的 PR #189 以及 #196 。 eks-pod-identity-agent 官方推荐的 EKS Pod Identity 实现方案依赖在集群里安装名为 eks-pod-identity-agent 的组件。该组件的工作负载 YAML 如下。 apiVersion: apps/v1 kind: DaemonSet metadata: annotations: deprecated.daemonset.template.generation: &#34;1&#34; creationTimestamp: &#34;2023-12-03T04:24:15Z&#34; generation: 1 labels: app.kubernetes.io/instance: eks-pod-identity-agent app.kubernetes.io/managed-by: Helm app.kubernetes.io/name: eks-pod-identity-agent app.kubernetes.io/version: 0.0.25 helm.sh/chart: eks-pod-identity-agent-1.0.0 name: eks-pod-identity-agent namespace: kube-system resourceVersion: &#34;8978&#34; uid: 08c03e91-69d4-460b-8acb-b9f9f546dd87 spec: revisionHistoryLimit: 10 selector: matchLabels: app.kubernetes.io/instance: eks-pod-identity-agent app.kubernetes.io/name: eks-pod-identity-agent template: metadata: creationTimestamp: null labels: app.kubernetes.io/instance: eks-pod-identity-agent app.kubernetes.io/name: eks-pod-identity-agent spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/os operator: In values: - linux - key: kubernetes.io/arch operator: In values: - amd64 - arm64 - key: eks.amazonaws.com/compute-type operator: NotIn values: - fargate containers: - args: - --port - &#34;80&#34; - --cluster-name - test - --probe-port - &#34;2703&#34; command: - /go-runner - /eks-pod-identity-agent - server env: - name: AWS_REGION value: us-west-2 image: 602401143452.dkr.ecr.us-west-2.amazonaws.com/eks/eks-pod-identity-agent:0.0.25 imagePullPolicy: Always livenessProbe: failureThreshold: 3 httpGet: host: localhost path: /healthz port: probes-port scheme: HTTP initialDelaySeconds: 30 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 10 name: eks-pod-identity-agent ports: - containerPort: 80 name: proxy protocol: TCP - containerPort: 2703 name: probes-port protocol: TCP readinessProbe: failureThreshold: 30 httpGet: host: localhost path: /readyz port: probes-port scheme: HTTP initialDelaySeconds: 1 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 10 resources: {} securityContext: capabilities: add: - CAP_NET_BIND_SERVICE terminationMessagePath: /dev/termination-log terminationMessagePolicy: File dnsPolicy: ClusterFirst hostNetwork: true initContainers: - command: - /go-runner - /eks-pod-identity-agent - initialize image: 602401143452.dkr.ecr.us-west-2.amazonaws.com/eks/eks-pod-identity-agent:0.0.25 imagePullPolicy: Always name: eks-pod-identity-agent-init resources: {} securityContext: privileged: true terminationMessagePath: /dev/termination-log terminationMessagePolicy: File priorityClassName: system-node-critical restartPolicy: Always schedulerName: default-scheduler securityContext: {} terminationGracePeriodSeconds: 30 updateStrategy: rollingUpdate: maxSurge: 0 maxUnavailable: 10% type: RollingUpdate status: currentNumberScheduled: 1 desiredNumberScheduled: 1 numberAvailable: 1 numberMisscheduled: 0 numberReady: 1 observedGeneration: 1 eks-pod-identity-agent 组件具有如下特点： 依赖节点 IAM 角色被授予如下 IAM 权限策略。 { &#34;Version&#34;: &#34;2012-10-17&#34;, &#34;Statement&#34;: [ { &#34;Effect&#34;: &#34;Allow&#34;, &#34;Action&#34;: [ &#34;eks-auth:AssumeRoleForPodIdentity&#34;, ], &#34;Resource&#34;: &#34;*&#34; } ] } 组件 Pod 使用 hostNetwork 。 组件内的服务将监听 80 和 2703 端口。 其中 80 端口监听的 IPv4 地址为 169.254.170.23, IPv6 地址为 [fd00:ec2::23] 。 $ ss -anltp |grep eks-pod LISTEN 0 4096 127.0.0.1:2703 0.0.0.0:* users:((&#34;eks-pod-identit&#34;,pid=3798,fd=5)) LISTEN 0 4096 169.254.170.23:80 0.0.0.0:* users:((&#34;eks-pod-identit&#34;,pid=3798,fd=4)) LISTEN 0 4096 [fd00:ec2::23]:80 [::]:* users:((&#34;eks-pod-identit&#34;,pid=3798,fd=3)) 组件将通过 init 容器在节点上创建一个 IPv4 地址为 169.254.170.23, IPv6 地址为 [fd00:ec2::23] 的网络接口 pod-id-link0 。 pod-id-link0: flags=195&lt;UP,BROADCAST,RUNNING,NOARP&gt; mtu 1500 inet 169.254.170.23 netmask 255.255.255.255 broadcast 0.0.0.0 inet6 fe80::2078:53ff:fe2f:c723 prefixlen 64 scopeid 0x20&lt;link&gt; inet6 fd00:ec2::23 prefixlen 128 scopeid 0x0&lt;global&gt; ether 22:78:53:2f:c7:23 txqueuelen 1000 (Ethernet) RX packets 0 bytes 0 (0.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 10 bytes 700 (700.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 init 容器还会设置下面这样的的路由规则，确保在本机处理发往 169.254.170.23 的流量。 169.254.170.23 dev pod-id-link0 AssumeRoleForPodIdentity EKS 提供了一个新的 API AssumeRoleForPodIdentity ， 用于使用 service account oidc token 获取扮演 service account 关联 IAM 角色的 sts token。 service account oidc token 中的 payload 的内容示例如下。 { &#34;aud&#34;: [ &#34;pods.eks.amazonaws.com&#34; ], &#34;exp&#34;: 1701672885, &#34;iat&#34;: 1701586485, &#34;iss&#34;: &#34;https://oidc.eks.us-west-2.amazonaws.com/id/DA16E524AXXXXXX&#34;, &#34;kubernetes.io&#34;: { &#34;namespace&#34;: &#34;default&#34;, &#34;pod&#34;: { &#34;name&#34;: &#34;test-596475c6d5-xgvml&#34;, &#34;uid&#34;: &#34;924e66b2-841e-4969-9fa7-a19f3f6f1029&#34; }, &#34;serviceaccount&#34;: { &#34;name&#34;: &#34;default&#34;, &#34;uid&#34;: &#34;eca98cb1-ca2e-469b-8f9d-2be9f5a3354f&#34; } }, &#34;nbf&#34;: 1701586485, &#34;sub&#34;: &#34;system:serviceaccount:default:default&#34; } 可以看到这个 oidc token 跟 IRSA 方案中的 oidc token 相比，除了 aud 不一样外（IRSA 中是 sts.amazonaws.com ）， 其他内容都是一样的。 因此，据我猜测，AssumeRoleForPodIdentity 的后端逻辑可能类似下面这样： 首先，基于 oidc 协议解析和校验客户端传递过来的 oidc token 的有效性和合法性。 然后，基于用户配置的 service account 与 IAM 角色关联关系，获取需要扮演的角色信息。 最后，调用 sts API 扮演对应角色，获取客户端所需的 sts token。 servce account 关联 IAM 角色 为了简化用户为 service account 关联 IAM 角色的操作，EKS 新增了一组用于管理 service account 与 IAM 角色关联关系的 API。 同时还增加了对应的 EKS 控制台操作页面，并且关联关系都存储在 EKS 侧，并没有去修改角色的信任策略。 CreatePodIdentityAssociation ：为 service account 关联角色。 DescribePodIdentityAssociation : 查看单条角色关联记录的详情。 UpdatePodIdentityAssociation ：修改 service account 关联的角色信息。 DeletePodIdentityAssociation ：删除一条角色关联记录。 ListPodIdentityAssociations ：获取当前存在的角色关联记录。 权限控制 在 IRSA 方案中，我们需要在 IAM 角色的信任策略中配置允许的集群 oidc provider 以及 service account 信息。 但是，在 EKS Pod Identity 方案中，我们不再需要修改角色的信任策略，只需要使用前面介绍的方法使用 EKS 控制台或者 EKS API 即可完成控制角色能被哪些集群的哪些 service account 使用，这些关联关系存储在 EKS 侧，不再需要频繁的更新角色的信任策略。 通过这种方式， EKS Pod Identity 解决了 IRSA 中因为角色信任策略的内容大小限制导致一个角色只能被有限的几个 service account 关联使用的问题 （详见 #148 ）， 在 EKS Pod Identity 方案中，一个角色可以与不限数量的 service account 进行关联。 attribute-based access control (ABAC) EKS Pod Identity 方案还引入了新的基于属性的访问控制能力（attribute-based access control (ABAC)）： 通过 EKS Pod Identity 方案获取到的 sts token 默认都携带了集群信息、命名空间以及 service account 等 tag 属性， 用户可以基于 IAM 提供的 tag 鉴权 特性， 在为角色配置权限策略时，实现基于属性的访问控制能力。 通过 EKS Pod Identity 获取的 sts token 默认携带了如下 tag ： eks-cluster-arn ：当前集群的 ARN。 eks-cluster-name ：当前集群的名称。 kubernetes-namespace: service account 所在的命名空间名称。 kubernetes-service-account ：service account 的名称。 kubernetes-pod-name ：使用 service account 的 pod 的名称。 kubernetes-pod-uid ：使用 service account 的 pod 的 uid。 &#34;tags&#34;: [ { &#34;key&#34;: &#34;eks-cluster-arn&#34;, &#34;value&#34;: &#34;arn:aws:eks:us-west-2:5XXXXXXXXXXX:cluster/test&#34; }, { &#34;key&#34;: &#34;eks-cluster-name&#34;, &#34;value&#34;: &#34;test&#34; }, { &#34;key&#34;: &#34;kubernetes-namespace&#34;, &#34;value&#34;: &#34;default&#34; }, { &#34;key&#34;: &#34;kubernetes-service-account&#34;, &#34;value&#34;: &#34;default&#34; }, { &#34;key&#34;: &#34;kubernetes-pod-name&#34;, &#34;value&#34;: &#34;test-596475c6d5-xgvml&#34; }, { &#34;key&#34;: &#34;kubernetes-pod-uid&#34;, &#34;value&#34;: &#34;924e66b2-841e-4969-9fa7-a19f3f6f1029&#34; } ] 我们在定义角色权限策略的时候，可以通过 ${aws:PrincipalTag/&lt;tag-key&gt;} 的方式 在权限策略的 Condition 配置中表示凭证属性中包含的特定 tag 的值。 { &#34;Version&#34;: &#34;2012-10-17&#34;, &#34;Statement&#34;: [ { &#34;Effect&#34;: &#34;Allow&#34;, &#34;Action&#34;: [ &#34;s3:GetObject&#34;, &#34;s3:GetObjectTagging&#34; ], &#34;Resource&#34;: &#34;*&#34;, &#34;Condition&#34;: { &#34;StringEquals&#34;: { &#34;s3:ExistingObjectTag/eks-cluster-name&#34;: &#34;${aws:PrincipalTag/eks-cluster-name}&#34; }, &#34;StringEqualsIfExists&#34;: { &#34;aws:ResourceTag/kubernetes-namespace&#34;: &#34;s3-demo&#34;, &#34;aws:Resourcelag/kubernetes-service-account&#34;: &#34;${aws:PrincipalTag/kubernetes-service-account}&#34; } } } ] } 通过上面这个示例权限策略，我们可以对通过 EKS Pod Identity 特性扮演角色获取的 sts token 的权限做如下限制： 只允许访问存在名为 eks-cluster-name 的 tag 的 s3 object ，并且 tag 的值必须是当前 sts token 关联集群的名称。 如果 s3 object 存在名为 kubernetes-namespace 的 tag，只允许访问这个 tag 的值是 s3-demo 的 object。 如果 s3 object 存在名为 kubernetes-service-account 的 tag，只允许访问这个 tag 的值是当前 sts token 关联的 service account 名称的 object。 与 IRSA 的区别 根据上面介绍的信息，我们可以比较一下 EKS Pod Identity 与 IRSA 特性的区别，它们主要的区别如下： 比较项 EKS Pod Identity IRSA 节点 IAM 角色增加额外权限 需要增加 eks-auth:AssumeRoleForPodIdentity 权限 不需要 创建 IAM oidc provider 不需要 需要为每个集群创建一个 oidc provider service account 关联角色 通过 EKS API/控制台 配置 service account annotation + 修改角色信任策略 一个角色可以关联的 service account 数量 无限制 角色信任策略有 4096 个字符限制， 最多关联 10 个左右 service account 或 集群 一个 service account 可以关联的角色数量 一个 无限制 角色信任策略修改次数 只需修改一次 确保信任 pods.eks.amazonaws.com 以及包含所需的 action 需要为每个关联的集群修改至少一次 基于 service account 相关属性进行访问控制 通过 ABAC 进行支持 不支持 集群类型 只支持 EKS 集群，不支持 AWS Outposts、 不支持 EKS Anywhere、AWS Fargate (Fargate)、自建集群 仅不支持 AWS Outposts 数据面依赖 kubelet + eks-pod-identity-agent kublet 稳定性风险 依赖集群控制面和数据面的稳定性 + EKS API； 同时还依赖 aks-pod-identity-agent 的稳定性； 应用 pod 如果先于 eks-pod-identity-agent pod 启动/就绪会出现短暂的无法获取到 sts token 的问题 （比如，同样配置了 hostNetwork 的 pod 在 自动伸缩场景可能会遇到这种情况，以及不建议 CNI、CSI 这些常常会先于 agent pod 启动的组件使用） 依赖集群控制面和数据面的稳定性 + STS API 参考资料 Amazon EKS Pod Identity simplifies IAM permissions for applications on Amazon EKS clusters | AWS News Blog Introducing fine-grained IAM roles for service accounts | AWS Open Source Blog EKS Pod Identities - Amazon EKS aws/amazon-eks-pod-identity-webhook: Amazon EKS Pod Identity Webhook Define permissions for EKS Pod Identities to assume roles based on tags - Amazon EKS Controlling access to and for IAM users and roles using tags - AWS Identity and Access Management IAM JSON policy elements: Condition - AWS Identity and Access Management Deep dive into the new Amazon EKS Pod Identity feature | Datadog Security Labs"/>
        <meta property="article:published_time" content="2023-12-03" />
            <meta property="article:section" content="security" />
            <meta property="article:tag" content="security" />
            <meta property="article:tag" content="kubernetes" />
            <meta property="article:tag" content="k8s" />
            <meta property="article:tag" content="aws" />
            <meta property="article:tag" content="eks" />
            <meta property="article:tag" content="pod-identity" />
            <meta property="article:tag" content="irsa" />
            <meta property="article:tag" content="cloud-security" />
            <meta property="article:author" content="mozillazg" />
            <meta property="og:image"
                  content="https://mozillazg.com/static/avatar.jpeg"/>


    <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@mozillazg">
        <meta name="twitter:creator" content="@mozillazg">
    <meta name="twitter:domain" content="https://mozillazg.com">
            <meta property="twitter:image"
                  content="https://mozillazg.com/static/avatar.jpeg"/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.4/dist/css/bootstrap.min.css" type="text/css"/>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/pygments-css@1.0.0/github.css" rel="stylesheet">
    <link rel="stylesheet" href="https://mozillazg.com/theme/css/style.css" type="text/css"/>
            <link href="https://mozillazg.com/static/custom.css" rel="stylesheet">

        <link href="https://mozillazg.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="mozillazg's Blog ATOM Feed"/>

        <link href="https://mozillazg.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="mozillazg's Blog RSS Feed"/>


        <link href="https://mozillazg.com/feeds/security.atom.xml" type="application/atom+xml" rel="alternate"
              title="mozillazg's Blog security ATOM Feed"/>


    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "publisher": {
            "@type": "Person",
            "name": "mozillazg",
            "logo": "https://mozillazg.com/static/avatar.jpeg"
        },
        "author": {
            "@type": "Person",
            "name": "mozillazg",
            "image": "https://mozillazg.com/static/avatar.jpeg",
            "url": "https://mozillazg.com",
            "sameAs": []
        },
        "headline": "Amazon EKS Pod Identity 新特性探索",
        "url": "https://mozillazg.com/2023/12/security-deep-dive-into-aws-eks-pod-identity-feature.html",
        "image": [
            "https://mozillazg.com/static/avatar.jpeg"
         ],
        "keywords": "security, kubernetes, k8s, aws, eks, pod-identity, irsa, cloud-security",
        "description": "本文将简单探索一下 AWS 本周新发布的名为 Amazon EKS Pod Identity 的 EKS 安全特性。 功能介绍 Amazon EKS Pod Identity 是 AWS 对 EKS 原有的 IAM roles for service accounts (IRSA) 功能的补充，通过新增的 EKS Pod Identity 功能，用户可以用更简便的方式实现为 Pod 安全的授予 AWS API 访问权限， 并且所有的配置管理操作都可以通过 AWS API 或者控制台完成。 使用方法 用户只需执行如下操作, 即可基于 EKS Pod Identity 特性实现为 Pod 内应用安全的授予 AWS API 访问权限。 首先，需要创建一个 IAM 角色，确保该角色信任 pods.eks.amazonaws.com 。角色信任策略示例如下。 { &#34;Version&#34;: &#34;2012-10-17&#34;, &#34;Statement&#34;: [ { &#34;Effect&#34;: &#34;Allow&#34;, &#34;Principal&#34;: { &#34;Service&#34;: &#34;pods.eks.amazonaws.com&#34; }, &#34;Action&#34;: [ &#34;sts:AssumeRole&#34;, &#34;sts:TagSession&#34; ] } ] } 其次，需要在 EKS 集群内安装 eks-pod-identity-agent 组件（支持通过控制台安装）。 aws eks create-addon \\ --cluster-name &lt;CLUSTER_NAME&gt; \\ --addon-name eks-pod-identity-agent \\ --addon-version v1.0.0-eksbuild.1 然后，需要配置应用 Pod 所使用的 Service Account 与 AWS IAM 角色之间的关联关系， 允许使用该 Service Account 的应用扮演特定的 IAM 角色（支持通过控制台配置）。 aws eks create-pod-identity-association \\ --cluster-name &lt;CLUSTER_NAME&gt; \\ --namespace &lt;NAMESPACE&gt; \\ --service-account &lt;SERVICE_ACCOUNT_NAME&gt; \\ --role-arn &lt;IAM_ROLE_ARN&gt; 最后，应用程序需要更新使用最新的支持 EKS Pod Identity 特性的 AWS SDK ， 并且代码里需要使用 SDK 提供的 默认凭证搜索逻辑 或者显式调用 EKS Pod Identity 依赖的 Container credential provider 。 工作流程 EKS Pod Identity 特性的工作流程如下。 当用户/Controller 向 apiserver 提交 Pod 时，会触发 eks-pod-identity-webhook 的 mutating webhook 流程。 eks-pod-identity-webhook 的 mutating webhook 流程会为 Pod 挂载 service account oidc token 文件以及配置环境变量 (AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE, AWS_CONTAINER_CREDENTIALS_FULL_URI ）。 - env: - name: AWS_STS_REGIONAL_ENDPOINTS value: regional - name: AWS_DEFAULT_REGION value: us-west-2 - name: AWS_REGION value: us-west-2 - name: AWS_CONTAINER_CREDENTIALS_FULL_URI value: http://169.254.170.23/v1/credentials - name: AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE value: /var/run/secrets/pods.eks.amazonaws.com/serviceaccount/eks-pod-identity-token volumeMounts: - mountPath: /var/run/secrets/pods.eks.amazonaws.com/serviceaccount name: eks-pod-identity-token readOnly: true volumes: - name: eks-pod-identity-token projected: defaultMode: 420 sources: - serviceAccountToken: audience: pods.eks.amazonaws.com expirationSeconds: 86400 path: eks-pod-identity-token Pod 容器内的应用使用的 AWS SDK 将使用通过环境变量 AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE 获取的 service account oidc token 访问环境变量 AWS_CONTAINER_CREDENTIALS_FULL_URI 指向的地址 （http://169.254.170.23/v1/credentials）获取 AWS sts token。 $ curl $AWS_CONTAINER_CREDENTIALS_FULL_URI -H &#34;Authorization: $(cat $AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE)&#34; 2&gt;/dev/null |jq { &#34;AccessKeyId&#34;: &#34;ASXXXXXXXXXXXXX&#34;, &#34;SecretAccessKey&#34;: &#34;+j5XXXXXXXX&#34;, &#34;Token&#34;: &#34;IQoJb3JpXXXXXXX&#34;, &#34;AccountId&#34;: &#34;5XXXXXXXXXXX&#34;, &#34;Expiration&#34;: &#34;2023-12-03T13:13:26Z&#34; } AWS_CONTAINER_CREDENTIALS_FULL_URI 指向的其实是 Pod 所在节点上部署的 eks-pod-identity-agent 组件 Pod 所暴露的服务。 eks-pod-identity-agent 收到请求后，将使用传递过来的 oidc token 访问 EKS 新增的 AssumeRoleForPodIdentity API 获取所需的 AWS sts token，然后将获取到的 sts token 返回给客户端。 $ aws eks-auth assume-role-for-pod-identity --cluster-name test --token $(cat $AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE) |jq { &#34;subject&#34;: { &#34;namespace&#34;: &#34;default&#34;, &#34;serviceAccount&#34;: &#34;default&#34; }, &#34;audience&#34;: &#34;pods.eks.amazonaws.com&#34;, &#34;podIdentityAssociation&#34;: { &#34;associationArn&#34;: &#34;arn:aws:eks:us-west-2:5XXXXXXXXXXX:podidentityassociation/test/a-6aaXXXXXXXXXXXXXX&#34;, &#34;associationId&#34;: &#34;a-6aaXXXXXXXXXXXXXX&#34; }, &#34;assumedRoleUser&#34;: { &#34;arn&#34;: &#34;arn:aws:sts::5XXXXXXXXXXX:assumed-role/test-eks-pod-identity/eks-test-XXXXXXXXXXXXXXXX&#34;, &#34;assumeRoleId&#34;: &#34;ARXXXXXXXXXXXXXXXXXXX:eks-test-XXXXXXXXXXXXXXXXXX&#34; }, &#34;credentials&#34;: { &#34;sessionToken&#34;: &#34;IQoXXXXX&#34;, &#34;secretAccessKey&#34;: &#34;nR4XXXXXX&#34;, &#34;accessKeyId&#34;: &#34;ASXXXXXXXXXXXXXXXXXX&#34;, &#34;expiration&#34;: &#34;2023-12-03T13:37:22+00:00&#34; } } 应用调用的 AWS SDK 使用获取到的 sts token 访问应用所需的 AWS 云产品 API。 这个流程中有几个关键的组件和信息需要重点关注，下面将逐个说明。 eks-pod-identity-webhook EKS Pod Identity 功能直接复用 IRSA 功能所依赖的 eks-pod-identity-webhook 组件， 使用这个组件实现为 Pod 自动注入所需的 oidc token 配置以及环境变量配置。并且， EKS 集群控制面中部署的 eks-pod-identity-webhook 为 EKS Pod Identity 做了特殊优化， 只有当对应的 service account 未包含 IRSA 相关配置，并且存在与之关联 的 IAM 角色信息（通过前面的使用方法中介绍的方法关联角色）时，才会为 Pod 注入 EKS Pod Identity 相关配置。 eks-pod-identity-webhook 为了支持 EKS Pod Identity 所作的修改可以参考开源实现（开源实现缺少判断存在关联角色的逻辑） 对应的 PR #189 以及 #196 。 eks-pod-identity-agent 官方推荐的 EKS Pod Identity 实现方案依赖在集群里安装名为 eks-pod-identity-agent 的组件。该组件的工作负载 YAML 如下。 apiVersion: apps/v1 kind: DaemonSet metadata: annotations: deprecated.daemonset.template.generation: &#34;1&#34; creationTimestamp: &#34;2023-12-03T04:24:15Z&#34; generation: 1 labels: app.kubernetes.io/instance: eks-pod-identity-agent app.kubernetes.io/managed-by: Helm app.kubernetes.io/name: eks-pod-identity-agent app.kubernetes.io/version: 0.0.25 helm.sh/chart: eks-pod-identity-agent-1.0.0 name: eks-pod-identity-agent namespace: kube-system resourceVersion: &#34;8978&#34; uid: 08c03e91-69d4-460b-8acb-b9f9f546dd87 spec: revisionHistoryLimit: 10 selector: matchLabels: app.kubernetes.io/instance: eks-pod-identity-agent app.kubernetes.io/name: eks-pod-identity-agent template: metadata: creationTimestamp: null labels: app.kubernetes.io/instance: eks-pod-identity-agent app.kubernetes.io/name: eks-pod-identity-agent spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/os operator: In values: - linux - key: kubernetes.io/arch operator: In values: - amd64 - arm64 - key: eks.amazonaws.com/compute-type operator: NotIn values: - fargate containers: - args: - --port - &#34;80&#34; - --cluster-name - test - --probe-port - &#34;2703&#34; command: - /go-runner - /eks-pod-identity-agent - server env: - name: AWS_REGION value: us-west-2 image: 602401143452.dkr.ecr.us-west-2.amazonaws.com/eks/eks-pod-identity-agent:0.0.25 imagePullPolicy: Always livenessProbe: failureThreshold: 3 httpGet: host: localhost path: /healthz port: probes-port scheme: HTTP initialDelaySeconds: 30 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 10 name: eks-pod-identity-agent ports: - containerPort: 80 name: proxy protocol: TCP - containerPort: 2703 name: probes-port protocol: TCP readinessProbe: failureThreshold: 30 httpGet: host: localhost path: /readyz port: probes-port scheme: HTTP initialDelaySeconds: 1 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 10 resources: {} securityContext: capabilities: add: - CAP_NET_BIND_SERVICE terminationMessagePath: /dev/termination-log terminationMessagePolicy: File dnsPolicy: ClusterFirst hostNetwork: true initContainers: - command: - /go-runner - /eks-pod-identity-agent - initialize image: 602401143452.dkr.ecr.us-west-2.amazonaws.com/eks/eks-pod-identity-agent:0.0.25 imagePullPolicy: Always name: eks-pod-identity-agent-init resources: {} securityContext: privileged: true terminationMessagePath: /dev/termination-log terminationMessagePolicy: File priorityClassName: system-node-critical restartPolicy: Always schedulerName: default-scheduler securityContext: {} terminationGracePeriodSeconds: 30 updateStrategy: rollingUpdate: maxSurge: 0 maxUnavailable: 10% type: RollingUpdate status: currentNumberScheduled: 1 desiredNumberScheduled: 1 numberAvailable: 1 numberMisscheduled: 0 numberReady: 1 observedGeneration: 1 eks-pod-identity-agent 组件具有如下特点： 依赖节点 IAM 角色被授予如下 IAM 权限策略。 { &#34;Version&#34;: &#34;2012-10-17&#34;, &#34;Statement&#34;: [ { &#34;Effect&#34;: &#34;Allow&#34;, &#34;Action&#34;: [ &#34;eks-auth:AssumeRoleForPodIdentity&#34;, ], &#34;Resource&#34;: &#34;*&#34; } ] } 组件 Pod 使用 hostNetwork 。 组件内的服务将监听 80 和 2703 端口。 其中 80 端口监听的 IPv4 地址为 169.254.170.23, IPv6 地址为 [fd00:ec2::23] 。 $ ss -anltp |grep eks-pod LISTEN 0 4096 127.0.0.1:2703 0.0.0.0:* users:((&#34;eks-pod-identit&#34;,pid=3798,fd=5)) LISTEN 0 4096 169.254.170.23:80 0.0.0.0:* users:((&#34;eks-pod-identit&#34;,pid=3798,fd=4)) LISTEN 0 4096 [fd00:ec2::23]:80 [::]:* users:((&#34;eks-pod-identit&#34;,pid=3798,fd=3)) 组件将通过 init 容器在节点上创建一个 IPv4 地址为 169.254.170.23, IPv6 地址为 [fd00:ec2::23] 的网络接口 pod-id-link0 。 pod-id-link0: flags=195&lt;UP,BROADCAST,RUNNING,NOARP&gt; mtu 1500 inet 169.254.170.23 netmask 255.255.255.255 broadcast 0.0.0.0 inet6 fe80::2078:53ff:fe2f:c723 prefixlen 64 scopeid 0x20&lt;link&gt; inet6 fd00:ec2::23 prefixlen 128 scopeid 0x0&lt;global&gt; ether 22:78:53:2f:c7:23 txqueuelen 1000 (Ethernet) RX packets 0 bytes 0 (0.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 10 bytes 700 (700.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 init 容器还会设置下面这样的的路由规则，确保在本机处理发往 169.254.170.23 的流量。 169.254.170.23 dev pod-id-link0 AssumeRoleForPodIdentity EKS 提供了一个新的 API AssumeRoleForPodIdentity ， 用于使用 service account oidc token 获取扮演 service account 关联 IAM 角色的 sts token。 service account oidc token 中的 payload 的内容示例如下。 { &#34;aud&#34;: [ &#34;pods.eks.amazonaws.com&#34; ], &#34;exp&#34;: 1701672885, &#34;iat&#34;: 1701586485, &#34;iss&#34;: &#34;https://oidc.eks.us-west-2.amazonaws.com/id/DA16E524AXXXXXX&#34;, &#34;kubernetes.io&#34;: { &#34;namespace&#34;: &#34;default&#34;, &#34;pod&#34;: { &#34;name&#34;: &#34;test-596475c6d5-xgvml&#34;, &#34;uid&#34;: &#34;924e66b2-841e-4969-9fa7-a19f3f6f1029&#34; }, &#34;serviceaccount&#34;: { &#34;name&#34;: &#34;default&#34;, &#34;uid&#34;: &#34;eca98cb1-ca2e-469b-8f9d-2be9f5a3354f&#34; } }, &#34;nbf&#34;: 1701586485, &#34;sub&#34;: &#34;system:serviceaccount:default:default&#34; } 可以看到这个 oidc token 跟 IRSA 方案中的 oidc token 相比，除了 aud 不一样外（IRSA 中是 sts.amazonaws.com ）， 其他内容都是一样的。 因此，据我猜测，AssumeRoleForPodIdentity 的后端逻辑可能类似下面这样： 首先，基于 oidc 协议解析和校验客户端传递过来的 oidc token 的有效性和合法性。 然后，基于用户配置的 service account 与 IAM 角色关联关系，获取需要扮演的角色信息。 最后，调用 sts API 扮演对应角色，获取客户端所需的 sts token。 servce account 关联 IAM 角色 为了简化用户为 service account 关联 IAM 角色的操作，EKS 新增了一组用于管理 service account 与 IAM 角色关联关系的 API。 同时还增加了对应的 EKS 控制台操作页面，并且关联关系都存储在 EKS 侧，并没有去修改角色的信任策略。 CreatePodIdentityAssociation ：为 service account 关联角色。 DescribePodIdentityAssociation : 查看单条角色关联记录的详情。 UpdatePodIdentityAssociation ：修改 service account 关联的角色信息。 DeletePodIdentityAssociation ：删除一条角色关联记录。 ListPodIdentityAssociations ：获取当前存在的角色关联记录。 权限控制 在 IRSA 方案中，我们需要在 IAM 角色的信任策略中配置允许的集群 oidc provider 以及 service account 信息。 但是，在 EKS Pod Identity 方案中，我们不再需要修改角色的信任策略，只需要使用前面介绍的方法使用 EKS 控制台或者 EKS API 即可完成控制角色能被哪些集群的哪些 service account 使用，这些关联关系存储在 EKS 侧，不再需要频繁的更新角色的信任策略。 通过这种方式， EKS Pod Identity 解决了 IRSA 中因为角色信任策略的内容大小限制导致一个角色只能被有限的几个 service account 关联使用的问题 （详见 #148 ）， 在 EKS Pod Identity 方案中，一个角色可以与不限数量的 service account 进行关联。 attribute-based access control (ABAC) EKS Pod Identity 方案还引入了新的基于属性的访问控制能力（attribute-based access control (ABAC)）： 通过 EKS Pod Identity 方案获取到的 sts token 默认都携带了集群信息、命名空间以及 service account 等 tag 属性， 用户可以基于 IAM 提供的 tag 鉴权 特性， 在为角色配置权限策略时，实现基于属性的访问控制能力。 通过 EKS Pod Identity 获取的 sts token 默认携带了如下 tag ： eks-cluster-arn ：当前集群的 ARN。 eks-cluster-name ：当前集群的名称。 kubernetes-namespace: service account 所在的命名空间名称。 kubernetes-service-account ：service account 的名称。 kubernetes-pod-name ：使用 service account 的 pod 的名称。 kubernetes-pod-uid ：使用 service account 的 pod 的 uid。 &#34;tags&#34;: [ { &#34;key&#34;: &#34;eks-cluster-arn&#34;, &#34;value&#34;: &#34;arn:aws:eks:us-west-2:5XXXXXXXXXXX:cluster/test&#34; }, { &#34;key&#34;: &#34;eks-cluster-name&#34;, &#34;value&#34;: &#34;test&#34; }, { &#34;key&#34;: &#34;kubernetes-namespace&#34;, &#34;value&#34;: &#34;default&#34; }, { &#34;key&#34;: &#34;kubernetes-service-account&#34;, &#34;value&#34;: &#34;default&#34; }, { &#34;key&#34;: &#34;kubernetes-pod-name&#34;, &#34;value&#34;: &#34;test-596475c6d5-xgvml&#34; }, { &#34;key&#34;: &#34;kubernetes-pod-uid&#34;, &#34;value&#34;: &#34;924e66b2-841e-4969-9fa7-a19f3f6f1029&#34; } ] 我们在定义角色权限策略的时候，可以通过 ${aws:PrincipalTag/&lt;tag-key&gt;} 的方式 在权限策略的 Condition 配置中表示凭证属性中包含的特定 tag 的值。 { &#34;Version&#34;: &#34;2012-10-17&#34;, &#34;Statement&#34;: [ { &#34;Effect&#34;: &#34;Allow&#34;, &#34;Action&#34;: [ &#34;s3:GetObject&#34;, &#34;s3:GetObjectTagging&#34; ], &#34;Resource&#34;: &#34;*&#34;, &#34;Condition&#34;: { &#34;StringEquals&#34;: { &#34;s3:ExistingObjectTag/eks-cluster-name&#34;: &#34;${aws:PrincipalTag/eks-cluster-name}&#34; }, &#34;StringEqualsIfExists&#34;: { &#34;aws:ResourceTag/kubernetes-namespace&#34;: &#34;s3-demo&#34;, &#34;aws:Resourcelag/kubernetes-service-account&#34;: &#34;${aws:PrincipalTag/kubernetes-service-account}&#34; } } } ] } 通过上面这个示例权限策略，我们可以对通过 EKS Pod Identity 特性扮演角色获取的 sts token 的权限做如下限制： 只允许访问存在名为 eks-cluster-name 的 tag 的 s3 object ，并且 tag 的值必须是当前 sts token 关联集群的名称。 如果 s3 object 存在名为 kubernetes-namespace 的 tag，只允许访问这个 tag 的值是 s3-demo 的 object。 如果 s3 object 存在名为 kubernetes-service-account 的 tag，只允许访问这个 tag 的值是当前 sts token 关联的 service account 名称的 object。 与 IRSA 的区别 根据上面介绍的信息，我们可以比较一下 EKS Pod Identity 与 IRSA 特性的区别，它们主要的区别如下： 比较项 EKS Pod Identity IRSA 节点 IAM 角色增加额外权限 需要增加 eks-auth:AssumeRoleForPodIdentity 权限 不需要 创建 IAM oidc provider 不需要 需要为每个集群创建一个 oidc provider service account 关联角色 通过 EKS API/控制台 配置 service account annotation + 修改角色信任策略 一个角色可以关联的 service account 数量 无限制 角色信任策略有 4096 个字符限制， 最多关联 10 个左右 service account 或 集群 一个 service account 可以关联的角色数量 一个 无限制 角色信任策略修改次数 只需修改一次 确保信任 pods.eks.amazonaws.com 以及包含所需的 action 需要为每个关联的集群修改至少一次 基于 service account 相关属性进行访问控制 通过 ABAC 进行支持 不支持 集群类型 只支持 EKS 集群，不支持 AWS Outposts、 不支持 EKS Anywhere、AWS Fargate (Fargate)、自建集群 仅不支持 AWS Outposts 数据面依赖 kubelet + eks-pod-identity-agent kublet 稳定性风险 依赖集群控制面和数据面的稳定性 + EKS API； 同时还依赖 aks-pod-identity-agent 的稳定性； 应用 pod 如果先于 eks-pod-identity-agent pod 启动/就绪会出现短暂的无法获取到 sts token 的问题 （比如，同样配置了 hostNetwork 的 pod 在 自动伸缩场景可能会遇到这种情况，以及不建议 CNI、CSI 这些常常会先于 agent pod 启动的组件使用） 依赖集群控制面和数据面的稳定性 + STS API 参考资料 Amazon EKS Pod Identity simplifies IAM permissions for applications on Amazon EKS clusters | AWS News Blog Introducing fine-grained IAM roles for service accounts | AWS Open Source Blog EKS Pod Identities - Amazon EKS aws/amazon-eks-pod-identity-webhook: Amazon EKS Pod Identity Webhook Define permissions for EKS Pod Identities to assume roles based on tags - Amazon EKS Controlling access to and for IAM users and roles using tags - AWS Identity and Access Management IAM JSON policy elements: Condition - AWS Identity and Access Management Deep dive into the new Amazon EKS Pod Identity feature | Datadog Security Labs",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https://mozillazg.com/2023/12/security-deep-dive-into-aws-eks-pod-identity-feature.html"
        },
        "datePublished": "2023-12-03"
    }
    </script>

</head>
<body>

<div class="navbar" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://mozillazg.com/" class="navbar-brand">
mozillazg's Blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="https://mozillazg.com/feeds/all.atom.xml">Feed</a></li>
                    <li><a href="/2014/10/pages/about-me.html">About</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://mozillazg.com/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
    <section id="content" class="yue">
        <article>
            <header class="text-center">
                <h1>
                    <a href="https://mozillazg.com/2023/12/security-deep-dive-into-aws-eks-pod-identity-feature.html"
                       rel="bookmark"
                       title="Permalink to Amazon EKS Pod Identity 新特性探索">
                        Amazon EKS Pod Identity 新特性探索
                    </a>
                </h1>
                <p class="published">
                    <time datetime="2023-12-03T00:00:00+00:00">
                    2023-12-03
                    </time>
                </p>
            </header>
            <div class="entry-content">
                <div class="well-sm article-info">
<footer class="post-info">
        <a href="https://mozillazg.com/category/security.html">security</a>


<span class="label label-default hide">Tags</span>
	<a href="https://mozillazg.com/tag/kubernetes.html">kubernetes</a>
        /
	<a href="https://mozillazg.com/tag/k8s.html">k8s</a>
        /
	<a href="https://mozillazg.com/tag/aws.html">aws</a>
        /
	<a href="https://mozillazg.com/tag/eks.html">eks</a>
        /
	<a href="https://mozillazg.com/tag/pod-identity.html">pod-identity</a>
        /
	<a href="https://mozillazg.com/tag/irsa.html">irsa</a>
        /
	<a href="https://mozillazg.com/tag/cloud-security.html">cloud-security</a>
    
</footer><!-- /.post-info -->                </div>
                <div class="js-toc"></div>
                <div>
                <p>本文将简单探索一下 AWS 本周新发布的名为 <a class="reference external" href="https://aws.amazon.com/blogs/aws/amazon-eks-pod-identity-simplifies-iam-permissions-for-applications-on-amazon-eks-clusters/">Amazon EKS Pod Identity</a> 的 EKS 安全特性。</p>
<div class="section" id="section-1">
<h2 id="hidsection-1">功能介绍<a class="headerlink" href="#hidsection-1" title="Permalink to this headline">¶</a></h2>
<p>Amazon EKS Pod Identity 是 AWS 对 EKS 原有的 <a class="reference external" href="https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/">IAM roles for service accounts (IRSA)</a>  功能的补充，通过新增的 EKS Pod Identity 功能，用户可以用更简便的方式实现为 Pod 安全的授予 AWS API 访问权限，
并且所有的配置管理操作都可以通过 AWS API 或者控制台完成。</p>
</div>
<div class="section" id="section-2">
<h2 id="hidsection-2">使用方法<a class="headerlink" href="#hidsection-2" title="Permalink to this headline">¶</a></h2>
<p>用户只需执行如下操作, 即可基于 EKS Pod Identity 特性实现为 Pod 内应用安全的授予 AWS API 访问权限。</p>
<ol class="arabic simple">
<li>首先，需要创建一个 IAM 角色，确保该角色信任 <tt class="docutils literal">pods.eks.amazonaws.com</tt> 。角色信任策略示例如下。</li>
</ol>
<div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;Statement&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;Principal&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;Service&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pods.eks.amazonaws.com&quot;</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;sts:AssumeRole&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;sts:TagSession&quot;</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
<ol class="arabic simple" start="2">
<li>其次，需要在 EKS 集群内安装 <a class="reference external" href="https://docs.aws.amazon.com/eks/latest/userguide/pod-id-agent-setup.html">eks-pod-identity-agent</a>
组件（支持通过控制台安装）。</li>
</ol>
<div class="highlight"><pre><span></span>aws<span class="w"> </span>eks<span class="w"> </span>create-addon<span class="w"> </span><span class="se">\</span>
--cluster-name<span class="w"> </span>&lt;CLUSTER_NAME&gt;<span class="w"> </span><span class="se">\</span>
--addon-name<span class="w"> </span>eks-pod-identity-agent<span class="w"> </span><span class="se">\</span>
--addon-version<span class="w"> </span>v1.0.0-eksbuild.1
</pre></div>
<ol class="arabic simple" start="3">
<li>然后，需要配置应用 Pod 所使用的 Service Account 与 AWS IAM 角色之间的关联关系，
允许使用该 Service Account 的应用扮演特定的 IAM 角色（支持通过控制台配置）。</li>
</ol>
<div class="highlight"><pre><span></span>aws<span class="w"> </span>eks<span class="w"> </span>create-pod-identity-association<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--cluster-name<span class="w"> </span>&lt;CLUSTER_NAME&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--namespace<span class="w"> </span>&lt;NAMESPACE&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--service-account<span class="w"> </span>&lt;SERVICE_ACCOUNT_NAME&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--role-arn<span class="w"> </span>&lt;IAM_ROLE_ARN&gt;
</pre></div>
<ol class="arabic simple" start="4">
<li>最后，应用程序需要更新使用最新的支持 EKS Pod Identity 特性的 <a class="reference external" href="https://docs.aws.amazon.com/eks/latest/userguide/pod-id-minimum-sdk.html">AWS SDK</a> ，
并且代码里需要使用 SDK 提供的 <a class="reference external" href="https://docs.aws.amazon.com/sdkref/latest/guide/standardized-credentials.html#credentialProviderChain">默认凭证搜索逻辑</a>
或者显式调用 EKS Pod Identity 依赖的 <a class="reference external" href="https://docs.aws.amazon.com/sdkref/latest/guide/feature-container-credentials.html">Container credential provider</a> 。</li>
</ol>
</div>
<div class="section" id="section-3">
<h2 id="hidsection-3">工作流程<a class="headerlink" href="#hidsection-3" title="Permalink to this headline">¶</a></h2>
<p>EKS Pod Identity 特性的工作流程如下。</p>
<p><img alt="image" src="/static/images/security/eks-pod-identity.png" /></p>
<ol class="arabic simple">
<li>当用户/Controller 向 apiserver 提交 Pod 时，会触发 <a class="reference external" href="https://github.com/aws/amazon-eks-pod-identity-webhook">eks-pod-identity-webhook</a> 的 mutating webhook 流程。</li>
<li>eks-pod-identity-webhook 的 mutating webhook 流程会为 Pod 挂载 service account oidc token 文件以及配置环境变量
(<tt class="docutils literal">AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE</tt>, <tt class="docutils literal">AWS_CONTAINER_CREDENTIALS_FULL_URI</tt> ）。</li>
</ol>
<div class="highlight"><pre><span></span><span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">env</span><span class="p">:</span>
<span class="w"> </span><span class="w w-Error"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS_STS_REGIONAL_ENDPOINTS</span>
<span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">regional</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS_DEFAULT_REGION</span>
<span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">us-west-2</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS_REGION</span>
<span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">us-west-2</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS_CONTAINER_CREDENTIALS_FULL_URI</span>
<span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://169.254.170.23/v1/credentials</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE</span>
<span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/secrets/pods.eks.amazonaws.com/serviceaccount/eks-pod-identity-token</span>
<span class="w">  </span><span class="nt">volumeMounts</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/secrets/pods.eks.amazonaws.com/serviceaccount</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eks-pod-identity-token</span>
<span class="w">    </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">volumes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eks-pod-identity-token</span>
<span class="w">  </span><span class="nt">projected</span><span class="p">:</span>
<span class="w">    </span><span class="nt">defaultMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">420</span>
<span class="w">    </span><span class="nt">sources</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">serviceAccountToken</span><span class="p">:</span>
<span class="w">        </span><span class="nt">audience</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pods.eks.amazonaws.com</span>
<span class="w">        </span><span class="nt">expirationSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">86400</span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eks-pod-identity-token</span>
</pre></div>
<ol class="arabic simple" start="3">
<li>Pod 容器内的应用使用的 AWS SDK 将使用通过环境变量 <tt class="docutils literal">AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE</tt> 获取的
service account oidc token 访问环境变量 <tt class="docutils literal">AWS_CONTAINER_CREDENTIALS_FULL_URI</tt> 指向的地址
（<tt class="docutils literal"><span class="pre">http://169.254.170.23/v1/credentials</span></tt>）获取 AWS sts token。</li>
</ol>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$ curl $AWS_CONTAINER_CREDENTIALS_FULL_URI -H &quot;Authorization</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$(cat $AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE)&quot; 2&gt;/dev/null |jq</span>
<span class="p p-Indicator">{</span>
<span class="w">  </span><span class="s">&quot;AccessKeyId&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;ASXXXXXXXXXXXXX&quot;</span><span class="p p-Indicator">,</span>
<span class="w">  </span><span class="s">&quot;SecretAccessKey&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;+j5XXXXXXXX&quot;</span><span class="p p-Indicator">,</span>
<span class="w">  </span><span class="s">&quot;Token&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;IQoJb3JpXXXXXXX&quot;</span><span class="p p-Indicator">,</span>
<span class="w">  </span><span class="s">&quot;AccountId&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;5XXXXXXXXXXX&quot;</span><span class="p p-Indicator">,</span>
<span class="w">  </span><span class="s">&quot;Expiration&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;2023-12-03T13:13:26Z&quot;</span>
<span class="p p-Indicator">}</span>
</pre></div>
<ol class="arabic simple" start="4">
<li><tt class="docutils literal">AWS_CONTAINER_CREDENTIALS_FULL_URI</tt> 指向的其实是 Pod 所在节点上部署的 eks-pod-identity-agent 组件 Pod 所暴露的服务。
eks-pod-identity-agent 收到请求后，将使用传递过来的 oidc token 访问 EKS 新增的 <a class="reference external" href="https://docs.aws.amazon.com/eks/latest/APIReference/API_auth_AssumeRoleForPodIdentity.html">AssumeRoleForPodIdentity</a> API 获取所需的 AWS sts token，然后将获取到的 sts token 返回给客户端。</li>
</ol>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$ aws eks-auth assume-role-for-pod-identity --cluster-name test --token $(cat $AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE) |jq</span>
<span class="l l-Scalar l-Scalar-Plain">{</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">&quot;subject&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">    </span><span class="s">&quot;namespace&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="p p-Indicator">,</span>
<span class="w">    </span><span class="s">&quot;serviceAccount&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;default&quot;</span>
<span class="w">  </span><span class="p p-Indicator">}</span><span class="err">,</span>
<span class="w">  </span><span class="s">&quot;audience&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;pods.eks.amazonaws.com&quot;</span><span class="err">,</span>
<span class="w">  </span><span class="s">&quot;podIdentityAssociation&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">    </span><span class="s">&quot;associationArn&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;arn:aws:eks:us-west-2:5XXXXXXXXXXX:podidentityassociation/test/a-6aaXXXXXXXXXXXXXX&quot;</span><span class="p p-Indicator">,</span>
<span class="w">    </span><span class="s">&quot;associationId&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;a-6aaXXXXXXXXXXXXXX&quot;</span>
<span class="w">  </span><span class="p p-Indicator">}</span><span class="err">,</span>
<span class="w">  </span><span class="s">&quot;assumedRoleUser&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">    </span><span class="s">&quot;arn&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;arn:aws:sts::5XXXXXXXXXXX:assumed-role/test-eks-pod-identity/eks-test-XXXXXXXXXXXXXXXX&quot;</span><span class="p p-Indicator">,</span>
<span class="w">    </span><span class="s">&quot;assumeRoleId&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;ARXXXXXXXXXXXXXXXXXXX:eks-test-XXXXXXXXXXXXXXXXXX&quot;</span>
<span class="w">  </span><span class="p p-Indicator">}</span><span class="err">,</span>
<span class="w">  </span><span class="s">&quot;credentials&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">    </span><span class="s">&quot;sessionToken&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;IQoXXXXX&quot;</span><span class="p p-Indicator">,</span>
<span class="w">    </span><span class="s">&quot;secretAccessKey&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;nR4XXXXXX&quot;</span><span class="p p-Indicator">,</span>
<span class="w">    </span><span class="s">&quot;accessKeyId&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;ASXXXXXXXXXXXXXXXXXX&quot;</span><span class="p p-Indicator">,</span>
<span class="w">    </span><span class="s">&quot;expiration&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;2023-12-03T13:37:22+00:00&quot;</span>
<span class="w">  </span><span class="p p-Indicator">}</span>
<span class="err">}</span>
</pre></div>
<ol class="arabic simple" start="5">
<li>应用调用的 AWS SDK 使用获取到的 sts token 访问应用所需的 AWS 云产品 API。</li>
</ol>
<p>这个流程中有几个关键的组件和信息需要重点关注，下面将逐个说明。</p>
</div>
<div class="section" id="eks-pod-identity-webhook">
<h2 id="hideks-pod-identity-webhook">eks-pod-identity-webhook<a class="headerlink" href="#hideks-pod-identity-webhook" title="Permalink to this headline">¶</a></h2>
<p>EKS Pod Identity 功能直接复用 IRSA 功能所依赖的 <a class="reference external" href="https://github.com/aws/amazon-eks-pod-identity-webhook">eks-pod-identity-webhook</a> 组件，
使用这个组件实现为 Pod 自动注入所需的 oidc token 配置以及环境变量配置。并且，
EKS 集群控制面中部署的 eks-pod-identity-webhook 为 EKS Pod Identity 做了特殊优化，
只有当对应的 service account 未包含 IRSA 相关配置，并且存在与之关联
的 IAM 角色信息（通过前面的使用方法中介绍的方法关联角色）时，才会为 Pod 注入 EKS Pod Identity 相关配置。</p>
<p>eks-pod-identity-webhook 为了支持 EKS Pod Identity 所作的修改可以参考开源实现（开源实现缺少判断存在关联角色的逻辑）
对应的 PR <a class="reference external" href="https://github.com/aws/amazon-eks-pod-identity-webhook/pull/189">#189</a> 以及
<a class="reference external" href="https://github.com/aws/amazon-eks-pod-identity-webhook/pull/196">#196</a> 。</p>
</div>
<div class="section" id="eks-pod-identity-agent">
<h2 id="hideks-pod-identity-agent">eks-pod-identity-agent<a class="headerlink" href="#hideks-pod-identity-agent" title="Permalink to this headline">¶</a></h2>
<p>官方推荐的 EKS Pod Identity 实现方案依赖在集群里安装名为 <a class="reference external" href="https://docs.aws.amazon.com/eks/latest/userguide/pod-id-agent-setup.html">eks-pod-identity-agent</a>
的组件。该组件的工作负载 YAML 如下。</p>
<div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">deprecated.daemonset.template.generation</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2023-12-03T04:24:15Z&quot;</span>
<span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app.kubernetes.io/instance</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eks-pod-identity-agent</span>
<span class="w">    </span><span class="nt">app.kubernetes.io/managed-by</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Helm</span>
<span class="w">    </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eks-pod-identity-agent</span>
<span class="w">    </span><span class="nt">app.kubernetes.io/version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0.25</span>
<span class="w">    </span><span class="nt">helm.sh/chart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eks-pod-identity-agent-1.0.0</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eks-pod-identity-agent</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;8978&quot;</span>
<span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">08c03e91-69d4-460b-8acb-b9f9f546dd87</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app.kubernetes.io/instance</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eks-pod-identity-agent</span>
<span class="w">      </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eks-pod-identity-agent</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app.kubernetes.io/instance</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eks-pod-identity-agent</span>
<span class="w">        </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eks-pod-identity-agent</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">affinity</span><span class="p">:</span>
<span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span>
<span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span>
<span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/os</span>
<span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">                </span><span class="nt">values</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/arch</span>
<span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">                </span><span class="nt">values</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">amd64</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arm64</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eks.amazonaws.com/compute-type</span>
<span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NotIn</span>
<span class="w">                </span><span class="nt">values</span><span class="p">:</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fargate</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">args</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--port</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--cluster-name</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--probe-port</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;2703&quot;</span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/go-runner</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/eks-pod-identity-agent</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS_REGION</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">us-west-2</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">602401143452.dkr.ecr.us-west-2.amazonaws.com/eks/eks-pod-identity-agent:0.0.25</span>
<span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<span class="w">        </span><span class="nt">livenessProbe</span><span class="p">:</span>
<span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">            </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/healthz</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">probes-port</span>
<span class="w">            </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HTTP</span>
<span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eks-pod-identity-agent</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">proxy</span>
<span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2703</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">probes-port</span>
<span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span>
<span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">            </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/readyz</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">probes-port</span>
<span class="w">            </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HTTP</span>
<span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span>
<span class="w">          </span><span class="nt">capabilities</span><span class="p">:</span>
<span class="w">            </span><span class="nt">add</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CAP_NET_BIND_SERVICE</span>
<span class="w">        </span><span class="nt">terminationMessagePath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/termination-log</span>
<span class="w">        </span><span class="nt">terminationMessagePolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">File</span>
<span class="w">      </span><span class="nt">dnsPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterFirst</span>
<span class="w">      </span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">initContainers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">command</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/go-runner</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/eks-pod-identity-agent</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">initialize</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">602401143452.dkr.ecr.us-west-2.amazonaws.com/eks/eks-pod-identity-agent:0.0.25</span>
<span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eks-pod-identity-agent-init</span>
<span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span>
<span class="w">          </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">terminationMessagePath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/termination-log</span>
<span class="w">        </span><span class="nt">terminationMessagePolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">File</span>
<span class="w">      </span><span class="nt">priorityClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system-node-critical</span>
<span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<span class="w">      </span><span class="nt">schedulerName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default-scheduler</span>
<span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="w">      </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span>
<span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10%</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
<span class="nt">status</span><span class="p">:</span>
<span class="w">  </span><span class="nt">currentNumberScheduled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">desiredNumberScheduled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">numberAvailable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">numberMisscheduled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">  </span><span class="nt">numberReady</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">observedGeneration</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</pre></div>
<p>eks-pod-identity-agent 组件具有如下特点：</p>
<ul class="simple">
<li>依赖节点 IAM 角色被授予如下 IAM 权限策略。</li>
</ul>
<div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;Version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;Statement&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">           </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
<span class="w">           </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">               </span><span class="s2">&quot;eks-auth:AssumeRoleForPodIdentity&quot;</span><span class="p">,</span>
<span class="w">           </span><span class="p">],</span>
<span class="w">           </span><span class="nt">&quot;Resource&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">   </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
<ul class="simple">
<li>组件 Pod 使用 <tt class="docutils literal">hostNetwork</tt> 。</li>
<li>组件内的服务将监听 80 和 2703 端口。</li>
<li>其中 80 端口监听的 IPv4 地址为 <tt class="docutils literal">169.254.170.23</tt>, IPv6 地址为 <tt class="docutils literal"><span class="pre">[fd00:ec2::23]</span></tt> 。</li>
</ul>
<div class="highlight"><pre><span></span>$<span class="w"> </span>ss<span class="w"> </span>-anltp<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>eks-pod
LISTEN<span class="w"> </span><span class="m">0</span><span class="w">      </span><span class="m">4096</span><span class="w">        </span><span class="m">127</span>.0.0.1:2703<span class="w">       </span><span class="m">0</span>.0.0.0:*<span class="w">    </span>users:<span class="o">((</span><span class="s2">&quot;eks-pod-identit&quot;</span>,pid<span class="o">=</span><span class="m">3798</span>,fd<span class="o">=</span><span class="m">5</span><span class="o">))</span>
LISTEN<span class="w"> </span><span class="m">0</span><span class="w">      </span><span class="m">4096</span><span class="w">   </span><span class="m">169</span>.254.170.23:80<span class="w">         </span><span class="m">0</span>.0.0.0:*<span class="w">    </span>users:<span class="o">((</span><span class="s2">&quot;eks-pod-identit&quot;</span>,pid<span class="o">=</span><span class="m">3798</span>,fd<span class="o">=</span><span class="m">4</span><span class="o">))</span>
LISTEN<span class="w"> </span><span class="m">0</span><span class="w">      </span><span class="m">4096</span><span class="w">   </span><span class="o">[</span>fd00:ec2::23<span class="o">]</span>:80<span class="w">            </span><span class="o">[</span>::<span class="o">]</span>:*<span class="w">    </span>users:<span class="o">((</span><span class="s2">&quot;eks-pod-identit&quot;</span>,pid<span class="o">=</span><span class="m">3798</span>,fd<span class="o">=</span><span class="m">3</span><span class="o">))</span>
</pre></div>
<ul class="simple">
<li>组件将通过 init 容器在节点上创建一个 IPv4 地址为 <tt class="docutils literal">169.254.170.23</tt>, IPv6 地址为 <tt class="docutils literal"><span class="pre">[fd00:ec2::23]</span></tt> 的网络接口 <tt class="docutils literal"><span class="pre">pod-id-link0</span></tt> 。</li>
</ul>
<div class="highlight"><pre><span></span>pod-id-link0:<span class="w"> </span><span class="nv">flags</span><span class="o">=</span><span class="m">195</span>&lt;UP,BROADCAST,RUNNING,NOARP&gt;<span class="w">  </span>mtu<span class="w"> </span><span class="m">1500</span>
<span class="w">        </span>inet<span class="w"> </span><span class="m">169</span>.254.170.23<span class="w">  </span>netmask<span class="w"> </span><span class="m">255</span>.255.255.255<span class="w">  </span>broadcast<span class="w"> </span><span class="m">0</span>.0.0.0
<span class="w">        </span>inet6<span class="w"> </span>fe80::2078:53ff:fe2f:c723<span class="w">  </span>prefixlen<span class="w"> </span><span class="m">64</span><span class="w">  </span>scopeid<span class="w"> </span>0x20&lt;link&gt;
<span class="w">        </span>inet6<span class="w"> </span>fd00:ec2::23<span class="w">  </span>prefixlen<span class="w"> </span><span class="m">128</span><span class="w">  </span>scopeid<span class="w"> </span>0x0&lt;global&gt;
<span class="w">        </span>ether<span class="w"> </span><span class="m">22</span>:78:53:2f:c7:23<span class="w">  </span>txqueuelen<span class="w"> </span><span class="m">1000</span><span class="w">  </span><span class="o">(</span>Ethernet<span class="o">)</span>
<span class="w">        </span>RX<span class="w"> </span>packets<span class="w"> </span><span class="m">0</span><span class="w">  </span>bytes<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="m">0</span>.0<span class="w"> </span>B<span class="o">)</span>
<span class="w">        </span>RX<span class="w"> </span>errors<span class="w"> </span><span class="m">0</span><span class="w">  </span>dropped<span class="w"> </span><span class="m">0</span><span class="w">  </span>overruns<span class="w"> </span><span class="m">0</span><span class="w">  </span>frame<span class="w"> </span><span class="m">0</span>
<span class="w">        </span>TX<span class="w"> </span>packets<span class="w"> </span><span class="m">10</span><span class="w">  </span>bytes<span class="w"> </span><span class="m">700</span><span class="w"> </span><span class="o">(</span><span class="m">700</span>.0<span class="w"> </span>B<span class="o">)</span>
<span class="w">        </span>TX<span class="w"> </span>errors<span class="w"> </span><span class="m">0</span><span class="w">  </span>dropped<span class="w"> </span><span class="m">0</span><span class="w"> </span>overruns<span class="w"> </span><span class="m">0</span><span class="w">  </span>carrier<span class="w"> </span><span class="m">0</span><span class="w">  </span>collisions<span class="w"> </span><span class="m">0</span>
</pre></div>
<ul class="simple">
<li>init 容器还会设置下面这样的的路由规则，确保在本机处理发往 <tt class="docutils literal">169.254.170.23</tt> 的流量。</li>
</ul>
<div class="highlight"><pre><span></span><span class="m">169</span>.254.170.23<span class="w"> </span>dev<span class="w"> </span>pod-id-link0
</pre></div>
</div>
<div class="section" id="assumeroleforpodidentity">
<h2 id="hidassumeroleforpodidentity">AssumeRoleForPodIdentity<a class="headerlink" href="#hidassumeroleforpodidentity" title="Permalink to this headline">¶</a></h2>
<p>EKS 提供了一个新的 API  <a class="reference external" href="https://docs.aws.amazon.com/eks/latest/APIReference/API_auth_AssumeRoleForPodIdentity.html">AssumeRoleForPodIdentity</a> ，
用于使用 service account oidc token 获取扮演 service account 关联 IAM 角色的 sts token。</p>
<p>service account oidc token 中的 payload 的内容示例如下。</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;pods.eks.amazonaws.com&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1701672885</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1701586485</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://oidc.eks.us-west-2.amazonaws.com/id/DA16E524AXXXXXX&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;kubernetes.io&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;namespace&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;pod&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;test-596475c6d5-xgvml&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;924e66b2-841e-4969-9fa7-a19f3f6f1029&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;serviceaccount&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eca98cb1-ca2e-469b-8f9d-2be9f5a3354f&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;nbf&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1701586485</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system:serviceaccount:default:default&quot;</span>
<span class="p">}</span>
</pre></div>
<p>可以看到这个 oidc token 跟 IRSA 方案中的 oidc token 相比，除了 aud 不一样外（IRSA 中是 <tt class="docutils literal">sts.amazonaws.com</tt> ），
其他内容都是一样的。</p>
<p>因此，据我猜测，AssumeRoleForPodIdentity 的后端逻辑可能类似下面这样：</p>
<ol class="arabic simple">
<li>首先，基于 oidc 协议解析和校验客户端传递过来的 oidc token 的有效性和合法性。</li>
<li>然后，基于用户配置的 service account 与 IAM 角色关联关系，获取需要扮演的角色信息。</li>
<li>最后，调用 sts API 扮演对应角色，获取客户端所需的 sts token。</li>
</ol>
</div>
<div class="section" id="servce-account-iam">
<h2 id="hidservce-account-iam">servce account 关联 IAM 角色<a class="headerlink" href="#hidservce-account-iam" title="Permalink to this headline">¶</a></h2>
<p>为了简化用户为 service account 关联 IAM 角色的操作，EKS 新增了一组用于管理 service account 与 IAM 角色关联关系的 API。
同时还增加了对应的 EKS 控制台操作页面，并且关联关系都存储在 EKS 侧，并没有去修改角色的信任策略。</p>
<ul class="simple">
<li><a class="reference external" href="https://docs.aws.amazon.com/eks/latest/APIReference/API_CreatePodIdentityAssociation.html">CreatePodIdentityAssociation</a> ：为 service account 关联角色。</li>
<li><a class="reference external" href="https://docs.aws.amazon.com/eks/latest/APIReference/API_DescribePodIdentityAssociation.html">DescribePodIdentityAssociation</a> : 查看单条角色关联记录的详情。</li>
<li><a class="reference external" href="https://docs.aws.amazon.com/eks/latest/APIReference/API_UpdatePodIdentityAssociation.html">UpdatePodIdentityAssociation</a> ：修改 service account 关联的角色信息。</li>
<li><a class="reference external" href="https://docs.aws.amazon.com/eks/latest/APIReference/API_DeletePodIdentityAssociation.html">DeletePodIdentityAssociation</a> ：删除一条角色关联记录。</li>
<li><a class="reference external" href="https://docs.aws.amazon.com/eks/latest/APIReference/API_ListPodIdentityAssociations.html">ListPodIdentityAssociations</a> ：获取当前存在的角色关联记录。</li>
</ul>
</div>
<div class="section" id="section-4">
<h2 id="hidsection-4">权限控制<a class="headerlink" href="#hidsection-4" title="Permalink to this headline">¶</a></h2>
<p>在 IRSA 方案中，我们需要在 IAM 角色的信任策略中配置允许的集群 oidc provider 以及 service account 信息。
但是，在 EKS Pod Identity 方案中，我们不再需要修改角色的信任策略，只需要使用前面介绍的方法使用 EKS 控制台或者 EKS API
即可完成控制角色能被哪些集群的哪些 service account 使用，这些关联关系存储在 EKS 侧，不再需要频繁的更新角色的信任策略。</p>
<p>通过这种方式， EKS Pod Identity 解决了 IRSA 中因为角色信任策略的内容大小限制导致一个角色只能被有限的几个
service account 关联使用的问题 （详见 <a class="reference external" href="https://github.com/aws/containers-roadmap/issues/1408">#148</a> ），
在 EKS Pod Identity 方案中，一个角色可以与不限数量的 service account 进行关联。</p>
<div class="section" id="attribute-based-access-control-abac">
<h3 id="hidattribute-based-access-control-abac">attribute-based access control (ABAC)<a class="headerlink" href="#hidattribute-based-access-control-abac" title="Permalink to this headline">¶</a></h3>
<p>EKS Pod Identity 方案还引入了新的基于属性的访问控制能力（attribute-based access control (ABAC)）：
通过 EKS Pod Identity 方案获取到的 sts token 默认都携带了集群信息、命名空间以及 service account 等 tag 属性，
用户可以基于 IAM 提供的 <a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_iam-tags.html">tag 鉴权</a> 特性，
在为角色配置权限策略时，实现基于属性的访问控制能力。</p>
<p>通过 EKS Pod Identity 获取的 sts token 默认携带了如下 tag ：</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">eks-cluster-arn</span></tt> ：当前集群的 ARN。</li>
<li><tt class="docutils literal"><span class="pre">eks-cluster-name</span></tt> ：当前集群的名称。</li>
<li><tt class="docutils literal"><span class="pre">kubernetes-namespace</span></tt>: service account 所在的命名空间名称。</li>
<li><tt class="docutils literal"><span class="pre">kubernetes-service-account</span></tt> ：service account 的名称。</li>
<li><tt class="docutils literal"><span class="pre">kubernetes-pod-name</span></tt> ：使用 service account 的 pod 的名称。</li>
<li><tt class="docutils literal"><span class="pre">kubernetes-pod-uid</span></tt> ：使用 service account 的 pod 的 uid。</li>
</ul>
<div class="highlight"><pre><span></span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eks-cluster-arn&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:eks:us-west-2:5XXXXXXXXXXX:cluster/test&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eks-cluster-name&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;test&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;kubernetes-namespace&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;kubernetes-service-account&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;kubernetes-pod-name&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;test-596475c6d5-xgvml&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;kubernetes-pod-uid&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;924e66b2-841e-4969-9fa7-a19f3f6f1029&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
<p>我们在定义角色权限策略的时候，可以通过 <tt class="docutils literal"><span class="pre">${aws:PrincipalTag/&lt;tag-key&gt;}</span></tt> 的方式
在权限策略的 <tt class="docutils literal">Condition</tt> 配置中表示凭证属性中包含的特定 tag 的值。</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;Statement&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;s3:GetObject&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;s3:GetObjectTagging&quot;</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;Resource&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;Condition&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;StringEquals&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;s3:ExistingObjectTag/eks-cluster-name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;${aws:PrincipalTag/eks-cluster-name}&quot;</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="nt">&quot;StringEqualsIfExists&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;aws:ResourceTag/kubernetes-namespace&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;s3-demo&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="nt">&quot;aws:Resourcelag/kubernetes-service-account&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;${aws:PrincipalTag/kubernetes-service-account}&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
<p>通过上面这个示例权限策略，我们可以对通过 EKS Pod Identity 特性扮演角色获取的 sts token 的权限做如下限制：</p>
<ul class="simple">
<li>只允许访问存在名为 <tt class="docutils literal"><span class="pre">eks-cluster-name</span></tt> 的 tag 的 s3 object ，并且 tag 的值必须是当前 sts token 关联集群的名称。</li>
<li>如果 s3 object 存在名为 <tt class="docutils literal"><span class="pre">kubernetes-namespace</span></tt> 的 tag，只允许访问这个 tag 的值是 <tt class="docutils literal"><span class="pre">s3-demo</span></tt> 的 object。</li>
<li>如果 s3 object 存在名为 <tt class="docutils literal"><span class="pre">kubernetes-service-account</span></tt> 的 tag，只允许访问这个 tag 的值是当前 sts token 关联的 service account 名称的 object。</li>
</ul>
</div>
</div>
<div class="section" id="irsa">
<h2 id="hidirsa">与 IRSA 的区别<a class="headerlink" href="#hidirsa" title="Permalink to this headline">¶</a></h2>
<p>根据上面介绍的信息，我们可以比较一下 EKS Pod Identity 与 IRSA 特性的区别，它们主要的区别如下：</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="36%" />
<col width="35%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">比较项</th>
<th class="head">EKS Pod Identity</th>
<th class="head">IRSA</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>节点 IAM 角色增加额外权限</td>
<td>需要增加 <tt class="docutils literal"><span class="pre">eks-auth:AssumeRoleForPodIdentity</span></tt> 权限</td>
<td><strong>不需要</strong></td>
</tr>
<tr><td>创建 IAM oidc provider</td>
<td><strong>不需要</strong></td>
<td>需要为每个集群创建一个 oidc provider</td>
</tr>
<tr><td>service account 关联角色</td>
<td><strong>通过 EKS API/控制台</strong></td>
<td>配置 service account annotation + 修改角色信任策略</td>
</tr>
<tr><td rowspan="2">一个角色可以关联的 service account 数量</td>
<td rowspan="2"><strong>无限制</strong></td>
<td rowspan="2">角色信任策略有 4096 个字符限制，
最多关联 10 个左右 service account 或 集群</td>
</tr>
<tr></tr>
<tr><td>一个 service account 可以关联的角色数量</td>
<td>一个</td>
<td>无限制</td>
</tr>
<tr><td rowspan="2">角色信任策略修改次数</td>
<td rowspan="2"><strong>只需修改一次</strong> 确保信任
<tt class="docutils literal">pods.eks.amazonaws.com</tt>
以及包含所需的 action</td>
<td rowspan="2">需要为每个关联的集群修改至少一次</td>
</tr>
<tr></tr>
<tr><td>基于 service account 相关属性进行访问控制</td>
<td><strong>通过 ABAC 进行支持</strong></td>
<td>不支持</td>
</tr>
<tr><td rowspan="2">集群类型</td>
<td rowspan="2">只支持 EKS 集群，不支持 AWS Outposts、
不支持 EKS Anywhere、AWS Fargate (Fargate)、自建集群</td>
<td rowspan="2"><strong>仅不支持 AWS Outposts</strong></td>
</tr>
<tr></tr>
<tr><td>数据面依赖</td>
<td>kubelet + eks-pod-identity-agent</td>
<td><strong>kublet</strong></td>
</tr>
<tr><td rowspan="5">稳定性风险</td>
<td rowspan="5">依赖集群控制面和数据面的稳定性 + EKS API；
同时还依赖 aks-pod-identity-agent 的稳定性；
应用 pod 如果先于 eks-pod-identity-agent pod
启动/就绪会出现短暂的无法获取到 sts token 的问题
（比如，同样配置了 <tt class="docutils literal">hostNetwork</tt> 的 pod 在
自动伸缩场景可能会遇到这种情况，以及不建议 CNI、CSI
这些常常会先于 agent pod 启动的组件使用）</td>
<td rowspan="5"><strong>依赖集群控制面和数据面的稳定性 + STS API</strong></td>
</tr>
<tr></tr>
<tr></tr>
<tr></tr>
<tr></tr>
</tbody>
</table>
</div>
<div class="section" id="section-5">
<h2 id="hidsection-5">参考资料<a class="headerlink" href="#hidsection-5" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://aws.amazon.com/blogs/aws/amazon-eks-pod-identity-simplifies-iam-permissions-for-applications-on-amazon-eks-clusters/">Amazon EKS Pod Identity simplifies IAM permissions for applications on Amazon EKS clusters | AWS News Blog</a></li>
<li><a class="reference external" href="https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/">Introducing fine-grained IAM roles for service accounts | AWS Open Source Blog</a></li>
<li><a class="reference external" href="https://docs.aws.amazon.com/eks/latest/userguide/pod-identities.html">EKS Pod Identities - Amazon EKS</a></li>
<li><a class="reference external" href="https://github.com/aws/amazon-eks-pod-identity-webhook">aws/amazon-eks-pod-identity-webhook: Amazon EKS Pod Identity Webhook</a></li>
<li><a class="reference external" href="https://docs.aws.amazon.com/eks/latest/userguide/pod-id-abac.html">Define permissions for EKS Pod Identities to assume roles based on tags - Amazon EKS</a></li>
<li><a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_iam-tags.html">Controlling access to and for IAM users and roles using tags - AWS Identity and Access Management</a></li>
<li><a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_condition.html">IAM JSON policy elements: Condition - AWS Identity and Access Management</a></li>
<li><a class="reference external" href="https://securitylabs.datadoghq.com/articles/eks-pod-identity-deep-dive/">Deep dive into the new Amazon EKS Pod Identity feature | Datadog Security Labs</a></li>
</ul>
</div>

                </div>
            </div>
            <!-- /.entry-content -->
<section class="text-center">
  
<div id="donate"></div>

<div class="social-share"></div>
<div class="social-comment-note">
<p>有任何建议和想法欢迎在下方评论区留言或者加我<a href="/static/wechat.png">微信</a>交流</p>
</div>

</section>
<section class="well" id="related-posts">
    <p>Related Posts:</p>
    <ul>
        <li><a href="https://mozillazg.com/2020/07/k8s-kubernetes-client-go-list-get-create-update-patch-delete-crd-resource-without-generate-client-code-update-or-create-via-yaml.html">在不生成 crd client 代码的情况下通过 client-go 增删改查 k8s crd 资源</a></li>
        <li><a href="https://mozillazg.com/2020/06/k8s-kubernetes-kubectl-syntax-of-impersonate-as-user-or-serviceaccount-or-group.html">kubernetes 用户扮演 API</a></li>
        <li><a href="https://mozillazg.com/2020/06/kubernetes-k8s-too-many-service-environment-variables-cause-pod-container-start-bash-too-slow.html">太多的 service 信息环境变量可能会导致容器中执行 bash 命令特别的慢</a></li>
        <li><a href="https://mozillazg.com/2020/05/k8s-kubernetes-use-which-psp-when-there-are-multiple-pod-security-policies.html">当有多个可用的 Pod Security Policy 时 k8s 的 PSP 选择策略</a></li>
        <li><a href="https://mozillazg.com/2021/11/security-use-dns-srv-to-get-all-service-info.html">通过向 DNS 服务发送 SRV 查询请求获取 kubernetes 集群内所有 Service 信息</a></li>
    </ul>
</section>
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'my-github-blog'; // required: replace example with your forum shortname

                    var disqus_identifier = 'security-deep-dive-into-aws-eks-pod-identity-feature';
                var disqus_url = 'https://mozillazg.com/2023/12/security-deep-dive-into-aws-eks-pod-identity-feature.html';

            var disqus_config = function () {
                this.language = "";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2023 mozillazg
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>
            &middot; <a href="/privacy-policy.html" target="_blank">Privacy</a>              <p><small>  <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="/static/images/by-sa-80x15.png" /></a>
    &quot;<span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">mozillazg's Blog</span>&quot; by <a xmlns:cc="http://creativecommons.org/ns#" href="https://mozillazg.com" property="cc:attributionName" rel="cc:attributionURL">mozillazg</a> is
  licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/jquery@2.1.1/dist/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'my-github-blog'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-77172981-1', 'auto');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->

<!-- share.js -->
<script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script>



<script src="https://cdn.jsdelivr.net/npm/tocbot@3.0.2/dist/tocbot.min.js"></script>
<script>
$(document).ready(function(){
  tocbot.init({
    // Where to render the table of contents.
    tocSelector: '.js-toc',
    // Where to grab the headings to build the table of contents.
    contentSelector: '.entry-content',
    // Which headings to grab inside of the contentSelector element.
    headingSelector: 'h2, h3, h4,h5',
    // Headings that match the ignoreSelector will be skipped.
    ignoreSelector: '.js-toc-ignore',
    // Main class to add to links.
    linkClass: 'toc-link',
    // Extra classes to add to links.
    extraLinkClasses: '',
    // Class to add to active links,
    // the link corresponding to the top most heading on the page.
    activeLinkClass: 'is-active-link',
    // Main class to add to lists.
    listClass: 'toc-list',
    // Extra classes to add to lists.
    extraListClasses: '',
    // Class that gets added when a list should be collapsed.
    isCollapsedClass: 'is-collapsed',
    // Class that gets added when a list should be able
    // to be collapsed but isn't necessarily collpased.
    collapsibleClass: 'is-collapsible',
    // Class to add to list items.
    listItemClass: 'toc-list-item',
    // How many heading levels should not be collpased.
    // For example, number 6 will show everything since
    // there are only 6 heading levels and number 0 will collpase them all.
    // The sections that are hidden will open
    // and close as you scroll to headings within them.
    collapseDepth: 6,
    // Smooth scrolling enabled.
    smoothScroll: true,
    // Smooth scroll duration.
    smoothScrollDuration: 420,
    // Callback for scroll end (requires: smoothScroll).
    scrollEndCallback: function (e) {},
    // Headings offset between the headings and the top of the document (this is meant for minor adjustments).
    headingsOffset: 0,
    // Timeout between events firing to make sure it's
    // not too rapid (for performance reasons).
    throttleTimeout: 50,
    // Element to add the positionFixedClass to.
    positionFixedSelector: null,
    // Fixed position class to add to make sidebar fixed after scrolling
    // down past the fixedSidebarOffset.
    positionFixedClass: 'is-position-fixed',
    // fixedSidebarOffset can be any number but by default is set
    // to auto which sets the fixedSidebarOffset to the sidebar
    // element's offsetTop from the top of the document on init.
    fixedSidebarOffset: 'auto',
    // includeHtml can be set to true to include the HTML markup from the
    // heading node instead of just including the textContent.
    includeHtml: false
  });
});
</script>
</body>
</html>