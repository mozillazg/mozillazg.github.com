<!DOCTYPE html>
<html lang="en"  prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml" class="han-init">
<head>
    <title>Python: Debugging running processes by means of preset backdoors (debugging interfaces) - mozillazg's Blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- share.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css">


    <link href="https://mozillazg.com/favicon.ico" rel="icon">

<link rel="canonical" href="https://mozillazg.com/2017/12/python-debug-running-process-threading-gevent-eventlet-asyncio-via-preset-backdoor-en.html">

        <meta name="author" content="mozillazg" />
        <meta name="keywords" content="python,debug,backdoor,en-version" />
    <meta name="description" content="Preface Whenever there is a problem with a running program/service, we want to be able to locate the cause of the problem as soon as possible, to be able to reproduce the problem and to solve it. We usually think that it would be good to know what the program is doing, it would be good to reproduce the problem immediately, and it would be good to know the value of the current variables in the program. There are many ways to know this information, and this article introduces an idea and method to debug a running process by means of a preset backdoor. A common way to preset the backdoor is by defining a signal handler that performs specific, easy to debug and find problems when the corresponding signal is received. For example, the following two examples will be given: Outputs specific information for debugging when a signal is received Enable remote debugging service when signal is received Outputs specific information for debugging when a signal is received For example, the traceback information of the current program is output so that you can know where the current program is running and even the values of local and global variables at the location where the code is executed. n the following example program, the program outputs the traceback information of the program when the USR1 signal is received: # -*- coding: utf-8 -*- from queue import Queue import signal import sys import threading import time import traceback def output_tracebacks(signum, frame): id2thread = {} for thread in threading.enumerate(): id2thread[thread.ident] = thread for thread_id, stack in sys._current_frames().items(): stack_list = traceback.format_list(traceback.extract_stack(stack)) print(&#39;thread {}:&#39;.format(id2thread[thread_id])) print(&#39;&#39;.join(stack_list)) def setup_backdoor(): signal.signal(signal.SIGUSR1, output_tracebacks) def worker(q): while True: task = q.get() if task is None: break # do something with task time.sleep(1.2) def producer(q): for x in range(100): q.put(x) time.sleep(1) q.put(None) setup_backdoor() q = Queue() t1 = threading.Thread(target=producer, args=(q,)) t1.start() t2 = threading.Thread(target=worker, args=(q,)) t2.start() for t in [t1, t2]: t.join() Run the program and activate the backdoor with the USR1 signal to get the traceback information of the program. $ python testa.py &amp; [1] 79163 $ kill -s USR1 79163 thread &lt;Thread(Thread-2, started 123145565609984)&gt;: File &#34;/xxx/lib/python3.6/threading.py&#34;, line 884, in _bootstrap self._bootstrap_inner() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 916, in _bootstrap_inner self.run() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 864, in run self._target(*self._args, **self._kwargs) File &#34;testa.py&#34;, line 30, in worker time.sleep(1.2) thread &lt;Thread(Thread-1, started 123145560354816)&gt;: File &#34;/xxx/lib/python3.6/threading.py&#34;, line 884, in _bootstrap self._bootstrap_inner() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 916, in _bootstrap_inner self.run() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 864, in run self._target(*self._args, **self._kwargs) File &#34;testa.py&#34;, line 36, in producer time.sleep(1) thread &lt;_MainThread(MainThread, started 140736812057536)&gt;: File &#34;testa.py&#34;, line 47, in &lt;module&gt; t.join() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 1056, in join self._wait_for_tstate_lock() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 1072, in _wait_for_tstate_lock elif lock.acquire(block, timeout): File &#34;testa.py&#34;, line 15, in output_tracebacks stack_list = traceback.format_list(traceback.extract_stack(stack)) For more on getting traceback information see Python: Getting traceback information for concurrent programs (threading/gevent/asyncio) Enable remote debugging service when signal is received For example, if you open a remote debugger (Python Shell) that uses the current runtime environment of the process, you can access the global variables that change at runtime in this debugger and execute code using the current runtime environment of the process: # -*- coding: utf-8 -*- from code import InteractiveConsole from queue import Queue import signal import socketserver import sys import threading import time import traceback class FileLikeObject(object): def __init__(self, rfile, wfile): self._rfile = rfile self._wfile = wfile def __getattr__(self, name): try: return getattr(self._rfile, name) except AttributeError: return getattr(self._wfile, name) def write(self, data): if not isinstance(data, bytes): data = data.encode(&#39;utf-8&#39;) self._wfile.write(data) def isatty(self): return True def flush(self): pass def readline(self, *args): try: data = self._rfile.readline(*args).replace(b&#39;\r\n&#39;, b&#39;\n&#39;) if not isinstance(data, str): data = data.decode(&#39;utf-8&#39;) return data except UnicodeError: return &#39;&#39; class DebuggerTCPHandler(socketserver.StreamRequestHandler): def handle(self): fileobj = FileLikeObject(self.rfile, self.wfile) sys.stdin = sys.stdout = sys.stderr = fileobj try: console = InteractiveConsole(locals=globals()) console.interact(banner=&#39;== debug server ==&#39;, exitmsg=&#39;&#39;) except SystemExit: pass finally: sys.stdin = sys.__stdin__ sys.stdout = sys.__stdout__ sys.stderr = sys.__stderr__ def output_tracebacks(): id2thread = {} for thread in threading.enumerate(): id2thread[thread.ident] = thread for thread_id, stack in sys._current_frames().items(): stack_list = traceback.format_list(traceback.extract_stack(stack)) print(&#39;thread {}:&#39;.format(id2thread[thread_id])) print(&#39;&#39;.join(stack_list)) debugger = None def start_debugger(signum, frame): print(&#39;start debugger...&#39;) server = socketserver.TCPServer((&#39;localhost&#39;, 9999), DebuggerTCPHandler) t = threading.Thread(target=server.serve_forever) t.start() global debugger debugger = (server, t) print(&#39;started debugger&#39;) def close_debugger(signum, frame): print(&#39;close debugger...&#39;) if debugger is None: print(&#39;closed debugger&#39;) return server, t = debugger server.shutdown() server.server_close() t.join() print(&#39;closed debugger&#39;) def setup_backdoor(): signal.signal(signal.SIGUSR1, start_debugger) signal.signal(signal.SIGUSR2, close_debugger) def worker(q): while True: task = q.get() if task is None: break # do something with task time.sleep(1.2) def producer(q): for x in range(100): q.put(x) time.sleep(1) q.put(None) setup_backdoor() q = Queue() t1 = threading.Thread(target=producer, args=(q,)) t1.start() t2 = threading.Thread(target=worker, args=(q,)) t2.start() for t in [t1, t2]: t.join() Run the program, activate the remote debugger via USR1 and close the remote debugging service via USR2 after debugging: $ python testb.py &amp; [1] 87173 $ kill -s USR1 87173 start debugger... started debugger $ $ telnet 127.0.0.1 9999 Trying 127.0.0.1... Connected to localhost. Escape character is &#39;^]&#39;. == debug server == &gt;&gt;&gt; output_tracebacks() thread &lt;Thread(Thread-3, started 123145482240000)&gt;: File &#34;/xxx/lib/python3.6/threading.py&#34;, line 884, in _bootstrap self._bootstrap_inner() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 916, in _bootstrap_inner self.run() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 864, in run self._target(*self._args, **self._kwargs) File &#34;/xxx/lib/python3.6/socketserver.py&#34;, line 238, in serve_forever self._handle_request_noblock() File &#34;/xxx/lib/python3.6/socketserver.py&#34;, line 317, in _handle_request_noblock self.process_request(request, client_address) File &#34;/xxx/lib/python3.6/socketserver.py&#34;, line 348, in process_request self.finish_request(request, client_address) File &#34;/xxx/lib/python3.6/socketserver.py&#34;, line 361, in finish_request self.RequestHandlerClass(request, client_address, self) File &#34;/xxx/lib/python3.6/socketserver.py&#34;, line 696, in __init__ self.handle() File &#34;testb.py&#34;, line 52, in handle console.interact(banner=&#39;== debug server ==&#39;, exitmsg=&#39;&#39;) File &#34;/xxx/lib/python3.6/code.py&#34;, line 233, in interact more = self.push(line) File &#34;/xxx/lib/python3.6/code.py&#34;, line 259, in push more = self.runsource(source, self.filename) File &#34;/xxx/lib/python3.6/code.py&#34;, line 75, in runsource self.runcode(code) File &#34;/xxx/lib/python3.6/code.py&#34;, line 91, in runcode exec(code, self.locals) File &#34;&lt;console&gt;&#34;, line 1, in &lt;module&gt; File &#34;testb.py&#34;, line 66, in output_tracebacks stack_list = traceback.format_list(traceback.extract_stack(stack)) thread &lt;Thread(Thread-2, started 123145476984832)&gt;: File &#34;/xxx/lib/python3.6/threading.py&#34;, line 884, in _bootstrap self._bootstrap_inner() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 916, in _bootstrap_inner self.run() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 864, in run self._target(*self._args, **self._kwargs) File &#34;testb.py&#34;, line 108, in worker time.sleep(1.2) thread &lt;Thread(Thread-1, started 123145471729664)&gt;: File &#34;/xxx/lib/python3.6/threading.py&#34;, line 884, in _bootstrap self._bootstrap_inner() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 916, in _bootstrap_inner self.run() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 864, in run self._target(*self._args, **self._kwargs) File &#34;testb.py&#34;, line 114, in producer time.sleep(1) thread &lt;_MainThread(MainThread, started 140736812057536)&gt;: File &#34;testb.py&#34;, line 125, in &lt;module&gt; t.join() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 1056, in join self._wait_for_tstate_lock() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 1072, in _wait_for_tstate_lock elif lock.acquire(block, timeout): &gt;&gt;&gt; q &lt;queue.Queue object at 0x10a2e8fd0&gt; &gt;&gt;&gt; q.qsize() 13 &gt;&gt;&gt; q.qsize() 14 &gt;&gt;&gt; exit() Connection closed by foreign host. $ jobs [1]+ Running python testb.py &amp; $ kill -s USR2 87173 close debugger... closed debugger $ telnet 127.0.0.1 9999 Trying 127.0.0.1... telnet: connect to address 127.0.0.1: Connection refused telnet: Unable to connect to remote host The above code is just a rough demonstration of how to implement a remote debugger, for a formal remote debugger you can refer to and use gevent.backdoor or twisted.conch.manhole ionelmc/python-manhole and other full-featured third-party modules. Summary The above two examples are just common pre-set backdoors, in fact, you can also pre-set other functions (for example, pre-set an HTTP server, access different URLs to get different runtime information or do some auxiliary debugging operations), all for debugging, all in order to locate and solve problems as soon as possible. Which backdoors need to be preset should be determined by the actual situation, on the one hand, to consider whether it will affect the normal operation of the service, on the other hand, we also need to consider which way which information can help us locate and solve problems faster, and most importantly to consider security issues, to do a good job of security protection, do not expose the port to the Internet. Although the title and the examples in the article are Python related, the idea is not limited to Python, but can be applied to services written in other languages as well. Feel free to share and discuss debugging techniques and problem solving with me. References 18.8. signal — Set handlers for asynchronous events — Python 3.6.4 documentation Python: get traceback information（threading/gevent/asyncio） - mozillazg&#39;s blog gevent.backdoor – Interactive greenlet-based network console that can be used in any process — gevent 1.3.0.dev0 documentation twisted.conch.manhole : API documentation ionelmc/python-manhole: Debugging manhole for python applications. 21.21. socketserver — A framework for network servers — Python 3.6.4 documentation 30.1. code — Interpreter base classes — Python 3.6.4 documentation" />

    <style>
      .js-toc {
        margin-bottom: 20px;
      }
      .donate-modal {
        text-align: center;
      }
      #donate-modal-container .donate-image {
        max-height: 300px !important;
        min-height: inherit !important;
      }
    </style>

        <meta property="og:site_name" content="mozillazg's Blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Python: Debugging running processes by means of preset backdoors (debugging interfaces)"/>
        <meta property="og:url" content="https://mozillazg.com/2017/12/python-debug-running-process-threading-gevent-eventlet-asyncio-via-preset-backdoor-en.html"/>
        <meta property="og:description" content="Preface Whenever there is a problem with a running program/service, we want to be able to locate the cause of the problem as soon as possible, to be able to reproduce the problem and to solve it. We usually think that it would be good to know what the program is doing, it would be good to reproduce the problem immediately, and it would be good to know the value of the current variables in the program. There are many ways to know this information, and this article introduces an idea and method to debug a running process by means of a preset backdoor. A common way to preset the backdoor is by defining a signal handler that performs specific, easy to debug and find problems when the corresponding signal is received. For example, the following two examples will be given: Outputs specific information for debugging when a signal is received Enable remote debugging service when signal is received Outputs specific information for debugging when a signal is received For example, the traceback information of the current program is output so that you can know where the current program is running and even the values of local and global variables at the location where the code is executed. n the following example program, the program outputs the traceback information of the program when the USR1 signal is received: # -*- coding: utf-8 -*- from queue import Queue import signal import sys import threading import time import traceback def output_tracebacks(signum, frame): id2thread = {} for thread in threading.enumerate(): id2thread[thread.ident] = thread for thread_id, stack in sys._current_frames().items(): stack_list = traceback.format_list(traceback.extract_stack(stack)) print(&#39;thread {}:&#39;.format(id2thread[thread_id])) print(&#39;&#39;.join(stack_list)) def setup_backdoor(): signal.signal(signal.SIGUSR1, output_tracebacks) def worker(q): while True: task = q.get() if task is None: break # do something with task time.sleep(1.2) def producer(q): for x in range(100): q.put(x) time.sleep(1) q.put(None) setup_backdoor() q = Queue() t1 = threading.Thread(target=producer, args=(q,)) t1.start() t2 = threading.Thread(target=worker, args=(q,)) t2.start() for t in [t1, t2]: t.join() Run the program and activate the backdoor with the USR1 signal to get the traceback information of the program. $ python testa.py &amp; [1] 79163 $ kill -s USR1 79163 thread &lt;Thread(Thread-2, started 123145565609984)&gt;: File &#34;/xxx/lib/python3.6/threading.py&#34;, line 884, in _bootstrap self._bootstrap_inner() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 916, in _bootstrap_inner self.run() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 864, in run self._target(*self._args, **self._kwargs) File &#34;testa.py&#34;, line 30, in worker time.sleep(1.2) thread &lt;Thread(Thread-1, started 123145560354816)&gt;: File &#34;/xxx/lib/python3.6/threading.py&#34;, line 884, in _bootstrap self._bootstrap_inner() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 916, in _bootstrap_inner self.run() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 864, in run self._target(*self._args, **self._kwargs) File &#34;testa.py&#34;, line 36, in producer time.sleep(1) thread &lt;_MainThread(MainThread, started 140736812057536)&gt;: File &#34;testa.py&#34;, line 47, in &lt;module&gt; t.join() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 1056, in join self._wait_for_tstate_lock() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 1072, in _wait_for_tstate_lock elif lock.acquire(block, timeout): File &#34;testa.py&#34;, line 15, in output_tracebacks stack_list = traceback.format_list(traceback.extract_stack(stack)) For more on getting traceback information see Python: Getting traceback information for concurrent programs (threading/gevent/asyncio) Enable remote debugging service when signal is received For example, if you open a remote debugger (Python Shell) that uses the current runtime environment of the process, you can access the global variables that change at runtime in this debugger and execute code using the current runtime environment of the process: # -*- coding: utf-8 -*- from code import InteractiveConsole from queue import Queue import signal import socketserver import sys import threading import time import traceback class FileLikeObject(object): def __init__(self, rfile, wfile): self._rfile = rfile self._wfile = wfile def __getattr__(self, name): try: return getattr(self._rfile, name) except AttributeError: return getattr(self._wfile, name) def write(self, data): if not isinstance(data, bytes): data = data.encode(&#39;utf-8&#39;) self._wfile.write(data) def isatty(self): return True def flush(self): pass def readline(self, *args): try: data = self._rfile.readline(*args).replace(b&#39;\r\n&#39;, b&#39;\n&#39;) if not isinstance(data, str): data = data.decode(&#39;utf-8&#39;) return data except UnicodeError: return &#39;&#39; class DebuggerTCPHandler(socketserver.StreamRequestHandler): def handle(self): fileobj = FileLikeObject(self.rfile, self.wfile) sys.stdin = sys.stdout = sys.stderr = fileobj try: console = InteractiveConsole(locals=globals()) console.interact(banner=&#39;== debug server ==&#39;, exitmsg=&#39;&#39;) except SystemExit: pass finally: sys.stdin = sys.__stdin__ sys.stdout = sys.__stdout__ sys.stderr = sys.__stderr__ def output_tracebacks(): id2thread = {} for thread in threading.enumerate(): id2thread[thread.ident] = thread for thread_id, stack in sys._current_frames().items(): stack_list = traceback.format_list(traceback.extract_stack(stack)) print(&#39;thread {}:&#39;.format(id2thread[thread_id])) print(&#39;&#39;.join(stack_list)) debugger = None def start_debugger(signum, frame): print(&#39;start debugger...&#39;) server = socketserver.TCPServer((&#39;localhost&#39;, 9999), DebuggerTCPHandler) t = threading.Thread(target=server.serve_forever) t.start() global debugger debugger = (server, t) print(&#39;started debugger&#39;) def close_debugger(signum, frame): print(&#39;close debugger...&#39;) if debugger is None: print(&#39;closed debugger&#39;) return server, t = debugger server.shutdown() server.server_close() t.join() print(&#39;closed debugger&#39;) def setup_backdoor(): signal.signal(signal.SIGUSR1, start_debugger) signal.signal(signal.SIGUSR2, close_debugger) def worker(q): while True: task = q.get() if task is None: break # do something with task time.sleep(1.2) def producer(q): for x in range(100): q.put(x) time.sleep(1) q.put(None) setup_backdoor() q = Queue() t1 = threading.Thread(target=producer, args=(q,)) t1.start() t2 = threading.Thread(target=worker, args=(q,)) t2.start() for t in [t1, t2]: t.join() Run the program, activate the remote debugger via USR1 and close the remote debugging service via USR2 after debugging: $ python testb.py &amp; [1] 87173 $ kill -s USR1 87173 start debugger... started debugger $ $ telnet 127.0.0.1 9999 Trying 127.0.0.1... Connected to localhost. Escape character is &#39;^]&#39;. == debug server == &gt;&gt;&gt; output_tracebacks() thread &lt;Thread(Thread-3, started 123145482240000)&gt;: File &#34;/xxx/lib/python3.6/threading.py&#34;, line 884, in _bootstrap self._bootstrap_inner() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 916, in _bootstrap_inner self.run() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 864, in run self._target(*self._args, **self._kwargs) File &#34;/xxx/lib/python3.6/socketserver.py&#34;, line 238, in serve_forever self._handle_request_noblock() File &#34;/xxx/lib/python3.6/socketserver.py&#34;, line 317, in _handle_request_noblock self.process_request(request, client_address) File &#34;/xxx/lib/python3.6/socketserver.py&#34;, line 348, in process_request self.finish_request(request, client_address) File &#34;/xxx/lib/python3.6/socketserver.py&#34;, line 361, in finish_request self.RequestHandlerClass(request, client_address, self) File &#34;/xxx/lib/python3.6/socketserver.py&#34;, line 696, in __init__ self.handle() File &#34;testb.py&#34;, line 52, in handle console.interact(banner=&#39;== debug server ==&#39;, exitmsg=&#39;&#39;) File &#34;/xxx/lib/python3.6/code.py&#34;, line 233, in interact more = self.push(line) File &#34;/xxx/lib/python3.6/code.py&#34;, line 259, in push more = self.runsource(source, self.filename) File &#34;/xxx/lib/python3.6/code.py&#34;, line 75, in runsource self.runcode(code) File &#34;/xxx/lib/python3.6/code.py&#34;, line 91, in runcode exec(code, self.locals) File &#34;&lt;console&gt;&#34;, line 1, in &lt;module&gt; File &#34;testb.py&#34;, line 66, in output_tracebacks stack_list = traceback.format_list(traceback.extract_stack(stack)) thread &lt;Thread(Thread-2, started 123145476984832)&gt;: File &#34;/xxx/lib/python3.6/threading.py&#34;, line 884, in _bootstrap self._bootstrap_inner() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 916, in _bootstrap_inner self.run() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 864, in run self._target(*self._args, **self._kwargs) File &#34;testb.py&#34;, line 108, in worker time.sleep(1.2) thread &lt;Thread(Thread-1, started 123145471729664)&gt;: File &#34;/xxx/lib/python3.6/threading.py&#34;, line 884, in _bootstrap self._bootstrap_inner() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 916, in _bootstrap_inner self.run() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 864, in run self._target(*self._args, **self._kwargs) File &#34;testb.py&#34;, line 114, in producer time.sleep(1) thread &lt;_MainThread(MainThread, started 140736812057536)&gt;: File &#34;testb.py&#34;, line 125, in &lt;module&gt; t.join() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 1056, in join self._wait_for_tstate_lock() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 1072, in _wait_for_tstate_lock elif lock.acquire(block, timeout): &gt;&gt;&gt; q &lt;queue.Queue object at 0x10a2e8fd0&gt; &gt;&gt;&gt; q.qsize() 13 &gt;&gt;&gt; q.qsize() 14 &gt;&gt;&gt; exit() Connection closed by foreign host. $ jobs [1]+ Running python testb.py &amp; $ kill -s USR2 87173 close debugger... closed debugger $ telnet 127.0.0.1 9999 Trying 127.0.0.1... telnet: connect to address 127.0.0.1: Connection refused telnet: Unable to connect to remote host The above code is just a rough demonstration of how to implement a remote debugger, for a formal remote debugger you can refer to and use gevent.backdoor or twisted.conch.manhole ionelmc/python-manhole and other full-featured third-party modules. Summary The above two examples are just common pre-set backdoors, in fact, you can also pre-set other functions (for example, pre-set an HTTP server, access different URLs to get different runtime information or do some auxiliary debugging operations), all for debugging, all in order to locate and solve problems as soon as possible. Which backdoors need to be preset should be determined by the actual situation, on the one hand, to consider whether it will affect the normal operation of the service, on the other hand, we also need to consider which way which information can help us locate and solve problems faster, and most importantly to consider security issues, to do a good job of security protection, do not expose the port to the Internet. Although the title and the examples in the article are Python related, the idea is not limited to Python, but can be applied to services written in other languages as well. Feel free to share and discuss debugging techniques and problem solving with me. References 18.8. signal — Set handlers for asynchronous events — Python 3.6.4 documentation Python: get traceback information（threading/gevent/asyncio） - mozillazg&#39;s blog gevent.backdoor – Interactive greenlet-based network console that can be used in any process — gevent 1.3.0.dev0 documentation twisted.conch.manhole : API documentation ionelmc/python-manhole: Debugging manhole for python applications. 21.21. socketserver — A framework for network servers — Python 3.6.4 documentation 30.1. code — Interpreter base classes — Python 3.6.4 documentation"/>
        <meta property="article:published_time" content="2017-12-31" />
            <meta property="article:section" content="python" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="debug" />
            <meta property="article:tag" content="backdoor" />
            <meta property="article:tag" content="en-version" />
            <meta property="article:author" content="mozillazg" />
            <meta property="og:image"
                  content="https://mozillazg.com/static/avatar.jpeg"/>


    <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@mozillazg">
        <meta name="twitter:creator" content="@mozillazg">
    <meta name="twitter:domain" content="https://mozillazg.com">
            <meta property="twitter:image"
                  content="https://mozillazg.com/static/avatar.jpeg"/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.4/dist/css/bootstrap.min.css" type="text/css"/>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/pygments-css@1.0.0/github.css" rel="stylesheet">
    <link rel="stylesheet" href="https://mozillazg.com/theme/css/style.css" type="text/css"/>
            <link href="https://mozillazg.com/static/han.min.css" rel="stylesheet">
            <link href="https://mozillazg.com/static/yue.css" rel="stylesheet">
            <link href="https://mozillazg.com/static/custom.css" rel="stylesheet">

        <link href="https://mozillazg.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="mozillazg's Blog ATOM Feed"/>

        <link href="https://mozillazg.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="mozillazg's Blog RSS Feed"/>


        <link href="https://mozillazg.com/feeds/python.atom.xml" type="application/atom+xml" rel="alternate"
              title="mozillazg's Blog python ATOM Feed"/>


    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "publisher": {
            "@type": "Person",
            "name": "mozillazg",
            "logo": "https://mozillazg.com/static/avatar.jpeg"
        },
        "author": {
            "@type": "Person",
            "name": "mozillazg",
            "image": "https://mozillazg.com/static/avatar.jpeg",
            "url": "https://mozillazg.com",
            "sameAs": []
        },
        "headline": "Python: Debugging running processes by means of preset backdoors (debugging interfaces)",
        "url": "https://mozillazg.com/2017/12/python-debug-running-process-threading-gevent-eventlet-asyncio-via-preset-backdoor-en.html",
        "image": [
            "https://mozillazg.com/static/avatar.jpeg"
         ],
        "keywords": "python, debug, backdoor, en-version",
        "description": "Preface Whenever there is a problem with a running program/service, we want to be able to locate the cause of the problem as soon as possible, to be able to reproduce the problem and to solve it. We usually think that it would be good to know what the program is doing, it would be good to reproduce the problem immediately, and it would be good to know the value of the current variables in the program. There are many ways to know this information, and this article introduces an idea and method to debug a running process by means of a preset backdoor. A common way to preset the backdoor is by defining a signal handler that performs specific, easy to debug and find problems when the corresponding signal is received. For example, the following two examples will be given: Outputs specific information for debugging when a signal is received Enable remote debugging service when signal is received Outputs specific information for debugging when a signal is received For example, the traceback information of the current program is output so that you can know where the current program is running and even the values of local and global variables at the location where the code is executed. n the following example program, the program outputs the traceback information of the program when the USR1 signal is received: # -*- coding: utf-8 -*- from queue import Queue import signal import sys import threading import time import traceback def output_tracebacks(signum, frame): id2thread = {} for thread in threading.enumerate(): id2thread[thread.ident] = thread for thread_id, stack in sys._current_frames().items(): stack_list = traceback.format_list(traceback.extract_stack(stack)) print(&#39;thread {}:&#39;.format(id2thread[thread_id])) print(&#39;&#39;.join(stack_list)) def setup_backdoor(): signal.signal(signal.SIGUSR1, output_tracebacks) def worker(q): while True: task = q.get() if task is None: break # do something with task time.sleep(1.2) def producer(q): for x in range(100): q.put(x) time.sleep(1) q.put(None) setup_backdoor() q = Queue() t1 = threading.Thread(target=producer, args=(q,)) t1.start() t2 = threading.Thread(target=worker, args=(q,)) t2.start() for t in [t1, t2]: t.join() Run the program and activate the backdoor with the USR1 signal to get the traceback information of the program. $ python testa.py &amp; [1] 79163 $ kill -s USR1 79163 thread &lt;Thread(Thread-2, started 123145565609984)&gt;: File &#34;/xxx/lib/python3.6/threading.py&#34;, line 884, in _bootstrap self._bootstrap_inner() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 916, in _bootstrap_inner self.run() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 864, in run self._target(*self._args, **self._kwargs) File &#34;testa.py&#34;, line 30, in worker time.sleep(1.2) thread &lt;Thread(Thread-1, started 123145560354816)&gt;: File &#34;/xxx/lib/python3.6/threading.py&#34;, line 884, in _bootstrap self._bootstrap_inner() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 916, in _bootstrap_inner self.run() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 864, in run self._target(*self._args, **self._kwargs) File &#34;testa.py&#34;, line 36, in producer time.sleep(1) thread &lt;_MainThread(MainThread, started 140736812057536)&gt;: File &#34;testa.py&#34;, line 47, in &lt;module&gt; t.join() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 1056, in join self._wait_for_tstate_lock() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 1072, in _wait_for_tstate_lock elif lock.acquire(block, timeout): File &#34;testa.py&#34;, line 15, in output_tracebacks stack_list = traceback.format_list(traceback.extract_stack(stack)) For more on getting traceback information see Python: Getting traceback information for concurrent programs (threading/gevent/asyncio) Enable remote debugging service when signal is received For example, if you open a remote debugger (Python Shell) that uses the current runtime environment of the process, you can access the global variables that change at runtime in this debugger and execute code using the current runtime environment of the process: # -*- coding: utf-8 -*- from code import InteractiveConsole from queue import Queue import signal import socketserver import sys import threading import time import traceback class FileLikeObject(object): def __init__(self, rfile, wfile): self._rfile = rfile self._wfile = wfile def __getattr__(self, name): try: return getattr(self._rfile, name) except AttributeError: return getattr(self._wfile, name) def write(self, data): if not isinstance(data, bytes): data = data.encode(&#39;utf-8&#39;) self._wfile.write(data) def isatty(self): return True def flush(self): pass def readline(self, *args): try: data = self._rfile.readline(*args).replace(b&#39;\\r\\n&#39;, b&#39;\\n&#39;) if not isinstance(data, str): data = data.decode(&#39;utf-8&#39;) return data except UnicodeError: return &#39;&#39; class DebuggerTCPHandler(socketserver.StreamRequestHandler): def handle(self): fileobj = FileLikeObject(self.rfile, self.wfile) sys.stdin = sys.stdout = sys.stderr = fileobj try: console = InteractiveConsole(locals=globals()) console.interact(banner=&#39;== debug server ==&#39;, exitmsg=&#39;&#39;) except SystemExit: pass finally: sys.stdin = sys.__stdin__ sys.stdout = sys.__stdout__ sys.stderr = sys.__stderr__ def output_tracebacks(): id2thread = {} for thread in threading.enumerate(): id2thread[thread.ident] = thread for thread_id, stack in sys._current_frames().items(): stack_list = traceback.format_list(traceback.extract_stack(stack)) print(&#39;thread {}:&#39;.format(id2thread[thread_id])) print(&#39;&#39;.join(stack_list)) debugger = None def start_debugger(signum, frame): print(&#39;start debugger...&#39;) server = socketserver.TCPServer((&#39;localhost&#39;, 9999), DebuggerTCPHandler) t = threading.Thread(target=server.serve_forever) t.start() global debugger debugger = (server, t) print(&#39;started debugger&#39;) def close_debugger(signum, frame): print(&#39;close debugger...&#39;) if debugger is None: print(&#39;closed debugger&#39;) return server, t = debugger server.shutdown() server.server_close() t.join() print(&#39;closed debugger&#39;) def setup_backdoor(): signal.signal(signal.SIGUSR1, start_debugger) signal.signal(signal.SIGUSR2, close_debugger) def worker(q): while True: task = q.get() if task is None: break # do something with task time.sleep(1.2) def producer(q): for x in range(100): q.put(x) time.sleep(1) q.put(None) setup_backdoor() q = Queue() t1 = threading.Thread(target=producer, args=(q,)) t1.start() t2 = threading.Thread(target=worker, args=(q,)) t2.start() for t in [t1, t2]: t.join() Run the program, activate the remote debugger via USR1 and close the remote debugging service via USR2 after debugging: $ python testb.py &amp; [1] 87173 $ kill -s USR1 87173 start debugger... started debugger $ $ telnet 127.0.0.1 9999 Trying 127.0.0.1... Connected to localhost. Escape character is &#39;^]&#39;. == debug server == &gt;&gt;&gt; output_tracebacks() thread &lt;Thread(Thread-3, started 123145482240000)&gt;: File &#34;/xxx/lib/python3.6/threading.py&#34;, line 884, in _bootstrap self._bootstrap_inner() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 916, in _bootstrap_inner self.run() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 864, in run self._target(*self._args, **self._kwargs) File &#34;/xxx/lib/python3.6/socketserver.py&#34;, line 238, in serve_forever self._handle_request_noblock() File &#34;/xxx/lib/python3.6/socketserver.py&#34;, line 317, in _handle_request_noblock self.process_request(request, client_address) File &#34;/xxx/lib/python3.6/socketserver.py&#34;, line 348, in process_request self.finish_request(request, client_address) File &#34;/xxx/lib/python3.6/socketserver.py&#34;, line 361, in finish_request self.RequestHandlerClass(request, client_address, self) File &#34;/xxx/lib/python3.6/socketserver.py&#34;, line 696, in __init__ self.handle() File &#34;testb.py&#34;, line 52, in handle console.interact(banner=&#39;== debug server ==&#39;, exitmsg=&#39;&#39;) File &#34;/xxx/lib/python3.6/code.py&#34;, line 233, in interact more = self.push(line) File &#34;/xxx/lib/python3.6/code.py&#34;, line 259, in push more = self.runsource(source, self.filename) File &#34;/xxx/lib/python3.6/code.py&#34;, line 75, in runsource self.runcode(code) File &#34;/xxx/lib/python3.6/code.py&#34;, line 91, in runcode exec(code, self.locals) File &#34;&lt;console&gt;&#34;, line 1, in &lt;module&gt; File &#34;testb.py&#34;, line 66, in output_tracebacks stack_list = traceback.format_list(traceback.extract_stack(stack)) thread &lt;Thread(Thread-2, started 123145476984832)&gt;: File &#34;/xxx/lib/python3.6/threading.py&#34;, line 884, in _bootstrap self._bootstrap_inner() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 916, in _bootstrap_inner self.run() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 864, in run self._target(*self._args, **self._kwargs) File &#34;testb.py&#34;, line 108, in worker time.sleep(1.2) thread &lt;Thread(Thread-1, started 123145471729664)&gt;: File &#34;/xxx/lib/python3.6/threading.py&#34;, line 884, in _bootstrap self._bootstrap_inner() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 916, in _bootstrap_inner self.run() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 864, in run self._target(*self._args, **self._kwargs) File &#34;testb.py&#34;, line 114, in producer time.sleep(1) thread &lt;_MainThread(MainThread, started 140736812057536)&gt;: File &#34;testb.py&#34;, line 125, in &lt;module&gt; t.join() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 1056, in join self._wait_for_tstate_lock() File &#34;/xxx/lib/python3.6/threading.py&#34;, line 1072, in _wait_for_tstate_lock elif lock.acquire(block, timeout): &gt;&gt;&gt; q &lt;queue.Queue object at 0x10a2e8fd0&gt; &gt;&gt;&gt; q.qsize() 13 &gt;&gt;&gt; q.qsize() 14 &gt;&gt;&gt; exit() Connection closed by foreign host. $ jobs [1]+ Running python testb.py &amp; $ kill -s USR2 87173 close debugger... closed debugger $ telnet 127.0.0.1 9999 Trying 127.0.0.1... telnet: connect to address 127.0.0.1: Connection refused telnet: Unable to connect to remote host The above code is just a rough demonstration of how to implement a remote debugger, for a formal remote debugger you can refer to and use gevent.backdoor or twisted.conch.manhole ionelmc/python-manhole and other full-featured third-party modules. Summary The above two examples are just common pre-set backdoors, in fact, you can also pre-set other functions (for example, pre-set an HTTP server, access different URLs to get different runtime information or do some auxiliary debugging operations), all for debugging, all in order to locate and solve problems as soon as possible. Which backdoors need to be preset should be determined by the actual situation, on the one hand, to consider whether it will affect the normal operation of the service, on the other hand, we also need to consider which way which information can help us locate and solve problems faster, and most importantly to consider security issues, to do a good job of security protection, do not expose the port to the Internet. Although the title and the examples in the article are Python related, the idea is not limited to Python, but can be applied to services written in other languages as well. Feel free to share and discuss debugging techniques and problem solving with me. References 18.8. signal — Set handlers for asynchronous events — Python 3.6.4 documentation Python: get traceback information（threading/gevent/asyncio） - mozillazg&#39;s blog gevent.backdoor – Interactive greenlet-based network console that can be used in any process — gevent 1.3.0.dev0 documentation twisted.conch.manhole : API documentation ionelmc/python-manhole: Debugging manhole for python applications. 21.21. socketserver — A framework for network servers — Python 3.6.4 documentation 30.1. code — Interpreter base classes — Python 3.6.4 documentation",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https://mozillazg.com/2017/12/python-debug-running-process-threading-gevent-eventlet-asyncio-via-preset-backdoor-en.html"
        },
        "datePublished": "2017-12-31"
    }
    </script>

</head>
<body>

<div class="navbar" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://mozillazg.com/" class="navbar-brand">
mozillazg's Blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="https://mozillazg.com/feeds/all.atom.xml">Feed</a></li>
                    <li><a href="/2014/10/pages/about-me.html">About</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://mozillazg.com/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
    <section id="content" class="yue">
        <article>
            <header class="text-center">
                <h1>
                    <a href="https://mozillazg.com/2017/12/python-debug-running-process-threading-gevent-eventlet-asyncio-via-preset-backdoor-en.html"
                       rel="bookmark"
                       title="Permalink to Python: Debugging running processes by means of preset backdoors (debugging interfaces)">
                        Python: Debugging running processes by means of preset backdoors (debugging interfaces)
                    </a>
                </h1>
                <p class="published">
                    <time datetime="2017-12-31T00:00:00+00:00">
                    2017-12-31
                    </time>
                </p>
            </header>
            <div class="entry-content">
                <div class="well-sm article-info">
<footer class="post-info">
        <a href="https://mozillazg.com/category/python.html">python</a>


<span class="label label-default hide">Tags</span>
	<a href="https://mozillazg.com/tag/debug.html">debug</a>
        /
	<a href="https://mozillazg.com/tag/backdoor.html">backdoor</a>
        /
	<a href="https://mozillazg.com/tag/en-version.html">en-version</a>
    <span class="label label-default">Lang</span>
	<a href="https://mozillazg.com/2017/12/python-debug-running-process-threading-gevent-eventlet-asyncio-via-preset-backdoor.html">zh</a>

</footer><!-- /.post-info -->                </div>
                <div class="js-toc"></div>
                <div>
                <div class="section" id="preface">
<h2 id="hidpreface">Preface<a class="headerlink" href="#hidpreface" title="Permalink to this headline">¶</a></h2>
<p>Whenever there is a problem with a running program/service, we want to be able to locate the cause of the problem as soon as possible, to be able to reproduce the problem and to solve it. We usually think that it would be good to know what the program is doing, it would be good to reproduce the problem immediately, and it would be good to know the value of the current variables in the program. There are many ways to know this information, and this article introduces an idea and method to debug a running process by means of a preset backdoor.</p>
<p>A common way to preset the backdoor is by defining a signal handler that performs specific, easy to debug and find problems when the corresponding signal is received.
For example, the following two examples will be given:</p>
<ul class="simple">
<li>Outputs specific information for debugging when a signal is received</li>
<li>Enable remote debugging service when signal is received</li>
</ul>
</div>
<div class="section" id="outputs-specific-information-for-debugging-when-a-signal-is-received">
<h2 id="hidoutputs-specific-information-for-debugging-when-a-signal-is-received">Outputs specific information for debugging when a signal is received<a class="headerlink" href="#hidoutputs-specific-information-for-debugging-when-a-signal-is-received" title="Permalink to this headline">¶</a></h2>
<p>For example, the traceback information of the current program is output so that you can know where the current program is running and even the values of local and global variables at the location where the code is executed.</p>
<p>n the following example program, the program outputs the traceback information of the program when the <cite>USR1</cite> signal is received:</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>


<span class="k">def</span> <span class="nf">output_tracebacks</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="n">id2thread</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threading</span><span class="o">.</span><span class="n">enumerate</span><span class="p">():</span>
        <span class="n">id2thread</span><span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">ident</span><span class="p">]</span> <span class="o">=</span> <span class="n">thread</span>
    <span class="k">for</span> <span class="n">thread_id</span><span class="p">,</span> <span class="n">stack</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">_current_frames</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">stack_list</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_list</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">extract_stack</span><span class="p">(</span><span class="n">stack</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;thread </span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id2thread</span><span class="p">[</span><span class="n">thread_id</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stack_list</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">setup_backdoor</span><span class="p">():</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="n">output_tracebacks</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c1"># do something with task</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">producer</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>


<span class="n">setup_backdoor</span><span class="p">()</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">producer</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,))</span>
<span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,))</span>
<span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">]:</span>
    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
<p>Run the program and activate the backdoor with the <cite>USR1</cite> signal to get the traceback information of the program.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>testa.py<span class="w"> </span><span class="p">&amp;</span>
<span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="m">79163</span>
$<span class="w"> </span><span class="nb">kill</span><span class="w"> </span>-s<span class="w"> </span>USR1<span class="w"> </span><span class="m">79163</span>
thread<span class="w"> </span>&lt;Thread<span class="o">(</span>Thread-2,<span class="w"> </span>started<span class="w"> </span><span class="m">123145565609984</span><span class="o">)</span>&gt;:
<span class="w">  </span>File<span class="w"> </span><span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">884</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>_bootstrap
<span class="w">    </span>self._bootstrap_inner<span class="o">()</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">916</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>_bootstrap_inner
<span class="w">    </span>self.run<span class="o">()</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">864</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>run
<span class="w">    </span>self._target<span class="o">(</span>*self._args,<span class="w"> </span>**self._kwargs<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">&quot;testa.py&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">30</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>worker
<span class="w">    </span>time.sleep<span class="o">(</span><span class="m">1</span>.2<span class="o">)</span>

thread<span class="w"> </span>&lt;Thread<span class="o">(</span>Thread-1,<span class="w"> </span>started<span class="w"> </span><span class="m">123145560354816</span><span class="o">)</span>&gt;:
<span class="w">  </span>File<span class="w"> </span><span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">884</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>_bootstrap
<span class="w">    </span>self._bootstrap_inner<span class="o">()</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">916</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>_bootstrap_inner
<span class="w">    </span>self.run<span class="o">()</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">864</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>run
<span class="w">    </span>self._target<span class="o">(</span>*self._args,<span class="w"> </span>**self._kwargs<span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">&quot;testa.py&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">36</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>producer
<span class="w">    </span>time.sleep<span class="o">(</span><span class="m">1</span><span class="o">)</span>

thread<span class="w"> </span>&lt;_MainThread<span class="o">(</span>MainThread,<span class="w"> </span>started<span class="w"> </span><span class="m">140736812057536</span><span class="o">)</span>&gt;:
<span class="w">  </span>File<span class="w"> </span><span class="s2">&quot;testa.py&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">47</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
<span class="w">    </span>t.join<span class="o">()</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">1056</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>join
<span class="w">    </span>self._wait_for_tstate_lock<span class="o">()</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">1072</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>_wait_for_tstate_lock
<span class="w">    </span><span class="k">elif</span><span class="w"> </span>lock.acquire<span class="o">(</span>block,<span class="w"> </span>timeout<span class="o">)</span>:
<span class="w">  </span>File<span class="w"> </span><span class="s2">&quot;testa.py&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">15</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>output_tracebacks
<span class="w">    </span><span class="nv">stack_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>traceback.format_list<span class="o">(</span>traceback.extract_stack<span class="o">(</span>stack<span class="o">))</span>
</pre></div>
<p>For more on getting traceback information see <a class="reference external" href="http://mozillazg.com/2017/12/python-get-concurrency-programm-all-tracebacks-threading-gevent-asyncio-etc-en.html">Python: Getting traceback information for concurrent programs (threading/gevent/asyncio)</a></p>
</div>
<div class="section" id="enable-remote-debugging-service-when-signal-is-received">
<h2 id="hidenable-remote-debugging-service-when-signal-is-received">Enable remote debugging service when signal is received<a class="headerlink" href="#hidenable-remote-debugging-service-when-signal-is-received" title="Permalink to this headline">¶</a></h2>
<p>For example, if you open a remote debugger (Python Shell) that uses the current runtime environment of the process, you can access the global variables that change at runtime in this debugger and execute code using the current runtime environment of the process:</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">code</span> <span class="kn">import</span> <span class="n">InteractiveConsole</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">socketserver</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>


<span class="k">class</span> <span class="nc">FileLikeObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rfile</span><span class="p">,</span> <span class="n">wfile</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rfile</span> <span class="o">=</span> <span class="n">rfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wfile</span> <span class="o">=</span> <span class="n">wfile</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rfile</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wfile</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">isatty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>


<span class="k">class</span> <span class="nc">DebuggerTCPHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">StreamRequestHandler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fileobj</span> <span class="o">=</span> <span class="n">FileLikeObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">fileobj</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">console</span> <span class="o">=</span> <span class="n">InteractiveConsole</span><span class="p">(</span><span class="nb">locals</span><span class="o">=</span><span class="nb">globals</span><span class="p">())</span>
            <span class="n">console</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">banner</span><span class="o">=</span><span class="s1">&#39;== debug server ==&#39;</span><span class="p">,</span> <span class="n">exitmsg</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdin__</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span>


<span class="k">def</span> <span class="nf">output_tracebacks</span><span class="p">():</span>
    <span class="n">id2thread</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threading</span><span class="o">.</span><span class="n">enumerate</span><span class="p">():</span>
        <span class="n">id2thread</span><span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">ident</span><span class="p">]</span> <span class="o">=</span> <span class="n">thread</span>
    <span class="k">for</span> <span class="n">thread_id</span><span class="p">,</span> <span class="n">stack</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">_current_frames</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">stack_list</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_list</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">extract_stack</span><span class="p">(</span><span class="n">stack</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;thread </span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id2thread</span><span class="p">[</span><span class="n">thread_id</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stack_list</span><span class="p">))</span>


<span class="n">debugger</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">start_debugger</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;start debugger...&#39;</span><span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">((</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">9999</span><span class="p">),</span> <span class="n">DebuggerTCPHandler</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">global</span> <span class="n">debugger</span>
    <span class="n">debugger</span> <span class="o">=</span> <span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;started debugger&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">close_debugger</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;close debugger...&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debugger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;closed debugger&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">server</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">debugger</span>
    <span class="n">server</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
    <span class="n">server</span><span class="o">.</span><span class="n">server_close</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;closed debugger&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">setup_backdoor</span><span class="p">():</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="n">start_debugger</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR2</span><span class="p">,</span> <span class="n">close_debugger</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c1"># do something with task</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">producer</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>


<span class="n">setup_backdoor</span><span class="p">()</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">producer</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,))</span>
<span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,))</span>
<span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">]:</span>
    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
<p>Run the program, activate the remote debugger via <cite>USR1</cite> and close the remote debugging service via <cite>USR2</cite> after debugging:</p>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">python</span> <span class="n">testb</span><span class="o">.</span><span class="n">py</span> <span class="o">&amp;</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="mi">87173</span>
<span class="err">$</span> <span class="n">kill</span> <span class="o">-</span><span class="n">s</span> <span class="n">USR1</span> <span class="mi">87173</span>
<span class="n">start</span> <span class="n">debugger</span><span class="o">...</span>
<span class="n">started</span> <span class="n">debugger</span>
<span class="err">$</span>
<span class="err">$</span> <span class="n">telnet</span> <span class="mf">127.0.0.1</span> <span class="mi">9999</span>
<span class="n">Trying</span> <span class="mf">127.0.0.1</span><span class="o">...</span>
<span class="n">Connected</span> <span class="n">to</span> <span class="n">localhost</span><span class="o">.</span>
<span class="n">Escape</span> <span class="n">character</span> <span class="ow">is</span> <span class="s1">&#39;^]&#39;</span><span class="o">.</span>
<span class="o">==</span> <span class="n">debug</span> <span class="n">server</span> <span class="o">==</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">output_tracebacks</span><span class="p">()</span>
<span class="n">thread</span> <span class="o">&lt;</span><span class="n">Thread</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145482240000</span><span class="p">)</span><span class="o">&gt;</span><span class="p">:</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">884</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_bootstrap</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_bootstrap_inner</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">916</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_bootstrap_inner</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">864</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/socketserver.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">238</span><span class="p">,</span> <span class="ow">in</span> <span class="n">serve_forever</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_request_noblock</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/socketserver.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">317</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_handle_request_noblock</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/socketserver.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">348</span><span class="p">,</span> <span class="ow">in</span> <span class="n">process_request</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">finish_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/socketserver.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">361</span><span class="p">,</span> <span class="ow">in</span> <span class="n">finish_request</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">RequestHandlerClass</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/socketserver.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">696</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__init__</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">&quot;testb.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">52</span><span class="p">,</span> <span class="ow">in</span> <span class="n">handle</span>
    <span class="n">console</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">banner</span><span class="o">=</span><span class="s1">&#39;== debug server ==&#39;</span><span class="p">,</span> <span class="n">exitmsg</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/code.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">233</span><span class="p">,</span> <span class="ow">in</span> <span class="n">interact</span>
    <span class="n">more</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/code.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">259</span><span class="p">,</span> <span class="ow">in</span> <span class="n">push</span>
    <span class="n">more</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runsource</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/code.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">75</span><span class="p">,</span> <span class="ow">in</span> <span class="n">runsource</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">runcode</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/code.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">91</span><span class="p">,</span> <span class="ow">in</span> <span class="n">runcode</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;console&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s2">&quot;testb.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">66</span><span class="p">,</span> <span class="ow">in</span> <span class="n">output_tracebacks</span>
    <span class="n">stack_list</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_list</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">extract_stack</span><span class="p">(</span><span class="n">stack</span><span class="p">))</span>

<span class="n">thread</span> <span class="o">&lt;</span><span class="n">Thread</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145476984832</span><span class="p">)</span><span class="o">&gt;</span><span class="p">:</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">884</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_bootstrap</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_bootstrap_inner</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">916</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_bootstrap_inner</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">864</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;testb.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">108</span><span class="p">,</span> <span class="ow">in</span> <span class="n">worker</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.2</span><span class="p">)</span>

<span class="n">thread</span> <span class="o">&lt;</span><span class="n">Thread</span><span class="p">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145471729664</span><span class="p">)</span><span class="o">&gt;</span><span class="p">:</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">884</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_bootstrap</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_bootstrap_inner</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">916</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_bootstrap_inner</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">864</span><span class="p">,</span> <span class="ow">in</span> <span class="n">run</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;testb.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">114</span><span class="p">,</span> <span class="ow">in</span> <span class="n">producer</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">thread</span> <span class="o">&lt;</span><span class="n">_MainThread</span><span class="p">(</span><span class="n">MainThread</span><span class="p">,</span> <span class="n">started</span> <span class="mi">140736812057536</span><span class="p">)</span><span class="o">&gt;</span><span class="p">:</span>
  <span class="n">File</span> <span class="s2">&quot;testb.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">125</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1056</span><span class="p">,</span> <span class="ow">in</span> <span class="n">join</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_tstate_lock</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/threading.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1072</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_wait_for_tstate_lock</span>
    <span class="k">elif</span> <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">q</span>
<span class="o">&lt;</span><span class="n">queue</span><span class="o">.</span><span class="n">Queue</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10a2e8fd0</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
<span class="mi">13</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
<span class="mi">14</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">exit</span><span class="p">()</span>
<span class="n">Connection</span> <span class="n">closed</span> <span class="n">by</span> <span class="n">foreign</span> <span class="n">host</span><span class="o">.</span>

<span class="err">$</span> <span class="n">jobs</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span>  <span class="n">Running</span>                 <span class="n">python</span> <span class="n">testb</span><span class="o">.</span><span class="n">py</span> <span class="o">&amp;</span>
<span class="err">$</span> <span class="n">kill</span> <span class="o">-</span><span class="n">s</span> <span class="n">USR2</span> <span class="mi">87173</span>
<span class="n">close</span> <span class="n">debugger</span><span class="o">...</span>
<span class="n">closed</span> <span class="n">debugger</span>

<span class="err">$</span> <span class="n">telnet</span> <span class="mf">127.0.0.1</span> <span class="mi">9999</span>
<span class="n">Trying</span> <span class="mf">127.0.0.1</span><span class="o">...</span>
<span class="n">telnet</span><span class="p">:</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">address</span> <span class="mf">127.0.0.1</span><span class="p">:</span> <span class="n">Connection</span> <span class="n">refused</span>
<span class="n">telnet</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">remote</span> <span class="n">host</span>
</pre></div>
<p>The above code is just a rough demonstration of how to implement a remote debugger, for a formal remote debugger you can refer to and use <a class="reference external" href="http://www.gevent.org/gevent.backdoor.html">gevent.backdoor</a> or <a class="reference external" href="http://twistedmatrix.com/documents/current/api/twisted.conch.manhole.html">twisted.conch.manhole</a>  <a class="reference external" href="https://github.com/ionelmc/python-manhole">ionelmc/python-manhole</a> and other full-featured third-party modules.</p>
</div>
<div class="section" id="summary">
<h2 id="hidsummary">Summary<a class="headerlink" href="#hidsummary" title="Permalink to this headline">¶</a></h2>
<p>The above two examples are just common pre-set backdoors, in fact, you can also pre-set other functions (for example, pre-set an HTTP server, access different URLs to get different runtime information or do some auxiliary debugging operations), all for debugging, all in order to locate and solve problems as soon as possible. Which backdoors need to be preset should be determined by the actual situation, on the one hand, to consider whether it will affect the normal operation of the service, on the other hand, we also need to consider which way which information can help us locate and solve problems faster, and most importantly <strong>to consider security issues</strong>, to do a good job of security protection, do not expose the port to the Internet.</p>
<p>Although the title and the examples in the article are Python related, the idea is not limited to Python, but can be applied to services written in other languages as well. Feel free to share and discuss debugging techniques and problem solving with me.</p>
</div>
<div class="section" id="references">
<h2 id="hidreferences">References<a class="headerlink" href="#hidreferences" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://docs.python.org/3.6/library/signal.html#signal.signal">18.8. signal — Set handlers for asynchronous events — Python 3.6.4 documentation</a></li>
<li><a class="reference external" href="http://mozillazg.com/2017/12/python-get-concurrency-programm-all-tracebacks-threading-gevent-asyncio-etc-en.html">Python: get traceback information（threading/gevent/asyncio） - mozillazg's blog</a></li>
<li><a class="reference external" href="http://www.gevent.org/gevent.backdoor.html">gevent.backdoor – Interactive greenlet-based network console that can be used in any process — gevent 1.3.0.dev0 documentation</a></li>
<li><a class="reference external" href="http://twistedmatrix.com/documents/current/api/twisted.conch.manhole.html">twisted.conch.manhole : API documentation</a></li>
<li><a class="reference external" href="https://github.com/ionelmc/python-manhole">ionelmc/python-manhole: Debugging manhole for python applications.</a></li>
<li><a class="reference external" href="https://docs.python.org/3.6/library/socketserver.html#socketserver.StreamRequestHandler">21.21. socketserver — A framework for network servers — Python 3.6.4 documentation</a></li>
<li><a class="reference external" href="https://docs.python.org/3.6/library/code.html#code.InteractiveConsole">30.1. code — Interpreter base classes — Python 3.6.4 documentation</a></li>
</ul>
</div>

                </div>
            </div>
            <!-- /.entry-content -->
<section class="text-center">
  
<div id="donate"></div>

<div class="social-share"></div>
<div class="social-comment-note">
<p class="text-center">有任何建议和想法欢迎在下方评论区留言或者加我<a href="/static/wechat.png">微信</a>交流</p>
</div>

</section>
<hr/>
<section class="comments" id="comments">
    <h2>Comments</h2>
    <script src="https://giscus.app/client.js"
            data-repo="mozillazg/mozillazg.github.com"
            data-repo-id="MDEwOlJlcG9zaXRvcnk3Njc4MTA2"
            data-category="Announcements"
            data-category-id="DIC_kwDOAHUoms4CckZl"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="bottom"
            data-theme="preferred_color_scheme"
            data-lang="en"
            data-loading="lazy"
            crossorigin="anonymous"
            async>
    </script>
</section>
        </article>
    </section>

        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2024 mozillazg
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>
            &middot; <a href="/privacy-policy.html" target="_blank">Privacy</a>              <p><small>  <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="/static/images/by-sa-80x15.png" /></a>
    &quot;<span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">mozillazg's Blog</span>&quot; by <a xmlns:cc="http://creativecommons.org/ns#" href="https://mozillazg.com" property="cc:attributionName" rel="cc:attributionURL">mozillazg</a> is
  licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/jquery@2.1.1/dist/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->

    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-77172981-1', 'auto');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->

<!-- share.js -->
<script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script>



<script src="https://cdn.jsdelivr.net/npm/tocbot@3.0.2/dist/tocbot.min.js"></script>
<script>
$(document).ready(function(){
  tocbot.init({
    // Where to render the table of contents.
    tocSelector: '.js-toc',
    // Where to grab the headings to build the table of contents.
    contentSelector: '.entry-content',
    // Which headings to grab inside of the contentSelector element.
    headingSelector: 'h2, h3, h4,h5',
    // Headings that match the ignoreSelector will be skipped.
    ignoreSelector: '.js-toc-ignore',
    // Main class to add to links.
    linkClass: 'toc-link',
    // Extra classes to add to links.
    extraLinkClasses: '',
    // Class to add to active links,
    // the link corresponding to the top most heading on the page.
    activeLinkClass: 'is-active-link',
    // Main class to add to lists.
    listClass: 'toc-list',
    // Extra classes to add to lists.
    extraListClasses: '',
    // Class that gets added when a list should be collapsed.
    isCollapsedClass: 'is-collapsed',
    // Class that gets added when a list should be able
    // to be collapsed but isn't necessarily collpased.
    collapsibleClass: 'is-collapsible',
    // Class to add to list items.
    listItemClass: 'toc-list-item',
    // How many heading levels should not be collpased.
    // For example, number 6 will show everything since
    // there are only 6 heading levels and number 0 will collpase them all.
    // The sections that are hidden will open
    // and close as you scroll to headings within them.
    collapseDepth: 6,
    // Smooth scrolling enabled.
    smoothScroll: true,
    // Smooth scroll duration.
    smoothScrollDuration: 420,
    // Callback for scroll end (requires: smoothScroll).
    scrollEndCallback: function (e) {},
    // Headings offset between the headings and the top of the document (this is meant for minor adjustments).
    headingsOffset: 0,
    // Timeout between events firing to make sure it's
    // not too rapid (for performance reasons).
    throttleTimeout: 50,
    // Element to add the positionFixedClass to.
    positionFixedSelector: null,
    // Fixed position class to add to make sidebar fixed after scrolling
    // down past the fixedSidebarOffset.
    positionFixedClass: 'is-position-fixed',
    // fixedSidebarOffset can be any number but by default is set
    // to auto which sets the fixedSidebarOffset to the sidebar
    // element's offsetTop from the top of the document on init.
    fixedSidebarOffset: 'auto',
    // includeHtml can be set to true to include the HTML markup from the
    // heading node instead of just including the textContent.
    includeHtml: false
  });
});
</script>
</body>
</html>