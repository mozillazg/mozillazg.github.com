<!DOCTYPE html>
<html lang="zh"  prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml" class="han-init">
<head>
    <title>Python: Mock 常用功能 - mozillazg's Blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- share.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css">


    <link href="https://mozillazg.com/favicon.ico" rel="icon">

<link rel="canonical" href="https://mozillazg.com/2018/03/python-introduction-mock-unit-test-examples-cookbook.html">

        <meta name="author" content="mozillazg" />
        <meta name="keywords" content="python,unittest,mock" />
    <meta name="description" content="前言 unittest.mock is a library for testing in Python. It allows you to replace parts of your system under test with mock objects and make assertions about how they have been used. Python 3.3 新增了一个可以用来在单元测试的时候进行 mock 操作的 unittest.mock 模块。 对于 Python 3.3 之前的版本也可以通过 pip install mock 安装拥有相同功能的移植版模块 mock 。本文记录一些常用的 unittest.mock 模块的用法，理论上同样也适用于 mock 这个第三方模块（注：本文例子是在 Python 3.6 下测试的）。 常见用法 定义返回值 &gt;&gt;&gt; from unittest.mock import MagicMock &gt;&gt;&gt; mock = MagicMock(return_value=3) &gt;&gt;&gt; # or &gt;&gt;&gt; # mock = MagicMock() &gt;&gt;&gt; # mock.return_value = 3 &gt;&gt;&gt; mock() 3 定义变化的返回值 &gt;&gt;&gt; mock = MagicMock(side_effect=[1, 2, 3]) # or # &gt;&gt;&gt; mock = MagicMock() # &gt;&gt;&gt; mock.side_effect = [1, 2, 3] &gt;&gt;&gt; mock() 1 &gt;&gt;&gt; mock() 2 &gt;&gt;&gt; mock() 3 &gt;&gt;&gt; mock() Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 939, in __call__ return _mock_self._mock_call(*args, **kwargs) File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 998, in _mock_call result = next(effect) StopIteration &gt;&gt;&gt; def side_effect(arg=1): ... return arg ... &gt;&gt;&gt; m = MagicMock(side_effect=side_effect) &gt;&gt;&gt; m() 1 &gt;&gt;&gt; m(1) 1 &gt;&gt;&gt; m(2) 2 定义抛出异常 &gt;&gt;&gt; m.side_effect = KeyError &gt;&gt;&gt; m() Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/python3.6/unittest/mock.py&#34;, line 939, in __call__ return _mock_self._mock_call(*args, **kwargs) File &#34;/xxx/python3.6/unittest/mock.py&#34;, line 995, in _mock_call raise effect KeyError &gt;&gt;&gt; mock 变量/属性 example.py: foo = {} def bar(): return foo class FooBar: def __init__(self): self.msg = &#39;test&#39; def hello(self): return &#39;hello&#39; def foobar(): return FooBar().hello() fb = FooBar() def hello(): return fb.msg &gt;&gt;&gt; from unittest.mock import patch &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m.test = MagicMock(return_value=233) &gt;&gt;&gt; m() &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372854824&#39;&gt; &gt;&gt;&gt; m.test &lt;MagicMock name=&#39;mock.test&#39; id=&#39;4372854768&#39;&gt; &gt;&gt;&gt; m.test() 233 &gt;&gt;&gt; &gt;&gt;&gt; import example &gt;&gt;&gt; example.foo {} &gt;&gt;&gt; example.hello() &#39;test&#39; &gt;&gt;&gt; with patch.object(example, &#39;foo&#39;, {&#39;lalala&#39;: 233}): ... example.foo ... {&#39;lalala&#39;: 233} &gt;&gt;&gt; example.foo {} &gt;&gt;&gt; with patch.object(example.fb, &#39;msg&#39;, 666): ... example.hello() ... 666 &gt;&gt;&gt; example.hello() &#39;test&#39; mock dict &gt;&gt;&gt; foo = {&#39;a&#39;: 233} &gt;&gt;&gt; &gt;&gt;&gt; foo[&#39;a&#39;] 233 &gt;&gt;&gt; &gt;&gt;&gt; with patch.dict(foo, {&#39;a&#39;: 666, &#39;b&#39;: 222}): ... print(foo[&#39;a&#39;]) ... print(foo[&#39;b&#39;]) ... 666 222 &gt;&gt;&gt; foo[&#39;a&#39;] 233 &gt;&gt;&gt; &#39;b&#39; in foo False &gt;&gt;&gt; with patch.dict(foo, a=666, b=222): ... print(foo[&#39;a&#39;]) ... print(foo[&#39;b&#39;]) ... 666 222 &gt;&gt;&gt; foo[&#39;a&#39;] 233 &gt;&gt;&gt; mock 函数 &gt;&gt;&gt; import example &gt;&gt;&gt; from unittest.mock import MagicMock, patch &gt;&gt;&gt; example.bar() {} &gt;&gt;&gt; with patch(&#39;example.bar&#39;, MagicMock(return_value=233)): ... example.bar() ... 233 &gt;&gt;&gt; &gt;&gt;&gt; with patch.object(example, &#39;bar&#39;, MagicMock(return_value=233)): ... example.bar() ... example.bar(233) ... 233 233 &gt;&gt;&gt; &gt;&gt;&gt; with patch.object(example, &#39;bar&#39;, autospec=True) as bar: ... bar.return_value = 666 ... example.bar() ... 666 &gt;&gt;&gt; with patch.object(example, &#39;bar&#39;, autospec=True): ... example.bar(233) ... Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 2, in &lt;module&gt; File &#34;&lt;string&gt;&#34;, line 2, in bar File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 171, in checksig sig.bind(*args, **kwargs) File &#34;/xxx/lib/python3.6/inspect.py&#34;, line 2934, in bind return args[0]._bind(args[1:], kwargs) File &#34;/xxx/lib/python3.6/inspect.py&#34;, line 2855, in _bind raise TypeError(&#39;too many positional arguments&#39;) from None TypeError: too many positional arguments autospec=True 可以保证 mock 后的对象拥有跟原来一样的函数签名。 mock 方法 &gt;&gt;&gt; example.foobar() &#39;hello&#39; &gt;&gt;&gt; with patch(&#39;example.FooBar&#39;) as mocked_cls: ... instance = MagicMock() ... instance.hello = MagicMock(return_value=&#39;mocked_hello_method&#39;) ... mocked_cls.return_value = instance ... example.foobar() ... &#39;mocked_hello_method&#39; &gt;&gt;&gt; mock @property 装饰的方法 可以使用 PropertyMock mock @property 装饰的方法以及描述符。 &gt;&gt;&gt; class Foo: ... def __init__(self): ... self._bar = 233 ... @property ... def bar(self): ... return self._bar ... @bar.setter ... def bar(self, value): ... self._bar = value ... &gt;&gt;&gt; f = Foo() &gt;&gt;&gt; f.bar 233 &gt;&gt;&gt; f.bar = 666 &gt;&gt;&gt; f.bar 666 &gt;&gt;&gt; with patch(&#39;__main__.Foo.bar&#39;, new_callable=PropertyMock) as mock_bar: ... mock_bar.return_value = &#39;mocked_bar&#39; ... foo = Foo() ... print(foo.bar) ... foo.bar = 266 ... print(foo.bar) ... mocked_bar mocked_bar &gt;&gt;&gt; mock_bar &lt;PropertyMock name=&#39;bar&#39; id=&#39;4373101536&#39;&gt; &gt;&gt;&gt; mock_bar.mock_calls [call(), call(266), call()] &gt;&gt;&gt; mock 内置函数 test.py: def to_str(obj): return str(obj) &gt;&gt;&gt; test.to_str(&#39;233&#39;) &#39;233&#39; &gt;&gt;&gt; with patch.object(__builtins__, &#39;str&#39;, int): ... test.to_str(&#39;233&#39;) ... test.to_str(&#39;foobar&#39;) ... 233 Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 3, in &lt;module&gt; File &#34;/xxx/test.py&#34;, line 2, in to_str return str(obj) ValueError: invalid literal for int() with base 10: &#39;foobar&#39; &gt;&gt;&gt; mock open 函数 read: &gt;&gt;&gt; from unittest.mock import mock_open &gt;&gt;&gt; m = mock_open(read_data=&#39;mocked data&#39;) &gt;&gt;&gt; with patch(&#39;__main__.open&#39;, m): ... with open(&#39;test&#39;) as fp: ... print(fp.read()) ... mocked data &gt;&gt;&gt; m &lt;MagicMock name=&#39;open&#39; spec=&#39;builtin_function_or_method&#39; id=&#39;4369854192&#39;&gt; &gt;&gt;&gt; m.mock_calls [call(&#39;test&#39;), call().__enter__(), call().read(), call().__exit__(None, None, None)] &gt;&gt;&gt; write: &gt;&gt;&gt; m2 = mock_open() &gt;&gt;&gt; with patch(&#39;__main__.open&#39;, m2): ... with open(&#39;bar&#39;, &#39;w&#39;) as fp: ... fp.write(&#39;write data&#39;) ... &gt;&gt;&gt; m2.mock_calls [call(&#39;bar&#39;, &#39;w&#39;), call().__enter__(), call().write(&#39;write data&#39;), call().__exit__(None, None, None)] &gt;&gt;&gt; m2().write.mock_calls [call(&#39;write data&#39;)] &gt;&gt;&gt; mock isinstance 可以用 __class__ 属性来通过 mock 对象的 isinstance 检查: &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m.__class__ = int &gt;&gt;&gt; isinstance(m, int) True &gt;&gt;&gt; m.__class__ = dict &gt;&gt;&gt; isinstance(m, dict) True &gt;&gt;&gt; mock 真值判断 可以通过 mock __bool__ 方法（Python 3） 或 __nonzero__ 方法(Python 2) 来 mock 对对象的真值判断: &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; bool(m) True &gt;&gt;&gt; m = MagicMock(__bool__=MagicMock(return_value=False)) &gt;&gt;&gt; bool(m) False &gt;&gt;&gt; if not m: print(&#39;false&#39;) ... false &gt;&gt;&gt; mock 特殊属性 所谓的特殊属性就是 Mock/MagicMock 对象自带的属性（自带一些可选参数 [1] ）， 比如 name ， 如果我们要 mock 的对象也有一个 name 属性的话， 通过 MagicMock(name=&#39;foo&#39;) 是无法 mock name 这个属性的， 可以用下面两种方法实现 mock 特殊属性: 覆盖 mock 对象的属性: &gt;&gt;&gt; m = MagicMock(name=&#39;foo&#39;) &gt;&gt;&gt; m.name &lt;MagicMock name=&#39;foo.name&#39; id=&#39;4372898816&#39;&gt; &gt;&gt;&gt; &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m.name = &#39;foo&#39; &gt;&gt;&gt; m.name &#39;foo&#39; &gt;&gt;&gt; 使用 configure_mock: &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m.name &lt;MagicMock name=&#39;mock.name&#39; id=&#39;4373042848&#39;&gt; &gt;&gt;&gt; m.configure_mock(name=&#39;foo&#39;) &gt;&gt;&gt; m.name &#39;foo&#39; &gt;&gt;&gt; 自动撤销 mock patch, patch.object 都支持通过 with 语句或者装饰器可以实现 只在指定函数/方法/块中应用 mock ，函数/方法/块结束后自动撤销 mock &gt;&gt;&gt; str(&#39;abc&#39;) &#39;abc&#39; &gt;&gt;&gt; with patch.object(__builtins__, &#39;str&#39;, int): ... str(&#39;abc&#39;) ... Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 2, in &lt;module&gt; ValueError: invalid literal for int() with base 10: &#39;abc&#39; &gt;&gt;&gt; str(&#39;abc&#39;) &#39;abc&#39; &gt;&gt;&gt; &gt;&gt;&gt; @patch.object(__builtins__, &#39;str&#39;, int) ... def test(): ... str(&#39;abc&#39;) ... &gt;&gt;&gt; str(&#39;abc&#39;) &#39;abc&#39; &gt;&gt;&gt; test() Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 1179, in patched return func(*args, **keywargs) File &#34;&lt;stdin&gt;&#34;, line 3, in test ValueError: invalid literal for int() with base 10: &#39;abc&#39; &gt;&gt;&gt; 常用检查方法 mock 的对象拥有一些可以用于单元测试的检查方法，可以用来测试 mock 对象的调用情况。 检查调用次数 待检查的 mock 对象: &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m(1) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372904760&#39;&gt; &gt;&gt;&gt; m(2) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372904760&#39;&gt; &gt;&gt;&gt; m(3) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372904760&#39;&gt; &gt;&gt;&gt; .called: 是否被调用过 &gt;&gt;&gt; m.called True &gt;&gt;&gt; .call_count: 获取调用次数 &gt;&gt;&gt; m.call_count 3 .assert_called(): 检查是否被调用过，如果没有被调用过，则会抛出 AssertionError 异常 &gt;&gt;&gt; m.assert_called() &gt;&gt;&gt; .assert_called_once(): 确保调用过一次，如果没调用或多于一次，则抛出 AssertionError 异常 &gt;&gt;&gt; m.assert_called_once() Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 795, in assert_called_once raise AssertionError(msg) AssertionError: Expected &#39;mock&#39; to have been called once. Called 3 times. &gt;&gt;&gt; .assert_not_called(): 确保没被调用过，否则抛出 AssertionError 异常 &gt;&gt;&gt; m.assert_not_called() Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 777, in assert_not_called raise AssertionError(msg) AssertionError: Expected &#39;mock&#39; to not have been called. Called 3 times. 检查调用时使用的参数 待检查的 mock 对象: &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m(1, 2, foo=&#39;bar&#39;) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372980792&#39;&gt; .call_args: 最后一次调用时使用的参数，未调用则返回 None &gt;&gt;&gt; m.call_args call(1, 2, foo=&#39;bar&#39;) &gt;&gt;&gt; .assert_called_once_with(*args, **kwargs): 确保只调用过一次，并且使用特定参数调用 &gt;&gt;&gt; m.assert_called_once_with(1, 2, foo=&#39;bar&#39;) &gt;&gt;&gt; &gt;&gt;&gt; m(2) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372980792&#39;&gt; &gt;&gt;&gt; &gt;&gt;&gt; m.assert_called_once_with(1, 2, foo=&#39;bar&#39;) Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 824, in assert_called_once_with raise AssertionError(msg) AssertionError: Expected &#39;mock&#39; to be called once. Called 2 times. &gt;&gt;&gt; .assert_any_call(*args, **kwargs): 检查某次用特定参数进行过调用 &gt;&gt;&gt; m.assert_any_call(1, 2, foo=&#39;bar&#39;) &gt;&gt;&gt; .assert_called_with(*args, **kwargs): 检查最后一次调用时使用的参数 &gt;&gt;&gt; m.assert_called_with(2) &gt;&gt;&gt; &gt;&gt;&gt; m.assert_called_with(1, 2, foo=&#39;bar&#39;) Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 814, in assert_called_with raise AssertionError(_error_message()) from cause AssertionError: Expected call: mock(1, 2, foo=&#39;bar&#39;) Actual call: mock(2) &gt;&gt;&gt; .call_args_list: 所有调用时使用的参数列表 &gt;&gt;&gt; m.call_args_list [call(1, 2, foo=&#39;bar&#39;), call(2)] &gt;&gt;&gt; m(3) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372980792&#39;&gt; &gt;&gt;&gt; m.call_args_list [call(1, 2, foo=&#39;bar&#39;), call(2), call(3)] .assert_has_calls(calls, any_order=False): 检查某几次调用时使用的参数， 如果 any_order 为 False 时必须是挨着的调用顺序，可以是中间的几次调用， 为 True 时 calls 中的记录可以是无序的 &gt;&gt;&gt; from unittest.mock import call &gt;&gt;&gt; m.call_args_list [call(1, 2, foo=&#39;bar&#39;), call(2), call(3)] &gt;&gt;&gt; &gt;&gt;&gt; m.assert_has_calls([call(2), call(3)]) &gt;&gt;&gt; &gt;&gt;&gt; m.assert_has_calls([call(3), call(2)]) Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 846, in assert_has_calls ) from cause AssertionError: Calls not found. Expected: [call(3), call(2)] Actual: [call(1, 2, foo=&#39;bar&#39;), call(2), call(3)] &gt;&gt;&gt; m.assert_has_calls([call(3), call(2)], any_order=True) &gt;&gt;&gt; .method_calls: mock 对象的方法调用记录 &gt;&gt;&gt; m.test_method(2, 3, 3) &lt;MagicMock name=&#39;mock.test_method()&#39; id=&#39;4372935456&#39;&gt; &gt;&gt;&gt; m.method_calls [call.test_method(2, 3, 3)] .mock_calls: 记录 mock 对象的所有调用，包含方法、magic method 以及返回值 mock &gt;&gt;&gt; m.mock_calls [call(1, 2, foo=&#39;bar&#39;), call(2), call(3), call.test_method(2, 3, 3)] &gt;&gt;&gt; &gt;&gt;&gt; m.call_args_list [call(1, 2, foo=&#39;bar&#39;), call(2), call(3)] 手动重置 mock 调用记录 可以使用 .reset_mock() 重置 mock 对象记录的调用记录: &gt;&gt;&gt; m.mock_calls [call(1, 2, foo=&#39;bar&#39;), call(2), call(3), call.test_method(2, 3, 3)] &gt;&gt;&gt; &gt;&gt;&gt; m.call_args_list [call(1, 2, foo=&#39;bar&#39;), call(2), call(3)] &gt;&gt;&gt; &gt;&gt;&gt; m.reset_mock() &gt;&gt;&gt; &gt;&gt;&gt; m.call_args_list [] &gt;&gt;&gt; m.mock_calls [] &gt;&gt;&gt; 总结 本文记录的是平时常用的一些 mock 相关的功能，更多内容详见 官方文档 。 参考资料 26.5. unittest.mock — mock object library — Python 3.6.4 documentation [1]26.5. unittest.mock — mock object library — Python 3.6.4 documentation" />

    <style>
      .js-toc {
        margin-bottom: 20px;
      }
      .donate-modal {
        text-align: center;
      }
      #donate-modal-container .donate-image {
        max-height: 300px !important;
        min-height: inherit !important;
      }
    </style>

        <meta property="og:site_name" content="mozillazg's Blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Python: Mock 常用功能"/>
        <meta property="og:url" content="https://mozillazg.com/2018/03/python-introduction-mock-unit-test-examples-cookbook.html"/>
        <meta property="og:description" content="前言 unittest.mock is a library for testing in Python. It allows you to replace parts of your system under test with mock objects and make assertions about how they have been used. Python 3.3 新增了一个可以用来在单元测试的时候进行 mock 操作的 unittest.mock 模块。 对于 Python 3.3 之前的版本也可以通过 pip install mock 安装拥有相同功能的移植版模块 mock 。本文记录一些常用的 unittest.mock 模块的用法，理论上同样也适用于 mock 这个第三方模块（注：本文例子是在 Python 3.6 下测试的）。 常见用法 定义返回值 &gt;&gt;&gt; from unittest.mock import MagicMock &gt;&gt;&gt; mock = MagicMock(return_value=3) &gt;&gt;&gt; # or &gt;&gt;&gt; # mock = MagicMock() &gt;&gt;&gt; # mock.return_value = 3 &gt;&gt;&gt; mock() 3 定义变化的返回值 &gt;&gt;&gt; mock = MagicMock(side_effect=[1, 2, 3]) # or # &gt;&gt;&gt; mock = MagicMock() # &gt;&gt;&gt; mock.side_effect = [1, 2, 3] &gt;&gt;&gt; mock() 1 &gt;&gt;&gt; mock() 2 &gt;&gt;&gt; mock() 3 &gt;&gt;&gt; mock() Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 939, in __call__ return _mock_self._mock_call(*args, **kwargs) File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 998, in _mock_call result = next(effect) StopIteration &gt;&gt;&gt; def side_effect(arg=1): ... return arg ... &gt;&gt;&gt; m = MagicMock(side_effect=side_effect) &gt;&gt;&gt; m() 1 &gt;&gt;&gt; m(1) 1 &gt;&gt;&gt; m(2) 2 定义抛出异常 &gt;&gt;&gt; m.side_effect = KeyError &gt;&gt;&gt; m() Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/python3.6/unittest/mock.py&#34;, line 939, in __call__ return _mock_self._mock_call(*args, **kwargs) File &#34;/xxx/python3.6/unittest/mock.py&#34;, line 995, in _mock_call raise effect KeyError &gt;&gt;&gt; mock 变量/属性 example.py: foo = {} def bar(): return foo class FooBar: def __init__(self): self.msg = &#39;test&#39; def hello(self): return &#39;hello&#39; def foobar(): return FooBar().hello() fb = FooBar() def hello(): return fb.msg &gt;&gt;&gt; from unittest.mock import patch &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m.test = MagicMock(return_value=233) &gt;&gt;&gt; m() &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372854824&#39;&gt; &gt;&gt;&gt; m.test &lt;MagicMock name=&#39;mock.test&#39; id=&#39;4372854768&#39;&gt; &gt;&gt;&gt; m.test() 233 &gt;&gt;&gt; &gt;&gt;&gt; import example &gt;&gt;&gt; example.foo {} &gt;&gt;&gt; example.hello() &#39;test&#39; &gt;&gt;&gt; with patch.object(example, &#39;foo&#39;, {&#39;lalala&#39;: 233}): ... example.foo ... {&#39;lalala&#39;: 233} &gt;&gt;&gt; example.foo {} &gt;&gt;&gt; with patch.object(example.fb, &#39;msg&#39;, 666): ... example.hello() ... 666 &gt;&gt;&gt; example.hello() &#39;test&#39; mock dict &gt;&gt;&gt; foo = {&#39;a&#39;: 233} &gt;&gt;&gt; &gt;&gt;&gt; foo[&#39;a&#39;] 233 &gt;&gt;&gt; &gt;&gt;&gt; with patch.dict(foo, {&#39;a&#39;: 666, &#39;b&#39;: 222}): ... print(foo[&#39;a&#39;]) ... print(foo[&#39;b&#39;]) ... 666 222 &gt;&gt;&gt; foo[&#39;a&#39;] 233 &gt;&gt;&gt; &#39;b&#39; in foo False &gt;&gt;&gt; with patch.dict(foo, a=666, b=222): ... print(foo[&#39;a&#39;]) ... print(foo[&#39;b&#39;]) ... 666 222 &gt;&gt;&gt; foo[&#39;a&#39;] 233 &gt;&gt;&gt; mock 函数 &gt;&gt;&gt; import example &gt;&gt;&gt; from unittest.mock import MagicMock, patch &gt;&gt;&gt; example.bar() {} &gt;&gt;&gt; with patch(&#39;example.bar&#39;, MagicMock(return_value=233)): ... example.bar() ... 233 &gt;&gt;&gt; &gt;&gt;&gt; with patch.object(example, &#39;bar&#39;, MagicMock(return_value=233)): ... example.bar() ... example.bar(233) ... 233 233 &gt;&gt;&gt; &gt;&gt;&gt; with patch.object(example, &#39;bar&#39;, autospec=True) as bar: ... bar.return_value = 666 ... example.bar() ... 666 &gt;&gt;&gt; with patch.object(example, &#39;bar&#39;, autospec=True): ... example.bar(233) ... Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 2, in &lt;module&gt; File &#34;&lt;string&gt;&#34;, line 2, in bar File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 171, in checksig sig.bind(*args, **kwargs) File &#34;/xxx/lib/python3.6/inspect.py&#34;, line 2934, in bind return args[0]._bind(args[1:], kwargs) File &#34;/xxx/lib/python3.6/inspect.py&#34;, line 2855, in _bind raise TypeError(&#39;too many positional arguments&#39;) from None TypeError: too many positional arguments autospec=True 可以保证 mock 后的对象拥有跟原来一样的函数签名。 mock 方法 &gt;&gt;&gt; example.foobar() &#39;hello&#39; &gt;&gt;&gt; with patch(&#39;example.FooBar&#39;) as mocked_cls: ... instance = MagicMock() ... instance.hello = MagicMock(return_value=&#39;mocked_hello_method&#39;) ... mocked_cls.return_value = instance ... example.foobar() ... &#39;mocked_hello_method&#39; &gt;&gt;&gt; mock @property 装饰的方法 可以使用 PropertyMock mock @property 装饰的方法以及描述符。 &gt;&gt;&gt; class Foo: ... def __init__(self): ... self._bar = 233 ... @property ... def bar(self): ... return self._bar ... @bar.setter ... def bar(self, value): ... self._bar = value ... &gt;&gt;&gt; f = Foo() &gt;&gt;&gt; f.bar 233 &gt;&gt;&gt; f.bar = 666 &gt;&gt;&gt; f.bar 666 &gt;&gt;&gt; with patch(&#39;__main__.Foo.bar&#39;, new_callable=PropertyMock) as mock_bar: ... mock_bar.return_value = &#39;mocked_bar&#39; ... foo = Foo() ... print(foo.bar) ... foo.bar = 266 ... print(foo.bar) ... mocked_bar mocked_bar &gt;&gt;&gt; mock_bar &lt;PropertyMock name=&#39;bar&#39; id=&#39;4373101536&#39;&gt; &gt;&gt;&gt; mock_bar.mock_calls [call(), call(266), call()] &gt;&gt;&gt; mock 内置函数 test.py: def to_str(obj): return str(obj) &gt;&gt;&gt; test.to_str(&#39;233&#39;) &#39;233&#39; &gt;&gt;&gt; with patch.object(__builtins__, &#39;str&#39;, int): ... test.to_str(&#39;233&#39;) ... test.to_str(&#39;foobar&#39;) ... 233 Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 3, in &lt;module&gt; File &#34;/xxx/test.py&#34;, line 2, in to_str return str(obj) ValueError: invalid literal for int() with base 10: &#39;foobar&#39; &gt;&gt;&gt; mock open 函数 read: &gt;&gt;&gt; from unittest.mock import mock_open &gt;&gt;&gt; m = mock_open(read_data=&#39;mocked data&#39;) &gt;&gt;&gt; with patch(&#39;__main__.open&#39;, m): ... with open(&#39;test&#39;) as fp: ... print(fp.read()) ... mocked data &gt;&gt;&gt; m &lt;MagicMock name=&#39;open&#39; spec=&#39;builtin_function_or_method&#39; id=&#39;4369854192&#39;&gt; &gt;&gt;&gt; m.mock_calls [call(&#39;test&#39;), call().__enter__(), call().read(), call().__exit__(None, None, None)] &gt;&gt;&gt; write: &gt;&gt;&gt; m2 = mock_open() &gt;&gt;&gt; with patch(&#39;__main__.open&#39;, m2): ... with open(&#39;bar&#39;, &#39;w&#39;) as fp: ... fp.write(&#39;write data&#39;) ... &gt;&gt;&gt; m2.mock_calls [call(&#39;bar&#39;, &#39;w&#39;), call().__enter__(), call().write(&#39;write data&#39;), call().__exit__(None, None, None)] &gt;&gt;&gt; m2().write.mock_calls [call(&#39;write data&#39;)] &gt;&gt;&gt; mock isinstance 可以用 __class__ 属性来通过 mock 对象的 isinstance 检查: &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m.__class__ = int &gt;&gt;&gt; isinstance(m, int) True &gt;&gt;&gt; m.__class__ = dict &gt;&gt;&gt; isinstance(m, dict) True &gt;&gt;&gt; mock 真值判断 可以通过 mock __bool__ 方法（Python 3） 或 __nonzero__ 方法(Python 2) 来 mock 对对象的真值判断: &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; bool(m) True &gt;&gt;&gt; m = MagicMock(__bool__=MagicMock(return_value=False)) &gt;&gt;&gt; bool(m) False &gt;&gt;&gt; if not m: print(&#39;false&#39;) ... false &gt;&gt;&gt; mock 特殊属性 所谓的特殊属性就是 Mock/MagicMock 对象自带的属性（自带一些可选参数 [1] ）， 比如 name ， 如果我们要 mock 的对象也有一个 name 属性的话， 通过 MagicMock(name=&#39;foo&#39;) 是无法 mock name 这个属性的， 可以用下面两种方法实现 mock 特殊属性: 覆盖 mock 对象的属性: &gt;&gt;&gt; m = MagicMock(name=&#39;foo&#39;) &gt;&gt;&gt; m.name &lt;MagicMock name=&#39;foo.name&#39; id=&#39;4372898816&#39;&gt; &gt;&gt;&gt; &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m.name = &#39;foo&#39; &gt;&gt;&gt; m.name &#39;foo&#39; &gt;&gt;&gt; 使用 configure_mock: &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m.name &lt;MagicMock name=&#39;mock.name&#39; id=&#39;4373042848&#39;&gt; &gt;&gt;&gt; m.configure_mock(name=&#39;foo&#39;) &gt;&gt;&gt; m.name &#39;foo&#39; &gt;&gt;&gt; 自动撤销 mock patch, patch.object 都支持通过 with 语句或者装饰器可以实现 只在指定函数/方法/块中应用 mock ，函数/方法/块结束后自动撤销 mock &gt;&gt;&gt; str(&#39;abc&#39;) &#39;abc&#39; &gt;&gt;&gt; with patch.object(__builtins__, &#39;str&#39;, int): ... str(&#39;abc&#39;) ... Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 2, in &lt;module&gt; ValueError: invalid literal for int() with base 10: &#39;abc&#39; &gt;&gt;&gt; str(&#39;abc&#39;) &#39;abc&#39; &gt;&gt;&gt; &gt;&gt;&gt; @patch.object(__builtins__, &#39;str&#39;, int) ... def test(): ... str(&#39;abc&#39;) ... &gt;&gt;&gt; str(&#39;abc&#39;) &#39;abc&#39; &gt;&gt;&gt; test() Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 1179, in patched return func(*args, **keywargs) File &#34;&lt;stdin&gt;&#34;, line 3, in test ValueError: invalid literal for int() with base 10: &#39;abc&#39; &gt;&gt;&gt; 常用检查方法 mock 的对象拥有一些可以用于单元测试的检查方法，可以用来测试 mock 对象的调用情况。 检查调用次数 待检查的 mock 对象: &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m(1) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372904760&#39;&gt; &gt;&gt;&gt; m(2) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372904760&#39;&gt; &gt;&gt;&gt; m(3) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372904760&#39;&gt; &gt;&gt;&gt; .called: 是否被调用过 &gt;&gt;&gt; m.called True &gt;&gt;&gt; .call_count: 获取调用次数 &gt;&gt;&gt; m.call_count 3 .assert_called(): 检查是否被调用过，如果没有被调用过，则会抛出 AssertionError 异常 &gt;&gt;&gt; m.assert_called() &gt;&gt;&gt; .assert_called_once(): 确保调用过一次，如果没调用或多于一次，则抛出 AssertionError 异常 &gt;&gt;&gt; m.assert_called_once() Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 795, in assert_called_once raise AssertionError(msg) AssertionError: Expected &#39;mock&#39; to have been called once. Called 3 times. &gt;&gt;&gt; .assert_not_called(): 确保没被调用过，否则抛出 AssertionError 异常 &gt;&gt;&gt; m.assert_not_called() Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 777, in assert_not_called raise AssertionError(msg) AssertionError: Expected &#39;mock&#39; to not have been called. Called 3 times. 检查调用时使用的参数 待检查的 mock 对象: &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m(1, 2, foo=&#39;bar&#39;) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372980792&#39;&gt; .call_args: 最后一次调用时使用的参数，未调用则返回 None &gt;&gt;&gt; m.call_args call(1, 2, foo=&#39;bar&#39;) &gt;&gt;&gt; .assert_called_once_with(*args, **kwargs): 确保只调用过一次，并且使用特定参数调用 &gt;&gt;&gt; m.assert_called_once_with(1, 2, foo=&#39;bar&#39;) &gt;&gt;&gt; &gt;&gt;&gt; m(2) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372980792&#39;&gt; &gt;&gt;&gt; &gt;&gt;&gt; m.assert_called_once_with(1, 2, foo=&#39;bar&#39;) Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 824, in assert_called_once_with raise AssertionError(msg) AssertionError: Expected &#39;mock&#39; to be called once. Called 2 times. &gt;&gt;&gt; .assert_any_call(*args, **kwargs): 检查某次用特定参数进行过调用 &gt;&gt;&gt; m.assert_any_call(1, 2, foo=&#39;bar&#39;) &gt;&gt;&gt; .assert_called_with(*args, **kwargs): 检查最后一次调用时使用的参数 &gt;&gt;&gt; m.assert_called_with(2) &gt;&gt;&gt; &gt;&gt;&gt; m.assert_called_with(1, 2, foo=&#39;bar&#39;) Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 814, in assert_called_with raise AssertionError(_error_message()) from cause AssertionError: Expected call: mock(1, 2, foo=&#39;bar&#39;) Actual call: mock(2) &gt;&gt;&gt; .call_args_list: 所有调用时使用的参数列表 &gt;&gt;&gt; m.call_args_list [call(1, 2, foo=&#39;bar&#39;), call(2)] &gt;&gt;&gt; m(3) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372980792&#39;&gt; &gt;&gt;&gt; m.call_args_list [call(1, 2, foo=&#39;bar&#39;), call(2), call(3)] .assert_has_calls(calls, any_order=False): 检查某几次调用时使用的参数， 如果 any_order 为 False 时必须是挨着的调用顺序，可以是中间的几次调用， 为 True 时 calls 中的记录可以是无序的 &gt;&gt;&gt; from unittest.mock import call &gt;&gt;&gt; m.call_args_list [call(1, 2, foo=&#39;bar&#39;), call(2), call(3)] &gt;&gt;&gt; &gt;&gt;&gt; m.assert_has_calls([call(2), call(3)]) &gt;&gt;&gt; &gt;&gt;&gt; m.assert_has_calls([call(3), call(2)]) Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 846, in assert_has_calls ) from cause AssertionError: Calls not found. Expected: [call(3), call(2)] Actual: [call(1, 2, foo=&#39;bar&#39;), call(2), call(3)] &gt;&gt;&gt; m.assert_has_calls([call(3), call(2)], any_order=True) &gt;&gt;&gt; .method_calls: mock 对象的方法调用记录 &gt;&gt;&gt; m.test_method(2, 3, 3) &lt;MagicMock name=&#39;mock.test_method()&#39; id=&#39;4372935456&#39;&gt; &gt;&gt;&gt; m.method_calls [call.test_method(2, 3, 3)] .mock_calls: 记录 mock 对象的所有调用，包含方法、magic method 以及返回值 mock &gt;&gt;&gt; m.mock_calls [call(1, 2, foo=&#39;bar&#39;), call(2), call(3), call.test_method(2, 3, 3)] &gt;&gt;&gt; &gt;&gt;&gt; m.call_args_list [call(1, 2, foo=&#39;bar&#39;), call(2), call(3)] 手动重置 mock 调用记录 可以使用 .reset_mock() 重置 mock 对象记录的调用记录: &gt;&gt;&gt; m.mock_calls [call(1, 2, foo=&#39;bar&#39;), call(2), call(3), call.test_method(2, 3, 3)] &gt;&gt;&gt; &gt;&gt;&gt; m.call_args_list [call(1, 2, foo=&#39;bar&#39;), call(2), call(3)] &gt;&gt;&gt; &gt;&gt;&gt; m.reset_mock() &gt;&gt;&gt; &gt;&gt;&gt; m.call_args_list [] &gt;&gt;&gt; m.mock_calls [] &gt;&gt;&gt; 总结 本文记录的是平时常用的一些 mock 相关的功能，更多内容详见 官方文档 。 参考资料 26.5. unittest.mock — mock object library — Python 3.6.4 documentation [1]26.5. unittest.mock — mock object library — Python 3.6.4 documentation"/>
        <meta property="article:published_time" content="2018-03-04" />
            <meta property="article:section" content="python" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="unittest" />
            <meta property="article:tag" content="mock" />
            <meta property="article:author" content="mozillazg" />
            <meta property="og:image"
                  content="https://mozillazg.com/static/avatar.jpeg"/>


    <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@mozillazg">
        <meta name="twitter:creator" content="@mozillazg">
    <meta name="twitter:domain" content="https://mozillazg.com">
            <meta property="twitter:image"
                  content="https://mozillazg.com/static/avatar.jpeg"/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.4/dist/css/bootstrap.min.css" type="text/css"/>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/pygments-css@1.0.0/github.css" rel="stylesheet">
    <link rel="stylesheet" href="https://mozillazg.com/theme/css/style.css" type="text/css"/>
            <link href="https://mozillazg.com/static/custom.css" rel="stylesheet">

        <link href="https://mozillazg.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="mozillazg's Blog ATOM Feed"/>

        <link href="https://mozillazg.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="mozillazg's Blog RSS Feed"/>


        <link href="https://mozillazg.com/feeds/python.atom.xml" type="application/atom+xml" rel="alternate"
              title="mozillazg's Blog python ATOM Feed"/>


    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "publisher": {
            "@type": "Person",
            "name": "mozillazg",
            "logo": "https://mozillazg.com/static/avatar.jpeg"
        },
        "author": {
            "@type": "Person",
            "name": "mozillazg",
            "image": "https://mozillazg.com/static/avatar.jpeg",
            "url": "https://mozillazg.com",
            "sameAs": []
        },
        "headline": "Python: Mock 常用功能",
        "url": "https://mozillazg.com/2018/03/python-introduction-mock-unit-test-examples-cookbook.html",
        "image": [
            "https://mozillazg.com/static/avatar.jpeg"
         ],
        "keywords": "python, unittest, mock",
        "description": "前言 unittest.mock is a library for testing in Python. It allows you to replace parts of your system under test with mock objects and make assertions about how they have been used. Python 3.3 新增了一个可以用来在单元测试的时候进行 mock 操作的 unittest.mock 模块。 对于 Python 3.3 之前的版本也可以通过 pip install mock 安装拥有相同功能的移植版模块 mock 。本文记录一些常用的 unittest.mock 模块的用法，理论上同样也适用于 mock 这个第三方模块（注：本文例子是在 Python 3.6 下测试的）。 常见用法 定义返回值 &gt;&gt;&gt; from unittest.mock import MagicMock &gt;&gt;&gt; mock = MagicMock(return_value=3) &gt;&gt;&gt; # or &gt;&gt;&gt; # mock = MagicMock() &gt;&gt;&gt; # mock.return_value = 3 &gt;&gt;&gt; mock() 3 定义变化的返回值 &gt;&gt;&gt; mock = MagicMock(side_effect=[1, 2, 3]) # or # &gt;&gt;&gt; mock = MagicMock() # &gt;&gt;&gt; mock.side_effect = [1, 2, 3] &gt;&gt;&gt; mock() 1 &gt;&gt;&gt; mock() 2 &gt;&gt;&gt; mock() 3 &gt;&gt;&gt; mock() Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 939, in __call__ return _mock_self._mock_call(*args, **kwargs) File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 998, in _mock_call result = next(effect) StopIteration &gt;&gt;&gt; def side_effect(arg=1): ... return arg ... &gt;&gt;&gt; m = MagicMock(side_effect=side_effect) &gt;&gt;&gt; m() 1 &gt;&gt;&gt; m(1) 1 &gt;&gt;&gt; m(2) 2 定义抛出异常 &gt;&gt;&gt; m.side_effect = KeyError &gt;&gt;&gt; m() Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/python3.6/unittest/mock.py&#34;, line 939, in __call__ return _mock_self._mock_call(*args, **kwargs) File &#34;/xxx/python3.6/unittest/mock.py&#34;, line 995, in _mock_call raise effect KeyError &gt;&gt;&gt; mock 变量/属性 example.py: foo = {} def bar(): return foo class FooBar: def __init__(self): self.msg = &#39;test&#39; def hello(self): return &#39;hello&#39; def foobar(): return FooBar().hello() fb = FooBar() def hello(): return fb.msg &gt;&gt;&gt; from unittest.mock import patch &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m.test = MagicMock(return_value=233) &gt;&gt;&gt; m() &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372854824&#39;&gt; &gt;&gt;&gt; m.test &lt;MagicMock name=&#39;mock.test&#39; id=&#39;4372854768&#39;&gt; &gt;&gt;&gt; m.test() 233 &gt;&gt;&gt; &gt;&gt;&gt; import example &gt;&gt;&gt; example.foo {} &gt;&gt;&gt; example.hello() &#39;test&#39; &gt;&gt;&gt; with patch.object(example, &#39;foo&#39;, {&#39;lalala&#39;: 233}): ... example.foo ... {&#39;lalala&#39;: 233} &gt;&gt;&gt; example.foo {} &gt;&gt;&gt; with patch.object(example.fb, &#39;msg&#39;, 666): ... example.hello() ... 666 &gt;&gt;&gt; example.hello() &#39;test&#39; mock dict &gt;&gt;&gt; foo = {&#39;a&#39;: 233} &gt;&gt;&gt; &gt;&gt;&gt; foo[&#39;a&#39;] 233 &gt;&gt;&gt; &gt;&gt;&gt; with patch.dict(foo, {&#39;a&#39;: 666, &#39;b&#39;: 222}): ... print(foo[&#39;a&#39;]) ... print(foo[&#39;b&#39;]) ... 666 222 &gt;&gt;&gt; foo[&#39;a&#39;] 233 &gt;&gt;&gt; &#39;b&#39; in foo False &gt;&gt;&gt; with patch.dict(foo, a=666, b=222): ... print(foo[&#39;a&#39;]) ... print(foo[&#39;b&#39;]) ... 666 222 &gt;&gt;&gt; foo[&#39;a&#39;] 233 &gt;&gt;&gt; mock 函数 &gt;&gt;&gt; import example &gt;&gt;&gt; from unittest.mock import MagicMock, patch &gt;&gt;&gt; example.bar() {} &gt;&gt;&gt; with patch(&#39;example.bar&#39;, MagicMock(return_value=233)): ... example.bar() ... 233 &gt;&gt;&gt; &gt;&gt;&gt; with patch.object(example, &#39;bar&#39;, MagicMock(return_value=233)): ... example.bar() ... example.bar(233) ... 233 233 &gt;&gt;&gt; &gt;&gt;&gt; with patch.object(example, &#39;bar&#39;, autospec=True) as bar: ... bar.return_value = 666 ... example.bar() ... 666 &gt;&gt;&gt; with patch.object(example, &#39;bar&#39;, autospec=True): ... example.bar(233) ... Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 2, in &lt;module&gt; File &#34;&lt;string&gt;&#34;, line 2, in bar File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 171, in checksig sig.bind(*args, **kwargs) File &#34;/xxx/lib/python3.6/inspect.py&#34;, line 2934, in bind return args[0]._bind(args[1:], kwargs) File &#34;/xxx/lib/python3.6/inspect.py&#34;, line 2855, in _bind raise TypeError(&#39;too many positional arguments&#39;) from None TypeError: too many positional arguments autospec=True 可以保证 mock 后的对象拥有跟原来一样的函数签名。 mock 方法 &gt;&gt;&gt; example.foobar() &#39;hello&#39; &gt;&gt;&gt; with patch(&#39;example.FooBar&#39;) as mocked_cls: ... instance = MagicMock() ... instance.hello = MagicMock(return_value=&#39;mocked_hello_method&#39;) ... mocked_cls.return_value = instance ... example.foobar() ... &#39;mocked_hello_method&#39; &gt;&gt;&gt; mock @property 装饰的方法 可以使用 PropertyMock mock @property 装饰的方法以及描述符。 &gt;&gt;&gt; class Foo: ... def __init__(self): ... self._bar = 233 ... @property ... def bar(self): ... return self._bar ... @bar.setter ... def bar(self, value): ... self._bar = value ... &gt;&gt;&gt; f = Foo() &gt;&gt;&gt; f.bar 233 &gt;&gt;&gt; f.bar = 666 &gt;&gt;&gt; f.bar 666 &gt;&gt;&gt; with patch(&#39;__main__.Foo.bar&#39;, new_callable=PropertyMock) as mock_bar: ... mock_bar.return_value = &#39;mocked_bar&#39; ... foo = Foo() ... print(foo.bar) ... foo.bar = 266 ... print(foo.bar) ... mocked_bar mocked_bar &gt;&gt;&gt; mock_bar &lt;PropertyMock name=&#39;bar&#39; id=&#39;4373101536&#39;&gt; &gt;&gt;&gt; mock_bar.mock_calls [call(), call(266), call()] &gt;&gt;&gt; mock 内置函数 test.py: def to_str(obj): return str(obj) &gt;&gt;&gt; test.to_str(&#39;233&#39;) &#39;233&#39; &gt;&gt;&gt; with patch.object(__builtins__, &#39;str&#39;, int): ... test.to_str(&#39;233&#39;) ... test.to_str(&#39;foobar&#39;) ... 233 Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 3, in &lt;module&gt; File &#34;/xxx/test.py&#34;, line 2, in to_str return str(obj) ValueError: invalid literal for int() with base 10: &#39;foobar&#39; &gt;&gt;&gt; mock open 函数 read: &gt;&gt;&gt; from unittest.mock import mock_open &gt;&gt;&gt; m = mock_open(read_data=&#39;mocked data&#39;) &gt;&gt;&gt; with patch(&#39;__main__.open&#39;, m): ... with open(&#39;test&#39;) as fp: ... print(fp.read()) ... mocked data &gt;&gt;&gt; m &lt;MagicMock name=&#39;open&#39; spec=&#39;builtin_function_or_method&#39; id=&#39;4369854192&#39;&gt; &gt;&gt;&gt; m.mock_calls [call(&#39;test&#39;), call().__enter__(), call().read(), call().__exit__(None, None, None)] &gt;&gt;&gt; write: &gt;&gt;&gt; m2 = mock_open() &gt;&gt;&gt; with patch(&#39;__main__.open&#39;, m2): ... with open(&#39;bar&#39;, &#39;w&#39;) as fp: ... fp.write(&#39;write data&#39;) ... &gt;&gt;&gt; m2.mock_calls [call(&#39;bar&#39;, &#39;w&#39;), call().__enter__(), call().write(&#39;write data&#39;), call().__exit__(None, None, None)] &gt;&gt;&gt; m2().write.mock_calls [call(&#39;write data&#39;)] &gt;&gt;&gt; mock isinstance 可以用 __class__ 属性来通过 mock 对象的 isinstance 检查: &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m.__class__ = int &gt;&gt;&gt; isinstance(m, int) True &gt;&gt;&gt; m.__class__ = dict &gt;&gt;&gt; isinstance(m, dict) True &gt;&gt;&gt; mock 真值判断 可以通过 mock __bool__ 方法（Python 3） 或 __nonzero__ 方法(Python 2) 来 mock 对对象的真值判断: &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; bool(m) True &gt;&gt;&gt; m = MagicMock(__bool__=MagicMock(return_value=False)) &gt;&gt;&gt; bool(m) False &gt;&gt;&gt; if not m: print(&#39;false&#39;) ... false &gt;&gt;&gt; mock 特殊属性 所谓的特殊属性就是 Mock/MagicMock 对象自带的属性（自带一些可选参数 [1] ）， 比如 name ， 如果我们要 mock 的对象也有一个 name 属性的话， 通过 MagicMock(name=&#39;foo&#39;) 是无法 mock name 这个属性的， 可以用下面两种方法实现 mock 特殊属性: 覆盖 mock 对象的属性: &gt;&gt;&gt; m = MagicMock(name=&#39;foo&#39;) &gt;&gt;&gt; m.name &lt;MagicMock name=&#39;foo.name&#39; id=&#39;4372898816&#39;&gt; &gt;&gt;&gt; &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m.name = &#39;foo&#39; &gt;&gt;&gt; m.name &#39;foo&#39; &gt;&gt;&gt; 使用 configure_mock: &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m.name &lt;MagicMock name=&#39;mock.name&#39; id=&#39;4373042848&#39;&gt; &gt;&gt;&gt; m.configure_mock(name=&#39;foo&#39;) &gt;&gt;&gt; m.name &#39;foo&#39; &gt;&gt;&gt; 自动撤销 mock patch, patch.object 都支持通过 with 语句或者装饰器可以实现 只在指定函数/方法/块中应用 mock ，函数/方法/块结束后自动撤销 mock &gt;&gt;&gt; str(&#39;abc&#39;) &#39;abc&#39; &gt;&gt;&gt; with patch.object(__builtins__, &#39;str&#39;, int): ... str(&#39;abc&#39;) ... Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 2, in &lt;module&gt; ValueError: invalid literal for int() with base 10: &#39;abc&#39; &gt;&gt;&gt; str(&#39;abc&#39;) &#39;abc&#39; &gt;&gt;&gt; &gt;&gt;&gt; @patch.object(__builtins__, &#39;str&#39;, int) ... def test(): ... str(&#39;abc&#39;) ... &gt;&gt;&gt; str(&#39;abc&#39;) &#39;abc&#39; &gt;&gt;&gt; test() Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 1179, in patched return func(*args, **keywargs) File &#34;&lt;stdin&gt;&#34;, line 3, in test ValueError: invalid literal for int() with base 10: &#39;abc&#39; &gt;&gt;&gt; 常用检查方法 mock 的对象拥有一些可以用于单元测试的检查方法，可以用来测试 mock 对象的调用情况。 检查调用次数 待检查的 mock 对象: &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m(1) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372904760&#39;&gt; &gt;&gt;&gt; m(2) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372904760&#39;&gt; &gt;&gt;&gt; m(3) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372904760&#39;&gt; &gt;&gt;&gt; .called: 是否被调用过 &gt;&gt;&gt; m.called True &gt;&gt;&gt; .call_count: 获取调用次数 &gt;&gt;&gt; m.call_count 3 .assert_called(): 检查是否被调用过，如果没有被调用过，则会抛出 AssertionError 异常 &gt;&gt;&gt; m.assert_called() &gt;&gt;&gt; .assert_called_once(): 确保调用过一次，如果没调用或多于一次，则抛出 AssertionError 异常 &gt;&gt;&gt; m.assert_called_once() Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 795, in assert_called_once raise AssertionError(msg) AssertionError: Expected &#39;mock&#39; to have been called once. Called 3 times. &gt;&gt;&gt; .assert_not_called(): 确保没被调用过，否则抛出 AssertionError 异常 &gt;&gt;&gt; m.assert_not_called() Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 777, in assert_not_called raise AssertionError(msg) AssertionError: Expected &#39;mock&#39; to not have been called. Called 3 times. 检查调用时使用的参数 待检查的 mock 对象: &gt;&gt;&gt; m = MagicMock() &gt;&gt;&gt; m(1, 2, foo=&#39;bar&#39;) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372980792&#39;&gt; .call_args: 最后一次调用时使用的参数，未调用则返回 None &gt;&gt;&gt; m.call_args call(1, 2, foo=&#39;bar&#39;) &gt;&gt;&gt; .assert_called_once_with(*args, **kwargs): 确保只调用过一次，并且使用特定参数调用 &gt;&gt;&gt; m.assert_called_once_with(1, 2, foo=&#39;bar&#39;) &gt;&gt;&gt; &gt;&gt;&gt; m(2) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372980792&#39;&gt; &gt;&gt;&gt; &gt;&gt;&gt; m.assert_called_once_with(1, 2, foo=&#39;bar&#39;) Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 824, in assert_called_once_with raise AssertionError(msg) AssertionError: Expected &#39;mock&#39; to be called once. Called 2 times. &gt;&gt;&gt; .assert_any_call(*args, **kwargs): 检查某次用特定参数进行过调用 &gt;&gt;&gt; m.assert_any_call(1, 2, foo=&#39;bar&#39;) &gt;&gt;&gt; .assert_called_with(*args, **kwargs): 检查最后一次调用时使用的参数 &gt;&gt;&gt; m.assert_called_with(2) &gt;&gt;&gt; &gt;&gt;&gt; m.assert_called_with(1, 2, foo=&#39;bar&#39;) Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 814, in assert_called_with raise AssertionError(_error_message()) from cause AssertionError: Expected call: mock(1, 2, foo=&#39;bar&#39;) Actual call: mock(2) &gt;&gt;&gt; .call_args_list: 所有调用时使用的参数列表 &gt;&gt;&gt; m.call_args_list [call(1, 2, foo=&#39;bar&#39;), call(2)] &gt;&gt;&gt; m(3) &lt;MagicMock name=&#39;mock()&#39; id=&#39;4372980792&#39;&gt; &gt;&gt;&gt; m.call_args_list [call(1, 2, foo=&#39;bar&#39;), call(2), call(3)] .assert_has_calls(calls, any_order=False): 检查某几次调用时使用的参数， 如果 any_order 为 False 时必须是挨着的调用顺序，可以是中间的几次调用， 为 True 时 calls 中的记录可以是无序的 &gt;&gt;&gt; from unittest.mock import call &gt;&gt;&gt; m.call_args_list [call(1, 2, foo=&#39;bar&#39;), call(2), call(3)] &gt;&gt;&gt; &gt;&gt;&gt; m.assert_has_calls([call(2), call(3)]) &gt;&gt;&gt; &gt;&gt;&gt; m.assert_has_calls([call(3), call(2)]) Traceback (most recent call last): File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt; File &#34;/xxx/lib/python3.6/unittest/mock.py&#34;, line 846, in assert_has_calls ) from cause AssertionError: Calls not found. Expected: [call(3), call(2)] Actual: [call(1, 2, foo=&#39;bar&#39;), call(2), call(3)] &gt;&gt;&gt; m.assert_has_calls([call(3), call(2)], any_order=True) &gt;&gt;&gt; .method_calls: mock 对象的方法调用记录 &gt;&gt;&gt; m.test_method(2, 3, 3) &lt;MagicMock name=&#39;mock.test_method()&#39; id=&#39;4372935456&#39;&gt; &gt;&gt;&gt; m.method_calls [call.test_method(2, 3, 3)] .mock_calls: 记录 mock 对象的所有调用，包含方法、magic method 以及返回值 mock &gt;&gt;&gt; m.mock_calls [call(1, 2, foo=&#39;bar&#39;), call(2), call(3), call.test_method(2, 3, 3)] &gt;&gt;&gt; &gt;&gt;&gt; m.call_args_list [call(1, 2, foo=&#39;bar&#39;), call(2), call(3)] 手动重置 mock 调用记录 可以使用 .reset_mock() 重置 mock 对象记录的调用记录: &gt;&gt;&gt; m.mock_calls [call(1, 2, foo=&#39;bar&#39;), call(2), call(3), call.test_method(2, 3, 3)] &gt;&gt;&gt; &gt;&gt;&gt; m.call_args_list [call(1, 2, foo=&#39;bar&#39;), call(2), call(3)] &gt;&gt;&gt; &gt;&gt;&gt; m.reset_mock() &gt;&gt;&gt; &gt;&gt;&gt; m.call_args_list [] &gt;&gt;&gt; m.mock_calls [] &gt;&gt;&gt; 总结 本文记录的是平时常用的一些 mock 相关的功能，更多内容详见 官方文档 。 参考资料 26.5. unittest.mock — mock object library — Python 3.6.4 documentation [1]26.5. unittest.mock — mock object library — Python 3.6.4 documentation",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https://mozillazg.com/2018/03/python-introduction-mock-unit-test-examples-cookbook.html"
        },
        "datePublished": "2018-03-04"
    }
    </script>

</head>
<body>

<div class="navbar" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://mozillazg.com/" class="navbar-brand">
mozillazg's Blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="https://mozillazg.com/feeds/all.atom.xml">Feed</a></li>
                    <li><a href="/2014/10/pages/about-me.html">About</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://mozillazg.com/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
    <section id="content" class="yue">
        <article>
            <header class="text-center">
                <h1>
                    <a href="https://mozillazg.com/2018/03/python-introduction-mock-unit-test-examples-cookbook.html"
                       rel="bookmark"
                       title="Permalink to Python: Mock 常用功能">
                        Python: Mock 常用功能
                    </a>
                </h1>
                <p class="published">
                    <time datetime="2018-03-04T00:00:00+00:00">
                    2018-03-04
                    </time>
                </p>
            </header>
            <div class="entry-content">
                <div class="well-sm article-info">
<footer class="post-info">
        <a href="https://mozillazg.com/category/python.html">python</a>


<span class="label label-default hide">Tags</span>
	<a href="https://mozillazg.com/tag/unittest.html">unittest</a>
        /
	<a href="https://mozillazg.com/tag/mock.html">mock</a>
    
</footer><!-- /.post-info -->                </div>
                <div class="js-toc"></div>
                <div>
                <div class="section" id="section-1">
<h2 id="hidsection-1">前言<a class="headerlink" href="#hidsection-1" title="Permalink to this headline">¶</a></h2>
<blockquote>
unittest.mock is a library for testing in Python. It allows you to replace parts of your system under test with mock objects and make assertions about how they have been used.</blockquote>
<p>Python 3.3 新增了一个可以用来在单元测试的时候进行 mock 操作的 <tt class="docutils literal">unittest.mock</tt> 模块。
对于 Python 3.3 之前的版本也可以通过 <tt class="docutils literal">pip install mock</tt> 安装拥有相同功能的移植版模块 <tt class="docutils literal">mock</tt> 。本文记录一些常用的 <tt class="docutils literal">unittest.mock</tt> 模块的用法，理论上同样也适用于 <tt class="docutils literal">mock</tt> 这个第三方模块（注：本文例子是在 Python 3.6 下测试的）。</p>
</div>
<div class="section" id="section-2">
<h2 id="hidsection-2">常见用法<a class="headerlink" href="#hidsection-2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="section-3">
<h3 id="hidsection-3">定义返回值<a class="headerlink" href="#hidsection-3" title="Permalink to this headline">¶</a></h3>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">MagicMock</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1"># or</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1"># mock = MagicMock()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1"># mock.return_value = 3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">()</span>
<span class="mi">3</span>
</pre></div>
</div>
<div class="section" id="section-4">
<h3 id="hidsection-4">定义变化的返回值<a class="headerlink" href="#hidsection-4" title="Permalink to this headline">¶</a></h3>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">side_effect</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="c1"># or</span>
<span class="c1"># &gt;&gt;&gt; mock = MagicMock()</span>
<span class="c1"># &gt;&gt;&gt; mock.side_effect = [1, 2, 3]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">()</span>
<span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">()</span>
<span class="mi">2</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">()</span>
<span class="mi">3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">()</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/unittest/mock.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">939</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__call__</span>
    <span class="k">return</span> <span class="n">_mock_self</span><span class="o">.</span><span class="n">_mock_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/unittest/mock.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">998</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_mock_call</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">effect</span><span class="p">)</span>
<span class="ne">StopIteration</span>


<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">side_effect</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">arg</span>
<span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">side_effect</span><span class="o">=</span><span class="n">side_effect</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="p">()</span>
<span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="mi">2</span>
</pre></div>
</div>
<div class="section" id="section-5">
<h3 id="hidsection-5">定义抛出异常<a class="headerlink" href="#hidsection-5" title="Permalink to this headline">¶</a></h3>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">KeyError</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="p">()</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/python3.6/unittest/mock.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">939</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__call__</span>
    <span class="k">return</span> <span class="n">_mock_self</span><span class="o">.</span><span class="n">_mock_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/python3.6/unittest/mock.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">995</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_mock_call</span>
    <span class="k">raise</span> <span class="n">effect</span>
<span class="ne">KeyError</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
</div>
<div class="section" id="mock">
<h3 id="hidmock">mock 变量/属性<a class="headerlink" href="#hidmock" title="Permalink to this headline">¶</a></h3>
<p>example.py:</p>
<div class="highlight"><pre><span></span><span class="n">foo</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">bar</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">foo</span>


<span class="k">class</span> <span class="nc">FooBar</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span>

    <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;hello&#39;</span>


<span class="k">def</span> <span class="nf">foobar</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">FooBar</span><span class="p">()</span><span class="o">.</span><span class="n">hello</span><span class="p">()</span>


<span class="n">fb</span> <span class="o">=</span> <span class="n">FooBar</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">fb</span><span class="o">.</span><span class="n">msg</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">233</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="p">()</span>
<span class="o">&lt;</span><span class="n">MagicMock</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mock()&#39;</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;4372854824&#39;</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">test</span>
<span class="o">&lt;</span><span class="n">MagicMock</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mock.test&#39;</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;4372854768&#39;</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">test</span><span class="p">()</span>
<span class="mi">233</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">example</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">example</span><span class="o">.</span><span class="n">foo</span>
<span class="p">{}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">example</span><span class="o">.</span><span class="n">hello</span><span class="p">()</span>
<span class="s1">&#39;test&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;lalala&#39;</span><span class="p">:</span> <span class="mi">233</span><span class="p">}):</span>
<span class="o">...</span>     <span class="n">example</span><span class="o">.</span><span class="n">foo</span>
<span class="o">...</span>
<span class="p">{</span><span class="s1">&#39;lalala&#39;</span><span class="p">:</span> <span class="mi">233</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">example</span><span class="o">.</span><span class="n">foo</span>
<span class="p">{}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">fb</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">,</span> <span class="mi">666</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">example</span><span class="o">.</span><span class="n">hello</span><span class="p">()</span>
<span class="o">...</span>
<span class="mi">666</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">example</span><span class="o">.</span><span class="n">hello</span><span class="p">()</span>
<span class="s1">&#39;test&#39;</span>
</pre></div>
</div>
<div class="section" id="mock-dict">
<h3 id="hidmock-dict">mock dict<a class="headerlink" href="#hidmock-dict" title="Permalink to this headline">¶</a></h3>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">233</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
<span class="mi">233</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">666</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">222</span><span class="p">}):</span>
<span class="o">...</span>     <span class="nb">print</span><span class="p">(</span><span class="n">foo</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span>
<span class="o">...</span>     <span class="nb">print</span><span class="p">(</span><span class="n">foo</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">])</span>
<span class="o">...</span>
<span class="mi">666</span>
<span class="mi">222</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
<span class="mi">233</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">foo</span>
<span class="kc">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">666</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">222</span><span class="p">):</span>
<span class="o">...</span>     <span class="nb">print</span><span class="p">(</span><span class="n">foo</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span>
<span class="o">...</span>     <span class="nb">print</span><span class="p">(</span><span class="n">foo</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">])</span>
<span class="o">...</span>
<span class="mi">666</span>
<span class="mi">222</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
<span class="mi">233</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
</div>
<div class="section" id="mock-1">
<h3 id="hidmock-1">mock 函数<a class="headerlink" href="#hidmock-1" title="Permalink to this headline">¶</a></h3>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">example</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">patch</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">example</span><span class="o">.</span><span class="n">bar</span><span class="p">()</span>
<span class="p">{}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;example.bar&#39;</span><span class="p">,</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">233</span><span class="p">)):</span>
<span class="o">...</span>     <span class="n">example</span><span class="o">.</span><span class="n">bar</span><span class="p">()</span>
<span class="o">...</span>
<span class="mi">233</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">233</span><span class="p">)):</span>
<span class="o">...</span>     <span class="n">example</span><span class="o">.</span><span class="n">bar</span><span class="p">()</span>
<span class="o">...</span>     <span class="n">example</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="mi">233</span><span class="p">)</span>
<span class="o">...</span>
<span class="mi">233</span>
<span class="mi">233</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">bar</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">bar</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">666</span>
<span class="o">...</span>     <span class="n">example</span><span class="o">.</span><span class="n">bar</span><span class="p">()</span>
<span class="o">...</span>
<span class="mi">666</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">example</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="mi">233</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2</span><span class="p">,</span> <span class="ow">in</span> <span class="n">bar</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/unittest/mock.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">171</span><span class="p">,</span> <span class="ow">in</span> <span class="n">checksig</span>
    <span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/inspect.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2934</span><span class="p">,</span> <span class="ow">in</span> <span class="n">bind</span>
    <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_bind</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">kwargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/inspect.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2855</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_bind</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;too many positional arguments&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
<span class="ne">TypeError</span><span class="p">:</span> <span class="n">too</span> <span class="n">many</span> <span class="n">positional</span> <span class="n">arguments</span>
</pre></div>
<p><tt class="docutils literal">autospec=True</tt> 可以保证 mock 后的对象拥有跟原来一样的函数签名。</p>
</div>
<div class="section" id="mock-2">
<h3 id="hidmock-2">mock 方法<a class="headerlink" href="#hidmock-2" title="Permalink to this headline">¶</a></h3>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">example</span><span class="o">.</span><span class="n">foobar</span><span class="p">()</span>
<span class="s1">&#39;hello&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;example.FooBar&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mocked_cls</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">instance</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
<span class="o">...</span>     <span class="n">instance</span><span class="o">.</span><span class="n">hello</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="s1">&#39;mocked_hello_method&#39;</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">mocked_cls</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">instance</span>
<span class="o">...</span>     <span class="n">example</span><span class="o">.</span><span class="n">foobar</span><span class="p">()</span>
<span class="o">...</span>
<span class="s1">&#39;mocked_hello_method&#39;</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
</div>
<div class="section" id="mock-property">
<h3 id="hidmock-property">mock &#64;property 装饰的方法<a class="headerlink" href="#hidmock-property" title="Permalink to this headline">¶</a></h3>
<p>可以使用 <tt class="docutils literal">PropertyMock</tt> mock <tt class="docutils literal">&#64;property</tt> 装饰的方法以及描述符。</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
<span class="o">...</span>     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="o">...</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_bar</span> <span class="o">=</span> <span class="mi">233</span>
<span class="o">...</span>     <span class="nd">@property</span>
<span class="o">...</span>     <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="o">...</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bar</span>
<span class="o">...</span>     <span class="nd">@bar</span><span class="o">.</span><span class="n">setter</span>
<span class="o">...</span>     <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="o">...</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_bar</span> <span class="o">=</span> <span class="n">value</span>
<span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">bar</span>
<span class="mi">233</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">bar</span> <span class="o">=</span> <span class="mi">666</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">bar</span>
<span class="mi">666</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;__main__.Foo.bar&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">PropertyMock</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_bar</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">mock_bar</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s1">&#39;mocked_bar&#39;</span>
<span class="o">...</span>     <span class="n">foo</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="o">...</span>     <span class="nb">print</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">bar</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">foo</span><span class="o">.</span><span class="n">bar</span> <span class="o">=</span> <span class="mi">266</span>
<span class="o">...</span>     <span class="nb">print</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">bar</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">mocked_bar</span>
<span class="n">mocked_bar</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_bar</span>
<span class="o">&lt;</span><span class="n">PropertyMock</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;4373101536&#39;</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock_bar</span><span class="o">.</span><span class="n">mock_calls</span>
<span class="p">[</span><span class="n">call</span><span class="p">(),</span> <span class="n">call</span><span class="p">(</span><span class="mi">266</span><span class="p">),</span> <span class="n">call</span><span class="p">()]</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
</div>
<div class="section" id="mock-3">
<h3 id="hidmock-3">mock 内置函数<a class="headerlink" href="#hidmock-3" title="Permalink to this headline">¶</a></h3>
<p>test.py:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">to_str</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">test</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="s1">&#39;233&#39;</span><span class="p">)</span>
<span class="s1">&#39;233&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">__builtins__</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">test</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="s1">&#39;233&#39;</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">test</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="mi">233</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">3</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/test.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2</span><span class="p">,</span> <span class="ow">in</span> <span class="n">to_str</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="ne">ValueError</span><span class="p">:</span> <span class="n">invalid</span> <span class="n">literal</span> <span class="k">for</span> <span class="nb">int</span><span class="p">()</span> <span class="k">with</span> <span class="n">base</span> <span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;foobar&#39;</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
</div>
<div class="section" id="mock-open">
<h3 id="hidmock-open">mock open 函数<a class="headerlink" href="#hidmock-open" title="Permalink to this headline">¶</a></h3>
<p>read:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">mock_open</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">read_data</span><span class="o">=</span><span class="s1">&#39;mocked data&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;__main__.open&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
<span class="o">...</span>         <span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="o">...</span>
<span class="n">mocked</span> <span class="n">data</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span>
<span class="o">&lt;</span><span class="n">MagicMock</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;open&#39;</span> <span class="n">spec</span><span class="o">=</span><span class="s1">&#39;builtin_function_or_method&#39;</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;4369854192&#39;</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">mock_calls</span>
<span class="p">[</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">),</span>
 <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">(),</span>
 <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
 <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
<p>write:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m2</span> <span class="o">=</span> <span class="n">mock_open</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;__main__.open&#39;</span><span class="p">,</span> <span class="n">m2</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;write data&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m2</span><span class="o">.</span><span class="n">mock_calls</span>
<span class="p">[</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">),</span>
 <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">(),</span>
 <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;write data&#39;</span><span class="p">),</span>
 <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m2</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">mock_calls</span>
<span class="p">[</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;write data&#39;</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
</div>
<div class="section" id="mock-isinstance">
<h3 id="hidmock-isinstance">mock isinstance<a class="headerlink" href="#hidmock-isinstance" title="Permalink to this headline">¶</a></h3>
<p>可以用 <tt class="docutils literal">__class__</tt> 属性来通过 mock 对象的 isinstance 检查:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="nb">int</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
<span class="kc">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="nb">dict</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
<span class="kc">True</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
</div>
<div class="section" id="mock-4">
<h3 id="hidmock-4">mock 真值判断<a class="headerlink" href="#hidmock-4" title="Permalink to this headline">¶</a></h3>
<p>可以通过 mock <tt class="docutils literal">__bool__</tt> 方法（Python 3） 或 <tt class="docutils literal">__nonzero__</tt> 方法(Python 2) 来 mock 对对象的真值判断:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">bool</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="kc">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="fm">__bool__</span><span class="o">=</span><span class="n">MagicMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">bool</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="kc">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;false&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">false</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
</div>
<div class="section" id="mock-5">
<h3 id="hidmock-5">mock 特殊属性<a class="headerlink" href="#hidmock-5" title="Permalink to this headline">¶</a></h3>
<p>所谓的特殊属性就是 <tt class="docutils literal">Mock</tt>/<tt class="docutils literal">MagicMock</tt> 对象自带的属性（自带一些可选参数 <a class="footnote-reference" href="#footnote-1" id="footnote-reference-1">[1]</a> ），
比如 <tt class="docutils literal">name</tt> ， 如果我们要 mock 的对象也有一个 <tt class="docutils literal">name</tt> 属性的话，
通过 <tt class="docutils literal"><span class="pre">MagicMock(name='foo')</span></tt> 是无法 mock <tt class="docutils literal">name</tt> 这个属性的，
可以用下面两种方法实现 mock 特殊属性:</p>
<p>覆盖 mock 对象的属性:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span>
<span class="o">&lt;</span><span class="n">MagicMock</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;foo.name&#39;</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;4372898816&#39;</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span>
<span class="s1">&#39;foo&#39;</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
<p>使用 <tt class="docutils literal">configure_mock</tt>:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span>
<span class="o">&lt;</span><span class="n">MagicMock</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mock.name&#39;</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;4373042848&#39;</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">configure_mock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span>
<span class="s1">&#39;foo&#39;</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
</div>
<div class="section" id="mock-6">
<h3 id="hidmock-6">自动撤销 mock<a class="headerlink" href="#hidmock-6" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal">patch</tt>, <tt class="docutils literal">patch.object</tt> 都支持通过 with 语句或者装饰器可以实现
只在指定函数/方法/块中应用 mock ，函数/方法/块结束后自动撤销 mock</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">)</span>
<span class="s1">&#39;abc&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">__builtins__</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<span class="o">...</span>     <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">ValueError</span><span class="p">:</span> <span class="n">invalid</span> <span class="n">literal</span> <span class="k">for</span> <span class="nb">int</span><span class="p">()</span> <span class="k">with</span> <span class="n">base</span> <span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;abc&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">)</span>
<span class="s1">&#39;abc&#39;</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">__builtins__</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
<span class="o">...</span> <span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
<span class="o">...</span>     <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">)</span>
<span class="s1">&#39;abc&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">test</span><span class="p">()</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/unittest/mock.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1179</span><span class="p">,</span> <span class="ow">in</span> <span class="n">patched</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywargs</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">3</span><span class="p">,</span> <span class="ow">in</span> <span class="n">test</span>
<span class="ne">ValueError</span><span class="p">:</span> <span class="n">invalid</span> <span class="n">literal</span> <span class="k">for</span> <span class="nb">int</span><span class="p">()</span> <span class="k">with</span> <span class="n">base</span> <span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;abc&#39;</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="section-6">
<h2 id="hidsection-6">常用检查方法<a class="headerlink" href="#hidsection-6" title="Permalink to this headline">¶</a></h2>
<p>mock 的对象拥有一些可以用于单元测试的检查方法，可以用来测试 mock 对象的调用情况。</p>
<div class="section" id="section-7">
<h3 id="hidsection-7">检查调用次数<a class="headerlink" href="#hidsection-7" title="Permalink to this headline">¶</a></h3>
<p>待检查的 mock 对象:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">MagicMock</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mock()&#39;</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;4372904760&#39;</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">MagicMock</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mock()&#39;</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;4372904760&#39;</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">MagicMock</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mock()&#39;</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;4372904760&#39;</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
<p><tt class="docutils literal">.called</tt>: 是否被调用过</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">called</span>
<span class="kc">True</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
<p><tt class="docutils literal">.call_count</tt>: 获取调用次数</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">call_count</span>
<span class="mi">3</span>
</pre></div>
<p><tt class="docutils literal">.assert_called()</tt>: 检查是否被调用过，如果没有被调用过，则会抛出 <tt class="docutils literal">AssertionError</tt> 异常</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
<p><tt class="docutils literal">.assert_called_once()</tt>: 确保调用过一次，如果没调用或多于一次，则抛出 <tt class="docutils literal">AssertionError</tt> 异常</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/unittest/mock.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">795</span><span class="p">,</span> <span class="ow">in</span> <span class="n">assert_called_once</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">Expected</span> <span class="s1">&#39;mock&#39;</span> <span class="n">to</span> <span class="n">have</span> <span class="n">been</span> <span class="n">called</span> <span class="n">once</span><span class="o">.</span> <span class="n">Called</span> <span class="mi">3</span> <span class="n">times</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
<p><tt class="docutils literal">.assert_not_called()</tt>: 确保没被调用过，否则抛出 <tt class="docutils literal">AssertionError</tt> 异常</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/unittest/mock.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">777</span><span class="p">,</span> <span class="ow">in</span> <span class="n">assert_not_called</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">Expected</span> <span class="s1">&#39;mock&#39;</span> <span class="n">to</span> <span class="ow">not</span> <span class="n">have</span> <span class="n">been</span> <span class="n">called</span><span class="o">.</span> <span class="n">Called</span> <span class="mi">3</span> <span class="n">times</span><span class="o">.</span>
</pre></div>
</div>
<div class="section" id="section-8">
<h3 id="hidsection-8">检查调用时使用的参数<a class="headerlink" href="#hidsection-8" title="Permalink to this headline">¶</a></h3>
<p>待检查的 mock 对象:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">MagicMock</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mock()&#39;</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;4372980792&#39;</span><span class="o">&gt;</span>
</pre></div>
<p><tt class="docutils literal">.call_args</tt>: 最后一次调用时使用的参数，未调用则返回 <tt class="docutils literal">None</tt></p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">call_args</span>
<span class="n">call</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
<p><tt class="docutils literal"><span class="pre">.assert_called_once_with(*args,</span> **kwargs)</tt>: 确保只调用过一次，并且使用特定参数调用</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">MagicMock</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mock()&#39;</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;4372980792&#39;</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/unittest/mock.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">824</span><span class="p">,</span> <span class="ow">in</span> <span class="n">assert_called_once_with</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">Expected</span> <span class="s1">&#39;mock&#39;</span> <span class="n">to</span> <span class="n">be</span> <span class="n">called</span> <span class="n">once</span><span class="o">.</span> <span class="n">Called</span> <span class="mi">2</span> <span class="n">times</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
<p><tt class="docutils literal"><span class="pre">.assert_any_call(*args,</span> **kwargs)</tt>: 检查某次用特定参数进行过调用</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">assert_any_call</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
<p><tt class="docutils literal"><span class="pre">.assert_called_with(*args,</span> **kwargs)</tt>: 检查最后一次调用时使用的参数</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/unittest/mock.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">814</span><span class="p">,</span> <span class="ow">in</span> <span class="n">assert_called_with</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">_error_message</span><span class="p">())</span> <span class="kn">from</span> <span class="nn">cause</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">Expected</span> <span class="n">call</span><span class="p">:</span> <span class="n">mock</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">Actual</span> <span class="n">call</span><span class="p">:</span> <span class="n">mock</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
<p><tt class="docutils literal">.call_args_list</tt>: 所有调用时使用的参数列表</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">call_args_list</span>
<span class="p">[</span><span class="n">call</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">MagicMock</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mock()&#39;</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;4372980792&#39;</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">call_args_list</span>
<span class="p">[</span><span class="n">call</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
</pre></div>
<p><tt class="docutils literal">.assert_has_calls(calls, any_order=False)</tt>: 检查某几次调用时使用的参数，
如果 <tt class="docutils literal">any_order</tt> 为 <tt class="docutils literal">False</tt> 时必须是挨着的调用顺序，可以是中间的几次调用，
为 <tt class="docutils literal">True</tt> 时 <tt class="docutils literal">calls</tt> 中的记录可以是无序的</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">call</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">call_args_list</span>
<span class="p">[</span><span class="n">call</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">([</span><span class="n">call</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">([</span><span class="n">call</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s2">&quot;/xxx/lib/python3.6/unittest/mock.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">846</span><span class="p">,</span> <span class="ow">in</span> <span class="n">assert_has_calls</span>
    <span class="p">)</span> <span class="kn">from</span> <span class="nn">cause</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="n">Calls</span> <span class="ow">not</span> <span class="n">found</span><span class="o">.</span>
<span class="n">Expected</span><span class="p">:</span> <span class="p">[</span><span class="n">call</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
<span class="n">Actual</span><span class="p">:</span> <span class="p">[</span><span class="n">call</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">([</span><span class="n">call</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">2</span><span class="p">)],</span> <span class="n">any_order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
<p><tt class="docutils literal">.method_calls</tt>: mock 对象的方法调用记录</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">test_method</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">MagicMock</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mock.test_method()&#39;</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;4372935456&#39;</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">method_calls</span>
<span class="p">[</span><span class="n">call</span><span class="o">.</span><span class="n">test_method</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
</pre></div>
<p><tt class="docutils literal">.mock_calls</tt>: 记录 mock 对象的所有调用，包含方法、magic method 以及返回值 mock</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">mock_calls</span>
<span class="p">[</span><span class="n">call</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">call</span><span class="o">.</span><span class="n">test_method</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">call_args_list</span>
<span class="p">[</span><span class="n">call</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
</pre></div>
</div>
<div class="section" id="mock-7">
<h3 id="hidmock-7">手动重置 mock 调用记录<a class="headerlink" href="#hidmock-7" title="Permalink to this headline">¶</a></h3>
<p>可以使用 <tt class="docutils literal">.reset_mock()</tt> 重置 mock 对象记录的调用记录:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">mock_calls</span>
<span class="p">[</span><span class="n">call</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">call</span><span class="o">.</span><span class="n">test_method</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">call_args_list</span>
<span class="p">[</span><span class="n">call</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">reset_mock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">call_args_list</span>
<span class="p">[]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">mock_calls</span>
<span class="p">[]</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="section-9">
<h2 id="hidsection-9">总结<a class="headerlink" href="#hidsection-9" title="Permalink to this headline">¶</a></h2>
<p>本文记录的是平时常用的一些 mock 相关的功能，更多内容详见 <a class="reference external" href="https://docs.python.org/3/library/unittest.mock.html">官方文档</a> 。</p>
</div>
<div class="section" id="section-10">
<h2 id="hidsection-10">参考资料<a class="headerlink" href="#hidsection-10" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://docs.python.org/3/library/unittest.mock.html">26.5. unittest.mock — mock object library — Python 3.6.4 documentation</a></li>
</ul>
<table class="docutils footnote" frame="void" id="footnote-1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-1">[1]</a></td><td><a class="reference external" href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.Mock">26.5. unittest.mock — mock object library — Python 3.6.4 documentation</a></td></tr>
</tbody>
</table>
</div>

                </div>
            </div>
            <!-- /.entry-content -->
<section class="text-center">
  
<div id="donate"></div>

<div class="social-share"></div>
<div class="social-comment-note">
<p>有任何建议和想法欢迎在下方评论区留言或者加我<a href="/static/wechat.png">微信</a>交流</p>
</div>

</section>
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'my-github-blog'; // required: replace example with your forum shortname

                    var disqus_identifier = 'python-introduction-mock-unit-test-examples-cookbook';
                var disqus_url = 'https://mozillazg.com/2018/03/python-introduction-mock-unit-test-examples-cookbook.html';

            var disqus_config = function () {
                this.language = "";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2023 mozillazg
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>
            &middot; <a href="/privacy-policy.html" target="_blank">Privacy</a>              <p><small>  <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="/static/images/by-sa-80x15.png" /></a>
    &quot;<span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">mozillazg's Blog</span>&quot; by <a xmlns:cc="http://creativecommons.org/ns#" href="https://mozillazg.com" property="cc:attributionName" rel="cc:attributionURL">mozillazg</a> is
  licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/jquery@2.1.1/dist/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'my-github-blog'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-77172981-1', 'auto');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->

<!-- share.js -->
<script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script>



<script src="https://cdn.jsdelivr.net/npm/tocbot@3.0.2/dist/tocbot.min.js"></script>
<script>
$(document).ready(function(){
  tocbot.init({
    // Where to render the table of contents.
    tocSelector: '.js-toc',
    // Where to grab the headings to build the table of contents.
    contentSelector: '.entry-content',
    // Which headings to grab inside of the contentSelector element.
    headingSelector: 'h2, h3, h4,h5',
    // Headings that match the ignoreSelector will be skipped.
    ignoreSelector: '.js-toc-ignore',
    // Main class to add to links.
    linkClass: 'toc-link',
    // Extra classes to add to links.
    extraLinkClasses: '',
    // Class to add to active links,
    // the link corresponding to the top most heading on the page.
    activeLinkClass: 'is-active-link',
    // Main class to add to lists.
    listClass: 'toc-list',
    // Extra classes to add to lists.
    extraListClasses: '',
    // Class that gets added when a list should be collapsed.
    isCollapsedClass: 'is-collapsed',
    // Class that gets added when a list should be able
    // to be collapsed but isn't necessarily collpased.
    collapsibleClass: 'is-collapsible',
    // Class to add to list items.
    listItemClass: 'toc-list-item',
    // How many heading levels should not be collpased.
    // For example, number 6 will show everything since
    // there are only 6 heading levels and number 0 will collpase them all.
    // The sections that are hidden will open
    // and close as you scroll to headings within them.
    collapseDepth: 6,
    // Smooth scrolling enabled.
    smoothScroll: true,
    // Smooth scroll duration.
    smoothScrollDuration: 420,
    // Callback for scroll end (requires: smoothScroll).
    scrollEndCallback: function (e) {},
    // Headings offset between the headings and the top of the document (this is meant for minor adjustments).
    headingsOffset: 0,
    // Timeout between events firing to make sure it's
    // not too rapid (for performance reasons).
    throttleTimeout: 50,
    // Element to add the positionFixedClass to.
    positionFixedSelector: null,
    // Fixed position class to add to make sidebar fixed after scrolling
    // down past the fixedSidebarOffset.
    positionFixedClass: 'is-position-fixed',
    // fixedSidebarOffset can be any number but by default is set
    // to auto which sets the fixedSidebarOffset to the sidebar
    // element's offsetTop from the top of the document on init.
    fixedSidebarOffset: 'auto',
    // includeHtml can be set to true to include the HTML markup from the
    // heading node instead of just including the textContent.
    includeHtml: false
  });
});
</script>
</body>
</html>