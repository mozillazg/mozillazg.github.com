<!DOCTYPE html>
<html lang="en"  prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml" class="han-init">
<head>
    <title>Frequently asked questions about using tracepoint with ebpf/libbpf programs - mozillazg's Blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- share.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css">


    <link href="https://mozillazg.com/favicon.ico" rel="icon">

<link rel="canonical" href="https://mozillazg.com/2022/05/ebpf-libbpf-tracepoint-common-questions-en.html">

        <meta name="author" content="mozillazg" />
        <meta name="keywords" content="ebpf,tracepoint,libbpf,libbpfgo,go,golang,en-version" />
    <meta name="description" content="Preface Note some common problems related to tracepoint when writing ebpf/libbpf programs (such as BPF_PROG_TYPE_TRACEPOINT program). What events can be monitored by tracepoint The events that tracepoint can monitor can be found by looking at the contents of the /sys/kernel/debug/tracing/available_events file. The format of each line in the file is: &lt;category&gt;:&lt;name&gt; For example: syscalls:sys_enter_execve Format of SEC content The SEC format for the tracepoint event is: SEC(&#34;tracepoint/&lt;category&gt;/&lt;name&gt;&#34;) // for example: // SEC(&#34;tracepoint/syscalls/sys_enter_openat&#34;) or: SEC(&#34;tp/&lt;category&gt;/&lt;name&gt;&#34;) // for example: // SEC(&#34;tp/syscalls/sys_enter_openat&#34;) the values of &lt;category&gt; and &lt;name&gt; both take the values listed in the available_events file earlier. SEC(&#34;tp/xx/yy&#34;) and SEC(&#34;tracepoint/xx/yy&#34;) are actually equivalent, depending on personal preference, which one can be used at will. How to determine the parameter type of the tracepoint event handler and get the corresponding kernel call parameters Suppose that we want to monitor the fchmodat system call involved in the chmod command via tracepoint. Then, how do we determine the types of parameters of the event handler functions in ebpf and how do we get the contents of the corresponding fchmodat system call parameters? For example, get the name of the file to be operated on and the value of the permission mode to be operated on. The first step is to determine the system call used by chmod, which is relatively simple and can be done in a variety of ways, such as through the strace command: $ strace chmod 600 a.txt ... fchmodat(AT_FDCWD, &#34;a.txt&#34;, 0600) = 0 ... The second step is to find the tracepoint event that can be used for this system call: $ sudo cat /sys/kernel/debug/tracing/available_events |grep fchmodat syscalls:sys_exit_fchmodat syscalls:sys_enter_fchmodat As you can see, there are sys_enter_fchmodat and sys_exit_fchmodat events. Here choose sys_enter_fchmodat event for subsequent explanation. The third step is to determine the argument type of the function. This needs to be found in the vmlinux.h file, generally sys_enter_xx corresponds to trace_event_raw_sys_enter, sys_exit_xx corresponds to trace_event_raw_sys_exit, and the others generally correspond to trace_event_raw_sys_enter. trace_event_raw_&lt;name&gt;, if you don&#39;t find it, you can refer to the trace_event_raw_sys_enter example to find its similar struct. For sys_enter_fchmodat, we use the struct trace_event_raw_sys_enter: struct trace_event_raw_sys_enter { struct trace_entry ent; long int id; long unsigned int args[6]; char __data[0]; }; The args stores the information we can get about the event, and what information is contained in them is what we need to determine in step 4. The fourth step is to determine what information is available in the event itself, although we know that the fchmodat system call requires the file name and mode information. However, we are not sure if this information is available in the ebpf program. This can be done by looking at /sys/kernel/debug/tracing/events/&lt;category&gt;/&lt;name&gt;/format file to see what information we can get. For example, the sys_enter_fchmodat event /sys/kernel/debug/tracing/events/syscalls/sys_enter_fchmodat/format is as follows: $ sudo cat /sys/kernel/debug/tracing/events/syscalls/sys_enter_fchmodat/format name: sys_enter_fchmodat ID: 647 format: field:unsigned short common_type; offset:0; size:2; signed:0; field:unsigned char common_flags; offset:2; size:1; signed:0; field:unsigned char common_preempt_count; offset:3; size:1; signed:0; field:int common_pid; offset:4; size:4; signed:1; field:int __syscall_nr; offset:8; size:4; signed:1; field:int dfd; offset:16; size:8; signed:0; field:const char * filename; offset:24; size:8; signed:0; field:umode_t mode; offset:32; size:8; signed:0; print fmt: &#34;dfd: 0x%08lx, filename: 0x%08lx, mode: 0x%08lx&#34;, ((unsigned long)(REC-&gt;dfd)), ((unsigned long)(REC-&gt;filename)), ((unsigned long)(REC-&gt;mode)) The fields referenced in print fmt are all information that we can get in the ebpf program. From the above, we can see that we can get the sys_enter_fchmodat event dfd, filename and mode information. Here contains the previously mentioned file name and permission mode information. The values of these fields can be obtained from the args array of trace_event_raw_sys_enter, i.e. args[0] for dfd, args[1] for filename and so on. Once the information has been determined, you can write the program. For example, the example ebpf program for the sys_enter_fchmodat event above is as follows: SEC(&#34;tracepoint/syscalls/sys_enter_fchmodat&#34;) int tracepoint__syscalls__sys_enter_fchmodat(struct trace_event_raw_sys_enter *ctx) { // ... char *filename_ptr = (char *) BPF_CORE_READ(ctx, args[1]); bpf_core_read_user_str(&amp;event-&gt;filename, sizeof(event-&gt;filename), filename_ptr); event-&gt;mode = BPF_CORE_READ(ctx, args[2]); // ... } You can check out full example codes on Github: https://github.com/mozillazg/hello-libbpfgo/tree/master/07-tracepoint-args https://github.com/mozillazg/hello-libbpfgo/tree/master/14-tracepoint-args-sched_switch References BPF CO-RE reference guide libbpf/libbpf.c at 12e932ac0e18546dd7247e66ea1b4aa236d2ef38 · libbpf/libbpf BCC to libbpf conversion guide" />

    <style>
      .js-toc {
        margin-bottom: 20px;
      }
      .donate-modal {
        text-align: center;
      }
      #donate-modal-container .donate-image {
        max-height: 300px !important;
        min-height: inherit !important;
      }
    </style>

        <meta property="og:site_name" content="mozillazg's Blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Frequently asked questions about using tracepoint with ebpf/libbpf programs"/>
        <meta property="og:url" content="https://mozillazg.com/2022/05/ebpf-libbpf-tracepoint-common-questions-en.html"/>
        <meta property="og:description" content="Preface Note some common problems related to tracepoint when writing ebpf/libbpf programs (such as BPF_PROG_TYPE_TRACEPOINT program). What events can be monitored by tracepoint The events that tracepoint can monitor can be found by looking at the contents of the /sys/kernel/debug/tracing/available_events file. The format of each line in the file is: &lt;category&gt;:&lt;name&gt; For example: syscalls:sys_enter_execve Format of SEC content The SEC format for the tracepoint event is: SEC(&#34;tracepoint/&lt;category&gt;/&lt;name&gt;&#34;) // for example: // SEC(&#34;tracepoint/syscalls/sys_enter_openat&#34;) or: SEC(&#34;tp/&lt;category&gt;/&lt;name&gt;&#34;) // for example: // SEC(&#34;tp/syscalls/sys_enter_openat&#34;) the values of &lt;category&gt; and &lt;name&gt; both take the values listed in the available_events file earlier. SEC(&#34;tp/xx/yy&#34;) and SEC(&#34;tracepoint/xx/yy&#34;) are actually equivalent, depending on personal preference, which one can be used at will. How to determine the parameter type of the tracepoint event handler and get the corresponding kernel call parameters Suppose that we want to monitor the fchmodat system call involved in the chmod command via tracepoint. Then, how do we determine the types of parameters of the event handler functions in ebpf and how do we get the contents of the corresponding fchmodat system call parameters? For example, get the name of the file to be operated on and the value of the permission mode to be operated on. The first step is to determine the system call used by chmod, which is relatively simple and can be done in a variety of ways, such as through the strace command: $ strace chmod 600 a.txt ... fchmodat(AT_FDCWD, &#34;a.txt&#34;, 0600) = 0 ... The second step is to find the tracepoint event that can be used for this system call: $ sudo cat /sys/kernel/debug/tracing/available_events |grep fchmodat syscalls:sys_exit_fchmodat syscalls:sys_enter_fchmodat As you can see, there are sys_enter_fchmodat and sys_exit_fchmodat events. Here choose sys_enter_fchmodat event for subsequent explanation. The third step is to determine the argument type of the function. This needs to be found in the vmlinux.h file, generally sys_enter_xx corresponds to trace_event_raw_sys_enter, sys_exit_xx corresponds to trace_event_raw_sys_exit, and the others generally correspond to trace_event_raw_sys_enter. trace_event_raw_&lt;name&gt;, if you don&#39;t find it, you can refer to the trace_event_raw_sys_enter example to find its similar struct. For sys_enter_fchmodat, we use the struct trace_event_raw_sys_enter: struct trace_event_raw_sys_enter { struct trace_entry ent; long int id; long unsigned int args[6]; char __data[0]; }; The args stores the information we can get about the event, and what information is contained in them is what we need to determine in step 4. The fourth step is to determine what information is available in the event itself, although we know that the fchmodat system call requires the file name and mode information. However, we are not sure if this information is available in the ebpf program. This can be done by looking at /sys/kernel/debug/tracing/events/&lt;category&gt;/&lt;name&gt;/format file to see what information we can get. For example, the sys_enter_fchmodat event /sys/kernel/debug/tracing/events/syscalls/sys_enter_fchmodat/format is as follows: $ sudo cat /sys/kernel/debug/tracing/events/syscalls/sys_enter_fchmodat/format name: sys_enter_fchmodat ID: 647 format: field:unsigned short common_type; offset:0; size:2; signed:0; field:unsigned char common_flags; offset:2; size:1; signed:0; field:unsigned char common_preempt_count; offset:3; size:1; signed:0; field:int common_pid; offset:4; size:4; signed:1; field:int __syscall_nr; offset:8; size:4; signed:1; field:int dfd; offset:16; size:8; signed:0; field:const char * filename; offset:24; size:8; signed:0; field:umode_t mode; offset:32; size:8; signed:0; print fmt: &#34;dfd: 0x%08lx, filename: 0x%08lx, mode: 0x%08lx&#34;, ((unsigned long)(REC-&gt;dfd)), ((unsigned long)(REC-&gt;filename)), ((unsigned long)(REC-&gt;mode)) The fields referenced in print fmt are all information that we can get in the ebpf program. From the above, we can see that we can get the sys_enter_fchmodat event dfd, filename and mode information. Here contains the previously mentioned file name and permission mode information. The values of these fields can be obtained from the args array of trace_event_raw_sys_enter, i.e. args[0] for dfd, args[1] for filename and so on. Once the information has been determined, you can write the program. For example, the example ebpf program for the sys_enter_fchmodat event above is as follows: SEC(&#34;tracepoint/syscalls/sys_enter_fchmodat&#34;) int tracepoint__syscalls__sys_enter_fchmodat(struct trace_event_raw_sys_enter *ctx) { // ... char *filename_ptr = (char *) BPF_CORE_READ(ctx, args[1]); bpf_core_read_user_str(&amp;event-&gt;filename, sizeof(event-&gt;filename), filename_ptr); event-&gt;mode = BPF_CORE_READ(ctx, args[2]); // ... } You can check out full example codes on Github: https://github.com/mozillazg/hello-libbpfgo/tree/master/07-tracepoint-args https://github.com/mozillazg/hello-libbpfgo/tree/master/14-tracepoint-args-sched_switch References BPF CO-RE reference guide libbpf/libbpf.c at 12e932ac0e18546dd7247e66ea1b4aa236d2ef38 · libbpf/libbpf BCC to libbpf conversion guide"/>
        <meta property="article:published_time" content="2022-05-15" />
            <meta property="article:section" content="ebpf" />
            <meta property="article:tag" content="ebpf" />
            <meta property="article:tag" content="tracepoint" />
            <meta property="article:tag" content="libbpf" />
            <meta property="article:tag" content="libbpfgo" />
            <meta property="article:tag" content="go" />
            <meta property="article:tag" content="golang" />
            <meta property="article:tag" content="en-version" />
            <meta property="article:author" content="mozillazg" />
            <meta property="og:image"
                  content="https://mozillazg.com/static/avatar.jpeg"/>


    <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@mozillazg">
        <meta name="twitter:creator" content="@mozillazg">
    <meta name="twitter:domain" content="https://mozillazg.com">
            <meta property="twitter:image"
                  content="https://mozillazg.com/static/avatar.jpeg"/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.4/dist/css/bootstrap.min.css" type="text/css"/>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/pygments-css@1.0.0/github.css" rel="stylesheet">
    <link rel="stylesheet" href="https://mozillazg.com/theme/css/style.css" type="text/css"/>
            <link href="https://mozillazg.com/static/custom.css" rel="stylesheet">

        <link href="https://mozillazg.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="mozillazg's Blog ATOM Feed"/>

        <link href="https://mozillazg.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="mozillazg's Blog RSS Feed"/>


        <link href="https://mozillazg.com/feeds/ebpf.atom.xml" type="application/atom+xml" rel="alternate"
              title="mozillazg's Blog ebpf ATOM Feed"/>


    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "publisher": {
            "@type": "Person",
            "name": "mozillazg",
            "logo": "https://mozillazg.com/static/avatar.jpeg"
        },
        "author": {
            "@type": "Person",
            "name": "mozillazg",
            "image": "https://mozillazg.com/static/avatar.jpeg",
            "url": "https://mozillazg.com",
            "sameAs": []
        },
        "headline": "Frequently asked questions about using tracepoint with ebpf/libbpf programs",
        "url": "https://mozillazg.com/2022/05/ebpf-libbpf-tracepoint-common-questions-en.html",
        "image": [
            "https://mozillazg.com/static/avatar.jpeg"
         ],
        "keywords": "ebpf, tracepoint, libbpf, libbpfgo, go, golang, en-version",
        "description": "Preface Note some common problems related to tracepoint when writing ebpf/libbpf programs (such as BPF_PROG_TYPE_TRACEPOINT program). What events can be monitored by tracepoint The events that tracepoint can monitor can be found by looking at the contents of the /sys/kernel/debug/tracing/available_events file. The format of each line in the file is: &lt;category&gt;:&lt;name&gt; For example: syscalls:sys_enter_execve Format of SEC content The SEC format for the tracepoint event is: SEC(&#34;tracepoint/&lt;category&gt;/&lt;name&gt;&#34;) // for example: // SEC(&#34;tracepoint/syscalls/sys_enter_openat&#34;) or: SEC(&#34;tp/&lt;category&gt;/&lt;name&gt;&#34;) // for example: // SEC(&#34;tp/syscalls/sys_enter_openat&#34;) the values of &lt;category&gt; and &lt;name&gt; both take the values listed in the available_events file earlier. SEC(&#34;tp/xx/yy&#34;) and SEC(&#34;tracepoint/xx/yy&#34;) are actually equivalent, depending on personal preference, which one can be used at will. How to determine the parameter type of the tracepoint event handler and get the corresponding kernel call parameters Suppose that we want to monitor the fchmodat system call involved in the chmod command via tracepoint. Then, how do we determine the types of parameters of the event handler functions in ebpf and how do we get the contents of the corresponding fchmodat system call parameters? For example, get the name of the file to be operated on and the value of the permission mode to be operated on. The first step is to determine the system call used by chmod, which is relatively simple and can be done in a variety of ways, such as through the strace command: $ strace chmod 600 a.txt ... fchmodat(AT_FDCWD, &#34;a.txt&#34;, 0600) = 0 ... The second step is to find the tracepoint event that can be used for this system call: $ sudo cat /sys/kernel/debug/tracing/available_events |grep fchmodat syscalls:sys_exit_fchmodat syscalls:sys_enter_fchmodat As you can see, there are sys_enter_fchmodat and sys_exit_fchmodat events. Here choose sys_enter_fchmodat event for subsequent explanation. The third step is to determine the argument type of the function. This needs to be found in the vmlinux.h file, generally sys_enter_xx corresponds to trace_event_raw_sys_enter, sys_exit_xx corresponds to trace_event_raw_sys_exit, and the others generally correspond to trace_event_raw_sys_enter. trace_event_raw_&lt;name&gt;, if you don&#39;t find it, you can refer to the trace_event_raw_sys_enter example to find its similar struct. For sys_enter_fchmodat, we use the struct trace_event_raw_sys_enter: struct trace_event_raw_sys_enter { struct trace_entry ent; long int id; long unsigned int args[6]; char __data[0]; }; The args stores the information we can get about the event, and what information is contained in them is what we need to determine in step 4. The fourth step is to determine what information is available in the event itself, although we know that the fchmodat system call requires the file name and mode information. However, we are not sure if this information is available in the ebpf program. This can be done by looking at /sys/kernel/debug/tracing/events/&lt;category&gt;/&lt;name&gt;/format file to see what information we can get. For example, the sys_enter_fchmodat event /sys/kernel/debug/tracing/events/syscalls/sys_enter_fchmodat/format is as follows: $ sudo cat /sys/kernel/debug/tracing/events/syscalls/sys_enter_fchmodat/format name: sys_enter_fchmodat ID: 647 format: field:unsigned short common_type; offset:0; size:2; signed:0; field:unsigned char common_flags; offset:2; size:1; signed:0; field:unsigned char common_preempt_count; offset:3; size:1; signed:0; field:int common_pid; offset:4; size:4; signed:1; field:int __syscall_nr; offset:8; size:4; signed:1; field:int dfd; offset:16; size:8; signed:0; field:const char * filename; offset:24; size:8; signed:0; field:umode_t mode; offset:32; size:8; signed:0; print fmt: &#34;dfd: 0x%08lx, filename: 0x%08lx, mode: 0x%08lx&#34;, ((unsigned long)(REC-&gt;dfd)), ((unsigned long)(REC-&gt;filename)), ((unsigned long)(REC-&gt;mode)) The fields referenced in print fmt are all information that we can get in the ebpf program. From the above, we can see that we can get the sys_enter_fchmodat event dfd, filename and mode information. Here contains the previously mentioned file name and permission mode information. The values of these fields can be obtained from the args array of trace_event_raw_sys_enter, i.e. args[0] for dfd, args[1] for filename and so on. Once the information has been determined, you can write the program. For example, the example ebpf program for the sys_enter_fchmodat event above is as follows: SEC(&#34;tracepoint/syscalls/sys_enter_fchmodat&#34;) int tracepoint__syscalls__sys_enter_fchmodat(struct trace_event_raw_sys_enter *ctx) { // ... char *filename_ptr = (char *) BPF_CORE_READ(ctx, args[1]); bpf_core_read_user_str(&amp;event-&gt;filename, sizeof(event-&gt;filename), filename_ptr); event-&gt;mode = BPF_CORE_READ(ctx, args[2]); // ... } You can check out full example codes on Github: https://github.com/mozillazg/hello-libbpfgo/tree/master/07-tracepoint-args https://github.com/mozillazg/hello-libbpfgo/tree/master/14-tracepoint-args-sched_switch References BPF CO-RE reference guide libbpf/libbpf.c at 12e932ac0e18546dd7247e66ea1b4aa236d2ef38 · libbpf/libbpf BCC to libbpf conversion guide",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https://mozillazg.com/2022/05/ebpf-libbpf-tracepoint-common-questions-en.html"
        },
        "datePublished": "2022-05-15"
    }
    </script>

</head>
<body>

<div class="navbar" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://mozillazg.com/" class="navbar-brand">
mozillazg's Blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="https://mozillazg.com/feeds/all.atom.xml">Feed</a></li>
                    <li><a href="/2014/10/pages/about-me.html">About</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://mozillazg.com/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
    <section id="content" class="yue">
        <article>
            <header class="text-center">
                <h1>
                    <a href="https://mozillazg.com/2022/05/ebpf-libbpf-tracepoint-common-questions-en.html"
                       rel="bookmark"
                       title="Permalink to Frequently asked questions about using tracepoint with ebpf/libbpf programs">
                        Frequently asked questions about using tracepoint with ebpf/libbpf programs
                    </a>
                </h1>
                <p class="published">
                    <time datetime="2022-05-15T00:00:00+00:00">
                    2022-05-15
                    </time>
                </p>
            </header>
            <div class="entry-content">
                <div class="well-sm article-info">
<footer class="post-info">
        <a href="https://mozillazg.com/category/ebpf.html">ebpf</a>


<span class="label label-default hide">Tags</span>
	<a href="https://mozillazg.com/tag/tracepoint.html">tracepoint</a>
        /
	<a href="https://mozillazg.com/tag/libbpf.html">libbpf</a>
        /
	<a href="https://mozillazg.com/tag/libbpfgo.html">libbpfgo</a>
        /
	<a href="https://mozillazg.com/tag/go.html">go</a>
        /
	<a href="https://mozillazg.com/tag/golang.html">golang</a>
        /
	<a href="https://mozillazg.com/tag/en-version.html">en-version</a>
    <span class="label label-default">Lang</span>
	<a href="https://mozillazg.com/2022/05/ebpf-libbpf-tracepoint-common-questions.html">zh</a>

</footer><!-- /.post-info -->                </div>
                <div class="js-toc"></div>
                <div>
                <div class="section" id="preface">
<h2 id="hidpreface">Preface<a class="headerlink" href="#hidpreface" title="Permalink to this headline">¶</a></h2>
<p>Note some common problems related to tracepoint when writing ebpf/libbpf programs (such as <tt class="docutils literal">BPF_PROG_TYPE_TRACEPOINT</tt> program).</p>
</div>
<div class="section" id="what-events-can-be-monitored-by-tracepoint">
<h2 id="hidwhat-events-can-be-monitored-by-tracepoint">What events can be monitored by tracepoint<a class="headerlink" href="#hidwhat-events-can-be-monitored-by-tracepoint" title="Permalink to this headline">¶</a></h2>
<p>The events that tracepoint can monitor can be found by looking at the contents of the <tt class="docutils literal">/sys/kernel/debug/tracing/available_events</tt> file.</p>
<p>The format of each line in the file is:</p>
<pre class="literal-block">
&lt;category&gt;:&lt;name&gt;
</pre>
<p>For example:</p>
<pre class="literal-block">
syscalls:sys_enter_execve
</pre>
</div>
<div class="section" id="format-of-sec-content">
<h2 id="hidformat-of-sec-content">Format of SEC content<a class="headerlink" href="#hidformat-of-sec-content" title="Permalink to this headline">¶</a></h2>
<p>The SEC format for the tracepoint event is:</p>
<pre class="literal-block">
SEC(&quot;tracepoint/&lt;category&gt;/&lt;name&gt;&quot;)

// for example:
// SEC(&quot;tracepoint/syscalls/sys_enter_openat&quot;)
</pre>
<p>or:</p>
<pre class="literal-block">
SEC(&quot;tp/&lt;category&gt;/&lt;name&gt;&quot;)

// for example:
// SEC(&quot;tp/syscalls/sys_enter_openat&quot;)
</pre>
<p>the values of <tt class="docutils literal">&lt;category&gt;</tt> and <tt class="docutils literal">&lt;name&gt;</tt> both take the values listed in the available_events file earlier.</p>
<p><tt class="docutils literal"><span class="pre">SEC(&quot;tp/xx/yy&quot;)</span></tt> and <tt class="docutils literal"><span class="pre">SEC(&quot;tracepoint/xx/yy&quot;)</span></tt> are actually equivalent, depending on personal preference, which one can be used at will.</p>
</div>
<div class="section" id="how-to-determine-the-parameter-type-of-the-tracepoint-event-handler-and-get-the-corresponding-kernel-call-parameters">
<h2 id="hidhow-to-determine-the-parameter-type-of-the-tracepoint-event-handler-and-get-the-corresponding-kernel-call-parameters">How to determine the parameter type of the tracepoint event handler and get the corresponding kernel call parameters<a class="headerlink" href="#hidhow-to-determine-the-parameter-type-of-the-tracepoint-event-handler-and-get-the-corresponding-kernel-call-parameters" title="Permalink to this headline">¶</a></h2>
<p>Suppose that we want to monitor the <tt class="docutils literal">fchmodat</tt> system call involved in the <tt class="docutils literal">chmod</tt> command via tracepoint. Then, how do we determine the types of parameters of the event handler functions in ebpf and how do we get the contents of the corresponding <tt class="docutils literal">fchmodat</tt> system call parameters? For example, get the name of the file to be operated on and the value of the permission mode to be operated on.</p>
<p>The first step is to determine the system call used by <tt class="docutils literal">chmod</tt>, which is relatively simple and can be done in a variety of ways, such as through the <tt class="docutils literal">strace</tt> command:</p>
<pre class="literal-block">
$ strace chmod 600 a.txt
...
fchmodat(AT_FDCWD, &quot;a.txt&quot;, 0600)       = 0
...
</pre>
<p>The second step is to find the tracepoint event that can be used for this system call:</p>
<pre class="literal-block">
$ sudo cat /sys/kernel/debug/tracing/available_events |grep fchmodat
syscalls:sys_exit_fchmodat
syscalls:sys_enter_fchmodat
</pre>
<p>As you can see, there are <tt class="docutils literal">sys_enter_fchmodat</tt> and <tt class="docutils literal">sys_exit_fchmodat</tt> events. Here choose
<tt class="docutils literal">sys_enter_fchmodat</tt> event for subsequent explanation.</p>
<p>The third step is to determine the argument type of the function. This needs to be found in the <tt class="docutils literal">vmlinux.h</tt> file, generally <tt class="docutils literal">sys_enter_xx</tt> corresponds to <tt class="docutils literal">trace_event_raw_sys_enter</tt>, <tt class="docutils literal">sys_exit_xx</tt> corresponds to <tt class="docutils literal">trace_event_raw_sys_exit</tt>, and the others generally correspond to <tt class="docutils literal">trace_event_raw_sys_enter</tt>. <tt class="docutils literal">trace_event_raw_&lt;name&gt;</tt>, if you don't find it, you can refer to the <tt class="docutils literal">trace_event_raw_sys_enter</tt> example to find its similar struct.</p>
<p>For <tt class="docutils literal">sys_enter_fchmodat</tt>, we use the struct <tt class="docutils literal">trace_event_raw_sys_enter</tt>:</p>
<div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">trace_event_raw_sys_enter</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">trace_entry</span> <span class="n">ent</span><span class="p">;</span>
    <span class="kt">long</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">args</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">__data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>
</pre></div>
<p>The <tt class="docutils literal">args</tt> stores the information we can get about the event, and what information is contained in them is what we need to determine in step 4.</p>
<p>The fourth step is to determine what information is available in the event itself, although we know that the <tt class="docutils literal">fchmodat</tt> system call requires the file name and mode information.
However, we are not sure if this information is available in the ebpf program. This can be done by looking at
<tt class="docutils literal"><span class="pre">/sys/kernel/debug/tracing/events/&lt;category&gt;/&lt;name&gt;/format</span></tt> file to see what information we can get.
For example, the <tt class="docutils literal">sys_enter_fchmodat</tt> event <tt class="docutils literal">/sys/kernel/debug/tracing/events/syscalls/sys_enter_fchmodat/format</tt> is as follows:</p>
<pre class="literal-block">
$ sudo cat /sys/kernel/debug/tracing/events/syscalls/sys_enter_fchmodat/format
name: sys_enter_fchmodat
ID: 647
format:
        field:unsigned short common_type;       offset:0;       size:2; signed:0;
        field:unsigned char common_flags;       offset:2;       size:1; signed:0;
        field:unsigned char common_preempt_count;       offset:3;       size:1; signed:0;
        field:int common_pid;   offset:4;       size:4; signed:1;

        field:int __syscall_nr; offset:8;       size:4; signed:1;
        field:int dfd;  offset:16;      size:8; signed:0;
        field:const char * filename;    offset:24;      size:8; signed:0;
        field:umode_t mode;     offset:32;      size:8; signed:0;

print fmt: &quot;dfd: 0x%08lx, filename: 0x%08lx, mode: 0x%08lx&quot;, ((unsigned long)(REC-&gt;dfd)), ((unsigned long)(REC-&gt;filename)), ((unsigned long)(REC-&gt;mode))
</pre>
<p>The fields referenced in <tt class="docutils literal">print fmt</tt> are all information that we can get in the ebpf program.
From the above, we can see that we can get the <tt class="docutils literal">sys_enter_fchmodat</tt> event <tt class="docutils literal">dfd</tt>, <tt class="docutils literal">filename</tt> and <tt class="docutils literal">mode</tt> information.  Here contains the previously mentioned file name and permission mode information.
The values of these fields can be obtained from the <tt class="docutils literal">args</tt> array of <tt class="docutils literal">trace_event_raw_sys_enter</tt>, i.e. <tt class="docutils literal">args[0]</tt> for <tt class="docutils literal">dfd</tt>, <tt class="docutils literal">args[1]</tt> for <tt class="docutils literal">filename</tt> and so on.</p>
<p>Once the information has been determined, you can write the program. For example, the example ebpf program for the <tt class="docutils literal">sys_enter_fchmodat</tt> event above is as follows:</p>
<div class="highlight"><pre><span></span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;tracepoint/syscalls/sys_enter_fchmodat&quot;</span><span class="p">)</span>
<span class="kt">int</span> <span class="n">tracepoint__syscalls__sys_enter_fchmodat</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_event_raw_sys_enter</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
        <span class="c1">// ...</span>

        <span class="kt">char</span> <span class="o">*</span><span class="n">filename_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_CORE_READ</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="n">bpf_core_read_user_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">),</span> <span class="n">filename_ptr</span><span class="p">);</span>
        <span class="n">event</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">BPF_CORE_READ</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

        <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
<p>You can check out full example codes on Github:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/mozillazg/hello-libbpfgo/tree/master/07-tracepoint-args">https://github.com/mozillazg/hello-libbpfgo/tree/master/07-tracepoint-args</a></li>
<li><a class="reference external" href="https://github.com/mozillazg/hello-libbpfgo/tree/master/14-tracepoint-args-sched_switch">https://github.com/mozillazg/hello-libbpfgo/tree/master/14-tracepoint-args-sched_switch</a></li>
</ul>
</div>
<div class="section" id="references">
<h2 id="hidreferences">References<a class="headerlink" href="#hidreferences" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://nakryiko.com/posts/bpf-core-reference-guide/">BPF CO-RE reference guide</a></li>
<li><a class="reference external" href="https://github.com/libbpf/libbpf/blob/12e932ac0e18546dd7247e66ea1b4aa236d2ef38/src/libbpf.c#L9002-L9081">libbpf/libbpf.c at 12e932ac0e18546dd7247e66ea1b4aa236d2ef38 · libbpf/libbpf</a></li>
<li><a class="reference external" href="https://nakryiko.com/posts/bcc-to-libbpf-howto-guide/">BCC to libbpf conversion guide</a></li>
</ul>
</div>

                </div>
            </div>
            <!-- /.entry-content -->
<section class="text-center">
  
<div id="donate"></div>

<div class="social-share"></div>
<div class="social-comment-note">
<p>有任何建议和想法欢迎在下方评论区留言或者加我<a href="/static/wechat.png">微信</a>交流</p>
</div>

</section>
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'my-github-blog'; // required: replace example with your forum shortname

                    var disqus_identifier = 'ebpf-libbpf-tracepoint-common-questions';
                var disqus_url = 'https://mozillazg.com/2022/05/ebpf-libbpf-tracepoint-common-questions-en.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2022 mozillazg
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>
            &middot; <a href="/privacy-policy.html" target="_blank">Privacy</a>              <p><small>  <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="/static/images/by-sa-80x15.png" /></a>
    &quot;<span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">mozillazg's Blog</span>&quot; by <a xmlns:cc="http://creativecommons.org/ns#" href="https://mozillazg.com" property="cc:attributionName" rel="cc:attributionURL">mozillazg</a> is
  licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/jquery@2.1.1/dist/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'my-github-blog'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-77172981-1', 'auto');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->

<!-- share.js -->
<script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script>



<script src="https://cdn.jsdelivr.net/npm/tocbot@3.0.2/dist/tocbot.min.js"></script>
<script>
$(document).ready(function(){
  tocbot.init({
    // Where to render the table of contents.
    tocSelector: '.js-toc',
    // Where to grab the headings to build the table of contents.
    contentSelector: '.entry-content',
    // Which headings to grab inside of the contentSelector element.
    headingSelector: 'h2, h3, h4,h5',
    // Headings that match the ignoreSelector will be skipped.
    ignoreSelector: '.js-toc-ignore',
    // Main class to add to links.
    linkClass: 'toc-link',
    // Extra classes to add to links.
    extraLinkClasses: '',
    // Class to add to active links,
    // the link corresponding to the top most heading on the page.
    activeLinkClass: 'is-active-link',
    // Main class to add to lists.
    listClass: 'toc-list',
    // Extra classes to add to lists.
    extraListClasses: '',
    // Class that gets added when a list should be collapsed.
    isCollapsedClass: 'is-collapsed',
    // Class that gets added when a list should be able
    // to be collapsed but isn't necessarily collpased.
    collapsibleClass: 'is-collapsible',
    // Class to add to list items.
    listItemClass: 'toc-list-item',
    // How many heading levels should not be collpased.
    // For example, number 6 will show everything since
    // there are only 6 heading levels and number 0 will collpase them all.
    // The sections that are hidden will open
    // and close as you scroll to headings within them.
    collapseDepth: 6,
    // Smooth scrolling enabled.
    smoothScroll: true,
    // Smooth scroll duration.
    smoothScrollDuration: 420,
    // Callback for scroll end (requires: smoothScroll).
    scrollEndCallback: function (e) {},
    // Headings offset between the headings and the top of the document (this is meant for minor adjustments).
    headingsOffset: 0,
    // Timeout between events firing to make sure it's
    // not too rapid (for performance reasons).
    throttleTimeout: 50,
    // Element to add the positionFixedClass to.
    positionFixedSelector: null,
    // Fixed position class to add to make sidebar fixed after scrolling
    // down past the fixedSidebarOffset.
    positionFixedClass: 'is-position-fixed',
    // fixedSidebarOffset can be any number but by default is set
    // to auto which sets the fixedSidebarOffset to the sidebar
    // element's offsetTop from the top of the document on init.
    fixedSidebarOffset: 'auto',
    // includeHtml can be set to true to include the HTML markup from the
    // heading node instead of just including the textContent.
    includeHtml: false
  });
});
</script>
</body>
</html>