<!DOCTYPE html>
<html lang="zh"  prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml" class="han-init">
<head>
    <title>ptcpdump v0.16 ~ v0.26 的主要变更内容 - mozillazg's Blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- share.css -->
    <link rel="stylesheet" href="/theme/cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css">


    <link href="https://mozillazg.com/favicon.ico" rel="icon">

<link rel="canonical" href="https://mozillazg.com/2024/11/whats-new-ptcpdump-v1.16-v1.26.html">

        <meta name="author" content="mozillazg" />
        <meta name="keywords" content="others,ptcpdump" />
    <meta name="description" content="ptcpdump v0.16 ~ v0.26 的主要变更内容 - 前言 距离 上次首次介绍 ptcpdump 项目已经过去好几个月了， 最近这几个月我一直在持续开发这个项目， 本文将按变更顺序介绍一下从上次的 v0.16 版本到最新的 v0.26 版本期间所发布的主要变更内容。 主要变更内容 兼容老版本的 TencentOS/OpenCloudOS 系统 根据用户 反馈 ， 之前的版本无法在老版本的 TencentOS/OpenCloudOS 上运行， 当前最新版本已经支持了如下 TencentOS/OpenCloudOS 系统版本： OpenCloudOS 7/8/9 and TencentOS Server 2.4/2.6/3.1/3.2 。 在输出中增加父进程信息 老版本: 13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52) 139.178.84.217.443 &gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0 Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org) Container (...) Pod (...) 新版本: 13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52) 139.178.84.217.443 &gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0 Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org) ParentProc (pid 553296, cmd /bin/sh, args sh) Container (...) Pod (...) 支持使用 Dockershim 的老版本 Kubernetes 环境 之前的版本无法在使用 Dockershim （准确的说是基于 CRI v1alpha2）的老版本 Kubernetes 环境中获取 Pod 信息，新版本已兼容这种环境。 修复按 Pod 名称过滤时，无法支持包含点号的名称 之前的版本中按 Pod 名称过滤时，过滤的名称不能包含英文点号，新版本已兼容包含点号的名称: --pod-name foo.bar.default 修复按 Pod 过滤时，无法支持包含多个容器的 Pod 的场景 之前的版本中按 Pod 过滤时，无法支持 Pod 中存在多个容器的场景，新版本已修复该问题。 支持同时运行多个 ptcpdump 实例 之前的版本同时只能运行一个 ptcpdump 进程，当运行多个 ptcpdump 进程时，老的进程将不能正常工作（抓不到任何流量）， 新版本已修复该问题，在新版本中可以同时运行多个 ptcpdump ..." />

    <style>
      .js-toc {
        margin-bottom: 20px;
      }
      .donate-modal {
        text-align: center;
      }
      #donate-modal-container .donate-image {
        max-height: 300px !important;
        min-height: inherit !important;
      }
    </style>

        <meta property="og:site_name" content="mozillazg's Blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="ptcpdump v0.16 ~ v0.26 的主要变更内容"/>
        <meta property="og:url" content="https://mozillazg.com/2024/11/whats-new-ptcpdump-v1.16-v1.26.html"/>
        <meta property="og:description" content="前言 距离 上次首次介绍 ptcpdump 项目已经过去好几个月了， 最近这几个月我一直在持续开发这个项目， 本文将按变更顺序介绍一下从上次的 v0.16 版本到最新的 v0.26 版本期间所发布的主要变更内容。 主要变更内容 兼容老版本的 TencentOS/OpenCloudOS 系统 根据用户 反馈 ， 之前的版本无法在老版本的 TencentOS/OpenCloudOS 上运行， 当前最新版本已经支持了如下 TencentOS/OpenCloudOS 系统版本： OpenCloudOS 7/8/9 and TencentOS Server 2.4/2.6/3.1/3.2 。 在输出中增加父进程信息 老版本: 13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52) 139.178.84.217.443 &gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0 Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org) Container (...) Pod (...) 新版本: 13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52) 139.178.84.217.443 &gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0 Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org) ParentProc (pid 553296, cmd /bin/sh, args sh) Container (...) Pod (...) 支持使用 Dockershim 的老版本 Kubernetes 环境 之前的版本无法在使用 Dockershim （准确的说是基于 CRI v1alpha2）的老版本 Kubernetes 环境中获取 Pod 信息，新版本已兼容这种环境。 修复按 Pod 名称过滤时，无法支持包含点号的名称 之前的版本中按 Pod 名称过滤时，过滤的名称不能包含英文点号，新版本已兼容包含点号的名称: --pod-name foo.bar.default 修复按 Pod 过滤时，无法支持包含多个容器的 Pod 的场景 之前的版本中按 Pod 过滤时，无法支持 Pod 中存在多个容器的场景，新版本已修复该问题。 支持同时运行多个 ptcpdump 实例 之前的版本同时只能运行一个 ptcpdump 进程，当运行多个 ptcpdump 进程时，老的进程将不能正常工作（抓不到任何流量）， 新版本已修复该问题，在新版本中可以同时运行多个 ptcpdump 进程，多个 ptcpdump 进程不会出现互相干扰或导致其他进程无法抓包的问题。 支持同时过滤多个进程 PID 现在 --pid 参数支持过滤多个 pid 了: --pid pid1 --pid pid2 新增参数 --micro, --nano, --time-stamp-precision 用于控制输出中的时间格式 新增参数 --micro, --nano, --time-stamp-precision ，作用和用法对标 tcpdump。 --micro, --time-stamp-precision=micro: 13:36:05.701978 IP 10.0.2.15.22 &gt; 10.0.2.2.59874: Flags [P.], seq 1370707216:1370707292, ack 4569736, win 62780, length 76 --nano, --time-stamp-precision=nano: 13:36:05.701978488 IP 10.0.2.15.22 &gt; 10.0.2.2.59874: Flags [P.], seq 1370707216:1370707292, ack 4569736, win 62780, length 76 新增参数 -A, -x, -xx, -X, -XX 用于控制数据输出格式 新增作用和用法对标 tcpdump 的参数 -A, -x, -xx, -X, -XX 。 -A: 14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094] E..nHL@.@... ..........P.G..vbbEP.......GET / HTTP/1.1 Host: qq.com User-Agent: curl/7.81.0 Accept: */* -x: 14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094] 0x0000: 4500 006e 484c 4000 4006 1bc4 0a00 020f 0x0010: cbcd fe9d d0e6 0050 c447 8e98 7662 6245 0x0020: 5018 faf0 d6da 0000 4745 5420 2f20 4854 0x0030: 5450 2f31 2e31 0d0a 486f 7374 3a20 7171 0x0040: 2e63 6f6d 0d0a 5573 6572 2d41 6765 6e74 0x0050: 3a20 6375 726c 2f37 2e38 312e 300d 0a41 0x0060: 6363 6570 743a 202a 2f2a 0d0a 0d0a -xx: 14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094] 0x0000: 0050 56eb bc4e 000c 298e 31f3 0800 4500 0x0010: 006e 484c 4000 4006 1bc4 0a00 020f cbcd 0x0020: fe9d d0e6 0050 c447 8e98 7662 6245 5018 0x0030: faf0 d6da 0000 4745 5420 2f20 4854 5450 0x0040: 2f31 2e31 0d0a 486f 7374 3a20 7171 2e63 0x0050: 6f6d 0d0a 5573 6572 2d41 6765 6e74 3a20 0x0060: 6375 726c 2f37 2e38 312e 300d 0a41 6363 0x0070: 6570 743a 202a 2f2a 0d0a 0d0a -X: 14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094] 0x0000: 4500 006e 484c 4000 4006 1bc4 0a00 020f E..nHL@.@....... 0x0010: cbcd fe9d d0e6 0050 c447 8e98 7662 6245 .......P.G..vbbE 0x0020: 5018 faf0 d6da 0000 4745 5420 2f20 4854 P.......GET / HT 0x0030: 5450 2f31 2e31 0d0a 486f 7374 3a20 7171 TP/1.1..Host: qq 0x0040: 2e63 6f6d 0d0a 5573 6572 2d41 6765 6e74 .com..User-Agent 0x0050: 3a20 6375 726c 2f37 2e38 312e 300d 0a41 : curl/7.81.0..A 0x0060: 6363 6570 743a 202a 2f2a 0d0a 0d0a ccept: */*.... -XX: 14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094] 0x0000: 0050 56eb bc4e 000c 298e 31f3 0800 4500 .PV..N..).1...E. 0x0010: 006e 484c 4000 4006 1bc4 0a00 020f cbcd .nHL@.@......... 0x0020: fe9d d0e6 0050 c447 8e98 7662 6245 5018 .....P.G..vbbEP. 0x0030: faf0 d6da 0000 4745 5420 2f20 4854 5450 ......GET / HTTP 0x0040: 2f31 2e31 0d0a 486f 7374 3a20 7171 2e63 /1.1..Host: qq.c 0x0050: 6f6d 0d0a 5573 6572 2d41 6765 6e74 3a20 om..User-Agent: 0x0060: 6375 726c 2f37 2e38 312e 300d 0a41 6363 curl/7.81.0..Acc 0x0070: 6570 743a 202a 2f2a 0d0a 0d0a ept: */*.... 新增用于编译和运行 ptcpdump 的 Docker 镜像 新增用于编译程序的 Docker 镜像： quay.io/ptcpdump/develop:latest 以及用于通过 Docker 运行 ptcpdump 的镜像： quay.io/ptcpdump/ptcpdump:latest 可以通过 make build-bpf-via-docker 和 make build-via-docker 按需编译 eBPF 程序和 ptcpdump 程序。 可以使用类似下面的命令，通过 docker 运行 ptcpdump: docker run --privileged --rm -t --net=host --pid=host \ -v /sys/fs/cgroup:/sys/fs/cgroup:ro \ quay.io/ptcpdump/ptcpdump:latest ptcpdump -i any -c 2 tcp 实验性新功能：在对 Go 程序进行抓包时生成相应的 TLS Key Log 文件 在新版本中还尝试了一个实验性的功能：在对 Go 程序进行抓包时生成相应的 TLS Key Log 文件。 TLS Key Log 文件又叫 SSLKEYLOGFILE ， 在 Wireshark 中对应的是 pre-master secret 配置， 第三方程序可以通过这个文件中记录的信息解密抓取的 TLS 流量。 注意：该功能是一个实验性的功能，只支持 1.18+ 版本的 Go 编译的程序（支持 stripped 的二进制）， 并且只支持通过 ptcpdump 运行目标 Go 程序。 可以通过下面两种方法试用这个功能： 通过 --write-keylog-file 参数或者环境变量 SSLKEYLOGFILE 指定 SSLKEYLOGFILE 文件的保存路径: sudo ptcpdump -i any --write-keylog-file /tmp/keylogfile.txt -w /tmp/go.pcapng -- ./gohttpapp 通过指定 --embed-keylog-to-pcapng 参数在保存数据到 pcapng 格式文件时内嵌 SSLKEYLOGFILE 文件内容: sudo ptcpdump -i any --embed-keylog-to-pcapng -w /tmp/gotls.pcapng -- ./gohttpapp 可以通过 Wireshark 或 tshark 使用记录的 SSLKEYLOGFILE 内容对保存的 TLS 数据进行解密: $ sudo tshark -r /tmp/go.pcapng -o tls.keylog_file:/tmp/keylogfile.txt | grep HTTP -B 2 Running as user &#34;root&#34; and group &#34;root&#34;. This could be dangerous. 18 0.518380586 10.0.2.15 → 13.35.238.63 TLSv1.3 118 Change Cipher Spec, Finished 19 0.519208290 13.35.238.63 → 10.0.2.15 TCP 60 443 → 47606 [ACK] Seq=5508 Ack=340 Win=64240 Len=0 20 0.519914720 10.0.2.15 → 13.35.238.63 HTTP 179 GET /foo/bar HTTP/1.1 $ tshark -r /tmp/gotls.pcapng | grep HTTP -B 2 20 0.525662563 10.0.2.15 → 13.35.238.114 TLSv1.3 118 Change Cipher Spec, Finished 21 0.526138582 13.35.238.114 → 10.0.2.15 TCP 60 443 → 37618 [ACK] Seq=5987 Ack=340 Win=64240 Len=0 22 0.526977836 10.0.2.15 → 13.35.238.114 HTTP 179 GET /foo/bar HTTP/1.1 ptcpdump 计划未来内置支持使用 SSLKEYLOGFILE 对 TLS 数据进行解密的能力， 以及在抓包时实时获取 SSLKEYLOGFILE 并自动解密的能力， 目前暂时只能使用第三方工具实现 TLS 数据解密。 默认输出 TCP Options 新版本将默认输出 TCP Options 信息： 老版本: 14:09:54.324433 ens33 curl.26570 Out IP (..).43772 &gt; (..).443: Flags [S], seq 1674193846, win 64240, length 0, ParentProc [ptcpdump.26560] 新版本: 14:09:54.324433 ens33 curl.26570 Out IP (..).43772 &gt; (..).443: Flags [S], seq 1674193846, win 64240, options [mss 1460,sackOK,TS val 2107137325 ecr 0,nop,wscale 7], length 0, ParentProc [ptcpdump.26560] 同时新版本还新增对 TCP SACK (Selective Acknowledgment) 和 TFO (TCP Fast Open) 的支持: SACK: 19:03:36.220872 IP6 dead:beef:2::2.35288 &gt; dead:beef:2::1.10029: Flags [.], seq 731670714, ack 2274465610, win 201, options [nop,nop,TS val 1253137130 ecr 837820024,nop,nop,sack 1 {2274467010:2274483378},mptcp 12 dss ack 16301812255838552430], length 0 TFO: 19:22:26.586851 IP6 dead:beef:1::2.54040 &gt; dead:beef:1::1.10056: Flags [S], seq 271661201, win 64800, options [mss 1440,sackOK,TS val 2947503028 ecr 0,nop,wscale 7,tfo cookiereq,nop,nop,mptcp 4 capable v1 flags [H]], length 0 19:22:26.591736 IP6 dead:beef:1::1.10056 &gt; dead:beef:1::2.54040: Flags [S.], seq 1229575956, ack 271661202, win 64260, options [mss 1440,nop,nop,sackOK,nop,wscale 7,tfo cookie 29b3cc66639d427d,nop,nop,mptcp 12 capable v1 flags [H] {0xc87438912bc26cb7}], length 0 输出 TCP Options 中的 MPTCP 信息 应 MPTCP (MultiPath TCP) 社区的 需求 ， 新增对 MPTCP 的支持: 15:31:51.696224 IP 10.0.1.2.60958 &gt; 10.0.1.1.10004: Flags [S], seq 3019570341, win 64240, options [mss 1460,sackOK,TS val 1007819908 ecr 0,nop,wscale 7,mptcp 4 capable v1 flags [H]], length 0 15:31:51.696346 IP 10.0.1.1.10004 &gt; 10.0.1.2.60958: Flags [S.], seq 2367868313, ack 3019570342, win 65160, options [mss 1460,sackOK,TS val 162498895 ecr 1007819908,nop,wscale 7,mptcp 12 capable v1 flags [H] {0x8ea1df6e0d588003}], length 0 15:31:51.696587 IP 10.0.1.2.60958 &gt; 10.0.1.1.10004: Flags [.], seq 3019570342, ack 2367868314, win 502, options [nop,nop,TS val 1007819909 ecr 162498895,mptcp 20 capable v1 flags [H] {0x465bcd01b5d78120,0x8ea1df6e0d588003}], length 0 新增参数 --netns 支持对在其他网络命名空间中的网络接口进行抓包 之前的版本只支持对当前网络命名空间中的网络接口进行抓包，新版本通过新增 --netns 参数支持对其他网络命名空间中的网络接口进行抓包: sudo ptcpdump -i lo --netns /run/netns/foobar sudo ptcpdump -i any --netns /run/netns/foobar sudo ptcpdump -i any --netns /proc/26/ns/net PcapNg 格式增强：读取/写入网络接口名称和 Inbound/Outbound 信息 在之前的版本中使用 ptcpdump -r &lt;file.pcapng&gt; 读取 pcapng 文件不会读取其中记录的网络接口名称以及 Inbound/Outbound 信息， 在新版本中已经解决了这个问题: $ ptcpdump -r demo.pcapng 14:36:35.880947 ens33 curl.244103 Out IP 10.0.2.15.37668 &gt; 114.114.114.114.53: 44427+ A? qq.com. (24), ParentProc [ptcpdump.244094] 14:36:35.882099 ens33 curl.244103 Out IP 10.0.2.15.37668 &gt; 114.114.114.114.53: 31415+ AAAA? qq.com. (24), ParentProc [ptcpdump.244094] 14:36:35.954613 ens33 curl.244103 In IP 114.114.114.114.53 &gt; 10.0.2.15.37668: 44427 3/0/0 A 203.205.254.157, A 113.108.81.189, A 123.150.76.218 (72), ParentProc [ptcpdump.244094] 同时新版在将捕获的流量信息保存为 PcapNg 格式的文件时，会自动写入 Inbound/Outbound 信息（之前的版本已写入网络接口信息）， 即支持 PcapNg 格式的 epb_flags （Enhanced Packet Block Flags Word ） 标记。 如果你对 ptcpdump 有额外的改进或新功能建议，欢迎在评论区或项目 issues 中留言。"/>
        <meta property="article:published_time" content="2024-11-02" />
            <meta property="article:section" content="others" />
            <meta property="article:tag" content="others" />
            <meta property="article:tag" content="ptcpdump" />
            <meta property="article:author" content="mozillazg" />
            <meta property="og:image"
                  content="https://mozillazg.com/static/avatar.jpeg"/>


    <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@mozillazg">
        <meta name="twitter:creator" content="@mozillazg">
    <meta name="twitter:domain" content="https://mozillazg.com">
            <meta property="twitter:image"
                  content="https://mozillazg.com/static/avatar.jpeg"/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/cdn.jsdelivr.net/npm/bootstrap@3.3.4/dist/css/bootstrap.min.css" type="text/css"/>
    <link href="/theme/cdn.jsdelivr.net/npm/font-awesome@4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/cdn.jsdelivr.net/npm/pygments-css@1.0.0/github.css" rel="stylesheet">
    <link rel="stylesheet" href="https://mozillazg.com/theme/css/style.css" type="text/css"/>
            <link href="/static/han.min.css" rel="stylesheet">
            <link href="/static/yue.css" rel="stylesheet">
            <link href="/static/custom.css" rel="stylesheet">

        <link href="https://mozillazg.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="mozillazg's Blog ATOM Feed"/>

        <link href="https://mozillazg.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="mozillazg's Blog RSS Feed"/>


        <link href="https://mozillazg.com/feeds/others.atom.xml" type="application/atom+xml" rel="alternate"
              title="mozillazg's Blog others ATOM Feed"/>


    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "publisher": {
            "@type": "Person",
            "name": "mozillazg",
            "logo": "https://mozillazg.com/static/avatar.jpeg"
        },
        "author": {
            "@type": "Person",
            "name": "mozillazg",
            "image": "https://mozillazg.com/static/avatar.jpeg",
            "url": "https://mozillazg.com",
            "sameAs": []
        },
        "headline": "ptcpdump v0.16 ~ v0.26 的主要变更内容",
        "url": "https://mozillazg.com/2024/11/whats-new-ptcpdump-v1.16-v1.26.html",
        "image": [
            "https://mozillazg.com/static/avatar.jpeg"
         ],
        "keywords": "others, ptcpdump",
        "description": "前言 距离 上次首次介绍 ptcpdump 项目已经过去好几个月了， 最近这几个月我一直在持续开发这个项目， 本文将按变更顺序介绍一下从上次的 v0.16 版本到最新的 v0.26 版本期间所发布的主要变更内容。 主要变更内容 兼容老版本的 TencentOS/OpenCloudOS 系统 根据用户 反馈 ， 之前的版本无法在老版本的 TencentOS/OpenCloudOS 上运行， 当前最新版本已经支持了如下 TencentOS/OpenCloudOS 系统版本： OpenCloudOS 7/8/9 and TencentOS Server 2.4/2.6/3.1/3.2 。 在输出中增加父进程信息 老版本: 13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52) 139.178.84.217.443 &gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0 Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org) Container (...) Pod (...) 新版本: 13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52) 139.178.84.217.443 &gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0 Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org) ParentProc (pid 553296, cmd /bin/sh, args sh) Container (...) Pod (...) 支持使用 Dockershim 的老版本 Kubernetes 环境 之前的版本无法在使用 Dockershim （准确的说是基于 CRI v1alpha2）的老版本 Kubernetes 环境中获取 Pod 信息，新版本已兼容这种环境。 修复按 Pod 名称过滤时，无法支持包含点号的名称 之前的版本中按 Pod 名称过滤时，过滤的名称不能包含英文点号，新版本已兼容包含点号的名称: --pod-name foo.bar.default 修复按 Pod 过滤时，无法支持包含多个容器的 Pod 的场景 之前的版本中按 Pod 过滤时，无法支持 Pod 中存在多个容器的场景，新版本已修复该问题。 支持同时运行多个 ptcpdump 实例 之前的版本同时只能运行一个 ptcpdump 进程，当运行多个 ptcpdump 进程时，老的进程将不能正常工作（抓不到任何流量）， 新版本已修复该问题，在新版本中可以同时运行多个 ptcpdump 进程，多个 ptcpdump 进程不会出现互相干扰或导致其他进程无法抓包的问题。 支持同时过滤多个进程 PID 现在 --pid 参数支持过滤多个 pid 了: --pid pid1 --pid pid2 新增参数 --micro, --nano, --time-stamp-precision 用于控制输出中的时间格式 新增参数 --micro, --nano, --time-stamp-precision ，作用和用法对标 tcpdump。 --micro, --time-stamp-precision=micro: 13:36:05.701978 IP 10.0.2.15.22 &gt; 10.0.2.2.59874: Flags [P.], seq 1370707216:1370707292, ack 4569736, win 62780, length 76 --nano, --time-stamp-precision=nano: 13:36:05.701978488 IP 10.0.2.15.22 &gt; 10.0.2.2.59874: Flags [P.], seq 1370707216:1370707292, ack 4569736, win 62780, length 76 新增参数 -A, -x, -xx, -X, -XX 用于控制数据输出格式 新增作用和用法对标 tcpdump 的参数 -A, -x, -xx, -X, -XX 。 -A: 14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094] E..nHL@.@... ..........P.G..vbbEP.......GET / HTTP/1.1 Host: qq.com User-Agent: curl/7.81.0 Accept: */* -x: 14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094] 0x0000: 4500 006e 484c 4000 4006 1bc4 0a00 020f 0x0010: cbcd fe9d d0e6 0050 c447 8e98 7662 6245 0x0020: 5018 faf0 d6da 0000 4745 5420 2f20 4854 0x0030: 5450 2f31 2e31 0d0a 486f 7374 3a20 7171 0x0040: 2e63 6f6d 0d0a 5573 6572 2d41 6765 6e74 0x0050: 3a20 6375 726c 2f37 2e38 312e 300d 0a41 0x0060: 6363 6570 743a 202a 2f2a 0d0a 0d0a -xx: 14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094] 0x0000: 0050 56eb bc4e 000c 298e 31f3 0800 4500 0x0010: 006e 484c 4000 4006 1bc4 0a00 020f cbcd 0x0020: fe9d d0e6 0050 c447 8e98 7662 6245 5018 0x0030: faf0 d6da 0000 4745 5420 2f20 4854 5450 0x0040: 2f31 2e31 0d0a 486f 7374 3a20 7171 2e63 0x0050: 6f6d 0d0a 5573 6572 2d41 6765 6e74 3a20 0x0060: 6375 726c 2f37 2e38 312e 300d 0a41 6363 0x0070: 6570 743a 202a 2f2a 0d0a 0d0a -X: 14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094] 0x0000: 4500 006e 484c 4000 4006 1bc4 0a00 020f E..nHL@.@....... 0x0010: cbcd fe9d d0e6 0050 c447 8e98 7662 6245 .......P.G..vbbE 0x0020: 5018 faf0 d6da 0000 4745 5420 2f20 4854 P.......GET / HT 0x0030: 5450 2f31 2e31 0d0a 486f 7374 3a20 7171 TP/1.1..Host: qq 0x0040: 2e63 6f6d 0d0a 5573 6572 2d41 6765 6e74 .com..User-Agent 0x0050: 3a20 6375 726c 2f37 2e38 312e 300d 0a41 : curl/7.81.0..A 0x0060: 6363 6570 743a 202a 2f2a 0d0a 0d0a ccept: */*.... -XX: 14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094] 0x0000: 0050 56eb bc4e 000c 298e 31f3 0800 4500 .PV..N..).1...E. 0x0010: 006e 484c 4000 4006 1bc4 0a00 020f cbcd .nHL@.@......... 0x0020: fe9d d0e6 0050 c447 8e98 7662 6245 5018 .....P.G..vbbEP. 0x0030: faf0 d6da 0000 4745 5420 2f20 4854 5450 ......GET / HTTP 0x0040: 2f31 2e31 0d0a 486f 7374 3a20 7171 2e63 /1.1..Host: qq.c 0x0050: 6f6d 0d0a 5573 6572 2d41 6765 6e74 3a20 om..User-Agent: 0x0060: 6375 726c 2f37 2e38 312e 300d 0a41 6363 curl/7.81.0..Acc 0x0070: 6570 743a 202a 2f2a 0d0a 0d0a ept: */*.... 新增用于编译和运行 ptcpdump 的 Docker 镜像 新增用于编译程序的 Docker 镜像： quay.io/ptcpdump/develop:latest 以及用于通过 Docker 运行 ptcpdump 的镜像： quay.io/ptcpdump/ptcpdump:latest 可以通过 make build-bpf-via-docker 和 make build-via-docker 按需编译 eBPF 程序和 ptcpdump 程序。 可以使用类似下面的命令，通过 docker 运行 ptcpdump: docker run --privileged --rm -t --net=host --pid=host \\ -v /sys/fs/cgroup:/sys/fs/cgroup:ro \\ quay.io/ptcpdump/ptcpdump:latest ptcpdump -i any -c 2 tcp 实验性新功能：在对 Go 程序进行抓包时生成相应的 TLS Key Log 文件 在新版本中还尝试了一个实验性的功能：在对 Go 程序进行抓包时生成相应的 TLS Key Log 文件。 TLS Key Log 文件又叫 SSLKEYLOGFILE ， 在 Wireshark 中对应的是 pre-master secret 配置， 第三方程序可以通过这个文件中记录的信息解密抓取的 TLS 流量。 注意：该功能是一个实验性的功能，只支持 1.18+ 版本的 Go 编译的程序（支持 stripped 的二进制）， 并且只支持通过 ptcpdump 运行目标 Go 程序。 可以通过下面两种方法试用这个功能： 通过 --write-keylog-file 参数或者环境变量 SSLKEYLOGFILE 指定 SSLKEYLOGFILE 文件的保存路径: sudo ptcpdump -i any --write-keylog-file /tmp/keylogfile.txt -w /tmp/go.pcapng -- ./gohttpapp 通过指定 --embed-keylog-to-pcapng 参数在保存数据到 pcapng 格式文件时内嵌 SSLKEYLOGFILE 文件内容: sudo ptcpdump -i any --embed-keylog-to-pcapng -w /tmp/gotls.pcapng -- ./gohttpapp 可以通过 Wireshark 或 tshark 使用记录的 SSLKEYLOGFILE 内容对保存的 TLS 数据进行解密: $ sudo tshark -r /tmp/go.pcapng -o tls.keylog_file:/tmp/keylogfile.txt | grep HTTP -B 2 Running as user &#34;root&#34; and group &#34;root&#34;. This could be dangerous. 18 0.518380586 10.0.2.15 → 13.35.238.63 TLSv1.3 118 Change Cipher Spec, Finished 19 0.519208290 13.35.238.63 → 10.0.2.15 TCP 60 443 → 47606 [ACK] Seq=5508 Ack=340 Win=64240 Len=0 20 0.519914720 10.0.2.15 → 13.35.238.63 HTTP 179 GET /foo/bar HTTP/1.1 $ tshark -r /tmp/gotls.pcapng | grep HTTP -B 2 20 0.525662563 10.0.2.15 → 13.35.238.114 TLSv1.3 118 Change Cipher Spec, Finished 21 0.526138582 13.35.238.114 → 10.0.2.15 TCP 60 443 → 37618 [ACK] Seq=5987 Ack=340 Win=64240 Len=0 22 0.526977836 10.0.2.15 → 13.35.238.114 HTTP 179 GET /foo/bar HTTP/1.1 ptcpdump 计划未来内置支持使用 SSLKEYLOGFILE 对 TLS 数据进行解密的能力， 以及在抓包时实时获取 SSLKEYLOGFILE 并自动解密的能力， 目前暂时只能使用第三方工具实现 TLS 数据解密。 默认输出 TCP Options 新版本将默认输出 TCP Options 信息： 老版本: 14:09:54.324433 ens33 curl.26570 Out IP (..).43772 &gt; (..).443: Flags [S], seq 1674193846, win 64240, length 0, ParentProc [ptcpdump.26560] 新版本: 14:09:54.324433 ens33 curl.26570 Out IP (..).43772 &gt; (..).443: Flags [S], seq 1674193846, win 64240, options [mss 1460,sackOK,TS val 2107137325 ecr 0,nop,wscale 7], length 0, ParentProc [ptcpdump.26560] 同时新版本还新增对 TCP SACK (Selective Acknowledgment) 和 TFO (TCP Fast Open) 的支持: SACK: 19:03:36.220872 IP6 dead:beef:2::2.35288 &gt; dead:beef:2::1.10029: Flags [.], seq 731670714, ack 2274465610, win 201, options [nop,nop,TS val 1253137130 ecr 837820024,nop,nop,sack 1 {2274467010:2274483378},mptcp 12 dss ack 16301812255838552430], length 0 TFO: 19:22:26.586851 IP6 dead:beef:1::2.54040 &gt; dead:beef:1::1.10056: Flags [S], seq 271661201, win 64800, options [mss 1440,sackOK,TS val 2947503028 ecr 0,nop,wscale 7,tfo cookiereq,nop,nop,mptcp 4 capable v1 flags [H]], length 0 19:22:26.591736 IP6 dead:beef:1::1.10056 &gt; dead:beef:1::2.54040: Flags [S.], seq 1229575956, ack 271661202, win 64260, options [mss 1440,nop,nop,sackOK,nop,wscale 7,tfo cookie 29b3cc66639d427d,nop,nop,mptcp 12 capable v1 flags [H] {0xc87438912bc26cb7}], length 0 输出 TCP Options 中的 MPTCP 信息 应 MPTCP (MultiPath TCP) 社区的 需求 ， 新增对 MPTCP 的支持: 15:31:51.696224 IP 10.0.1.2.60958 &gt; 10.0.1.1.10004: Flags [S], seq 3019570341, win 64240, options [mss 1460,sackOK,TS val 1007819908 ecr 0,nop,wscale 7,mptcp 4 capable v1 flags [H]], length 0 15:31:51.696346 IP 10.0.1.1.10004 &gt; 10.0.1.2.60958: Flags [S.], seq 2367868313, ack 3019570342, win 65160, options [mss 1460,sackOK,TS val 162498895 ecr 1007819908,nop,wscale 7,mptcp 12 capable v1 flags [H] {0x8ea1df6e0d588003}], length 0 15:31:51.696587 IP 10.0.1.2.60958 &gt; 10.0.1.1.10004: Flags [.], seq 3019570342, ack 2367868314, win 502, options [nop,nop,TS val 1007819909 ecr 162498895,mptcp 20 capable v1 flags [H] {0x465bcd01b5d78120,0x8ea1df6e0d588003}], length 0 新增参数 --netns 支持对在其他网络命名空间中的网络接口进行抓包 之前的版本只支持对当前网络命名空间中的网络接口进行抓包，新版本通过新增 --netns 参数支持对其他网络命名空间中的网络接口进行抓包: sudo ptcpdump -i lo --netns /run/netns/foobar sudo ptcpdump -i any --netns /run/netns/foobar sudo ptcpdump -i any --netns /proc/26/ns/net PcapNg 格式增强：读取/写入网络接口名称和 Inbound/Outbound 信息 在之前的版本中使用 ptcpdump -r &lt;file.pcapng&gt; 读取 pcapng 文件不会读取其中记录的网络接口名称以及 Inbound/Outbound 信息， 在新版本中已经解决了这个问题: $ ptcpdump -r demo.pcapng 14:36:35.880947 ens33 curl.244103 Out IP 10.0.2.15.37668 &gt; 114.114.114.114.53: 44427+ A? qq.com. (24), ParentProc [ptcpdump.244094] 14:36:35.882099 ens33 curl.244103 Out IP 10.0.2.15.37668 &gt; 114.114.114.114.53: 31415+ AAAA? qq.com. (24), ParentProc [ptcpdump.244094] 14:36:35.954613 ens33 curl.244103 In IP 114.114.114.114.53 &gt; 10.0.2.15.37668: 44427 3/0/0 A 203.205.254.157, A 113.108.81.189, A 123.150.76.218 (72), ParentProc [ptcpdump.244094] 同时新版在将捕获的流量信息保存为 PcapNg 格式的文件时，会自动写入 Inbound/Outbound 信息（之前的版本已写入网络接口信息）， 即支持 PcapNg 格式的 epb_flags （Enhanced Packet Block Flags Word ） 标记。 如果你对 ptcpdump 有额外的改进或新功能建议，欢迎在评论区或项目 issues 中留言。",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https://mozillazg.com/2024/11/whats-new-ptcpdump-v1.16-v1.26.html"
        },
        "datePublished": "2024-11-02"
    }
    </script>

</head>
<body>

<div class="navbar" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://mozillazg.com/" class="navbar-brand">
mozillazg's Blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="https://mozillazg.com/feeds/all.atom.xml">Feed</a></li>
                    <li><a href="/2014/10/pages/about-me.html">About</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://mozillazg.com/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
    <section id="content" class="yue">
        <article>
            <header class="text-center">
                <h1>
                    <a href="https://mozillazg.com/2024/11/whats-new-ptcpdump-v1.16-v1.26.html"
                       rel="bookmark"
                       title="Permalink to ptcpdump v0.16 ~ v0.26 的主要变更内容">
                        ptcpdump v0.16 ~ v0.26 的主要变更内容
                    </a>
                </h1>
                <p class="published">
                    <time datetime="2024-11-02T00:00:00+00:00">
                    2024-11-02
                    </time>
                </p>
            </header>
            <div class="entry-content">
                <div class="well-sm article-info">
<footer class="post-info">
        <a href="https://mozillazg.com/category/others.html">others</a>


<span class="label label-default hide">Tags</span>
	<a href="https://mozillazg.com/tag/ptcpdump.html">ptcpdump</a>
    <span class="label label-default">Lang</span>
	<a href="https://mozillazg.com/2024/11/whats-new-ptcpdump-v1.16-v1.26-en.html">en</a>

</footer><!-- /.post-info -->                </div>
                <div class="js-toc"></div>
                <div>
                <div class="section" id="section-1">
<h2 id="hidsection-1">前言<a class="headerlink" href="#hidsection-1" title="Permalink to this headline">¶</a></h2>
<p>距离 <a class="reference external" href="https://mozillazg.com/2024/07/ebpf-ptcpdump-capturing-the-network-traffic-of-a-process-or-container-or-pod.html">上次首次介绍</a>
<a class="reference external" href="https://github.com/mozillazg/ptcpdump">ptcpdump</a> 项目已经过去好几个月了，
最近这几个月我一直在持续开发这个项目，
本文将按变更顺序介绍一下从上次的 v0.16 版本到最新的 v0.26 版本期间所发布的主要变更内容。</p>
</div>
<div class="section" id="section-2">
<h2 id="hidsection-2">主要变更内容<a class="headerlink" href="#hidsection-2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="tencentos-opencloudos">
<h3 id="hidtencentos-opencloudos">兼容老版本的 TencentOS/OpenCloudOS 系统<a class="headerlink" href="#hidtencentos-opencloudos" title="Permalink to this headline">¶</a></h3>
<p>根据用户 <a class="reference external" href="https://github.com/mozillazg/ptcpdump/issues/89">反馈</a> ，
之前的版本无法在老版本的 TencentOS/OpenCloudOS 上运行，
当前最新版本已经支持了如下 TencentOS/OpenCloudOS 系统版本：
OpenCloudOS 7/8/9 and TencentOS Server 2.4/2.6/3.1/3.2 。</p>
</div>
<div class="section" id="section-3">
<h3 id="hidsection-3">在输出中增加父进程信息<a class="headerlink" href="#hidsection-3" title="Permalink to this headline">¶</a></h3>
<p>老版本:</p>
<pre class="literal-block">
13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52)
    139.178.84.217.443 &gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0
    Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org)
    Container (...)
    Pod (...)
</pre>
<p>新版本:</p>
<pre class="literal-block">
13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52)
    139.178.84.217.443 &gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0
    Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org)
    ParentProc (pid 553296, cmd /bin/sh, args sh)
    Container (...)
    Pod (...)
</pre>
</div>
<div class="section" id="dockershim-kubernetes">
<h3 id="hiddockershim-kubernetes">支持使用 Dockershim 的老版本 Kubernetes 环境<a class="headerlink" href="#hiddockershim-kubernetes" title="Permalink to this headline">¶</a></h3>
<p>之前的版本无法在使用 Dockershim （准确的说是基于 CRI v1alpha2）的老版本 Kubernetes 环境中获取 Pod 信息，新版本已兼容这种环境。</p>
</div>
<div class="section" id="pod">
<h3 id="hidpod">修复按 Pod 名称过滤时，无法支持包含点号的名称<a class="headerlink" href="#hidpod" title="Permalink to this headline">¶</a></h3>
<p>之前的版本中按 Pod 名称过滤时，过滤的名称不能包含英文点号，新版本已兼容包含点号的名称:</p>
<pre class="literal-block">
--pod-name foo.bar.default
</pre>
</div>
<div class="section" id="pod-pod">
<h3 id="hidpod-pod">修复按 Pod 过滤时，无法支持包含多个容器的 Pod 的场景<a class="headerlink" href="#hidpod-pod" title="Permalink to this headline">¶</a></h3>
<p>之前的版本中按 Pod 过滤时，无法支持 Pod 中存在多个容器的场景，新版本已修复该问题。</p>
</div>
<div class="section" id="ptcpdump">
<h3 id="hidptcpdump">支持同时运行多个 ptcpdump 实例<a class="headerlink" href="#hidptcpdump" title="Permalink to this headline">¶</a></h3>
<p>之前的版本同时只能运行一个 ptcpdump 进程，当运行多个 ptcpdump 进程时，老的进程将不能正常工作（抓不到任何流量），
新版本已修复该问题，在新版本中可以同时运行多个 ptcpdump 进程，多个 ptcpdump 进程不会出现互相干扰或导致其他进程无法抓包的问题。</p>
</div>
<div class="section" id="pid">
<h3 id="hidpid">支持同时过滤多个进程 PID<a class="headerlink" href="#hidpid" title="Permalink to this headline">¶</a></h3>
<p>现在 <tt class="docutils literal"><span class="pre">--pid</span></tt> 参数支持过滤多个 pid 了:</p>
<pre class="literal-block">
--pid pid1 --pid pid2
</pre>
</div>
<div class="section" id="micro-nano-time-stamp-precision">
<h3 id="hidmicro-nano-time-stamp-precision">新增参数 --micro, --nano, --time-stamp-precision 用于控制输出中的时间格式<a class="headerlink" href="#hidmicro-nano-time-stamp-precision" title="Permalink to this headline">¶</a></h3>
<p>新增参数 <tt class="docutils literal"><span class="pre">--micro</span></tt>, <tt class="docutils literal"><span class="pre">--nano</span></tt>, <tt class="docutils literal"><span class="pre">--time-stamp-precision</span></tt> ，作用和用法对标 tcpdump。</p>
<p><tt class="docutils literal"><span class="pre">--micro</span></tt>, <tt class="docutils literal"><span class="pre">--time-stamp-precision=micro</span></tt>:</p>
<pre class="literal-block">
13:36:05.701978 IP 10.0.2.15.22 &gt; 10.0.2.2.59874: Flags [P.], seq 1370707216:1370707292, ack 4569736, win 62780, length 76
</pre>
<p><tt class="docutils literal"><span class="pre">--nano</span></tt>, <tt class="docutils literal"><span class="pre">--time-stamp-precision=nano</span></tt>:</p>
<pre class="literal-block">
13:36:05.701978488 IP 10.0.2.15.22 &gt; 10.0.2.2.59874: Flags [P.], seq 1370707216:1370707292, ack 4569736, win 62780, length 76
</pre>
</div>
<div class="section" id="a-x-xx-x-xx">
<h3 id="hida-x-xx-x-xx">新增参数 -A, -x, -xx, -X, -XX 用于控制数据输出格式<a class="headerlink" href="#hida-x-xx-x-xx" title="Permalink to this headline">¶</a></h3>
<p>新增作用和用法对标 tcpdump 的参数 <tt class="docutils literal"><span class="pre">-A</span></tt>, <tt class="docutils literal"><span class="pre">-x</span></tt>, <tt class="docutils literal"><span class="pre">-xx</span></tt>, <tt class="docutils literal"><span class="pre">-X</span></tt>, <tt class="docutils literal"><span class="pre">-XX</span></tt> 。</p>
<p><tt class="docutils literal"><span class="pre">-A</span></tt>:</p>
<pre class="literal-block">
14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094]
E..nHL&#64;.&#64;...
..........P.G..vbbEP.......GET / HTTP/1.1
Host: qq.com
User-Agent: curl/7.81.0
Accept: */*
</pre>
<p><tt class="docutils literal"><span class="pre">-x</span></tt>:</p>
<pre class="literal-block">
14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094]
        0x0000:  4500 006e 484c 4000 4006 1bc4 0a00 020f
        0x0010:  cbcd fe9d d0e6 0050 c447 8e98 7662 6245
        0x0020:  5018 faf0 d6da 0000 4745 5420 2f20 4854
        0x0030:  5450 2f31 2e31 0d0a 486f 7374 3a20 7171
        0x0040:  2e63 6f6d 0d0a 5573 6572 2d41 6765 6e74
        0x0050:  3a20 6375 726c 2f37 2e38 312e 300d 0a41
        0x0060:  6363 6570 743a 202a 2f2a 0d0a 0d0a
</pre>
<p><tt class="docutils literal"><span class="pre">-xx</span></tt>:</p>
<pre class="literal-block">
14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094]
        0x0000:  0050 56eb bc4e 000c 298e 31f3 0800 4500
        0x0010:  006e 484c 4000 4006 1bc4 0a00 020f cbcd
        0x0020:  fe9d d0e6 0050 c447 8e98 7662 6245 5018
        0x0030:  faf0 d6da 0000 4745 5420 2f20 4854 5450
        0x0040:  2f31 2e31 0d0a 486f 7374 3a20 7171 2e63
        0x0050:  6f6d 0d0a 5573 6572 2d41 6765 6e74 3a20
        0x0060:  6375 726c 2f37 2e38 312e 300d 0a41 6363
        0x0070:  6570 743a 202a 2f2a 0d0a 0d0a
</pre>
<p><tt class="docutils literal"><span class="pre">-X</span></tt>:</p>
<pre class="literal-block">
14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094]
        0x0000:  4500 006e 484c 4000 4006 1bc4 0a00 020f  E..nHL&#64;.&#64;.......
        0x0010:  cbcd fe9d d0e6 0050 c447 8e98 7662 6245  .......P.G..vbbE
        0x0020:  5018 faf0 d6da 0000 4745 5420 2f20 4854  P.......GET / HT
        0x0030:  5450 2f31 2e31 0d0a 486f 7374 3a20 7171  TP/1.1..Host: qq
        0x0040:  2e63 6f6d 0d0a 5573 6572 2d41 6765 6e74  .com..User-Agent
        0x0050:  3a20 6375 726c 2f37 2e38 312e 300d 0a41  : curl/7.81.0..A
        0x0060:  6363 6570 743a 202a 2f2a 0d0a 0d0a       ccept: */*....
</pre>
<p><tt class="docutils literal"><span class="pre">-XX</span></tt>:</p>
<pre class="literal-block">
14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094]
        0x0000:  0050 56eb bc4e 000c 298e 31f3 0800 4500  .PV..N..).1...E.
        0x0010:  006e 484c 4000 4006 1bc4 0a00 020f cbcd  .nHL&#64;.&#64;.........
        0x0020:  fe9d d0e6 0050 c447 8e98 7662 6245 5018  .....P.G..vbbEP.
        0x0030:  faf0 d6da 0000 4745 5420 2f20 4854 5450  ......GET / HTTP
        0x0040:  2f31 2e31 0d0a 486f 7374 3a20 7171 2e63  /1.1..Host: qq.c
        0x0050:  6f6d 0d0a 5573 6572 2d41 6765 6e74 3a20  om..User-Agent:
        0x0060:  6375 726c 2f37 2e38 312e 300d 0a41 6363  curl/7.81.0..Acc
        0x0070:  6570 743a 202a 2f2a 0d0a 0d0a            ept: */*....
</pre>
</div>
<div class="section" id="ptcpdump-docker">
<h3 id="hidptcpdump-docker">新增用于编译和运行 ptcpdump 的 Docker 镜像<a class="headerlink" href="#hidptcpdump-docker" title="Permalink to this headline">¶</a></h3>
<p>新增用于编译程序的 Docker 镜像： <tt class="docutils literal">quay.io/ptcpdump/develop:latest</tt>
以及用于通过 Docker 运行 ptcpdump 的镜像： <tt class="docutils literal">quay.io/ptcpdump/ptcpdump:latest</tt></p>
<ul>
<li><p class="first">可以通过 <tt class="docutils literal">make <span class="pre">build-bpf-via-docker</span></tt> 和 <tt class="docutils literal">make <span class="pre">build-via-docker</span></tt> 按需编译 eBPF 程序和 ptcpdump 程序。</p>
</li>
<li><p class="first">可以使用类似下面的命令，通过 docker 运行 ptcpdump:</p>
<pre class="literal-block">
docker run --privileged --rm -t --net=host --pid=host \
  -v /sys/fs/cgroup:/sys/fs/cgroup:ro \
  quay.io/ptcpdump/ptcpdump:latest ptcpdump -i any -c 2 tcp
</pre>
</li>
</ul>
</div>
<div class="section" id="go-tls-key-log">
<h3 id="hidgo-tls-key-log">实验性新功能：在对 Go 程序进行抓包时生成相应的 TLS Key Log 文件<a class="headerlink" href="#hidgo-tls-key-log" title="Permalink to this headline">¶</a></h3>
<p>在新版本中还尝试了一个实验性的功能：在对 Go 程序进行抓包时生成相应的 TLS Key Log 文件。</p>
<p>TLS Key Log 文件又叫 <a class="reference external" href="https://tlswg.org/sslkeylogfile/draft-ietf-tls-keylogfile.html">SSLKEYLOGFILE</a> ，
在 Wireshark 中对应的是 pre-master secret 配置，
第三方程序可以通过这个文件中记录的信息解密抓取的 TLS 流量。</p>
<p>注意：该功能是一个实验性的功能，只支持 1.18+ 版本的 Go 编译的程序（支持 stripped 的二进制），
并且只支持通过 ptcpdump 运行目标 Go 程序。</p>
<p>可以通过下面两种方法试用这个功能：</p>
<ul>
<li><p class="first">通过 <tt class="docutils literal"><span class="pre">--write-keylog-file</span></tt> 参数或者环境变量 <tt class="docutils literal">SSLKEYLOGFILE</tt> 指定 SSLKEYLOGFILE 文件的保存路径:</p>
<pre class="literal-block">
sudo ptcpdump -i any --write-keylog-file /tmp/keylogfile.txt -w /tmp/go.pcapng -- ./gohttpapp
</pre>
</li>
<li><p class="first">通过指定 <tt class="docutils literal"><span class="pre">--embed-keylog-to-pcapng</span></tt> 参数在保存数据到 pcapng 格式文件时内嵌 SSLKEYLOGFILE 文件内容:</p>
<pre class="literal-block">
sudo ptcpdump -i any --embed-keylog-to-pcapng -w /tmp/gotls.pcapng -- ./gohttpapp
</pre>
</li>
</ul>
<p>可以通过 Wireshark 或 tshark 使用记录的 SSLKEYLOGFILE 内容对保存的 TLS 数据进行解密:</p>
<pre class="literal-block">
$ sudo tshark -r /tmp/go.pcapng -o tls.keylog_file:/tmp/keylogfile.txt | grep HTTP -B 2
Running as user &quot;root&quot; and group &quot;root&quot;. This could be dangerous.
   18 0.518380586    10.0.2.15 → 13.35.238.63 TLSv1.3 118 Change Cipher Spec, Finished
   19 0.519208290 13.35.238.63 → 10.0.2.15    TCP 60 443 → 47606 [ACK] Seq=5508 Ack=340 Win=64240 Len=0
   20 0.519914720    10.0.2.15 → 13.35.238.63 HTTP 179 GET /foo/bar HTTP/1.1


$ tshark -r /tmp/gotls.pcapng | grep HTTP -B 2
   20 0.525662563    10.0.2.15 → 13.35.238.114 TLSv1.3 118 Change Cipher Spec, Finished
   21 0.526138582 13.35.238.114 → 10.0.2.15    TCP 60 443 → 37618 [ACK] Seq=5987 Ack=340 Win=64240 Len=0
   22 0.526977836    10.0.2.15 → 13.35.238.114 HTTP 179 GET /foo/bar HTTP/1.1
</pre>
<p>ptcpdump 计划未来内置支持使用 SSLKEYLOGFILE 对 TLS 数据进行解密的能力，
以及在抓包时实时获取 SSLKEYLOGFILE 并自动解密的能力，
目前暂时只能使用第三方工具实现 TLS 数据解密。</p>
</div>
<div class="section" id="tcp-options">
<h3 id="hidtcp-options">默认输出 TCP Options<a class="headerlink" href="#hidtcp-options" title="Permalink to this headline">¶</a></h3>
<p>新版本将默认输出 TCP Options 信息：</p>
<p>老版本:</p>
<pre class="literal-block">
14:09:54.324433 ens33 curl.26570 Out IP (..).43772 &gt; (..).443: Flags [S], seq 1674193846, win 64240, length 0, ParentProc [ptcpdump.26560]
</pre>
<p>新版本:</p>
<pre class="literal-block">
14:09:54.324433 ens33 curl.26570 Out IP (..).43772 &gt; (..).443: Flags [S], seq 1674193846, win 64240, options [mss 1460,sackOK,TS val 2107137325 ecr 0,nop,wscale 7], length 0, ParentProc [ptcpdump.26560]
</pre>
<p>同时新版本还新增对 TCP SACK (Selective Acknowledgment) 和 TFO (TCP Fast Open) 的支持:</p>
<p>SACK:</p>
<pre class="literal-block">
19:03:36.220872 IP6 dead:beef:2::2.35288 &gt; dead:beef:2::1.10029: Flags [.], seq 731670714, ack 2274465610, win 201, options [nop,nop,TS val 1253137130 ecr 837820024,nop,nop,sack 1 {2274467010:2274483378},mptcp 12 dss ack 16301812255838552430], length 0
</pre>
<p>TFO:</p>
<pre class="literal-block">
19:22:26.586851 IP6 dead:beef:1::2.54040 &gt; dead:beef:1::1.10056: Flags [S], seq 271661201, win 64800, options [mss 1440,sackOK,TS val 2947503028 ecr 0,nop,wscale 7,tfo  cookiereq,nop,nop,mptcp 4 capable v1 flags [H]], length 0
19:22:26.591736 IP6 dead:beef:1::1.10056 &gt; dead:beef:1::2.54040: Flags [S.], seq 1229575956, ack 271661202, win 64260, options [mss 1440,nop,nop,sackOK,nop,wscale 7,tfo  cookie 29b3cc66639d427d,nop,nop,mptcp 12 capable v1 flags [H] {0xc87438912bc26cb7}], length 0
</pre>
</div>
<div class="section" id="tcp-options-mptcp">
<h3 id="hidtcp-options-mptcp">输出 TCP Options 中的 MPTCP 信息<a class="headerlink" href="#hidtcp-options-mptcp" title="Permalink to this headline">¶</a></h3>
<p>应 MPTCP (MultiPath TCP) 社区的 <a class="reference external" href="https://github.com/mozillazg/ptcpdump/issues/148">需求</a>  ，
新增对 MPTCP 的支持:</p>
<pre class="literal-block">
15:31:51.696224 IP 10.0.1.2.60958 &gt; 10.0.1.1.10004: Flags [S], seq 3019570341, win 64240, options [mss 1460,sackOK,TS val 1007819908 ecr 0,nop,wscale 7,mptcp 4 capable v1 flags [H]], length 0
15:31:51.696346 IP 10.0.1.1.10004 &gt; 10.0.1.2.60958: Flags [S.], seq 2367868313, ack 3019570342, win 65160, options [mss 1460,sackOK,TS val 162498895 ecr 1007819908,nop,wscale 7,mptcp 12 capable v1 flags [H] {0x8ea1df6e0d588003}], length 0
15:31:51.696587 IP 10.0.1.2.60958 &gt; 10.0.1.1.10004: Flags [.], seq 3019570342, ack 2367868314, win 502, options [nop,nop,TS val 1007819909 ecr 162498895,mptcp 20 capable v1 flags [H] {0x465bcd01b5d78120,0x8ea1df6e0d588003}], length 0
</pre>
</div>
<div class="section" id="netns">
<h3 id="hidnetns">新增参数 --netns 支持对在其他网络命名空间中的网络接口进行抓包<a class="headerlink" href="#hidnetns" title="Permalink to this headline">¶</a></h3>
<p>之前的版本只支持对当前网络命名空间中的网络接口进行抓包，新版本通过新增 <tt class="docutils literal"><span class="pre">--netns</span></tt>
参数支持对其他网络命名空间中的网络接口进行抓包:</p>
<pre class="literal-block">
sudo ptcpdump -i lo --netns /run/netns/foobar
sudo ptcpdump -i any --netns /run/netns/foobar
sudo ptcpdump -i any --netns /proc/26/ns/net
</pre>
</div>
<div class="section" id="pcapng-inbound-outbound">
<h3 id="hidpcapng-inbound-outbound">PcapNg 格式增强：读取/写入网络接口名称和 Inbound/Outbound 信息<a class="headerlink" href="#hidpcapng-inbound-outbound" title="Permalink to this headline">¶</a></h3>
<p>在之前的版本中使用 <tt class="docutils literal">ptcpdump <span class="pre">-r</span> &lt;file.pcapng&gt;</tt> 读取 pcapng 文件不会读取其中记录的网络接口名称以及 Inbound/Outbound 信息，
在新版本中已经解决了这个问题:</p>
<pre class="literal-block">
$ ptcpdump -r demo.pcapng
14:36:35.880947 ens33 curl.244103 Out IP 10.0.2.15.37668 &gt; 114.114.114.114.53: 44427+ A? qq.com. (24), ParentProc [ptcpdump.244094]
14:36:35.882099 ens33 curl.244103 Out IP 10.0.2.15.37668 &gt; 114.114.114.114.53: 31415+ AAAA? qq.com. (24), ParentProc [ptcpdump.244094]
14:36:35.954613 ens33 curl.244103 In IP 114.114.114.114.53 &gt; 10.0.2.15.37668: 44427 3/0/0 A 203.205.254.157, A 113.108.81.189, A 123.150.76.218 (72), ParentProc [ptcpdump.244094]
</pre>
<p>同时新版在将捕获的流量信息保存为 PcapNg 格式的文件时，会自动写入 Inbound/Outbound 信息（之前的版本已写入网络接口信息），
即支持 PcapNg 格式的
epb_flags （<a class="reference external" href="https://www.ietf.org/archive/id/draft-tuexen-opsawg-pcapng-05.html#name-enhanced-packet-block-flags">Enhanced Packet Block Flags Word</a> ）
标记。</p>
<p>如果你对 ptcpdump 有额外的改进或新功能建议，欢迎在评论区或项目 issues 中留言。</p>
</div>
</div>

                </div>
            </div>
            <!-- /.entry-content -->
<section class="text-center">
  
<div id="donate"></div>

<div class="social-share"></div>
<div class="social-comment-note">
<p class="text-center">有任何建议和想法欢迎在下方评论区留言或者加我<a href="/static/wechat.png">微信</a>交流</p>
</div>

</section>
<section class="well" id="related-posts">
    <p>Related Posts:</p>
    <ul>
        <li><a href="https://mozillazg.com/2024/07/ebpf-ptcpdump-capturing-the-network-traffic-of-a-process-or-container-or-pod-en.html">ptcpdump: Capturing the Network Traffic of any Process, Container, or Pod</a></li>
        <li><a href="https://mozillazg.com/2024/11/whats-new-ptcpdump-v1.16-v1.26-en.html">Major Changes in ptcpdump versions 0.16 to 0.26</a></li>
        <li><a href="https://mozillazg.com/2024/07/ebpf-ptcpdump-capturing-the-network-traffic-of-a-process-or-container-or-pod.html">ptcpdump: 抓包时显示进程信息以及对任意进程、容器或 Pod 进行抓包</a></li>
    </ul>
</section>
<hr/>
<section class="comments" id="comments">
    <h2>Comments</h2>
    <script src="https://giscus.app/client.js"
            data-repo="mozillazg/mozillazg.github.com"
            data-repo-id="MDEwOlJlcG9zaXRvcnk3Njc4MTA2"
            data-category="Announcements"
            data-category-id="DIC_kwDOAHUoms4CckZl"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="bottom"
            data-theme="preferred_color_scheme"
            data-description="<description>"
            data-lang="en"
            data-loading="lazy"
            crossorigin="anonymous"
            async>
    </script>
</section>
        </article>
    </section>

        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2025 mozillazg
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>
            &middot; <a href="/privacy-policy.html" target="_blank">Privacy</a>              <p><small>  <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="/static/images/by-sa-80x15.png" /></a>
    &quot;<span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">mozillazg's Blog</span>&quot; by <a xmlns:cc="http://creativecommons.org/ns#" href="https://mozillazg.com" property="cc:attributionName" rel="cc:attributionURL">mozillazg</a> is
  licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/cdn.jsdelivr.net/npm/jquery@2.1.1/dist/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/cdn.jsdelivr.net/npm/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->


<!-- share.js -->
<script src="/theme/cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script>



<script src="/theme/cdn.jsdelivr.net/npm/tocbot@3.0.2/dist/tocbot.min.js"></script>
<script>
$(document).ready(function(){
  tocbot.init({
    // Where to render the table of contents.
    tocSelector: '.js-toc',
    // Where to grab the headings to build the table of contents.
    contentSelector: '.entry-content',
    // Which headings to grab inside of the contentSelector element.
    headingSelector: 'h2, h3, h4,h5',
    // Headings that match the ignoreSelector will be skipped.
    ignoreSelector: '.js-toc-ignore',
    // Main class to add to links.
    linkClass: 'toc-link',
    // Extra classes to add to links.
    extraLinkClasses: '',
    // Class to add to active links,
    // the link corresponding to the top most heading on the page.
    activeLinkClass: 'is-active-link',
    // Main class to add to lists.
    listClass: 'toc-list',
    // Extra classes to add to lists.
    extraListClasses: '',
    // Class that gets added when a list should be collapsed.
    isCollapsedClass: 'is-collapsed',
    // Class that gets added when a list should be able
    // to be collapsed but isn't necessarily collpased.
    collapsibleClass: 'is-collapsible',
    // Class to add to list items.
    listItemClass: 'toc-list-item',
    // How many heading levels should not be collpased.
    // For example, number 6 will show everything since
    // there are only 6 heading levels and number 0 will collpase them all.
    // The sections that are hidden will open
    // and close as you scroll to headings within them.
    collapseDepth: 6,
    // Smooth scrolling enabled.
    smoothScroll: true,
    // Smooth scroll duration.
    smoothScrollDuration: 420,
    // Callback for scroll end (requires: smoothScroll).
    scrollEndCallback: function (e) {},
    // Headings offset between the headings and the top of the document (this is meant for minor adjustments).
    headingsOffset: 0,
    // Timeout between events firing to make sure it's
    // not too rapid (for performance reasons).
    throttleTimeout: 50,
    // Element to add the positionFixedClass to.
    positionFixedSelector: null,
    // Fixed position class to add to make sidebar fixed after scrolling
    // down past the fixedSidebarOffset.
    positionFixedClass: 'is-position-fixed',
    // fixedSidebarOffset can be any number but by default is set
    // to auto which sets the fixedSidebarOffset to the sidebar
    // element's offsetTop from the top of the document on init.
    fixedSidebarOffset: 'auto',
    // includeHtml can be set to true to include the HTML markup from the
    // heading node instead of just including the textContent.
    includeHtml: false
  });
});
</script>
</body>
</html>