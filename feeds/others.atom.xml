<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>mozillazg's Blog</title><link href="https://mozillazg.com/" rel="alternate"></link><link href="https://mozillazg.com/feeds/others.atom.xml" rel="self"></link><id>https://mozillazg.com/</id><updated>2025-11-29T00:00:00+00:00</updated><entry><title>Major Changes in ptcpdump versions 0.33 to 0.37</title><link href="https://mozillazg.com/2025/11/whats-new-ptcpdump-v0.33-v0.37-en.html" rel="alternate"></link><published>2025-11-29T00:00:00+00:00</published><updated>2025-11-29T00:00:00+00:00</updated><author><name>mozillazg</name></author><id>tag:mozillazg.com,2025-11-29:2025/11/whats-new-ptcpdump-v0.33-v0.37-en.html</id><summary type="html">&lt;div class="section" id="preface"&gt;
&lt;h2 id="hidpreface"&gt;Preface&lt;a class="headerlink" href="#hidpreface" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;This article introduces the main changes in &lt;a class="reference external" href="https://github.com/mozillazg/ptcpdump"&gt;ptcpdump&lt;/a&gt;
from v0.33 (after &lt;a class="reference external" href="https://mozillazg.com/2025/01/whats-new-ptcpdump-v0.27-v0.32-en.html"&gt;v0.32&lt;/a&gt; )
to the latest v0.37, in chronological order.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="main-changes"&gt;
&lt;h2 id="hidmain-changes"&gt;Main changes&lt;a class="headerlink" href="#hidmain-changes" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="prefer-using-bpf-ringbuf-instead-of-bpf-perfbuf"&gt;
&lt;h3 id="hidprefer-using-bpf-ringbuf-instead-of-bpf-perfbuf"&gt;Prefer using BPF ringbuf instead of BPF perfbuf&lt;a class="headerlink" href="#hidprefer-using-bpf-ringbuf-instead-of-bpf-perfbuf" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;If the Linux kernel on the current system supports BPF ringbuf,
ptcpdump will prioritize using BPF ringbuf to optimize program performance.
For more information about BPF ringbuf, please refer to
&lt;a class="reference external" href="https://nakryiko.com/posts/bpf-ringbuf/"&gt;BPF ring buffer&lt;/a&gt; .&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-the-issue-where-packet-filtering-by-process-failed-when-using-the-cgroup-skb-backend"&gt;
&lt;h3 id="hidfix-the-issue-where-packet-filtering-by-process-failed-when-using-the-cgroup-skb-backend"&gt;Fix the issue where packet filtering by process failed when using the cgroup-skb backend&lt;a class="headerlink" href="#hidfix-the-issue-where-packet-filtering-by-process-failed-when-using-the-cgroup-skb-backend" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Fixed an issue in previous versions where the features corresponding to
the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--pid&lt;/span&gt;&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--pname&lt;/span&gt;&lt;/tt&gt; parameters failed when the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;cgroup-skb&lt;/span&gt;&lt;/tt&gt; backend
was specified via &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--backend=cgroup-skb&lt;/span&gt;&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="support-reading-pcapng-format-data-from-standard-input"&gt;
&lt;h3 id="hidsupport-reading-pcapng-format-data-from-standard-input"&gt;Support reading PcapNG format data from standard input&lt;a class="headerlink" href="#hidsupport-reading-pcapng-format-data-from-standard-input" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;It now supports reading PcapNG format data from standard input using &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-r&lt;/span&gt; -&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ cat data.pcapng | ptcpdump -r -
$ ptcpdump -r - &amp;lt; data.pcapng
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="support-file-rotation-using-c-and-w-options"&gt;
&lt;h3 id="hidsupport-file-rotation-using-c-and-w-options"&gt;Support file rotation using -C and -W options&lt;a class="headerlink" href="#hidsupport-file-rotation-using-c-and-w-options" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;It now supports file rotation when saving data to a file using &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-w&lt;/span&gt;&lt;/tt&gt;,
by using the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-C&lt;/span&gt;&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-W&lt;/span&gt;&lt;/tt&gt; options:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo ptcpdump -i any -w data.pcapng -C 1mb
sudo ptcpdump -i any -w data.pcapng -C 1mb -W 5
&lt;/pre&gt;
&lt;p&gt;Where:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-C&lt;/span&gt;&lt;/tt&gt; specifies the maximum file size. When this size is exceeded, a number will be
appended to the old filename (e.g., &lt;tt class="docutils literal"&gt;data.pcapng1&lt;/tt&gt;) to save historical data.&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-W&lt;/span&gt;&lt;/tt&gt; specifies the number of files to keep. It must be used with &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-C&lt;/span&gt;&lt;/tt&gt; to limit the number of files.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="support-reading-pcap-filter-expressions-from-a-file-using-f-expression-file"&gt;
&lt;h3 id="hidsupport-reading-pcap-filter-expressions-from-a-file-using-f-expression-file"&gt;Support reading pcap filter expressions from a file using -F/--expression-file&lt;a class="headerlink" href="#hidsupport-reading-pcap-filter-expressions-from-a-file-using-f-expression-file" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;It now supports reading pcap filter expressions from a file using the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-F&lt;/span&gt;&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--expression-file&lt;/span&gt;&lt;/tt&gt; option:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo ptcpdump -i any -c 10 -F filter.txt
sudo ptcpdump -i any -c 10 --expression-file filter.txt
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="support-specifying-output-time-format-using-tt-ttt-tttt-ttttt"&gt;
&lt;h3 id="hidsupport-specifying-output-time-format-using-tt-ttt-tttt-ttttt"&gt;Support specifying output time format using -tt, -ttt, -tttt, -ttttt&lt;a class="headerlink" href="#hidsupport-specifying-output-time-format-using-tt-ttt-tttt-ttttt" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;It now supports using &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-tt&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-ttt&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-tttt&lt;/span&gt;&lt;/tt&gt;, and &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-ttttt&lt;/span&gt;&lt;/tt&gt; to
specify the time format when outputting packet information.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-tt&lt;/span&gt;&lt;/tt&gt; : Displays timestamp format, e.g., &lt;tt class="docutils literal"&gt;1764417816.346098 ens33 sshd.183127 Out IP xx.xx.xx.xx.22 &amp;gt; &lt;span class="pre"&gt;xx.xx.xx.xx.64755:...&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-ttt&lt;/span&gt;&lt;/tt&gt; : Displays the time interval between two records, e.g., &lt;tt class="docutils literal"&gt;00:00:00.000265 ens33 sshd.183127 Out IP xx.xx.xx.xx.22 &amp;gt; &lt;span class="pre"&gt;xx.xx.xx.xx.64755:...&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-tttt&lt;/span&gt;&lt;/tt&gt; : Displays date and time, e.g., &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;2025-11-29&lt;/span&gt; 20:03:36.346098 ens33 sshd.183127 Out IP xx.xx.xx.xx.22 &amp;gt; &lt;span class="pre"&gt;xx.xx.xx.xx.64755:...&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-ttttt&lt;/span&gt;&lt;/tt&gt; : Displays the time interval since the first record, e.g., &lt;tt class="docutils literal"&gt;00:00:00.002708 ens33 sshd.183127 Out IP xx.xx.xx.xx.22 &amp;gt; &lt;span class="pre"&gt;xx.xx.xx.xx.64755:...&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="support-using-system-installed-libpcap-via-dynamic-linking"&gt;
&lt;h3 id="hidsupport-using-system-installed-libpcap-via-dynamic-linking"&gt;Support using system-installed libpcap via dynamic linking&lt;a class="headerlink" href="#hidsupport-using-system-installed-libpcap-via-dynamic-linking" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Previous versions only supported compiling the dependent libpcap library via static linking.
It now supports using the system-installed libpcap library via dynamic linking to
meet the needs of simplified system library management.&lt;/p&gt;
&lt;p&gt;You can use the dynamic link library through either of the following compilation methods:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ CGO_ENABLED=1 go build -tags dynamic
$ make build-dynamic-link
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-the-issue-where-using-s-0-caused-the-program-to-crash"&gt;
&lt;h3 id="hidfix-the-issue-where-using-s-0-caused-the-program-to-crash"&gt;Fix the issue where using -s 0 caused the program to crash&lt;a class="headerlink" href="#hidfix-the-issue-where-using-s-0-caused-the-program-to-crash" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;In previous versions, using the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-s&lt;/span&gt; 0&lt;/tt&gt; option caused the ptcpdump program to crash. This issue is now fixed.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-the-issue-of-inaccurate-timestamps-in-terminal-output"&gt;
&lt;h3 id="hidfix-the-issue-of-inaccurate-timestamps-in-terminal-output"&gt;Fix the issue of inaccurate timestamps in terminal output&lt;a class="headerlink" href="#hidfix-the-issue-of-inaccurate-timestamps-in-terminal-output" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;In previous versions, the timestamps of packet information in the terminal
output drifted further from the actual event time over time.
This issue is now fixed.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="experimental-support-for-armv7-cpu-architecture"&gt;
&lt;h3 id="hidexperimental-support-for-armv7-cpu-architecture"&gt;Experimental support for armv7 CPU architecture&lt;a class="headerlink" href="#hidexperimental-support-for-armv7-cpu-architecture" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Experimental support for the armv7 CPU architecture has been added in the new version.
Since there is no CI environment supporting the armv7 architecture, this is only experimental support,
and compatibility in future versions cannot be guaranteed. If a version no longer supports armv7,
feedback is welcome.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="add-tp-btf-backend"&gt;
&lt;h3 id="hidadd-tp-btf-backend"&gt;Add tp-btf backend&lt;a class="headerlink" href="#hidadd-tp-btf-backend" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;A new backend &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;tp-btf&lt;/span&gt;&lt;/tt&gt; has been added.
When this backend is used, ptcpdump uses &lt;tt class="docutils literal"&gt;BPF_PROG_TYPE_TRACING&lt;/tt&gt; eBPF programs to capture packets.
The main difference from the &lt;tt class="docutils literal"&gt;tc&lt;/tt&gt; backend is that &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;tp-btf&lt;/span&gt;&lt;/tt&gt; captures data from all network namespaces by default,
while the &lt;tt class="docutils literal"&gt;tc&lt;/tt&gt; backend defaults to capturing data only from the current
network namespace (use &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--netns&lt;/span&gt;&lt;/tt&gt; to specify a specific network namespace).
For differences between backends, see &lt;a class="reference external" href="https://github.com/mozillazg/ptcpdump?tab=readme-ov-file#backend"&gt;Backend&lt;/a&gt; .&lt;/p&gt;
&lt;p&gt;You can use the new &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;tp-btf&lt;/span&gt;&lt;/tt&gt; backend via &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--backend&lt;/span&gt; &lt;span class="pre"&gt;tp-btf&lt;/span&gt;&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="add-socket-filter-backend"&gt;
&lt;h3 id="hidadd-socket-filter-backend"&gt;Add socket-filter backend&lt;a class="headerlink" href="#hidadd-socket-filter-backend" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Another new backend &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;socket-filter&lt;/span&gt;&lt;/tt&gt; has been added.
When this backend is used, ptcpdump uses &lt;tt class="docutils literal"&gt;BPF_PROG_TYPE_SOCKET_FILTER&lt;/tt&gt; eBPF programs to capture packets.
When using this backend, the output of ptcpdump is closer to the output
of tcpdump because the packet capture timing is more similar.
For differences between backends, see &lt;a class="reference external" href="https://github.com/mozillazg/ptcpdump?tab=readme-ov-file#backend"&gt;Backend&lt;/a&gt; .&lt;/p&gt;
&lt;p&gt;You can use the new &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;socket-filter&lt;/span&gt;&lt;/tt&gt; backend via &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--backend&lt;/span&gt; &lt;span class="pre"&gt;socket-filter&lt;/span&gt;&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="display-inode-id-in-cross-network-namespace-results"&gt;
&lt;h3 id="hiddisplay-inode-id-in-cross-network-namespace-results"&gt;Display inode ID in cross-network namespace results&lt;a class="headerlink" href="#hiddisplay-inode-id-in-cross-network-namespace-results" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Starting from the new version, when the output contains data from a non-current network namespace,
the program will attempt to display the inode ID of that network
namespace when showing network interface information:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
12:20:31.336316 eth0&amp;#64;4026533097 curl.405939 Out IP 172.17.0.4.38670 &amp;gt; 1.1.1.1.80: Flags [S], seq 3064539219, win 64240, options [mss 1460,sackOK,TS val 1731159046 ecr 0,nop,wscale 7], length 0, ParentProc [bash.405653]
12:20:31.336382 veth1d387b0 curl.405939 In IP 172.17.0.4.38670 &amp;gt; 1.1.1.1.80: Flags [S], seq 3064539219, win 64240, options [mss 1460,sackOK,TS val 1731159046 ecr 0,nop,wscale 7], length 0, ParentProc [bash.405653]
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="add-ip-options-information-to-v-output"&gt;
&lt;h3 id="hidadd-ip-options-information-to-v-output"&gt;Add IP Options information to -v output&lt;a class="headerlink" href="#hidadd-ip-options-information-to-v-output" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;The new version will output IP Options information when using the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-v&lt;/span&gt;&lt;/tt&gt; option for details:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
09:48:31.908813 IP (tos 0x0, ttl 64, id 39183, offset 0, flags [none], proto TCP (6), length 80, options (RR 1.2.3.4, 1.0.0.0 0.0.0.0 0.0.0.0 0.0.0.0 0.0.0.0 0.0.0.0 0.0.0.0 0.0.0.0,EOL))
    ${IP}.1373 &amp;gt; 1.1.1.1.80: Flags [S], cksum 0xbfb4, seq 122218745, win 512, length 0
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="add-output-for-http-information"&gt;
&lt;h3 id="hidadd-output-for-http-information"&gt;Add output for HTTP information&lt;a class="headerlink" href="#hidadd-output-for-http-information" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;If a packet contains HTTP data, the new version will output basic HTTP information by default:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
13:27:02.285015 IP ${IP}.57166 &amp;gt; ${IP}.80: Flags [P.], ..., length 73: HTTP: GET / HTTP/1.1
13:27:02.516911 IP ${IP}.80 &amp;gt; ${IP}.57166: Flags [P.], ..., length 349: HTTP: HTTP/1.1 301 Moved Permanently
&lt;/pre&gt;
&lt;p&gt;If &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-v&lt;/span&gt;&lt;/tt&gt; is used for detailed output, detailed HTTP information will be included:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
13:27:02.285015 IP (tos 0x0, ttl 64, id 8683, offset 0, flags [DF], proto TCP (6), length 113)
    ..., length 73: HTTP: GET / HTTP/1.1
        GET / HTTP/1.1
        Host: kernel.org
        User-Agent: curl/8.5.0
        Accept: */*

13:27:02.516911 IP (tos 0x0, ttl 128, id 62994, offset 0, flags [none], proto TCP (6), length 389)
    ..., length 349: HTTP: HTTP/1.1 301 Moved Permanently
        HTTP/1.1 301 Moved Permanently
        Server: nginx
        Date: Sat, 05 Jul 2025 13:27:02 GMT
        Content-Type: text/html
        Content-Length: 162
        Connection: keep-alive
        Location: https://kernel.org/

        &amp;lt;html&amp;gt;
        &amp;lt;head&amp;gt;&amp;lt;title&amp;gt;301 Moved Permanently&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;
        &amp;lt;body&amp;gt;
        &amp;lt;center&amp;gt;&amp;lt;h1&amp;gt;301 Moved Permanently&amp;lt;/h1&amp;gt;&amp;lt;/center&amp;gt;
        &amp;lt;hr&amp;gt;&amp;lt;center&amp;gt;nginx&amp;lt;/center&amp;gt;
        &amp;lt;/body&amp;gt;
        &amp;lt;/html&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="add-output-for-tls-information"&gt;
&lt;h3 id="hidadd-output-for-tls-information"&gt;Add output for TLS information&lt;a class="headerlink" href="#hidadd-output-for-tls-information" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;If a packet contains TLS data, the new version will output TLS Client Hello
or Server Hello information by default:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
13:48:40.371849 IP ${IP}.47812 &amp;gt; ${IP}.443: Flags [P.], ..., length 517: TLSv1.0: Client Hello (SNI=kernel.org)
13:48:40.606677 IP ${IP}.443 &amp;gt; ${IP}.47812: Flags [P.], ..., length 1412: TLSv1.3: Server Hello
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="add-support-for-capturing-on-l3-network-interface-devices"&gt;
&lt;h3 id="hidadd-support-for-capturing-on-l3-network-interface-devices"&gt;Add support for capturing on L3 network interface devices&lt;a class="headerlink" href="#hidadd-support-for-capturing-on-l3-network-interface-devices" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Previous versions only supported capturing on L2 network interface devices.
The new version adds support for L3 network interfaces (such as TUN devices).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="change-to-display-tcp-sequence-numbers-as-relative-numbers-by-default"&gt;
&lt;h3 id="hidchange-to-display-tcp-sequence-numbers-as-relative-numbers-by-default"&gt;Change to display TCP sequence numbers as relative numbers by default&lt;a class="headerlink" href="#hidchange-to-display-tcp-sequence-numbers-as-relative-numbers-by-default" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;In previous versions, raw TCP sequence numbers were displayed by default, which was hard to read:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
20:03:36.346098 ens33 sshd.183127 Out IP ${IP}.22 &amp;gt; ${IP}.64755: Flags [P.], seq 1457857145:1457857369, ack 1966040526, win 65535, length 224, ParentProc [sshd.16678]
20:03:36.346909 ens33 sshd.183127 In IP ${IP}.64755 &amp;gt; ${IP}.22: Flags [.], seq 1966040526, ack 1457857369, win 64240, length 0, ParentProc [sshd.16678]
20:03:36.348807 ens33 sshd.183127 Out IP ${IP}.22 &amp;gt; ${IP}.64755: Flags [P.], seq 1457857369:1457857593, ack 1966040526, win 65535, length 224, ParentProc [sshd.16678]
&lt;/pre&gt;
&lt;p&gt;The new version displays TCP sequence numbers as relative numbers by default:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
20:03:36.346098 ens33 sshd.183127 Out IP ${IP}.22 &amp;gt; ${IP}.64755: Flags [P.], seq 1457857145:1457857369, ack 1966040526, win 65535, length 224, ParentProc [sshd.16678]
20:03:36.346909 ens33 sshd.183127 In IP ${IP}.64755 &amp;gt; ${IP}.22: Flags [.], ack 224, win 64240, length 0, ParentProc [sshd.16678]
20:03:36.348807 ens33 sshd.183127 Out IP ${IP}.22 &amp;gt; ${IP}.64755: Flags [P.], seq 224:448, ack 0, win 65535, length 224, ParentProc [sshd.16678]
&lt;/pre&gt;
&lt;p&gt;It also adds the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-S&lt;/span&gt;&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--absolute-tcp-sequence-numbers&lt;/span&gt;&lt;/tt&gt; options to
switch back to displaying raw numbers.&lt;/p&gt;
&lt;p&gt;If you have any additional improvements or new feature suggestions for ptcpdump,
feel free to leave a comment in the comments section or project issues.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="ptcpdump"></category></entry><entry><title>ptcpdump v0.33 ~ v0.37 的主要变更内容</title><link href="https://mozillazg.com/2025/11/whats-new-ptcpdump-v0.33-v0.37.html" rel="alternate"></link><published>2025-11-29T00:00:00+00:00</published><updated>2025-11-29T00:00:00+00:00</updated><author><name>mozillazg</name></author><id>tag:mozillazg.com,2025-11-29:2025/11/whats-new-ptcpdump-v0.33-v0.37.html</id><summary type="html">&lt;div class="section" id="section-1"&gt;
&lt;h2 id="hidsection-1"&gt;前言&lt;a class="headerlink" href="#hidsection-1" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;本文将按变更顺序介绍一下 &lt;a class="reference external" href="https://github.com/mozillazg/ptcpdump"&gt;ptcpdump&lt;/a&gt;
从上次的 &lt;a class="reference external" href="https://mozillazg.com/2025/01/whats-new-ptcpdump-v0.27-v0.32.html"&gt;v0.32&lt;/a&gt;
之后的 v0.33 版本到最新的 v0.37 版本期间所发布的主要变更内容。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="section-2"&gt;
&lt;h2 id="hidsection-2"&gt;主要变更内容&lt;a class="headerlink" href="#hidsection-2" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="bpf-ringbuf-bpf-perfbuf"&gt;
&lt;h3 id="hidbpf-ringbuf-bpf-perfbuf"&gt;优先使用 BPF ringbuf 代替 BPF perfbuf&lt;a class="headerlink" href="#hidbpf-ringbuf-bpf-perfbuf" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;如果当前系统使用的 Linux 内核支持 BPF ringbuf 的话，
ptcpdump 将优先使用 BPF ringbuf 技术优化程序性能。
关于 BPF ringbuf 的更多信息，详见 &lt;a class="reference external" href="https://nakryiko.com/posts/bpf-ringbuf/"&gt;BPF ring buffer&lt;/a&gt; 。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="cgroup-skb"&gt;
&lt;h3 id="hidcgroup-skb"&gt;修复使用 cgroup-skb 后端时按进程过滤数据包功能失效的问题&lt;a class="headerlink" href="#hidcgroup-skb" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;修复之前的版本中，通过 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--backend=cgroup-skb&lt;/span&gt;&lt;/tt&gt; 参数指定使用 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;cgroup-skb&lt;/span&gt;&lt;/tt&gt; 后端时，
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--pid&lt;/span&gt;&lt;/tt&gt; 或 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--pname&lt;/span&gt;&lt;/tt&gt; 参数对应的功能失效的问题。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pcapng"&gt;
&lt;h3 id="hidpcapng"&gt;支持从标准输入中读取 PcapNG 格式的数据&lt;a class="headerlink" href="#hidpcapng" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;现已支持通过 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-r&lt;/span&gt; -&lt;/tt&gt; 从标准输入中读取 PcapNG 格式的数据:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ cat data.pcapng | ptcpdump -r -
$ ptcpdump -r - &amp;lt; data.pcapng
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="c-w"&gt;
&lt;h3 id="hidc-w"&gt;支持 -C 和 -W 参数实现文件轮转功能&lt;a class="headerlink" href="#hidc-w" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;现已支持在使用 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-w&lt;/span&gt;&lt;/tt&gt; 保存数据到文件中时，使用 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-C&lt;/span&gt;&lt;/tt&gt; 或 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-W&lt;/span&gt;&lt;/tt&gt; 参数实现文件轮转功能:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo ptcpdump -i any -w data.pcapng -C 1mb
sudo ptcpdump -i any -w data.pcapng -C 1mb -W 5
&lt;/pre&gt;
&lt;p&gt;其中:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-C&lt;/span&gt;&lt;/tt&gt; 指定文件的最大大小，当超过该大小时，将在旧的文件名后面追加数字（比如 &lt;tt class="docutils literal"&gt;data.pcapng1&lt;/tt&gt; ），来保存历史数据。&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-W&lt;/span&gt;&lt;/tt&gt; 自定保存的文件数量，需要与 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-C&lt;/span&gt;&lt;/tt&gt; 一起使用，用于限制文件数量。&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="f-expression-file-pcap-fitler"&gt;
&lt;h3 id="hidf-expression-file-pcap-fitler"&gt;支持 -F/--expression-file 参数实现从文件中读取 pcap fitler 表达式&lt;a class="headerlink" href="#hidf-expression-file-pcap-fitler" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;现已支持使用 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-F&lt;/span&gt;&lt;/tt&gt; 或者 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--expression-file&lt;/span&gt;&lt;/tt&gt; 参数从文件中读取 pcap filter 包过滤表达式:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo ptcpdump -i any -c 10 -F filter.txt
sudo ptcpdump -i any -c 10 --expression-file filter.txt
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="tt-ttt-tttt-ttttt"&gt;
&lt;h3 id="hidtt-ttt-tttt-ttttt"&gt;支持 -tt, -ttt, -tttt, -ttttt 参数实现指定输出的时间格式&lt;a class="headerlink" href="#hidtt-ttt-tttt-ttttt" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;现已支持使用 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-tt&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-ttt&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-tttt&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-ttttt&lt;/span&gt;&lt;/tt&gt; 指定输出包信息时的时间信息格式。&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-tt&lt;/span&gt;&lt;/tt&gt; : 显示时间戳格式，比如 &lt;tt class="docutils literal"&gt;1764417816.346098 ens33 sshd.183127 Out IP xx.xx.xx.xx.22 &amp;gt; &lt;span class="pre"&gt;xx.xx.xx.xx.64755:...&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-ttt&lt;/span&gt;&lt;/tt&gt; : 显示两条记录的时间间隔, 比如 &lt;tt class="docutils literal"&gt;00:00:00.000265 ens33 sshd.183127 Out IP xx.xx.xx.xx.22 &amp;gt; &lt;span class="pre"&gt;xx.xx.xx.xx.64755:...&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-tttt&lt;/span&gt;&lt;/tt&gt; : 显示日期和时间，比如 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;2025-11-29&lt;/span&gt; 20:03:36.346098 ens33 sshd.183127 Out IP xx.xx.xx.xx.22 &amp;gt; &lt;span class="pre"&gt;xx.xx.xx.xx.64755:...&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-ttttt&lt;/span&gt;&lt;/tt&gt; : 显示距离第一条记录的时间间隔，比如 &lt;tt class="docutils literal"&gt;00:00:00.002708 ens33 sshd.183127 Out IP xx.xx.xx.xx.22 &amp;gt; &lt;span class="pre"&gt;xx.xx.xx.xx.64755:...&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="libpcap"&gt;
&lt;h3 id="hidlibpcap"&gt;支持通过动态链接的方式使用系统安装的 libpcap&lt;a class="headerlink" href="#hidlibpcap" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;之前的版本只支持以静态链接的方式编译依赖的 libpcap 库，
现已支持通过动态链接的方式使用系统安装的 libpcap 库，满足简化系统库管理的需求。&lt;/p&gt;
&lt;p&gt;可以通过下面任一编译方式使用动态链接库:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ CGO_ENABLED=1 go build -tags dynamic
$ make build-dynamic-link
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="s-0"&gt;
&lt;h3 id="hids-0"&gt;修复 -s 0 参数会导致程序崩溃的问题&lt;a class="headerlink" href="#hids-0" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;在之前的版本中，如果使用 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-s&lt;/span&gt; 0&lt;/tt&gt; 参数会导致 ptcpdump 程序崩溃，这个问题现已修复。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="section-3"&gt;
&lt;h3 id="hidsection-3"&gt;修复终端输出中的时间信息不准确的问题&lt;a class="headerlink" href="#hidsection-3" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;在之前的版本中，终端输出的包信息的时间信息随着时间的推移会与实践的事件时间差距越来越大，
这个问题现已修复。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="armv7-cpu"&gt;
&lt;h3 id="hidarmv7-cpu"&gt;实验性支持 armv7 CPU 架构&lt;a class="headerlink" href="#hidarmv7-cpu" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;在新版本中已实验性支持 armv7 CPU 架构。
因为缺少支持 armv7 架构的 CI 环境， 因此只能作为实验性支持，
没法保证未来版本的兼容性。如果某个版本不再支持 armv7 了，
欢迎反馈。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="tp-btf"&gt;
&lt;h3 id="hidtp-btf"&gt;新增 tp-btf 后端&lt;a class="headerlink" href="#hidtp-btf" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;新版本增加了一个新的后端 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;tp-btf&lt;/span&gt;&lt;/tt&gt; ，
当指定使用该后端时，ptcpdump 将使用 &lt;tt class="docutils literal"&gt;BPF_PROG_TYPE_TRACING&lt;/tt&gt; 类型的 eBPF 程序来捕获数据包。
该后端与 &lt;tt class="docutils literal"&gt;tc&lt;/tt&gt; 后端的主要区别是：&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;tp-btf&lt;/span&gt;&lt;/tt&gt; 默认将能捕获所有网络命名空间下的数据，
而 &lt;tt class="docutils literal"&gt;tc&lt;/tt&gt; 后端默认只捕获当前网络命名空间下的数据（可以通过 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--netns&lt;/span&gt;&lt;/tt&gt; 命令指定捕获特定网络命名空间下的数据）。
关于该后端与其他后端的区别，详见 &lt;a class="reference external" href="https://github.com/mozillazg/ptcpdump?tab=readme-ov-file#backend"&gt;Backend&lt;/a&gt; 。&lt;/p&gt;
&lt;p&gt;可以通过 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--backend&lt;/span&gt; &lt;span class="pre"&gt;tp-btf&lt;/span&gt;&lt;/tt&gt; 使用新增的 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;tp-btf&lt;/span&gt;&lt;/tt&gt; 后端。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="socket-filter"&gt;
&lt;h3 id="hidsocket-filter"&gt;新增 socket-filter 后端&lt;a class="headerlink" href="#hidsocket-filter" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;新版本增加了另一个新的后端 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;socket-filter&lt;/span&gt;&lt;/tt&gt; ，
当指定使用该后端时，ptcpdump 将使用 &lt;tt class="docutils literal"&gt;BPF_PROG_TYPE_SOCKET_FILTER&lt;/tt&gt; 类型的 eBPF 程序来捕获数据包。
使用该后端时，ptcpdump 的输出结果将更接近 tcpdump 的输出结果，因为此时它们两个捕获数据包的时机会更接近。
关于该后端与其他后端的区别，详见 &lt;a class="reference external" href="https://github.com/mozillazg/ptcpdump?tab=readme-ov-file#backend"&gt;Backend&lt;/a&gt; 。&lt;/p&gt;
&lt;p&gt;可以通过 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--backend&lt;/span&gt; &lt;span class="pre"&gt;socket-filter&lt;/span&gt;&lt;/tt&gt; 使用新增的 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;socket-filter&lt;/span&gt;&lt;/tt&gt; 后端。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="inode-id"&gt;
&lt;h3 id="hidinode-id"&gt;在跨网络命名空间的数据结果中显示 inode ID 信息&lt;a class="headerlink" href="#hidinode-id" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;从新版本开始，当输出结果中包含非当前网络命名空间的数据时，程序将会尝试在输出网络接口信息时，显示对应网络命名空间的 inode ID 信息:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
12:20:31.336316 eth0&amp;#64;4026533097 curl.405939 Out IP 172.17.0.4.38670 &amp;gt; 1.1.1.1.80: Flags [S], seq 3064539219, win 64240, options [mss 1460,sackOK,TS val 1731159046 ecr 0,nop,wscale 7], length 0, ParentProc [bash.405653]
12:20:31.336382 veth1d387b0 curl.405939 In IP 172.17.0.4.38670 &amp;gt; 1.1.1.1.80: Flags [S], seq 3064539219, win 64240, options [mss 1460,sackOK,TS val 1731159046 ecr 0,nop,wscale 7], length 0, ParentProc [bash.405653]
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="v-ip-options"&gt;
&lt;h3 id="hidv-ip-options"&gt;-v 的输出中增加 IP Options 信息&lt;a class="headerlink" href="#hidv-ip-options" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;新版本在使用 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-v&lt;/span&gt;&lt;/tt&gt; 参数输出详情时，将输出 IP Options 信息:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
09:48:31.908813 IP (tos 0x0, ttl 64, id 39183, offset 0, flags [none], proto TCP (6), length 80, options (RR 1.2.3.4, 1.0.0.0 0.0.0.0 0.0.0.0 0.0.0.0 0.0.0.0 0.0.0.0 0.0.0.0 0.0.0.0,EOL))
    ${IP}.1373 &amp;gt; 1.1.1.1.80: Flags [S], cksum 0xbfb4, seq 122218745, win 512, length 0
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="http"&gt;
&lt;h3 id="hidhttp"&gt;新增输出 HTTP 信息&lt;a class="headerlink" href="#hidhttp" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;如果某一行的数据包是 HTTP 数据，新版本将默认输出基本的 HTTP 信息:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
13:27:02.285015 IP ${IP}.57166 &amp;gt; ${IP}.80: Flags [P.], ..., length 73: HTTP: GET / HTTP/1.1
13:27:02.516911 IP ${IP}.80 &amp;gt; ${IP}.57166: Flags [P.], ..., length 349: HTTP: HTTP/1.1 301 Moved Permanently
&lt;/pre&gt;
&lt;p&gt;如果使用 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-v&lt;/span&gt;&lt;/tt&gt; 参数输出详情，则会包含详细的 HTTP 信息:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
13:27:02.285015 IP (tos 0x0, ttl 64, id 8683, offset 0, flags [DF], proto TCP (6), length 113)
    ..., length 73: HTTP: GET / HTTP/1.1
        GET / HTTP/1.1
        Host: kernel.org
        User-Agent: curl/8.5.0
        Accept: */*

13:27:02.516911 IP (tos 0x0, ttl 128, id 62994, offset 0, flags [none], proto TCP (6), length 389)
    ..., length 349: HTTP: HTTP/1.1 301 Moved Permanently
        HTTP/1.1 301 Moved Permanently
        Server: nginx
        Date: Sat, 05 Jul 2025 13:27:02 GMT
        Content-Type: text/html
        Content-Length: 162
        Connection: keep-alive
        Location: https://kernel.org/

        &amp;lt;html&amp;gt;
        &amp;lt;head&amp;gt;&amp;lt;title&amp;gt;301 Moved Permanently&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;
        &amp;lt;body&amp;gt;
        &amp;lt;center&amp;gt;&amp;lt;h1&amp;gt;301 Moved Permanently&amp;lt;/h1&amp;gt;&amp;lt;/center&amp;gt;
        &amp;lt;hr&amp;gt;&amp;lt;center&amp;gt;nginx&amp;lt;/center&amp;gt;
        &amp;lt;/body&amp;gt;
        &amp;lt;/html&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="tls"&gt;
&lt;h3 id="hidtls"&gt;新增输出 TLS 信息&lt;a class="headerlink" href="#hidtls" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;如果某一行的数据包是 TLS 数据，新版本将默认输出 TLS Client Hello 或 Server Hello 信息:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
13:48:40.371849 IP ${IP}.47812 &amp;gt; ${IP}.443: Flags [P.], ..., length 517: TLSv1.0: Client Hello (SNI=kernel.org)
13:48:40.606677 IP ${IP}.443 &amp;gt; ${IP}.47812: Flags [P.], ..., length 1412: TLSv1.3: Server Hello
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="l3"&gt;
&lt;h3 id="hidl3"&gt;新增支持对 L3 网络接口设备抓包&lt;a class="headerlink" href="#hidl3" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;之前的版本只支持对 L2 网络接口设备抓包，新版本已增加对 L3 网络接口（比如 TUN 设备）的支持。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="tcp"&gt;
&lt;h3 id="hidtcp"&gt;改为默认以相对数字显示 TCP 序列号&lt;a class="headerlink" href="#hidtcp" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;在之前的版本中，默认会显示 TCP 序列号的原始数字，比较难阅读:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
20:03:36.346098 ens33 sshd.183127 Out IP ${IP}.22 &amp;gt; ${IP}.64755: Flags [P.], seq 1457857145:1457857369, ack 1966040526, win 65535, length 224, ParentProc [sshd.16678]
20:03:36.346909 ens33 sshd.183127 In IP ${IP}.64755 &amp;gt; ${IP}.22: Flags [.], seq 1966040526, ack 1457857369, win 64240, length 0, ParentProc [sshd.16678]
20:03:36.348807 ens33 sshd.183127 Out IP ${IP}.22 &amp;gt; ${IP}.64755: Flags [P.], seq 1457857369:1457857593, ack 1966040526, win 65535, length 224, ParentProc [sshd.16678]
&lt;/pre&gt;
&lt;p&gt;新版本将默认以相对数字的形式显示 TCP 序列号信息:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
20:03:36.346098 ens33 sshd.183127 Out IP ${IP}.22 &amp;gt; ${IP}.64755: Flags [P.], seq 1457857145:1457857369, ack 1966040526, win 65535, length 224, ParentProc [sshd.16678]
20:03:36.346909 ens33 sshd.183127 In IP ${IP}.64755 &amp;gt; ${IP}.22: Flags [.], ack 224, win 64240, length 0, ParentProc [sshd.16678]
20:03:36.348807 ens33 sshd.183127 Out IP ${IP}.22 &amp;gt; ${IP}.64755: Flags [P.], seq 224:448, ack 0, win 65535, length 224, ParentProc [sshd.16678]
&lt;/pre&gt;
&lt;p&gt;同时新增 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-S&lt;/span&gt;&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--absolute-tcp-sequence-numbers&lt;/span&gt;&lt;/tt&gt; 参数用于控制恢复之前的显示原始数字的模式。&lt;/p&gt;
&lt;p&gt;如果你对 ptcpdump 有额外的改进或新功能建议，欢迎在评论区或项目 issues 中留言。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="ptcpdump"></category></entry><entry><title>ptcpdump v0.27 ~ v0.32 的主要变更内容</title><link href="https://mozillazg.com/2025/01/whats-new-ptcpdump-v0.27-v0.32-en.html" rel="alternate"></link><published>2025-01-25T00:00:00+00:00</published><updated>2025-01-25T00:00:00+00:00</updated><author><name>mozillazg</name></author><id>tag:mozillazg.com,2025-01-25:2025/01/whats-new-ptcpdump-v0.27-v0.32-en.html</id><summary type="html">&lt;div class="section" id="introduction"&gt;
&lt;h2 id="hidintroduction"&gt;Introduction&lt;a class="headerlink" href="#hidintroduction" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;This article introduces the main changes in &lt;a class="reference external" href="https://github.com/mozillazg/ptcpdump"&gt;ptcpdump&lt;/a&gt;
from v0.27 (after &lt;a class="reference external" href="https://mozillazg.com/2024/11/whats-new-ptcpdump-v1.16-v1.26-en.html"&gt;v0.26&lt;/a&gt;)
to the latest v0.32, in chronological order.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="main-changes"&gt;
&lt;h2 id="hidmain-changes"&gt;Main Changes&lt;a class="headerlink" href="#hidmain-changes" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="add-q-quiet-option"&gt;
&lt;h3 id="hidadd-q-quiet-option"&gt;Add -q/--quiet option&lt;a class="headerlink" href="#hidadd-q-quiet-option" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Added the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-q/--quiet&lt;/span&gt;&lt;/tt&gt; option to simplify the output:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
13:50:35.524360 lo curl.345650 Out IP 127.0.0.1.58694 &amp;gt; 127.0.0.1.8000: tcp 0, ParentProc [bash.345626]
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="add-context-option"&gt;
&lt;h3 id="hidadd-context-option"&gt;Add --context option&lt;a class="headerlink" href="#hidadd-context-option" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Added the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--context&lt;/span&gt;&lt;/tt&gt; option to specify the context information included in the output. This option controls showing only specific context information.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;Use &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--context=process&lt;/span&gt;&lt;/tt&gt; to restrict output to process information only:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
# --context=process
09:32:09.718892 vethee2a302f wget.3553008 In IP 10.244.0.2.33426 &amp;gt; 139.178.84.217.80: Flags [S], seq 4113492822, win 64240, length 0

# -v --context=process
13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52)
    139.178.84.217.443 &amp;gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0
    Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org)
&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;This option supports specifying multiple values either by separating them with commas or by specifying the option multiple times:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
# -v --context=process,parentproc
# -v --context=process --context=parentproc

13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52)
    139.178.84.217.443 &amp;gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0
    Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org)
    ParentProc (pid 553296, cmd /bin/sh, args sh)

# -v --context=process,parentproc,container
# -v --context=process --context=parentproc --context=container

13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52)
    139.178.84.217.443 &amp;gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0
    Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org)
    ParentProc (pid 553296, cmd /bin/sh, args sh)
    Container (name test, id d9028334568bf75a5a084963a8f98f78c56bba7f45f823b3780a135b71b91e95, image docker.io/library/alpine:3.18, labels {&amp;quot;io.cri-containerd.kind&amp;quot;:&amp;quot;container&amp;quot;,&amp;quot;io.kubernetes.container.name&amp;quot;:&amp;quot;test&amp;quot;,&amp;quot;io.kubernetes.pod.name&amp;quot;:&amp;quot;test&amp;quot;,&amp;quot;io.kubernetes.pod.namespace&amp;quot;:&amp;quot;default&amp;quot;,&amp;quot;io.kubernetes.pod.uid&amp;quot;:&amp;quot;9e4bc54b-de48-4b1c-8b9e-54709f67ed0c&amp;quot;})
&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="use-fentry-btf-raw-tracepoint-and-tcx-ebpf-features-on-newer-kernels"&gt;
&lt;h3 id="hiduse-fentry-btf-raw-tracepoint-and-tcx-ebpf-features-on-newer-kernels"&gt;Use fentry, btf raw tracepoint, and tcx ebpf features on newer kernels&lt;a class="headerlink" href="#hiduse-fentry-btf-raw-tracepoint-and-tcx-ebpf-features-on-newer-kernels" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;When running ptcpdump on newer kernels, the program will automatically use fentry instead of kprobe,
btf raw tracepoint instead of raw tracepoint, and tcx instead of tc.
Using these new ebpf features optimizes performance on newer kernels.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="add-backend-option"&gt;
&lt;h3 id="hidadd-backend-option"&gt;Add --backend option&lt;a class="headerlink" href="#hidadd-backend-option" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Added the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--backend&lt;/span&gt;&lt;/tt&gt; option to specify the technology used for packet capturing. The default is tc/tcx.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="support-backend-cgroup-skb"&gt;
&lt;h3 id="hidsupport-backend-cgroup-skb"&gt;Support --backend=cgroup-skb&lt;a class="headerlink" href="#hidsupport-backend-cgroup-skb" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;It now supports using &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--backend=cgroup-skb&lt;/span&gt;&lt;/tt&gt; to capture packets using cgroup-skb ebpf programs.
Traffic captured this way will not contain link-layer information; the link-layer information in ptcpdump output will be fixed fake data.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="support-openwrt-24-10-x86-64-system"&gt;
&lt;h3 id="hidsupport-openwrt-24-10-x86-64-system"&gt;Support OpenWrt 24.10 x86-64 system&lt;a class="headerlink" href="#hidsupport-openwrt-24-10-x86-64-system" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Based on user feedback, program compatibility has been improved to support using ptcpdump on OpenWrt 24.10 x86-64 systems (provided the system kernel was compiled with ebpf and BTF parameters enabled).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="support-displaying-thread-information-in-output"&gt;
&lt;h3 id="hidsupport-displaying-thread-information-in-output"&gt;Support displaying thread information in output&lt;a class="headerlink" href="#hidsupport-displaying-thread-information-in-output" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;When capturing packets using &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--backend=cgroup-skb&lt;/span&gt;&lt;/tt&gt;, thread information is now displayed in the output:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ sudo ptcpdump -i any --backend cgroup-skb -v port 80

10:18:26.846884 ens33 Out IP (tos 0x0, ttl 64, id 57734, offset 0, flags [DF], proto TCP (6), length 478)
    xxx.xxx.xxx.35102 &amp;gt; xxx.xxx.xxx.80: Flags [P.], cksum 0x3381, seq xx:xx, ack xx, win 64240, length 438
    Process (pid 113278, cmd /snap/firefox/5437/usr/lib/firefox/firefox, args /snap/firefox/5437/usr/lib/firefox/firefox)
    Thread (tid 113438, name Socket Thread)
    ParentProc (pid 49607, cmd /usr/bin/xfce4-panel, args xfce4-panel --display :0.0 --sm-client-id xxxx)
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="support-displaying-uid-in-output-and-capturing-by-uid"&gt;
&lt;h3 id="hidsupport-displaying-uid-in-output-and-capturing-by-uid"&gt;Support displaying UID in output and capturing by UID&lt;a class="headerlink" href="#hidsupport-displaying-uid-in-output-and-capturing-by-uid" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;It now supports displaying UID information in the output:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
12:37:40.051539 ens33 Out IP (tos 0x0, ttl 64, id 48697, offset 0, flags [DF], proto TCP (6), length 60)
    10.0.x.x.42906 &amp;gt; 139.x.x.x.443: Flags [S], cksum 0xecc8, seq 940329637, win 64240, options [mss 1460,sackOK,TS val 3421262256 ecr 0,nop,wscale 7], length 0
    Process (pid 99722, cmd /usr/bin/curl, args curl https://kernel.org)
    User (uid 1000)
    ParentProc (pid 18840, cmd /usr/bin/bash, args -bash)
&lt;/pre&gt;
&lt;p&gt;It now supports specifying a UID for packet capturing:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ sudo ptcpdump -i any --uid 100 -v port 80
&lt;/pre&gt;
&lt;p&gt;If you have additional improvements or new feature suggestions for ptcpdump,
feel free to leave a message in the comments or project issues.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="ptcpdump"></category></entry><entry><title>ptcpdump v0.27 ~ v0.32 的主要变更内容</title><link href="https://mozillazg.com/2025/01/whats-new-ptcpdump-v0.27-v0.32.html" rel="alternate"></link><published>2025-01-25T00:00:00+00:00</published><updated>2025-01-25T00:00:00+00:00</updated><author><name>mozillazg</name></author><id>tag:mozillazg.com,2025-01-25:2025/01/whats-new-ptcpdump-v0.27-v0.32.html</id><summary type="html">&lt;div class="section" id="section-1"&gt;
&lt;h2 id="hidsection-1"&gt;前言&lt;a class="headerlink" href="#hidsection-1" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;本文将按变更顺序介绍一下 &lt;a class="reference external" href="https://github.com/mozillazg/ptcpdump"&gt;ptcpdump&lt;/a&gt;
从上次的 &lt;a class="reference external" href="https://mozillazg.com/2024/11/whats-new-ptcpdump-v1.16-v1.26.html"&gt;v0.26&lt;/a&gt;
之后的 v0.27 版本到最新的 v0.32 版本期间所发布的主要变更内容。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="section-2"&gt;
&lt;h2 id="hidsection-2"&gt;主要变更内容&lt;a class="headerlink" href="#hidsection-2" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="q-quiet"&gt;
&lt;h3 id="hidq-quiet"&gt;新增 -q/--quiet 参数&lt;a class="headerlink" href="#hidq-quiet" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;新增 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-q/--quiet&lt;/span&gt;&lt;/tt&gt; 参数用于精简输出内容:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
13:50:35.524360 lo curl.345650 Out IP 127.0.0.1.58694 &amp;gt; 127.0.0.1.8000: tcp 0, ParentProc [bash.345626]
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="context"&gt;
&lt;h3 id="hidcontext"&gt;新增 --context 参数&lt;a class="headerlink" href="#hidcontext" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;新增 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--context&lt;/span&gt;&lt;/tt&gt; 参数用于指定输出中包含的上下文信息，可以通过这个参数控制只显示特定的上下文信息。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;通过 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--context=process&lt;/span&gt;&lt;/tt&gt; 限制只输出进程信息:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
# --context=process
09:32:09.718892 vethee2a302f wget.3553008 In IP 10.244.0.2.33426 &amp;gt; 139.178.84.217.80: Flags [S], seq 4113492822, win 64240, length 0

# -v --context=process
13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52)
    139.178.84.217.443 &amp;gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0
    Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org)
&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;该参数既支持通过英文逗号分割多个值，也支持多次指定参数的方式指定多个值:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
# -v --context=process,parentproc
# -v --context=process --context=parentproc

13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52)
    139.178.84.217.443 &amp;gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0
    Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org)
    ParentProc (pid 553296, cmd /bin/sh, args sh)

# -v --context=process,parentproc,container
# -v --context=process --context=parentproc --context=container

13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52)
    139.178.84.217.443 &amp;gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0
    Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org)
    ParentProc (pid 553296, cmd /bin/sh, args sh)
    Container (name test, id d9028334568bf75a5a084963a8f98f78c56bba7f45f823b3780a135b71b91e95, image docker.io/library/alpine:3.18, labels {&amp;quot;io.cri-containerd.kind&amp;quot;:&amp;quot;container&amp;quot;,&amp;quot;io.kubernetes.container.name&amp;quot;:&amp;quot;test&amp;quot;,&amp;quot;io.kubernetes.pod.name&amp;quot;:&amp;quot;test&amp;quot;,&amp;quot;io.kubernetes.pod.namespace&amp;quot;:&amp;quot;default&amp;quot;,&amp;quot;io.kubernetes.pod.uid&amp;quot;:&amp;quot;9e4bc54b-de48-4b1c-8b9e-54709f67ed0c&amp;quot;})
&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="fentry-btf-raw-tracepoint-tcx-ebpf"&gt;
&lt;h3 id="hidfentry-btf-raw-tracepoint-tcx-ebpf"&gt;在高版本内核中使用 fentry, btf raw tracepoint 以及 tcx ebpf 特性&lt;a class="headerlink" href="#hidfentry-btf-raw-tracepoint-tcx-ebpf" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;当在高版本内核中执行 ptcpdump 程序时，程序将自动使用 fentry 代替 kprobe，
使用 btf raw tracepoint 代替 raw tracepoint, 使用 tcx 代替 tc，
通过使用这些新的 ebpf 特性，优化程序在高版本内核下的性能。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="backend"&gt;
&lt;h3 id="hidbackend"&gt;新增 --backend 参数&lt;a class="headerlink" href="#hidbackend" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;新增 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--backend&lt;/span&gt;&lt;/tt&gt; 参数用于指定抓包时使用的技术，默认是使用的 tc/tcx 技术。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="backend-cgroup-skb"&gt;
&lt;h3 id="hidbackend-cgroup-skb"&gt;支持 --backend=cgroup-skb&lt;a class="headerlink" href="#hidbackend-cgroup-skb" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;支持通过 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--backend=cgroup-skb&lt;/span&gt;&lt;/tt&gt; 参数指定使用 cgroup-skb ebpf 程序进行抓包。
使用该方式抓取的流量将不包含链路层信息，ptcpdump 输出中的链路层信息将是一个固定的 fake 数据。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="openwrt-24-10-x86-64"&gt;
&lt;h3 id="hidopenwrt-24-10-x86-64"&gt;支持 OpenWrt 24.10 x86-64 系统&lt;a class="headerlink" href="#hidopenwrt-24-10-x86-64" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;根据用户的需求反馈，提升程序兼容性，支持在 OpenWrt 24.10 x86-64 系统中使用 ptcpdump （前提是系统内核在编译时启用 ebpf 和 BTF 相关参数）。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="section-3"&gt;
&lt;h3 id="hidsection-3"&gt;支持在输出中显示线程信息&lt;a class="headerlink" href="#hidsection-3" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;当通过 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--backend=cgroup-skb&lt;/span&gt;&lt;/tt&gt; 进行抓包时，新增在输出中显示线程信息:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ sudo ptcpdump -i any --backend cgroup-skb -v port 80

10:18:26.846884 ens33 Out IP (tos 0x0, ttl 64, id 57734, offset 0, flags [DF], proto TCP (6), length 478)
    xxx.xxx.xxx.35102 &amp;gt; xxx.xxx.xxx.80: Flags [P.], cksum 0x3381, seq xx:xx, ack xx, win 64240, length 438
    Process (pid 113278, cmd /snap/firefox/5437/usr/lib/firefox/firefox, args /snap/firefox/5437/usr/lib/firefox/firefox)
    Thread (tid 113438, name Socket Thread)
    ParentProc (pid 49607, cmd /usr/bin/xfce4-panel, args xfce4-panel --display :0.0 --sm-client-id xxxx)
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="uid-uid"&gt;
&lt;h3 id="hiduid-uid"&gt;支持在输出中显示 uid 以及按 uid 抓包&lt;a class="headerlink" href="#hiduid-uid" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;新增在输出中显示 uid 信息:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
12:37:40.051539 ens33 Out IP (tos 0x0, ttl 64, id 48697, offset 0, flags [DF], proto TCP (6), length 60)
    10.0.x.x.42906 &amp;gt; 139.x.x.x.443: Flags [S], cksum 0xecc8, seq 940329637, win 64240, options [mss 1460,sackOK,TS val 3421262256 ecr 0,nop,wscale 7], length 0
    Process (pid 99722, cmd /usr/bin/curl, args curl https://kernel.org)
    User (uid 1000)
    ParentProc (pid 18840, cmd /usr/bin/bash, args -bash)
&lt;/pre&gt;
&lt;p&gt;新增支持指定 uid 进行抓包:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ sudo ptcpdump -i any --uid 100 -v port 80
&lt;/pre&gt;
&lt;p&gt;如果你对 ptcpdump 有额外的改进或新功能建议，欢迎在评论区或项目 issues 中留言。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="ptcpdump"></category></entry><entry><title>Major Changes in ptcpdump versions 0.16 to 0.26</title><link href="https://mozillazg.com/2024/11/whats-new-ptcpdump-v1.16-v1.26-en.html" rel="alternate"></link><published>2024-11-02T00:00:00+00:00</published><updated>2024-11-02T00:00:00+00:00</updated><author><name>mozillazg</name></author><id>tag:mozillazg.com,2024-11-02:2024/11/whats-new-ptcpdump-v1.16-v1.26-en.html</id><summary type="html">&lt;div class="section" id="preface"&gt;
&lt;h2 id="hidpreface"&gt;Preface&lt;a class="headerlink" href="#hidpreface" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;It has been several months since the
&lt;a class="reference external" href="https://mozillazg.com/2024/07/ebpf-ptcpdump-capturing-the-network-traffic-of-a-process-or-container-or-pod.html"&gt;last introduction&lt;/a&gt;
of the &lt;a class="reference external" href="https://github.com/mozillazg/ptcpdump"&gt;ptcpdump&lt;/a&gt; project.
Over these past months, I have been continuously developing this project.
This article will introduce the major changes released from the previous v0.16
version to the latest v0.26 version in chronological order.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="main-changes"&gt;
&lt;h2 id="hidmain-changes"&gt;Main changes&lt;a class="headerlink" href="#hidmain-changes" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="compatible-with-older-versions-of-tencentos-opencloudos-system"&gt;
&lt;h3 id="hidcompatible-with-older-versions-of-tencentos-opencloudos-system"&gt;Compatible with older versions of TencentOS/OpenCloudOS system&lt;a class="headerlink" href="#hidcompatible-with-older-versions-of-tencentos-opencloudos-system" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Base on user &lt;a class="reference external" href="https://github.com/mozillazg/ptcpdump/issues/89"&gt;feedback&lt;/a&gt;
the older versions were not compatible with previous editions of TencentOS/OpenCloudOS.
However, the current update now includes support for the following TencentOS/OpenCloudOS
releases: OpenCloudOS 7/8/9 and TencentOS Server 2.4/2.6/3.1/3.2.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="add-parent-process-information-to-the-output"&gt;
&lt;h3 id="hidadd-parent-process-information-to-the-output"&gt;Add parent process information to the output&lt;a class="headerlink" href="#hidadd-parent-process-information-to-the-output" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Old version:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52)
    139.178.84.217.443 &amp;gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0
    Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org)
    Container (...)
    Pod (...)
&lt;/pre&gt;
&lt;p&gt;Latest update:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52)
    139.178.84.217.443 &amp;gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0
    Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org)
    ParentProc (pid 553296, cmd /bin/sh, args sh)
    Container (...)
    Pod (...)
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="support-using-an-older-version-of-kubernetes-environment-with-dockershim"&gt;
&lt;h3 id="hidsupport-using-an-older-version-of-kubernetes-environment-with-dockershim"&gt;Support using an older version of Kubernetes environment with Dockershim&lt;a class="headerlink" href="#hidsupport-using-an-older-version-of-kubernetes-environment-with-dockershim" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;The earlier release couldn't gather Pod data in legacy Kubernetes setups running
Dockershim (specifically CRI v1alpha2). The latest update is now compatible with such environments.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-for-filtering-by-pod-name-containing-periods"&gt;
&lt;h3 id="hidfix-for-filtering-by-pod-name-containing-periods"&gt;Fix for filtering by Pod name containing periods&lt;a class="headerlink" href="#hidfix-for-filtering-by-pod-name-containing-periods" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;In the past, when filtering by Pod name, names with periods were not supported.
The latest version now allows names with periods to be filtered:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
--pod-name foo.bar.default
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-the-scenario-where-filtering-by-pod-does-not-support-pods-with-multiple-containers"&gt;
&lt;h3 id="hidfix-the-scenario-where-filtering-by-pod-does-not-support-pods-with-multiple-containers"&gt;Fix the scenario where filtering by Pod does not support Pods with multiple containers&lt;a class="headerlink" href="#hidfix-the-scenario-where-filtering-by-pod-does-not-support-pods-with-multiple-containers" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;In previous versions, filtering by Pod did not support scenarios where Pods contain multiple containers.
This issue has been resolved in the new version.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="supporting-the-concurrent-execution-of-multiple-ptcpdump-instances"&gt;
&lt;h3 id="hidsupporting-the-concurrent-execution-of-multiple-ptcpdump-instances"&gt;Supporting the Concurrent Execution of Multiple ptcpdump Instances&lt;a class="headerlink" href="#hidsupporting-the-concurrent-execution-of-multiple-ptcpdump-instances" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Previously, only one ptcpdump process could run at a time. Running multiple ptcpdump processes simultaneously
would cause the old process to malfunction (capture no traffic). The latest version has resolved this issue.
In the new version, multiple ptcpdump processes can run concurrently without interfering
with each other or causing problems with packet capture for other processes.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="support-filtering-multiple-process-pid-simultaneously"&gt;
&lt;h3 id="hidsupport-filtering-multiple-process-pid-simultaneously"&gt;Support Filtering Multiple Process PID Simultaneously&lt;a class="headerlink" href="#hidsupport-filtering-multiple-process-pid-simultaneously" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Now the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--pid&lt;/span&gt;&lt;/tt&gt; parameter supports filtering multiple PIDs simultaneously:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
--pid pid1 --pid pid2
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="new-parameters-micro-nano-time-stamp-precision-added-to-control-the-time-format-in-the-output"&gt;
&lt;h3 id="hidnew-parameters-micro-nano-time-stamp-precision-added-to-control-the-time-format-in-the-output"&gt;New parameters --micro, --nano, --time-stamp-precision added to control the time format in the output&lt;a class="headerlink" href="#hidnew-parameters-micro-nano-time-stamp-precision-added-to-control-the-time-format-in-the-output" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;New parameters &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--micro&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--nano&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--time-stamp-precision&lt;/span&gt;&lt;/tt&gt; have been added to control the
time format in the output, mirroring the functionality and usage of tcpdump.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--micro&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--time-stamp-precision=micro&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
13:36:05.701978 IP 10.0.2.15.22 &amp;gt; 10.0.2.2.59874: Flags [P.], seq 1370707216:1370707292, ack 4569736, win 62780, length 76
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--nano&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--time-stamp-precision=nano&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
13:36:05.701978488 IP 10.0.2.15.22 &amp;gt; 10.0.2.2.59874: Flags [P.], seq 1370707216:1370707292, ack 4569736, win 62780, length 76
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="add-parameters-a-x-xx-x-xx-to-control-the-output-format-of-the-data"&gt;
&lt;h3 id="hidadd-parameters-a-x-xx-x-xx-to-control-the-output-format-of-the-data"&gt;Add parameters -A, -x, -xx, -X, -XX to control the output format of the data&lt;a class="headerlink" href="#hidadd-parameters-a-x-xx-x-xx-to-control-the-output-format-of-the-data" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Add functionality and usage comparison of tcpdump flags &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-A&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-x&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-xx&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-XX&lt;/span&gt;&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-A&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &amp;gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094]
E..nHL&amp;#64;.&amp;#64;...
..........P.G..vbbEP.......GET / HTTP/1.1
Host: qq.com
User-Agent: curl/7.81.0
Accept: */*
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-x&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &amp;gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094]
        0x0000:  4500 006e 484c 4000 4006 1bc4 0a00 020f
        0x0010:  cbcd fe9d d0e6 0050 c447 8e98 7662 6245
        0x0020:  5018 faf0 d6da 0000 4745 5420 2f20 4854
        0x0030:  5450 2f31 2e31 0d0a 486f 7374 3a20 7171
        0x0040:  2e63 6f6d 0d0a 5573 6572 2d41 6765 6e74
        0x0050:  3a20 6375 726c 2f37 2e38 312e 300d 0a41
        0x0060:  6363 6570 743a 202a 2f2a 0d0a 0d0a
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-xx&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &amp;gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094]
        0x0000:  0050 56eb bc4e 000c 298e 31f3 0800 4500
        0x0010:  006e 484c 4000 4006 1bc4 0a00 020f cbcd
        0x0020:  fe9d d0e6 0050 c447 8e98 7662 6245 5018
        0x0030:  faf0 d6da 0000 4745 5420 2f20 4854 5450
        0x0040:  2f31 2e31 0d0a 486f 7374 3a20 7171 2e63
        0x0050:  6f6d 0d0a 5573 6572 2d41 6765 6e74 3a20
        0x0060:  6375 726c 2f37 2e38 312e 300d 0a41 6363
        0x0070:  6570 743a 202a 2f2a 0d0a 0d0a
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &amp;gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094]
        0x0000:  4500 006e 484c 4000 4006 1bc4 0a00 020f  E..nHL&amp;#64;.&amp;#64;.......
        0x0010:  cbcd fe9d d0e6 0050 c447 8e98 7662 6245  .......P.G..vbbE
        0x0020:  5018 faf0 d6da 0000 4745 5420 2f20 4854  P.......GET / HT
        0x0030:  5450 2f31 2e31 0d0a 486f 7374 3a20 7171  TP/1.1..Host: qq
        0x0040:  2e63 6f6d 0d0a 5573 6572 2d41 6765 6e74  .com..User-Agent
        0x0050:  3a20 6375 726c 2f37 2e38 312e 300d 0a41  : curl/7.81.0..A
        0x0060:  6363 6570 743a 202a 2f2a 0d0a 0d0a       ccept: */*....
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-XX&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &amp;gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094]
        0x0000:  0050 56eb bc4e 000c 298e 31f3 0800 4500  .PV..N..).1...E.
        0x0010:  006e 484c 4000 4006 1bc4 0a00 020f cbcd  .nHL&amp;#64;.&amp;#64;.........
        0x0020:  fe9d d0e6 0050 c447 8e98 7662 6245 5018  .....P.G..vbbEP.
        0x0030:  faf0 d6da 0000 4745 5420 2f20 4854 5450  ......GET / HTTP
        0x0040:  2f31 2e31 0d0a 486f 7374 3a20 7171 2e63  /1.1..Host: qq.c
        0x0050:  6f6d 0d0a 5573 6572 2d41 6765 6e74 3a20  om..User-Agent:
        0x0060:  6375 726c 2f37 2e38 312e 300d 0a41 6363  curl/7.81.0..Acc
        0x0070:  6570 743a 202a 2f2a 0d0a 0d0a            ept: */*....
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="create-docker-images-for-compiling-and-running-ptcpdump"&gt;
&lt;h3 id="hidcreate-docker-images-for-compiling-and-running-ptcpdump"&gt;Create Docker Images for Compiling and Running ptcpdump&lt;a class="headerlink" href="#hidcreate-docker-images-for-compiling-and-running-ptcpdump" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Create a Docker image for compiling programs: &lt;tt class="docutils literal"&gt;quay.io/ptcpdump/develop:latest&lt;/tt&gt; and
a Docker image for running ptcpdump through Docker: &lt;tt class="docutils literal"&gt;quay.io/ptcpdump/ptcpdump:latest&lt;/tt&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;Compile eBPF programs and ptcpdump programs as needed using &lt;tt class="docutils literal"&gt;make &lt;span class="pre"&gt;build-bpf-via-docker&lt;/span&gt;&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;make &lt;span class="pre"&gt;build-via-docker&lt;/span&gt;&lt;/tt&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;You can run ptcpdump through Docker using a command similar to the following:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
docker run --privileged --rm -t --net=host --pid=host \
  -v /sys/fs/cgroup:/sys/fs/cgroup:ro \
  quay.io/ptcpdump/ptcpdump:latest ptcpdump -i any -c 2 tcp
&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="experimental-new-feature-generating-corresponding-tls-key-log-file-when-capturing-go-program-s-network-traffic"&gt;
&lt;h3 id="hidexperimental-new-feature-generating-corresponding-tls-key-log-file-when-capturing-go-program-s-network-traffic"&gt;Experimental New Feature: Generating Corresponding TLS Key Log File When Capturing Go Program's Network Traffic&lt;a class="headerlink" href="#hidexperimental-new-feature-generating-corresponding-tls-key-log-file-when-capturing-go-program-s-network-traffic" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;A new experimental feature has been implemented in the latest version:
generating the corresponding TLS Key Log file when capturing Go program's network traffic.&lt;/p&gt;
&lt;p&gt;The TLS Key Log file, also known as &lt;a class="reference external" href="https://tlswg.org/sslkeylogfile/draft-ietf-tls-keylogfile.html"&gt;SSLKEYLOGFILE&lt;/a&gt; ,
corresponds to the pre-master secret configuration in Wireshark.
Third-party programs can decrypt captured TLS traffic using the information recorded in this file.&lt;/p&gt;
&lt;p&gt;Please note: This feature is experimental and is only supported by Go programs compiled with version 1.18 or above (supports stripped binary).
It also requires running the target Go program via ptcpdump.&lt;/p&gt;
&lt;p&gt;You can try out this feature using the following two methods:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;Use the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--write-keylog-file&lt;/span&gt;&lt;/tt&gt; argument or the &lt;tt class="docutils literal"&gt;SSLKEYLOGFILE&lt;/tt&gt; environment variable to specify the location
where the SSLKEYLOGFILE file will be saved:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo ptcpdump -i any --write-keylog-file /tmp/keylogfile.txt -w /tmp/go.pcapng -- ./gohttpapp
&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;By specifying the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--embed-keylog-to-pcapng&lt;/span&gt;&lt;/tt&gt; parameter, embed the contents of the SSLKEYLOGFILE into
the saved data in the pcapng format file:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo ptcpdump -i any --embed-keylog-to-pcapng -w /tmp/gotls.pcapng -- ./gohttpapp
&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Later, you can decrypt the saved TLS data using the recorded SSLKEYLOGFILE content with Wireshark or tshark:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ sudo tshark -r /tmp/go.pcapng -o tls.keylog_file:/tmp/keylogfile.txt | grep HTTP -B 2
Running as user &amp;quot;root&amp;quot; and group &amp;quot;root&amp;quot;. This could be dangerous.
   18 0.518380586    10.0.2.15 → 13.35.238.63 TLSv1.3 118 Change Cipher Spec, Finished
   19 0.519208290 13.35.238.63 → 10.0.2.15    TCP 60 443 → 47606 [ACK] Seq=5508 Ack=340 Win=64240 Len=0
   20 0.519914720    10.0.2.15 → 13.35.238.63 HTTP 179 GET /foo/bar HTTP/1.1


$ tshark -r /tmp/gotls.pcapng | grep HTTP -B 2
   20 0.525662563    10.0.2.15 → 13.35.238.114 TLSv1.3 118 Change Cipher Spec, Finished
   21 0.526138582 13.35.238.114 → 10.0.2.15    TCP 60 443 → 37618 [ACK] Seq=5987 Ack=340 Win=64240 Len=0
   22 0.526977836    10.0.2.15 → 13.35.238.114 HTTP 179 GET /foo/bar HTTP/1.1
&lt;/pre&gt;
&lt;p&gt;ptcpdump plans to eventually have built-in support for decrypting TLS data using SSLKEYLOGFILE
and to automatically decrypt TLS data in real-time while capturing packets.
Currently, this can only be achieved using third-party tools for decrypting TLS data.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="output-tcp-options-by-default"&gt;
&lt;h3 id="hidoutput-tcp-options-by-default"&gt;Output TCP options by default&lt;a class="headerlink" href="#hidoutput-tcp-options-by-default" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;The new version will by default output TCP Options information:&lt;/p&gt;
&lt;p&gt;Old version:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
14:09:54.324433 ens33 curl.26570 Out IP (..).43772 &amp;gt; (..).443: Flags [S], seq 1674193846, win 64240, length 0, ParentProc [ptcpdump.26560]
&lt;/pre&gt;
&lt;p&gt;Latest version:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
14:09:54.324433 ens33 curl.26570 Out IP (..).43772 &amp;gt; (..).443: Flags [S], seq 1674193846, win 64240, options [mss 1460,sackOK,TS val 2107137325 ecr 0,nop,wscale 7], length 0, ParentProc [ptcpdump.26560]
&lt;/pre&gt;
&lt;p&gt;Moreover, the latest update includes support for TCP SACK (Selective Acknowledgment) and TFO (TCP Fast Open).&lt;/p&gt;
&lt;p&gt;SACK:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
19:03:36.220872 IP6 dead:beef:2::2.35288 &amp;gt; dead:beef:2::1.10029: Flags [.], seq 731670714, ack 2274465610, win 201, options [nop,nop,TS val 1253137130 ecr 837820024,nop,nop,sack 1 {2274467010:2274483378},mptcp 12 dss ack 16301812255838552430], length 0
&lt;/pre&gt;
&lt;p&gt;TFO:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
19:22:26.586851 IP6 dead:beef:1::2.54040 &amp;gt; dead:beef:1::1.10056: Flags [S], seq 271661201, win 64800, options [mss 1440,sackOK,TS val 2947503028 ecr 0,nop,wscale 7,tfo  cookiereq,nop,nop,mptcp 4 capable v1 flags [H]], length 0
19:22:26.591736 IP6 dead:beef:1::1.10056 &amp;gt; dead:beef:1::2.54040: Flags [S.], seq 1229575956, ack 271661202, win 64260, options [mss 1440,nop,nop,sackOK,nop,wscale 7,tfo  cookie 29b3cc66639d427d,nop,nop,mptcp 12 capable v1 flags [H] {0xc87438912bc26cb7}], length 0
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="output-the-mptcp-information-in-the-tcp-options"&gt;
&lt;h3 id="hidoutput-the-mptcp-information-in-the-tcp-options"&gt;Output the MPTCP information in the TCP Options&lt;a class="headerlink" href="#hidoutput-the-mptcp-information-in-the-tcp-options" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;According to the &lt;a class="reference external" href="https://github.com/mozillazg/ptcpdump/issues/148"&gt;requirement&lt;/a&gt; from
the MPTCP (MultiPath TCP) community, support for MPTCP should be added:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
15:31:51.696224 IP 10.0.1.2.60958 &amp;gt; 10.0.1.1.10004: Flags [S], seq 3019570341, win 64240, options [mss 1460,sackOK,TS val 1007819908 ecr 0,nop,wscale 7,mptcp 4 capable v1 flags [H]], length 0
15:31:51.696346 IP 10.0.1.1.10004 &amp;gt; 10.0.1.2.60958: Flags [S.], seq 2367868313, ack 3019570342, win 65160, options [mss 1460,sackOK,TS val 162498895 ecr 1007819908,nop,wscale 7,mptcp 12 capable v1 flags [H] {0x8ea1df6e0d588003}], length 0
15:31:51.696587 IP 10.0.1.2.60958 &amp;gt; 10.0.1.1.10004: Flags [.], seq 3019570342, ack 2367868314, win 502, options [nop,nop,TS val 1007819909 ecr 162498895,mptcp 20 capable v1 flags [H] {0x465bcd01b5d78120,0x8ea1df6e0d588003}], length 0
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="add-a-new-parameter-netns-to-support-capturing-network-interfaces-in-other-network-namespaces"&gt;
&lt;h3 id="hidadd-a-new-parameter-netns-to-support-capturing-network-interfaces-in-other-network-namespaces"&gt;Add a new parameter --netns to support capturing network interfaces in other network namespaces&lt;a class="headerlink" href="#hidadd-a-new-parameter-netns-to-support-capturing-network-interfaces-in-other-network-namespaces" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;The previous version only supported capturing network interfaces in the current network namespace.
The new version now supports capturing network interfaces in other network namespaces
by adding the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--netns&lt;/span&gt;&lt;/tt&gt; parameter:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo ptcpdump -i lo --netns /run/netns/foobar
sudo ptcpdump -i any --netns /run/netns/foobar
sudo ptcpdump -i any --netns /proc/26/ns/net
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="pcapng-format-enhancement-reading-writing-network-interface-names-and-inbound-outbound-information"&gt;
&lt;h3 id="hidpcapng-format-enhancement-reading-writing-network-interface-names-and-inbound-outbound-information"&gt;PcapNg format enhancement: reading/writing network interface names and Inbound/Outbound information&lt;a class="headerlink" href="#hidpcapng-format-enhancement-reading-writing-network-interface-names-and-inbound-outbound-information" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;In previous versions, using &lt;tt class="docutils literal"&gt;ptcpdump &lt;span class="pre"&gt;-r&lt;/span&gt; &amp;lt;file.pcapng&amp;gt;&lt;/tt&gt; to read a pcapng file did not display
the recorded network interface names and Inbound/Outbound information.
This issue has been resolved in the new version:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ptcpdump -r demo.pcapng
14:36:35.880947 ens33 curl.244103 Out IP 10.0.2.15.37668 &amp;gt; 114.114.114.114.53: 44427+ A? qq.com. (24), ParentProc [ptcpdump.244094]
14:36:35.882099 ens33 curl.244103 Out IP 10.0.2.15.37668 &amp;gt; 114.114.114.114.53: 31415+ AAAA? qq.com. (24), ParentProc [ptcpdump.244094]
14:36:35.954613 ens33 curl.244103 In IP 114.114.114.114.53 &amp;gt; 10.0.2.15.37668: 44427 3/0/0 A 203.205.254.157, A 113.108.81.189, A 123.150.76.218 (72), ParentProc [ptcpdump.244094]
&lt;/pre&gt;
&lt;p&gt;When saving the captured traffic information as a PcapNg format file, the new version will automatically
write Inbound/Outbound information (previous versions already wrote network interface information),
thus supporting the epb_flags (&lt;a class="reference external" href="https://www.ietf.org/archive/id/draft-tuexen-opsawg-pcapng-05.html#name-enhanced-packet-block-flags"&gt;Enhanced Packet Block Flags Word&lt;/a&gt; )
flag for the PcapNg format.&lt;/p&gt;
&lt;p&gt;If you have any additional improvements or new feature suggestions for ptcpdump,
feel free to leave a comment in the comments section or project issues.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="ptcpdump"></category></entry><entry><title>ptcpdump v0.16 ~ v0.26 的主要变更内容</title><link href="https://mozillazg.com/2024/11/whats-new-ptcpdump-v1.16-v1.26.html" rel="alternate"></link><published>2024-11-02T00:00:00+00:00</published><updated>2024-11-02T00:00:00+00:00</updated><author><name>mozillazg</name></author><id>tag:mozillazg.com,2024-11-02:2024/11/whats-new-ptcpdump-v1.16-v1.26.html</id><summary type="html">&lt;div class="section" id="section-1"&gt;
&lt;h2 id="hidsection-1"&gt;前言&lt;a class="headerlink" href="#hidsection-1" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;距离 &lt;a class="reference external" href="https://mozillazg.com/2024/07/ebpf-ptcpdump-capturing-the-network-traffic-of-a-process-or-container-or-pod.html"&gt;上次首次介绍&lt;/a&gt;
&lt;a class="reference external" href="https://github.com/mozillazg/ptcpdump"&gt;ptcpdump&lt;/a&gt; 项目已经过去好几个月了，
最近这几个月我一直在持续开发这个项目，
本文将按变更顺序介绍一下从上次的 v0.16 版本到最新的 v0.26 版本期间所发布的主要变更内容。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="section-2"&gt;
&lt;h2 id="hidsection-2"&gt;主要变更内容&lt;a class="headerlink" href="#hidsection-2" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="tencentos-opencloudos"&gt;
&lt;h3 id="hidtencentos-opencloudos"&gt;兼容老版本的 TencentOS/OpenCloudOS 系统&lt;a class="headerlink" href="#hidtencentos-opencloudos" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;根据用户 &lt;a class="reference external" href="https://github.com/mozillazg/ptcpdump/issues/89"&gt;反馈&lt;/a&gt; ，
之前的版本无法在老版本的 TencentOS/OpenCloudOS 上运行，
当前最新版本已经支持了如下 TencentOS/OpenCloudOS 系统版本：
OpenCloudOS 7/8/9 and TencentOS Server 2.4/2.6/3.1/3.2 。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="section-3"&gt;
&lt;h3 id="hidsection-3"&gt;在输出中增加父进程信息&lt;a class="headerlink" href="#hidsection-3" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;老版本:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52)
    139.178.84.217.443 &amp;gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0
    Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org)
    Container (...)
    Pod (...)
&lt;/pre&gt;
&lt;p&gt;新版本:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
13:44:41.529003 eth0 In IP (tos 0x4, ttl 45, id 45428, offset 0, flags [DF], proto TCP (6), length 52)
    139.178.84.217.443 &amp;gt; 172.19.0.2.42606: Flags [.], cksum 0x5284, seq 3173118145, ack 1385712707, win 118, options [nop,nop,TS val 134560683 ecr 1627716996], length 0
    Process (pid 553587, cmd /usr/bin/wget, args wget kernel.org)
    ParentProc (pid 553296, cmd /bin/sh, args sh)
    Container (...)
    Pod (...)
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="dockershim-kubernetes"&gt;
&lt;h3 id="hiddockershim-kubernetes"&gt;支持使用 Dockershim 的老版本 Kubernetes 环境&lt;a class="headerlink" href="#hiddockershim-kubernetes" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;之前的版本无法在使用 Dockershim （准确的说是基于 CRI v1alpha2）的老版本 Kubernetes 环境中获取 Pod 信息，新版本已兼容这种环境。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pod"&gt;
&lt;h3 id="hidpod"&gt;修复按 Pod 名称过滤时，无法支持包含点号的名称&lt;a class="headerlink" href="#hidpod" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;之前的版本中按 Pod 名称过滤时，过滤的名称不能包含英文点号，新版本已兼容包含点号的名称:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
--pod-name foo.bar.default
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="pod-pod"&gt;
&lt;h3 id="hidpod-pod"&gt;修复按 Pod 过滤时，无法支持包含多个容器的 Pod 的场景&lt;a class="headerlink" href="#hidpod-pod" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;之前的版本中按 Pod 过滤时，无法支持 Pod 中存在多个容器的场景，新版本已修复该问题。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="ptcpdump"&gt;
&lt;h3 id="hidptcpdump"&gt;支持同时运行多个 ptcpdump 实例&lt;a class="headerlink" href="#hidptcpdump" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;之前的版本同时只能运行一个 ptcpdump 进程，当运行多个 ptcpdump 进程时，老的进程将不能正常工作（抓不到任何流量），
新版本已修复该问题，在新版本中可以同时运行多个 ptcpdump 进程，多个 ptcpdump 进程不会出现互相干扰或导致其他进程无法抓包的问题。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pid"&gt;
&lt;h3 id="hidpid"&gt;支持同时过滤多个进程 PID&lt;a class="headerlink" href="#hidpid" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;现在 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--pid&lt;/span&gt;&lt;/tt&gt; 参数支持过滤多个 pid 了:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
--pid pid1 --pid pid2
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="micro-nano-time-stamp-precision"&gt;
&lt;h3 id="hidmicro-nano-time-stamp-precision"&gt;新增参数 --micro, --nano, --time-stamp-precision 用于控制输出中的时间格式&lt;a class="headerlink" href="#hidmicro-nano-time-stamp-precision" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;新增参数 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--micro&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--nano&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--time-stamp-precision&lt;/span&gt;&lt;/tt&gt; ，作用和用法对标 tcpdump。&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--micro&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--time-stamp-precision=micro&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
13:36:05.701978 IP 10.0.2.15.22 &amp;gt; 10.0.2.2.59874: Flags [P.], seq 1370707216:1370707292, ack 4569736, win 62780, length 76
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--nano&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--time-stamp-precision=nano&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
13:36:05.701978488 IP 10.0.2.15.22 &amp;gt; 10.0.2.2.59874: Flags [P.], seq 1370707216:1370707292, ack 4569736, win 62780, length 76
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="a-x-xx-x-xx"&gt;
&lt;h3 id="hida-x-xx-x-xx"&gt;新增参数 -A, -x, -xx, -X, -XX 用于控制数据输出格式&lt;a class="headerlink" href="#hida-x-xx-x-xx" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;新增作用和用法对标 tcpdump 的参数 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-A&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-x&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-xx&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-XX&lt;/span&gt;&lt;/tt&gt; 。&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-A&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &amp;gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094]
E..nHL&amp;#64;.&amp;#64;...
..........P.G..vbbEP.......GET / HTTP/1.1
Host: qq.com
User-Agent: curl/7.81.0
Accept: */*
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-x&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &amp;gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094]
        0x0000:  4500 006e 484c 4000 4006 1bc4 0a00 020f
        0x0010:  cbcd fe9d d0e6 0050 c447 8e98 7662 6245
        0x0020:  5018 faf0 d6da 0000 4745 5420 2f20 4854
        0x0030:  5450 2f31 2e31 0d0a 486f 7374 3a20 7171
        0x0040:  2e63 6f6d 0d0a 5573 6572 2d41 6765 6e74
        0x0050:  3a20 6375 726c 2f37 2e38 312e 300d 0a41
        0x0060:  6363 6570 743a 202a 2f2a 0d0a 0d0a
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-xx&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &amp;gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094]
        0x0000:  0050 56eb bc4e 000c 298e 31f3 0800 4500
        0x0010:  006e 484c 4000 4006 1bc4 0a00 020f cbcd
        0x0020:  fe9d d0e6 0050 c447 8e98 7662 6245 5018
        0x0030:  faf0 d6da 0000 4745 5420 2f20 4854 5450
        0x0040:  2f31 2e31 0d0a 486f 7374 3a20 7171 2e63
        0x0050:  6f6d 0d0a 5573 6572 2d41 6765 6e74 3a20
        0x0060:  6375 726c 2f37 2e38 312e 300d 0a41 6363
        0x0070:  6570 743a 202a 2f2a 0d0a 0d0a
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &amp;gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094]
        0x0000:  4500 006e 484c 4000 4006 1bc4 0a00 020f  E..nHL&amp;#64;.&amp;#64;.......
        0x0010:  cbcd fe9d d0e6 0050 c447 8e98 7662 6245  .......P.G..vbbE
        0x0020:  5018 faf0 d6da 0000 4745 5420 2f20 4854  P.......GET / HT
        0x0030:  5450 2f31 2e31 0d0a 486f 7374 3a20 7171  TP/1.1..Host: qq
        0x0040:  2e63 6f6d 0d0a 5573 6572 2d41 6765 6e74  .com..User-Agent
        0x0050:  3a20 6375 726c 2f37 2e38 312e 300d 0a41  : curl/7.81.0..A
        0x0060:  6363 6570 743a 202a 2f2a 0d0a 0d0a       ccept: */*....
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-XX&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
14:36:38.159559 ens33 curl.244103 Out IP 10.0.2.15.53478 &amp;gt; 203.205.254.157.80: Flags [P.], seq 3293023896:3293023966, ack 1986159173, win 64240, length 70, ParentProc [ptcpdump.244094]
        0x0000:  0050 56eb bc4e 000c 298e 31f3 0800 4500  .PV..N..).1...E.
        0x0010:  006e 484c 4000 4006 1bc4 0a00 020f cbcd  .nHL&amp;#64;.&amp;#64;.........
        0x0020:  fe9d d0e6 0050 c447 8e98 7662 6245 5018  .....P.G..vbbEP.
        0x0030:  faf0 d6da 0000 4745 5420 2f20 4854 5450  ......GET / HTTP
        0x0040:  2f31 2e31 0d0a 486f 7374 3a20 7171 2e63  /1.1..Host: qq.c
        0x0050:  6f6d 0d0a 5573 6572 2d41 6765 6e74 3a20  om..User-Agent:
        0x0060:  6375 726c 2f37 2e38 312e 300d 0a41 6363  curl/7.81.0..Acc
        0x0070:  6570 743a 202a 2f2a 0d0a 0d0a            ept: */*....
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="ptcpdump-docker"&gt;
&lt;h3 id="hidptcpdump-docker"&gt;新增用于编译和运行 ptcpdump 的 Docker 镜像&lt;a class="headerlink" href="#hidptcpdump-docker" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;新增用于编译程序的 Docker 镜像： &lt;tt class="docutils literal"&gt;quay.io/ptcpdump/develop:latest&lt;/tt&gt;
以及用于通过 Docker 运行 ptcpdump 的镜像： &lt;tt class="docutils literal"&gt;quay.io/ptcpdump/ptcpdump:latest&lt;/tt&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;可以通过 &lt;tt class="docutils literal"&gt;make &lt;span class="pre"&gt;build-bpf-via-docker&lt;/span&gt;&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;make &lt;span class="pre"&gt;build-via-docker&lt;/span&gt;&lt;/tt&gt; 按需编译 eBPF 程序和 ptcpdump 程序。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;可以使用类似下面的命令，通过 docker 运行 ptcpdump:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
docker run --privileged --rm -t --net=host --pid=host \
  -v /sys/fs/cgroup:/sys/fs/cgroup:ro \
  quay.io/ptcpdump/ptcpdump:latest ptcpdump -i any -c 2 tcp
&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="go-tls-key-log"&gt;
&lt;h3 id="hidgo-tls-key-log"&gt;实验性新功能：在对 Go 程序进行抓包时生成相应的 TLS Key Log 文件&lt;a class="headerlink" href="#hidgo-tls-key-log" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;在新版本中还尝试了一个实验性的功能：在对 Go 程序进行抓包时生成相应的 TLS Key Log 文件。&lt;/p&gt;
&lt;p&gt;TLS Key Log 文件又叫 &lt;a class="reference external" href="https://tlswg.org/sslkeylogfile/draft-ietf-tls-keylogfile.html"&gt;SSLKEYLOGFILE&lt;/a&gt; ，
在 Wireshark 中对应的是 pre-master secret 配置，
第三方程序可以通过这个文件中记录的信息解密抓取的 TLS 流量。&lt;/p&gt;
&lt;p&gt;注意：该功能是一个实验性的功能，只支持 1.18+ 版本的 Go 编译的程序（支持 stripped 的二进制），
并且只支持通过 ptcpdump 运行目标 Go 程序。&lt;/p&gt;
&lt;p&gt;可以通过下面两种方法试用这个功能：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;通过 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--write-keylog-file&lt;/span&gt;&lt;/tt&gt; 参数或者环境变量 &lt;tt class="docutils literal"&gt;SSLKEYLOGFILE&lt;/tt&gt; 指定 SSLKEYLOGFILE 文件的保存路径:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo ptcpdump -i any --write-keylog-file /tmp/keylogfile.txt -w /tmp/go.pcapng -- ./gohttpapp
&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;通过指定 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--embed-keylog-to-pcapng&lt;/span&gt;&lt;/tt&gt; 参数在保存数据到 pcapng 格式文件时内嵌 SSLKEYLOGFILE 文件内容:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo ptcpdump -i any --embed-keylog-to-pcapng -w /tmp/gotls.pcapng -- ./gohttpapp
&lt;/pre&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;可以通过 Wireshark 或 tshark 使用记录的 SSLKEYLOGFILE 内容对保存的 TLS 数据进行解密:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ sudo tshark -r /tmp/go.pcapng -o tls.keylog_file:/tmp/keylogfile.txt | grep HTTP -B 2
Running as user &amp;quot;root&amp;quot; and group &amp;quot;root&amp;quot;. This could be dangerous.
   18 0.518380586    10.0.2.15 → 13.35.238.63 TLSv1.3 118 Change Cipher Spec, Finished
   19 0.519208290 13.35.238.63 → 10.0.2.15    TCP 60 443 → 47606 [ACK] Seq=5508 Ack=340 Win=64240 Len=0
   20 0.519914720    10.0.2.15 → 13.35.238.63 HTTP 179 GET /foo/bar HTTP/1.1


$ tshark -r /tmp/gotls.pcapng | grep HTTP -B 2
   20 0.525662563    10.0.2.15 → 13.35.238.114 TLSv1.3 118 Change Cipher Spec, Finished
   21 0.526138582 13.35.238.114 → 10.0.2.15    TCP 60 443 → 37618 [ACK] Seq=5987 Ack=340 Win=64240 Len=0
   22 0.526977836    10.0.2.15 → 13.35.238.114 HTTP 179 GET /foo/bar HTTP/1.1
&lt;/pre&gt;
&lt;p&gt;ptcpdump 计划未来内置支持使用 SSLKEYLOGFILE 对 TLS 数据进行解密的能力，
以及在抓包时实时获取 SSLKEYLOGFILE 并自动解密的能力，
目前暂时只能使用第三方工具实现 TLS 数据解密。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="tcp-options"&gt;
&lt;h3 id="hidtcp-options"&gt;默认输出 TCP Options&lt;a class="headerlink" href="#hidtcp-options" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;新版本将默认输出 TCP Options 信息：&lt;/p&gt;
&lt;p&gt;老版本:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
14:09:54.324433 ens33 curl.26570 Out IP (..).43772 &amp;gt; (..).443: Flags [S], seq 1674193846, win 64240, length 0, ParentProc [ptcpdump.26560]
&lt;/pre&gt;
&lt;p&gt;新版本:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
14:09:54.324433 ens33 curl.26570 Out IP (..).43772 &amp;gt; (..).443: Flags [S], seq 1674193846, win 64240, options [mss 1460,sackOK,TS val 2107137325 ecr 0,nop,wscale 7], length 0, ParentProc [ptcpdump.26560]
&lt;/pre&gt;
&lt;p&gt;同时新版本还新增对 TCP SACK (Selective Acknowledgment) 和 TFO (TCP Fast Open) 的支持:&lt;/p&gt;
&lt;p&gt;SACK:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
19:03:36.220872 IP6 dead:beef:2::2.35288 &amp;gt; dead:beef:2::1.10029: Flags [.], seq 731670714, ack 2274465610, win 201, options [nop,nop,TS val 1253137130 ecr 837820024,nop,nop,sack 1 {2274467010:2274483378},mptcp 12 dss ack 16301812255838552430], length 0
&lt;/pre&gt;
&lt;p&gt;TFO:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
19:22:26.586851 IP6 dead:beef:1::2.54040 &amp;gt; dead:beef:1::1.10056: Flags [S], seq 271661201, win 64800, options [mss 1440,sackOK,TS val 2947503028 ecr 0,nop,wscale 7,tfo  cookiereq,nop,nop,mptcp 4 capable v1 flags [H]], length 0
19:22:26.591736 IP6 dead:beef:1::1.10056 &amp;gt; dead:beef:1::2.54040: Flags [S.], seq 1229575956, ack 271661202, win 64260, options [mss 1440,nop,nop,sackOK,nop,wscale 7,tfo  cookie 29b3cc66639d427d,nop,nop,mptcp 12 capable v1 flags [H] {0xc87438912bc26cb7}], length 0
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="tcp-options-mptcp"&gt;
&lt;h3 id="hidtcp-options-mptcp"&gt;输出 TCP Options 中的 MPTCP 信息&lt;a class="headerlink" href="#hidtcp-options-mptcp" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;应 MPTCP (MultiPath TCP) 社区的 &lt;a class="reference external" href="https://github.com/mozillazg/ptcpdump/issues/148"&gt;需求&lt;/a&gt;  ，
新增对 MPTCP 的支持:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
15:31:51.696224 IP 10.0.1.2.60958 &amp;gt; 10.0.1.1.10004: Flags [S], seq 3019570341, win 64240, options [mss 1460,sackOK,TS val 1007819908 ecr 0,nop,wscale 7,mptcp 4 capable v1 flags [H]], length 0
15:31:51.696346 IP 10.0.1.1.10004 &amp;gt; 10.0.1.2.60958: Flags [S.], seq 2367868313, ack 3019570342, win 65160, options [mss 1460,sackOK,TS val 162498895 ecr 1007819908,nop,wscale 7,mptcp 12 capable v1 flags [H] {0x8ea1df6e0d588003}], length 0
15:31:51.696587 IP 10.0.1.2.60958 &amp;gt; 10.0.1.1.10004: Flags [.], seq 3019570342, ack 2367868314, win 502, options [nop,nop,TS val 1007819909 ecr 162498895,mptcp 20 capable v1 flags [H] {0x465bcd01b5d78120,0x8ea1df6e0d588003}], length 0
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="netns"&gt;
&lt;h3 id="hidnetns"&gt;新增参数 --netns 支持对在其他网络命名空间中的网络接口进行抓包&lt;a class="headerlink" href="#hidnetns" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;之前的版本只支持对当前网络命名空间中的网络接口进行抓包，新版本通过新增 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--netns&lt;/span&gt;&lt;/tt&gt;
参数支持对其他网络命名空间中的网络接口进行抓包:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo ptcpdump -i lo --netns /run/netns/foobar
sudo ptcpdump -i any --netns /run/netns/foobar
sudo ptcpdump -i any --netns /proc/26/ns/net
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="pcapng-inbound-outbound"&gt;
&lt;h3 id="hidpcapng-inbound-outbound"&gt;PcapNg 格式增强：读取/写入网络接口名称和 Inbound/Outbound 信息&lt;a class="headerlink" href="#hidpcapng-inbound-outbound" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;在之前的版本中使用 &lt;tt class="docutils literal"&gt;ptcpdump &lt;span class="pre"&gt;-r&lt;/span&gt; &amp;lt;file.pcapng&amp;gt;&lt;/tt&gt; 读取 pcapng 文件不会读取其中记录的网络接口名称以及 Inbound/Outbound 信息，
在新版本中已经解决了这个问题:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ptcpdump -r demo.pcapng
14:36:35.880947 ens33 curl.244103 Out IP 10.0.2.15.37668 &amp;gt; 114.114.114.114.53: 44427+ A? qq.com. (24), ParentProc [ptcpdump.244094]
14:36:35.882099 ens33 curl.244103 Out IP 10.0.2.15.37668 &amp;gt; 114.114.114.114.53: 31415+ AAAA? qq.com. (24), ParentProc [ptcpdump.244094]
14:36:35.954613 ens33 curl.244103 In IP 114.114.114.114.53 &amp;gt; 10.0.2.15.37668: 44427 3/0/0 A 203.205.254.157, A 113.108.81.189, A 123.150.76.218 (72), ParentProc [ptcpdump.244094]
&lt;/pre&gt;
&lt;p&gt;同时新版在将捕获的流量信息保存为 PcapNg 格式的文件时，会自动写入 Inbound/Outbound 信息（之前的版本已写入网络接口信息），
即支持 PcapNg 格式的
epb_flags （&lt;a class="reference external" href="https://www.ietf.org/archive/id/draft-tuexen-opsawg-pcapng-05.html#name-enhanced-packet-block-flags"&gt;Enhanced Packet Block Flags Word&lt;/a&gt; ）
标记。&lt;/p&gt;
&lt;p&gt;如果你对 ptcpdump 有额外的改进或新功能建议，欢迎在评论区或项目 issues 中留言。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="ptcpdump"></category></entry><entry><title>我参与写作的新书《eBPF 云原生安全：原理与实践》目前正在新鲜发售中</title><link href="https://mozillazg.com/2024/09/new-book-cloud-native-security-with-ebpf.html" rel="alternate"></link><published>2024-09-28T00:00:00+00:00</published><updated>2024-09-28T00:00:00+00:00</updated><author><name>mozillazg</name></author><id>tag:mozillazg.com,2024-09-28:2024/09/new-book-cloud-native-security-with-ebpf.html</id><summary type="html">&lt;p&gt;我跟同事合著的新书《eBPF 云原生安全：原理与实践》在 8 月底的时候已经正式对外发售了。
好像还没在博客中宣传过这个消息，今天特意发篇文章来打个广告。&lt;/p&gt;
&lt;div class="section" id="section-1"&gt;
&lt;h2 id="hidsection-1"&gt;广告时间&lt;a class="headerlink" href="#hidsection-1" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;我跟同事合著的由机械工业出版社出版的新书《eBPF 云原生安全：原理与实践》现已正式出版发售，各大电商平台上均有现货！
推荐对 eBPF 或安全感兴趣的朋友们关注一下。下面是一些链接资源，供大家参考：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;出版社旗下公众号的介绍页面：&lt;a class="reference external" href="https://mp.weixin.qq.com/s/EWsKxgRFNiqF1HEqVNEQ5w"&gt;https://mp.weixin.qq.com/s/EWsKxgRFNiqF1HEqVNEQ5w&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;豆瓣介绍页面：&lt;a class="reference external" href="https://book.douban.com/subject/37022239/"&gt;https://book.douban.com/subject/37022239/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;京东购买链接：&lt;a class="reference external" href="https://item.jd.com/10111206687256.html"&gt;https://item.jd.com/10111206687256.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;天猫购买链接：&lt;a class="reference external" href="https://detail.tmall.com/item.htm?id=82"&gt;https://detail.tmall.com/item.htm?id=82&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;书中所有示例程序的完整源代码：&lt;a class="reference external" href="https://github.com/mozillazg/cloud-native-security-with-ebpf"&gt;https://github.com/mozillazg/cloud-native-security-with-ebpf&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="section-2"&gt;
&lt;h2 id="hidsection-2"&gt;关于这本书&lt;a class="headerlink" href="#hidsection-2" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;我从 2022 年开始参与本书的写作，耗时 2 年多，期间经历了新冠疫情封控、疫情结束、各种拖延症发作，
最后终于在 2024 年 8 月底正式对外出版发售了！&lt;/p&gt;
&lt;p&gt;在这里我想感谢家人和朋友们的支持和帮助、感谢机械工业出版社的各位主编、编辑、设计、文案、市场、营销、策划、印刷等
老师的支持和帮助、感谢同事和领导的支持和帮助。&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;尤其要感谢出版社的杨福川老师给予我们写作本书的机会以及老师对我们写作和出版的帮助和督促；&lt;/li&gt;
&lt;li&gt;感谢出版社的陈洁老师专业的编辑水平和素养以及专业和细致认真的审稿和出版支持；&lt;/li&gt;
&lt;li&gt;感谢匡大虎老师愿意合作参与本书的写作，感谢匡老师带我飞；&lt;/li&gt;
&lt;li&gt;感谢易立、李鹏两位老板的大力支持，感谢两位老板在百忙中抽空为本书撰写推荐语；&lt;/li&gt;
&lt;li&gt;感谢姜坦、杜岚两位老师百忙中抽空为本书撰写推荐语；&lt;/li&gt;
&lt;li&gt;感谢 &lt;a class="reference external" href="https://github.com/Zheaoli"&gt;&amp;#64;Zheaoli&lt;/a&gt; 、 &lt;a class="reference external" href="https://github.com/jschwinger233"&gt;&amp;#64;jschwinger233&lt;/a&gt; 两位老师在百忙中抽空阅读本书并撰写推荐语；&lt;/li&gt;
&lt;li&gt;感谢我的妻子的支持，感谢她对我写作的支持和包容；&lt;/li&gt;
&lt;li&gt;感谢 &lt;a class="reference external" href="https://github.com/Zheaoli"&gt;&amp;#64;Zheaoli&lt;/a&gt; 老师在网上向网友们推荐本书；&lt;/li&gt;
&lt;li&gt;感谢 &lt;a class="reference external" href="https://x.com/yihong0618"&gt;&amp;#64;yihong0618&lt;/a&gt; 老师在网上向网友们推荐本书；&lt;/li&gt;
&lt;li&gt;感谢已经购买和即将购买这本书的读者朋友们的支持。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;最后，关于这本书的质量：我只能保证这本书不是一本烂书、书中所有的代码都能跑通并且结果可以复现（
可以在上面的源码仓库中查看所有示例代码的编译和运行说明），至于是否是好书就见仁见智了。
因为是第一次写书以及本人水平有限，难免会存在各种各样的问题，大家如果有任何建议或发现任何问题可以在前面的源码仓库中通过 issue 的形式反馈
或者加我微信反馈（下方有我的微信二维码链接，相信细心的你一定能找到），也可以在下方评论区反馈。&lt;/p&gt;
&lt;/div&gt;
</summary></entry><entry><title>使用 except 命令解决无法在无 tty 的环境里执行 kubectl exec -it 命令的问题</title><link href="https://mozillazg.com/2024/03/fix-can-not-run-kubectl-exec-it-in-no-tty-env.html" rel="alternate"></link><published>2024-03-23T00:00:00+00:00</published><updated>2024-03-23T00:00:00+00:00</updated><author><name>mozillazg</name></author><id>tag:mozillazg.com,2024-03-23:2024/03/fix-can-not-run-kubectl-exec-it-in-no-tty-env.html</id><summary type="html">&lt;div class="section" id="section-1"&gt;
&lt;h2 id="hidsection-1"&gt;问题&lt;a class="headerlink" href="#hidsection-1" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;当我们在无 tty 环境下执行 &lt;tt class="docutils literal"&gt;kubectl exec &lt;span class="pre"&gt;-it&lt;/span&gt;&lt;/tt&gt; 命令的时候，
kubectl 会输出如下警告然后自动禁用 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-t&lt;/span&gt;&lt;/tt&gt; 选项:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Unable to use a TTY - input is not a terminal or the right kind of file
&lt;/pre&gt;
&lt;p&gt;无 tty 的场景包括但不限于：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;在未启用 tty 的容器中执行 kubectl 命令&lt;/li&gt;
&lt;li&gt;使用 nohup 执行包含 kubectl 命令的脚本（可以使用该方法在不修改原脚本的情况下复现上面的报错）&lt;/li&gt;
&lt;li&gt;使用管道或 &lt;tt class="docutils literal"&gt;&amp;lt;&lt;/tt&gt; 作为 kubectl 命令的输入&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="section-2"&gt;
&lt;h2 id="hidsection-2"&gt;解决方法&lt;a class="headerlink" href="#hidsection-2" title="Permalink to this headline"&gt;¶&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;对于无需进行交互式操作的场景，通常可以通过主动去除 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-t&lt;/span&gt;&lt;/tt&gt; 选项来去掉该告警。
但是有时我们的场景确实需要进行交互式操作，
或者我们的场景是即便不需要进行交互式操作也会需要依赖 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-t&lt;/span&gt;&lt;/tt&gt; 选项（比如，为了测试 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-t&lt;/span&gt;&lt;/tt&gt; 选项的功能）。&lt;/p&gt;
&lt;p&gt;此时，我们可以通过 &lt;a class="reference external" href="https://linux.die.net/man/1/expect"&gt;except&lt;/a&gt; 这个工具来启用一个 tty，
满足 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-t&lt;/span&gt;&lt;/tt&gt; 选项所依赖的环境:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
cat &amp;lt;&amp;lt;EOF &amp;gt; test.sh

# 执行 kubectl exec -it 命令
spawn kubectl exec -it xxxx yyy

# 可以通过 send 和 expect 进行交互式操作
# send &amp;quot;&amp;lt;CMD&amp;gt;\r&amp;quot;
# expect &amp;quot;&amp;lt;STR&amp;gt;&amp;quot;

# 发送 exit 命令，退出交互式终端
# send &amp;quot;exit\r&amp;quot;
# expect eof

EOF

except -f test.sh
&lt;/pre&gt;
&lt;p&gt;关于 &lt;tt class="docutils literal"&gt;except&lt;/tt&gt; 命令的详细使用方式大家可以在网络上自行搜索。&lt;/p&gt;
&lt;/div&gt;
</summary><category term="kubectl"></category></entry></feed>